<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:vo="com.efi.vo.*" width="392" height="346" defaultButton="{select_button}" showCloseButton="false" creationComplete="init()"
    close="PopUpManager.removePopUp(this);"
    title="Price List" xmlns:text="flash.text.*" borderThickness="3" borderStyle="solid" horizontalScrollPolicy="off" 
    label="Price List" name="Price List"
    verticalScrollPolicy="off">

<mx:RemoteObject id="dataService" destination="dataService">
	<mx:method name="getAll" fault="handleFault(event)" result="handleLoadResult(event)"/>
</mx:RemoteObject>

<mx:Producer id="producer" destination="pricelist"/>
<mx:Consumer id="consumer" destination="pricelist" message="messageHandler(event.message)"/>
<mx:Consumer id="notification_consumer" destination="notifications" message="messageHandler(event.message)"/>

<mx:Script>
                                   
<![CDATA[ 
	import com.efi.vo.Contact;           
    import com.efi.vo.Account;    
    import com.efi.view.EditContact;
    import com.efi.view.EditCustomer;    
    import com.efi.view.PressDefinitions;
    import com.efi.vo.Charge;        
	import mx.managers.PopUpManager;       
	import com.efi.vo.PriceList;
	import com.efi.vo.PriceListBase; 
	import com.efi.vo.WasteChart;                          
	import mx.controls.Alert;                          
	import mx.containers.Canvas;   
	import mx.core.Container;                      
	import mx.rpc.events.ResultEvent;                                 
	import mx.rpc.events.FaultEvent;                          
	import mx.events.ValidationResultEvent;                          
	import mx.validators.Validator;       
	import mx.messaging.messages.AsyncMessage;
	import mx.messaging.messages.IMessage;
	import mx.core.Application;
	import mx.collections.ArrayCollection;
	    
	[Bindable]                                
	private var list:ArrayCollection = new ArrayCollection();
                                                                        	         
	public var itemType:String;
	
	[Bindable]                                
	public var priceList:PriceListBase;

	public var parentContainer:Container;
	// Holds a reference to the currently focussed control on the form.
 	private var focusedFormControl:DisplayObject;                           
           
	                    
	private function handleLoadResult(event:ResultEvent):void {
		list = event.result as ArrayCollection;
	}
	
	private function handleFault(ev:FaultEvent):void {                               
		var message:String;
		              
		message = "Error: "                          
		+ ev.fault.faultCode + " - "                                  
		+ ev.fault.faultDetail + " - "                                  
		+ ev.fault.faultString;
		Alert.show(message, "Error", 0, this, null);                                 
	}

	private function messageHandler(message:IMessage):void
	{
		var messageBody:Object = message.body;// as com.efi.messaging.MessageBody;
		
		var messageType:String = messageBody.messageType;
		if (messageType == "ADDUPDATE" || messageType == "DELETE") {
			var payloadType:String = messageBody.payloadType as String; // What kind of item was added/deleted
			var payload:Number = messageBody.payload as Number; // ID if item added or deleted
			if (payloadType == "PriceList" || payloadType == "PriceListBase" || payloadType == "WasteChart") {
				dataService.getAll(payloadType)
			}
		}
	}
	                                                       
	private function init():void {   
		consumer.subscribe();
		notification_consumer.subscribe();     

	    PopUpManager.centerPopUp(this);
	    if (this.itemType == null)
	    	this.itemType = "PriceListBase";

		dataService.getAll(this.itemType);
		
		if (this.itemType == "WasteChart"){
			this.title = "Waste Chart"
			this.label = "Waste Chart"
		} else if (this.itemType =="SpeedTable") {
			this.title = "Speed Table"
			this.label = "Speed Table"
		}
		parentContainer = Snowmass.getInstance().mainNavigator.selectedChild;

	}
	                                
	private function doSelect():void {	
		
		var editPage:Container = parentContainer;
		if (dataGrid.selectedItem != null){
			switch(editPage.className) {
			case "PressDefinitions":
				(editPage as PressDefinitions).setPriceList(dataGrid.selectedItem as PriceListBase);
				break;
			case "ChargeDefinitions": 
				(editPage as ChargeDefinitions).setPriceList(priceList as WasteChart);
				break;
			case "StockDefinitions":
				(editPage as StockDefinitions).setPriceList(dataGrid.selectedItem as PriceListBase);
				break;
			case "CopierDefinitions" :
				(editPage as CopierDefinitions).setPriceList(dataGrid.selectedItem as PriceListBase);
				break;
			}

			PopUpManager.removePopUp(this);
		}
		
	}     
	
	private function doNew():void {
		var editPage:Container = parentContainer;
		var titleWindow:PriceListEditor = PriceListEditor(PopUpManager.createPopUp(editPage, PriceListEditor, true));
	    titleWindow.setStyle("borderAlpha", 0.9);
	    titleWindow.itemType= this.itemType;
		PopUpManager.removePopUp(this);
		dataService.getAll(this.itemType);
		
	}

	private function doEdit():void {
		var editPage:Container = parentContainer;
		var titleWindow:PriceListEditor = PriceListEditor(PopUpManager.createPopUp(editPage, PriceListEditor, true));
	    titleWindow.setStyle("borderAlpha", 0.9);
	    titleWindow.mapfromPricelist(dataGrid.selectedItem as PriceListBase);
		PopUpManager.removePopUp(this);
	}
		
	private function doClear():void {
		PopUpManager.removePopUp(this);		
	}
	
	private function doDelete():void {
		
	}
	
	private function doCancel():void {
		
		PopUpManager.removePopUp(this);
	}
]]>        
</mx:Script>
                             

                             
	<mx:Canvas width="361" height="100%" verticalScrollPolicy="off" horizontalScrollPolicy="off">
		<mx:DataGrid id="dataGrid" width="228" height="261" dataProvider="{list}"
		doubleClickEnabled="true" doubleClick="doEdit()"  showHeaders="false" borderStyle="solid" borderThickness="3" x="0" y="0" editable="false" enabled="true">               
		<mx:columns>
		     <mx:DataGridColumn dataField="name" headerText="Name" />                         
		</mx:columns>
		</mx:DataGrid>
		<mx:Button label="Select" id="select_button" enabled="true" click="doSelect();"  width="108" x="236" y="10"/>
		<mx:Button label="Clear" enabled="true" click="doClear();" id="clear_button" width="108" x="237.5" y="40"/>
		<mx:Button label="New" click="doNew();" id="new_button" width="108" x="236" y="80"/>
		<mx:Button label="Edit" click="doEdit();" id="edit_button" width="108" x="236" y="106"/>
		<mx:Button label="Delete" click="doDelete();" id="delete_button" width="108" x="236" y="132"/>
		<mx:Button label="Cancel" click="doCancel();" id="cancel_button" width="108" x="236" y="172"/>
		<mx:HRule x="236" y="70" width="109.5"/>
		<mx:HRule x="234.5" y="162" width="109.5"/>
	</mx:Canvas>
<mx:Spacer height="10" />        

</mx:TitleWindow>