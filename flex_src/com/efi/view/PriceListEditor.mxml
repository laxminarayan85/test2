<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:vo="com.efi.vo.*" width="424" height="458" 
	defaultButton="{select_button}" 
	showCloseButton="false" 
	creationComplete="init()"
    close="PopUpManager.removePopUp(this);" 
    title="Price List" xmlns:text="flash.text.*" borderThickness="3" borderStyle="solid" 
    horizontalScrollPolicy="off" 
    label="Price List" name="Price List"
    verticalScrollPolicy="off">

<mx:RemoteObject id="dataService" destination="dataService">
	<mx:method name="getAll" fault="handleFault(event)" result="handleLoadResult(event)"/>
	<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveResult(event)"/>
	<mx:method name="deleteItem" fault="handleFault(event)" result="handleDeleteResult(event)"/>
</mx:RemoteObject>
<mx:RemoteObject id="dataServiceElements" destination="dataService">
	<mx:method name="getFromParent" fault="handleFault(event)" result="handleLoadElementsResult(event)"/>
	<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveElementsResult(event)"/>
</mx:RemoteObject>

<mx:Producer id="producer" destination="pricelist"/>
<mx:Consumer id="consumer" destination="pricelist" message="messageHandler(event.message)"/>
<mx:Consumer id="notification_consumer" destination="notifications" message="messageHandler(event.message)"/>

<mx:Script>
                                   
<![CDATA[
	import com.efi.vo.PriceList;
	import com.efi.vo.PriceListElement;
	import com.efi.view.CopierDefinitions;
    import com.efi.view.PressDefinitions;
    import com.efi.view.StockDefinitions;

	import com.efi.vo.WasteChart;                          
	import com.efi.vo.PriceListBase; 
	import com.efi.vo.Contact;           
    import com.efi.vo.Account;    
    import com.efi.view.EditContact;
    import com.efi.view.EditCustomer;            
	import mx.managers.PopUpManager;                                 
	import mx.controls.Alert;                          
	import mx.containers.Canvas;   
	import mx.core.Container;                      
	import mx.rpc.events.ResultEvent;                                 
	import mx.rpc.events.FaultEvent;                          
	import mx.events.ValidationResultEvent;                          
	import mx.validators.Validator;       
	import mx.messaging.messages.AsyncMessage;
	import mx.messaging.messages.IMessage;
	import mx.core.Application;
	import mx.collections.ArrayCollection;
	    
	[Bindable]                                
	public var priceList:PriceListBase;
	
	[Bindable] 
	public var priceListElement:PriceListElement;
	
	public var parentContainer:Container;

	[Bindable] 
	private var pricelists:ArrayCollection = new ArrayCollection();   
           
	[Bindable] 
    private var PriceListElementArray:ArrayCollection = new ArrayCollection();
	[Bindable] 
	private var PriceListElementDeleteArray:ArrayCollection = new ArrayCollection();
    [Bindable]
    private var quantity_header:String = "Quantity";
    
    [Bindable]
    private var price_header:String = "Price";
                                                                 	         
	public var itemType:String;

	[Bindable]
	private var amountRadioValue:String = "amtiscurrency";
	
	// Holds a reference to the currently focussed control on the form.
 	private var focusedFormControl:DisplayObject;                           
   	
	private function handleFault(ev:FaultEvent):void {                               
		var message:String;
		message = "Error: "                          
		+ ev.fault.faultCode + " - "                                  
		+ ev.fault.faultDetail + " - "                                  
		+ ev.fault.faultString;
		Alert.show(message, "Error", 0, this, null);                                 
	}
	                                                       
	private function init():void {
		consumer.subscribe();
		notification_consumer.subscribe();     

	    PopUpManager.centerPopUp(this);
	    dataService.getAll(itemType);
		parentContainer = Snowmass.getInstance().mainNavigator.selectedChild;
		if (itemType == "PriceList" ||itemType == "PriceListBase")
		{
			this.title = "Price List"
			this.label = "Price List"
			if (priceList == null)
			{
				priceList = new PriceList();
			} 
		}else
		{	
			this.title = "Waste Chart"
			this.label = "Waste Chart"
			if (priceList == null)
			{
				priceList = new WasteChart();
			} 
		}
	}
	                                
	private function doSelect():void {	

		maptoPricelist();
		dataService.addUpdate(priceList);

		PopUpManager.removePopUp(this);
		
	}     
	
	private function doNew():void {
		mapfromPricelist(null);
	}
	
	private function doClear():void {
		PopUpManager.removePopUp(this);		
	}
	
	private function doDelete():void {
		 dataService.deleteItem(itemType,priceList.id);
	}
	
	private function UpdateElementData():void{

		for each (var item:PriceListElement in PriceListElementArray)
		{
			item.priceListBase = priceList;
			dataServiceElements.addUpdate(item);
		}
		

	}
	public function mapfromPricelist(pricelist1:PriceListBase):void {
		if (pricelist1 != null){
			if (priceList == null){
				priceList = new PriceListBase;
				priceListElement = new PriceListElement(); 
			}
			priceList = pricelist1; 

			//title_edit.text = priceList.name;
		}else
		{
			if (priceList == null){
				priceList = new PriceListBase;
				priceListElement = new PriceListElement(); 
			}
		}
		chkInterpolate.selected = priceList.interpolate;
		chkUseAsRateList.selected = priceList.isRate;
		chkProductionDiscount.selected = priceList.isDiscount;
		chkIgnoreGlobalPriceChange.selected = priceList.ignorePriceAdjustments;
	}
	
	private function maptoPricelist():void {
		
		priceList.name = title_edit.text;
		priceList.interpolate = chkInterpolate.selected;
		priceList.isRate = chkUseAsRateList.selected;
		priceList.isDiscount = chkProductionDiscount.selected;
		priceList.ignorePriceAdjustments = chkIgnoreGlobalPriceChange.selected;
	
	}
	
	
	private function messageHandler(message:IMessage):void
	{
	}

	private function handleSaveResult(ev:ResultEvent):void {
		if (itemType == "PriceList" ||itemType == "PriceListBase")
		{
			priceList = ev.result as PriceList
		}else{
			priceList = ev.result as WasteChart
		}
		UpdateElementData();

		var editPage:Container = parentContainer;

		switch(editPage.className) {
			case "PressDefinitions":
				(editPage as PressDefinitions).setPriceList(priceList);
				break;
			case "ChargeDefinitions": 
				(editPage as ChargeDefinitions).setPriceList(priceList as WasteChart);
				break;
			case "StockDefinitions":
				(editPage as StockDefinitions).setPriceList(priceList);
				break;
			case "CopierDefinitions" :
				(editPage as CopierDefinitions).setPriceList(priceList);
				break;
		}

		dataService.getAll(itemType)
	}
	private function handleLoadResult(ev:ResultEvent):void {
		pricelists = ev.result as ArrayCollection;
		dataServiceElements.getFromParent("PriceListElement","pricelistbase",priceList.id)
	}
	private function handleDeleteResult(ev:ResultEvent):void {
		dataService.getAll(itemType)
		doNew();
	}
	private function handleLoadElementsResult(ev:ResultEvent):void {
		PriceListElementArray = ev.result as ArrayCollection;
		if (PriceListElementArray == null){
			PriceListElementArray = new ArrayCollection();
		}
	}
	private function handleSaveElementsResult(ev:ResultEvent):void {
		if (priceList != null)
			dataServiceElements.getFromParent("PriceListElement","pricelistbase",priceList.id)
	}
	
	private function doNewPriceListElement():void {
		var newItem:PriceListElement = new PriceListElement();
		PriceListElementArray.addItem(newItem);

	}
	private function doRemovePriceListElement():void {
		var newItem:PriceListElement = dataGrid.selectedItem as PriceListElement;
		PriceListElementDeleteArray.addItem(newItem);
		PriceListElementArray.removeItemAt(dataGrid.selectedIndex);
	}

]]>        
</mx:Script>            
	<mx:Canvas width="400" height="406" verticalScrollPolicy="off" horizontalScrollPolicy="off">
		<mx:DataGrid id="dataGrid" width="154" height="309" dataProvider="{PriceListElementArray}"
		showHeaders="true" borderStyle="solid" borderThickness="3" x="0" y="0" editable="true" enabled="true">               
		<mx:columns>
		     <mx:DataGridColumn dataField="quantity" headerText="{quantity_header}" />
		     <mx:DataGridColumn dataField="amount" headerText="{price_header}" />
		</mx:columns>
		</mx:DataGrid>
		<mx:Button label="OK" id="select_button" enabled="true" click="doSelect()"  width="108" x="0" y="374"/>
		<mx:Button label="Cancel" enabled="true" click="doClear();" id="clear_button" width="108" x="116" y="374"/>
		<mx:TextInput x="204" y="10" id="title_edit" text="{priceList.name}" width="186"/>
		<mx:Label x="162" y="12" text="Title:"/>
		<mx:RadioButtonGroup id="amount_radio_group" selectedValue="{amountRadioValue}"/>
		<mx:RadioButton x="204" y="40" label="Amount is currency" groupName="amount_radio_group" value="amtiscurrency"/>
		<mx:RadioButton x="204" y="62" label="Amount is percent" groupName="amount_radio_group" value="amtispercent"/>
		<mx:CheckBox x="204" y="163" label="Ignore global price changes" selected="{priceList.ignorePriceAdjustments}" id="chkIgnoreGlobalPriceChange"/>
		<mx:CheckBox x="204" y="96" label="Interpolate" selected="{priceList.interpolate}" id="chkInterpolate"/>
		<mx:CheckBox x="227" y="140" label="Production discount" width="137" selected="{priceList.isDiscount}" id="chkProductionDiscount"/>
		<mx:CheckBox x="204" y="118" label="Use as rate list" selected="{priceList.isRate}" id="chkUseAsRateList"/>
		<mx:Button x="34" y="317" width="38" height="38" click="doNewPriceListElement();">
			<mx:icon>@Embed(source='../../../assets/new.png')</mx:icon>
		</mx:Button>
		<mx:Button x="84" y="317" width="38" height="38" click="doRemovePriceListElement();">
			<mx:icon>@Embed(source='../../../assets/cancel.png')</mx:icon>
		</mx:Button>
	</mx:Canvas>
<mx:Spacer height="10" />        

</mx:TitleWindow>