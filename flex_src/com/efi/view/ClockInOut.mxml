<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute" width="638" height="538" title="Time Tracking" label="Time Tracking" 
	creationComplete="init()" xmlns:components="com.efi.components.*" xmlns:vo="com.efi.vo.*" showCloseButton="true" close="PopUpManager.removePopUp(this) ">
	<mx:RemoteObject id="dataService" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadResult(event)"/>
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveResult(event)"/>
		<mx:method name="deleteItem" fault="handleFault(event)" result="handleDeleteResult(event)"/>
	</mx:RemoteObject>

	<mx:RemoteObject id="dataServiceTimeCard" destination="dataService">
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveTimeCardResult(event)"/>
		<mx:method name="getByClockInOut" fault="handleFault(event)" result="handleLoadTimeCardResult(event)"/>
		<mx:method name="getByClockInOutBreak" fault="handleFault(event)" result="handleLoadTimeCardBreakResult(event)"/>
	</mx:RemoteObject>

	
	<mx:Producer id="producer" destination="employees"/>
	<mx:Consumer id="consumer" destination="employees" message="messageHandler(event.message)"/>
	<mx:Consumer id="notification_consumer" destination="notifications" message="messageHandler(event.message)"/>
	
<mx:Script>  	
<![CDATA[
	import com.efi.vo.TimeCard;
	import mx.controls.Alert;                                         
	import mx.managers.PopUpManager;                                         
	import mx.containers.TitleWindow;                                         
	import mx.collections.ArrayCollection;                                         
	import mx.rpc.events.ResultEvent;                                         
	import mx.rpc.events.FaultEvent;                                         
	import mx.messaging.messages.AsyncMessage;
	import mx.messaging.messages.IMessage;
	import mx.printing.PrintAdvancedDataGrid;
    import mx.printing.PrintDataGrid;
    import mx.core.Application;
	import com.efi.vo.Employee;
    import com.efi.vo.City;
	import com.efi.vo.Country;
	import com.efi.vo.State;
	import com.efi.vo.Zip;

	[Bindable]
	private var employeesArray:ArrayCollection = new ArrayCollection();

	[Bindable]
	private var timecardArray:ArrayCollection = new ArrayCollection();
	[Bindable]
	private var timecardBreakArray:ArrayCollection = new ArrayCollection();

	[Bindable] 
	private var employee:Employee;

	[Bindable] 
	private var timecard:TimeCard;

	[Bindable]
	private var OnOffBreak:String="On Break";
		
	public function init():void {
		var application:Snowmass = Snowmass.getInstance();
	/* 	consumer.subscribe();
		notification_consumer.subscribe();      */
		dataService.getAll("Employee");
		//user = application.currentUser;
	} 
	
	private function messageHandler(message:IMessage):void
	{
		var messageBody:String = message.body as String;
  		dataService.getAll("Employee");
	}
	private function handleLoadResult(ev:ResultEvent):void {
		employeesArray = ev.result as ArrayCollection;
	}
	private function handleSaveResult(ev:ResultEvent):void {
		dataService.getAll("Employee")
	}
	private function handleDeleteResult(ev:ResultEvent):void {
		dataService.getAll("Employee")
	}  
	
	private function handleSaveTimeCardResult(ev:ResultEvent):void {
	}
	private function handleLoadTimeCardResult(ev:ResultEvent):void {
		timecardArray = ev.result as ArrayCollection;
	}
	private function handleLoadTimeCardBreakResult(ev:ResultEvent):void {
		timecardBreakArray = ev.result as ArrayCollection;
	}
	
	private function setEmployee():void
	{	
		dataService.addUpdate(employee);
	}
	
	private function setTimeCard(reason:String):void {

		var newCard:TimeCard;
		var item:TimeCard;
		var currentArray:ArrayCollection = new ArrayCollection();
		
		if ((reason == "in") ||(reason == "out"))
		{

			for each(item in timecardArray) {
				if (item.employee == employee && item.created == new Date())
				{
					currentArray.addItem(item);
				}
			}
			if (timecardArray == null || timecardArray.length == 0)
			{
				newCard = new TimeCard();
			}else {
				newCard = timecardArray.getItemAt(0,0) as TimeCard;
			}
			if (reason == "in")
			{
				newCard.startDateTime = new Date(); 
				newCard.endDateTime = null;
				newCard.breakTime = null
				newCard.employee = employee;
				newCard.onClock = 1;
			}
			if (reason == "out")
			{
				newCard.endDateTime = new Date();
				newCard.onClock = 0;
			}
		} else {
	
			for each(item in timecardBreakArray) {
				if (item.employee == employee && item.created == new Date())
				{
					currentArray.addItem(item);
				}
			}
			if (timecardBreakArray == null || timecardBreakArray.length == 0)
			{
				newCard = new TimeCard();
			}else {
				newCard = timecardBreakArray.getItemAt(0,0) as TimeCard;
			}

			if (reason == "breakstart")
			{
				newCard.startDateTime = new Date();
				newCard.endDateTime = null;
				newCard.employee = employee;
				newCard.breakTime = new Date();
				newCard.onClock = 0;
			}
			if (reason == "breakstop")
			{
				newCard.endDateTime = new Date();
			}
		}
			
		dataServiceTimeCard.addUpdate(newCard);
	}

	private function doClockIn(): void{  
		if (employee != null){
			if (employee.clockBreak == true)
			{
				setTimeCard("breakstop");
			}
			employee.clockIn= true;
			employee.clockOut = false;
			employee.clockBreak= false;
			setEmployee();
			setTimeCard("in");
			employee = null;
		}
	}
	  
	private function doClockOut(): void{ 
		if (employee != null){
			if (employee.clockBreak == true)
			{
				setTimeCard("breakstop");
			}
			employee.clockIn= false;
			employee.clockOut = true;
			employee.clockBreak= false; 
			setEmployee();
			setTimeCard("out");
			employee = null;
		}
	}
	
	private function doClockBreak(): void{ 
		if (employee != null){
			if (employee.clockBreak == true)
			{
				setTimeCard("breakstop");
				employee.clockIn= false;
				employee.clockOut = false;
				employee.clockBreak= false;
			}
			else
			{
				employee.clockIn= false;
				employee.clockOut = false;
				employee.clockBreak= true;
				setTimeCard("breakstart");
			}
			setEmployee();
			employee = null;
		}
	}
	
	private function handleFault(ev:FaultEvent):void {  
		var message:String;
		              
		message = "Error: "                          
		+ ev.fault.faultCode + " - "                                  
		+ ev.fault.faultDetail + " - "                                  
		+ ev.fault.faultString;
		Alert.show(message, "Error", 0, null, null, null, 4);                                 
	}

	private function doGrid(): void{ 
		employee = employeeGrid.selectedItem as Employee;
		dataServiceTimeCard.getByClockInOut("TimeCard",employee);
		dataServiceTimeCard.getByClockInOutBreak("TimeCard",employee);
		if (employee.clockBreak == true){
			OnOffBreak = "Off Break"
		}else {
			OnOffBreak = "On Break"
		}
		
	}  
              
]]>
                             
</mx:Script>

	<mx:Button x="20" y="37" label="Clock In" width="132" height="107" icon="@Embed(source='../../../assets/ClockIn.png')" id="clockIn" click="doClockIn();"/>
	<mx:Button x="20" y="165" label="Clock Out" width="132" height="107" icon="@Embed(source='../../../assets/ClockOut.png')" id="clockOut" click="doClockOut();"/>
	<mx:Button x="20" y="310" label="{OnOffBreak}" width="132" height="107" id="clockBreak" icon="@Embed(source='../../../assets/ClockOnBreak.png')" click="doClockBreak();"/>
	<mx:AdvancedDataGrid x="167" y="37" width="100%" id="employeeGrid" dataProvider="{employeesArray}" height="380" sortExpertMode="true"
		itemClick="doGrid()">
		<mx:groupedColumns>
			<mx:AdvancedDataGridColumn width="50" headerText="First Name" sortable="false" textAlign="center" dataField="firstName" />
			<mx:AdvancedDataGridColumn width="50" headerText="Last Name" sortable="false" textAlign="center" dataField="lastName"/>
				<mx:AdvancedDataGridColumnGroup id="Inout" headerText="Status" sortable="false" editable="false">
				<mx:AdvancedDataGridColumn width="20" headerText="Out" sortable="false" textAlign="center"  editable="false" dataField="clockOut" itemRenderer="com.efi.components.GenericCheckboxRenderer"  rendererIsEditor="false" editorDataField="selected"/>
				<mx:AdvancedDataGridColumn width="20" headerText="In" sortable="false" textAlign="center" editable="false" dataField="clockIn" itemRenderer="com.efi.components.GenericCheckboxRenderer" rendererIsEditor="false" editorDataField="selected"/>
				<mx:AdvancedDataGridColumn width="20" headerText="Break" sortable="false" textAlign="center" editable="false" dataField="clockBreak" itemRenderer="com.efi.components.GenericCheckboxRenderer" rendererIsEditor="false" editorDataField="selected"/>
			</mx:AdvancedDataGridColumnGroup>
		</mx:groupedColumns>
	</mx:AdvancedDataGrid>
	
</mx:TitleWindow>
