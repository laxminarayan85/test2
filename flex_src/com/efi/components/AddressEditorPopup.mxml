<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:fc="http://www.adobe.com/2006/fc"
        height="214"
        width="438"
        showCloseButton="true"
        verticalScrollPolicy="off"
        horizontalScrollPolicy="off"
        creationComplete="init()"
        close="doCancel()"
        defaultButton="{ok_button}" title="Edit Address">
        
	<mx:Metadata>
		[Event(name="SaveAddressEvent", type="com.efi.events.SaveAddressEvent")]
 	</mx:Metadata>
	
	<mx:RemoteObject id="cityDataService" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadCity(event)"/>
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveCityResult(event)"/>
	</mx:RemoteObject>
	
	<mx:RemoteObject id="stateDataService" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadState(event)"/>
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveStateResult(event)"/>
	</mx:RemoteObject>
	
	<mx:RemoteObject id="countryDataService" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadCountry(event)"/>
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveCountryResult(event)"/>
	</mx:RemoteObject>
	
	<mx:RemoteObject id="zipDataService" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadZip(event)"/>
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveZipResult(event)"/>
	</mx:RemoteObject>
		
    <mx:Canvas width="409" height="167">
    <mx:Label x="10" y="33" text="Street:" width="67" textAlign="right"/>
    <mx:Label x="10" y="82" text="City:" width="67" textAlign="right"/>
    <mx:Label x="306" y="82" text="State:" width="39" textAlign="right"/>
    <mx:Label x="10" y="106" text="Zip:" width="67" textAlign="right"/>
    <mx:Label x="164" y="106" text="Country:" width="57" textAlign="right"/>
            
    <mx:Label x="10" y="10" text="Company:" width="67" textAlign="right"/>
    <mx:TextInput x="85" y="10" width="314" id="company_edit" text="{address.name}"/>
    <mx:TextInput x="85" y="33" width="314" id="street1_edit" text="{address.street1}"/>
    <mx:TextInput x="85" y="56" width="314" id="street2_edit" text="{address.street2}"/>
    <fc:AutoComplete id="citycombo" x="85" y="80" labelField="name" dataProvider="{cityDataProvider}" focusOut="focusOutCity()" lookAhead="true" width="164"/>
    <fc:AutoComplete id="statecombo" x="353" y="80" labelField="name" dataProvider="{stateDataProvider}" focusOut="focusOutState()" lookAhead="true" width="46"/>
    <fc:AutoComplete id="zipcombo" x="85" y="104" labelField="name" dataProvider="{zipDataProvider}" focusOut="focusOutZip()" lookAhead="true" width="76"/>
    <fc:AutoComplete id="countrycombo" x="224" y="104" labelField="name" dataProvider="{countryDataProvider}" focusOut="focusOutCountry()" lookAhead="true" width="175"/>
    	
    <mx:Button x="241" y="135" id="ok_button" label="OK" width="75" click="doOK()"/>
    <mx:Button x="324" y="135" id="cancel_button" label="Cancel" width="75" click="doCancel()"/>
    </mx:Canvas>
<mx:Script>
	<![CDATA[
	import com.efi.events.SaveAddressEvent;
	import com.efi.events.UpdateDataProviderEvent;
	import com.efi.vo.Address;
    import com.efi.vo.City;
	import com.efi.vo.Country;
	import com.efi.vo.State;
	import com.efi.vo.Zip;
	import com.efi.vo.ModelBase;
	
	import mx.collections.ArrayCollection;
	import mx.managers.PopUpManager;                                         
	import mx.rpc.events.ResultEvent;                                         
	import mx.rpc.events.FaultEvent;                                         
	import mx.controls.Alert;                                         

	[Bindable]                                         
	private var address:Address ;

	[Bindable]
	public var cityDataProvider:ArrayCollection = null;
	
	[Bindable]
	public var zipDataProvider:ArrayCollection = null;
	
	[Bindable]
	public var stateDataProvider:ArrayCollection = null;

	[Bindable]
	public var countryDataProvider:ArrayCollection = null;
    
    private var originalAddress:Address = null;
	
	private function init():void {
		cityDataService.getAll("City");
		stateDataService.getAll("State");
		countryDataService.getAll("Country");
		zipDataService.getAll("Zip");
		
	
	}      
		
 	private function itemExists(list:ArrayCollection, item:Object):Boolean {
		var i:int;
		
		for (i=0; i<list.length; i++) {
			if (list.getItemAt(i).name == item.name) {
				return true;
			}
		}
		return false;
	}

	private function handleLoadCity(ev:ResultEvent):void {
		var	selectedItem = citycombo.selectedItem;
	 	cityDataProvider = ev.result as ArrayCollection;
		if (selectedItem != null){
	 		citycombo.selectedIndex = findItem (selectedItem,cityDataProvider);
	 	}
	 	else 
	 		citycombo.selectedIndex = findItem(this.address.city.name, cityDataProvider);
	}   
	
	private function handleLoadState(ev:ResultEvent):void {
		var selectedItem = statecombo.selectedItem;
		stateDataProvider = ev.result as ArrayCollection;
	 	if (selectedItem != null){
	 		statecombo.selectedIndex = findItem (selectedItem,stateDataProvider);
	 	}
	 	else
	 		statecombo.selectedIndex = findItem(this.address.state.name, stateDataProvider);
	}
	
	private function handleLoadCountry(ev:ResultEvent):void {
		var selectedItem = countrycombo.selectedItem;
		countryDataProvider = ev.result as ArrayCollection;
	 	if (selectedItem != null){
	 		countrycombo.selectedIndex = findItem (selectedItem,countryDataProvider);
	 	}
	 	else
	 		countrycombo.selectedIndex = findItem(this.address.country.name, countryDataProvider);
	}   
	
	private function handleLoadZip(ev:ResultEvent):void {
		var selectedItem = zipcombo.selectedItem;
		zipDataProvider = ev.result as ArrayCollection;
	 	if (selectedItem != null){
	 		zipcombo.selectedIndex = findItem (selectedItem,zipDataProvider);
	 	}
	 	else
	 		zipcombo.selectedIndex = findItem(this.address.zip.name, zipDataProvider);
	}                                 

	private function handleSaveCityResult(ev:ResultEvent):void {
		cityDataService.getAll("City");
	}      
	
	private function handleSaveStateResult(ev:ResultEvent):void {
		stateDataService.getAll("State");
	}      

	private function handleSaveCountryResult(ev:ResultEvent):void {
		countryDataService.getAll("Country");
	}      

	private function handleSaveZipResult(ev:ResultEvent):void {
		zipDataService.getAll("Zip");
	}   
	
	private function handleFault(ev:FaultEvent):void {  
		var message:String;
		              
		message = "Error: "                          
		+ ev.fault.faultCode + " - "                                  
		+ ev.fault.faultDetail + " - "                                  
		+ ev.fault.faultString;
		Alert.show(message, "Error", 0);                                 
	}
	
 	private function findItem(name:String, array:ArrayCollection):int {
		for each(var element:Object in array) {
			if (name == element.name) {
				return array.getItemIndex(element);
			}
		}
		return -1;
	}
   
	public function setAddress(addr:Address):void {
		this.address = addr;
		originalAddress = addr;
		
	}
	
	public function getAddress():Address {
		return this.address;
	}
	
	private function focusOutCity(): void{                             
		var city:City;
		var result:Boolean;
		
			if (citycombo.typedText != null && citycombo.typedText != "" && citycombo.selectedIndex == -1) {
				var item:int = findItem(citycombo.typedText, cityDataProvider);
				if (item == -1) {
					city = new City();
					city.name = citycombo.text;
					address.city = city;
					cityDataService.addUpdate(city);
					}
				else {
					citycombo.selectedItem = item;
					
				}
			
			}
			address.city = citycombo.selectedItem as City;
	}

	private function focusOutState(): void{                             
		var state:com.efi.vo.State;
		var result:Boolean;
		
		if (statecombo.typedText != null && statecombo.typedText != "" && statecombo.selectedIndex == -1) {
			var item:int = findItem(statecombo.typedText, stateDataProvider);
			if (item == -1) {
				state = new com.efi.vo.State();
				state.name = statecombo.text;
				address.state = state;
				stateDataService.addUpdate(state);
			}
			else {
				statecombo.selectedItem = item;
				
			}
			
		}
		address.state = statecombo.selectedItem as com.efi.vo.State;
	}

	private function focusOutZip(): void{                             
		var zip:Zip;
		var result:Boolean;
		
		if (zipcombo.typedText != null && zipcombo.typedText != "" && zipcombo.selectedIndex == -1) {
			var item:int = findItem(zipcombo.typedText, zipDataProvider);
			if (item == -1) {
				zip = new Zip();
				zip.name = zipcombo.text;
				address.zip = zip;
				zipDataService.addUpdate(zip);
			}
			else {
				zipcombo.selectedItem = item;
				
			}
		}
		address.zip = zipcombo.selectedItem as Zip;
		
	}

	private function focusOutCountry(): void{                             
		var country:Country;
		var result:Boolean;
		
		if (countrycombo.typedText != null && countrycombo.typedText != "" && countrycombo.selectedIndex == -1) {
			var item:int = findItem(countrycombo.typedText, countryDataProvider);
			if (item == -1) {
				country = new Country();
				country.name = countrycombo.text;
				address.country = country;
				countryDataService.addUpdate(country);
			}
			else {
				countrycombo.selectedItem = item;
				
			}
		}
		address.country = countrycombo.selectedItem as Country;
	}

	private function doCancel():void {
		PopUpManager.removePopUp(this);
	}
	
	private function doOK():void {
		address.name = company_edit.text;
		address.street1 = street1_edit.text;
		address.street2 = street2_edit.text;
		address.city = citycombo.selectedItem as City;
		address.state = statecombo.selectedItem as State;
		address.zip = zipcombo.selectedItem as Zip;
		address.country = countrycombo.selectedItem as Country;
		
		var eventObj:SaveAddressEvent = new SaveAddressEvent("SaveAddressEvent", address);
		dispatchEvent(eventObj);
		PopUpManager.removePopUp(this);
	}

	]]>
</mx:Script>
    
</mx:TitleWindow>
