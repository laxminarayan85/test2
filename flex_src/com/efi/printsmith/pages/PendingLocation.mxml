<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" width="412" height="504"
	layout="vertical" showCloseButton="true" creationComplete="{init()}" close="{closeWindow()}"
    title="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'jobCmd.Location')}"
    paddingBottom="5" paddingLeft="5" paddingRight="5" paddingTop="5"
    xmlns:fc="http://www.adobe.com/2006/fc">
    
    <mx:Script>
    	<![CDATA[
    		import com.efi.printsmith.data.ProductionLocations;
    		import mx.collections.ArrayCollection;
    		import mx.utils.StringUtil;
    		import mx.controls.Alert;
    		import mx.rpc.events.FaultEvent;
    		import mx.rpc.events.ResultEvent;
    		import com.efi.printsmith.data.JobBase;
    		import com.efi.printsmith.data.InvoiceBase;
    		import mx.managers.PopUpManager;
    		
    		[Bindable] private var _invoiceBase:InvoiceBase;
    		
    		[Bindable] private var location:String = "";
    		
    		[Bindable] private var jobsList:ArrayCollection = new ArrayCollection();
    		
    		[Bindable] private var productionLocationsList:ArrayCollection = new ArrayCollection();
    		
    		private function init():void {
    			PopUpManager.centerPopUp(this);
    		}
    		
    		private function closeWindow():void {
    			PopUpManager.removePopUp(this);
    		}
    		
    		public function get invoiceBase():InvoiceBase {
				return _invoiceBase;	
			}
			
			public function set invoiceBase(tmpInvoiceBase:InvoiceBase):void {
				_invoiceBase = tmpInvoiceBase;
				dataService.getAll("ProductionLocations");
			}
			
			private function handleLoadResult(event:ResultEvent):void {
				_invoiceBase = event.result as InvoiceBase;
				getDocumentLocation();
				jobsList = new ArrayCollection();
				if(_invoiceBase.jobs!=null) {
					jobsList = _invoiceBase.jobs;
				}
				var jobBase:JobBase = new JobBase();
				jobBase.id=0;
				jobBase.description = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'posDoneCmd.SelectJob');
				jobsList.addItemAt(jobBase,0);
				if(jobsList.length>1){
					job_combo.selectedIndex = 1;
					var jobBaseObj:JobBase = jobsList.getItemAt(1) as JobBase;
					if(jobBaseObj.location!=null){
						job_location.selectedIndex = findItem(jobBaseObj.location.id,productionLocationsList);
					}
				}
			}
			
			private function handleLoadLocationsResult(event:ResultEvent):void {
				var arrayList:ArrayCollection = event.result as ArrayCollection;
				productionLocationsList = new ArrayCollection();
				if(arrayList!=null){
					productionLocationsList = arrayList;
				}
				dataService.getInvoice(_invoiceBase.id);
			}
			
			private function findItem(id:int, array:ArrayCollection):int
			{
				for each (var element:Object in array)
				{
					if (id == element.id)
					{
						return array.getItemIndex(element);
					}
				}
				return -1;
			}
			
			private function handleFault(ev:FaultEvent):void {  
				var errorDetail:String="";
				if (ev.fault!=null && ev.fault.faultCode=="InvalidSecurityAccess"){
					errorDetail = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, ev.fault.faultDetail);
					Alert.show(errorDetail,ev.fault.faultCode, Alert.OK, null, null, null, Alert.OK);
				}else{
					var message:String;
					              
					message = "Error: "                          
					+ ev.fault.faultCode + " - "                                  
					+ ev.fault.faultDetail + " - "                                  
					+ ev.fault.faultString;
					Alert.show(message, "Error", 0, null, null, null,4);                                 
				}
			}
			
			private function getDocumentLocation():void {
				if(_invoiceBase.jobs!=null && _invoiceBase.jobs.length>0){
					for each(var job:JobBase in  _invoiceBase.jobs){
						if(job.location!=null){
							location = job.location.name;
							doc_location.selectedIndex = findItem(job.location.id,productionLocationsList);
						}
						break;
					}
				}
			}
			
			private function getJobsSize(invoiceBaseObj:InvoiceBase):String {
				var jobSize:int=0;
				if(invoiceBaseObj!=null){
					if(invoiceBaseObj.jobs!=null){
						jobSize = invoiceBaseObj.jobs.length;
					}
				}
				return StringUtil.substitute(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'posDoneCmd.Jobs0'),jobSize);
			}
			
			private function jobLabelFunc(item:Object):String {
				if(item!=null){
					if(item.id==0){
						return item.description;
					} else {
						if(item.location==null){
							return item.description;
						} else {
							return item.description+" @ "+item.location.name;
						}
					}
				}
				return "";
			}
			
			private function setJobLocation(event:Event):void {
				var jobBaseObj:JobBase = event.currentTarget.selectedItem as JobBase; 
				if(jobBaseObj.location!=null){
					job_location.selectedIndex = findItem(jobBaseObj.location.id,productionLocationsList);
				}
			}
    	]]>
    </mx:Script>

	<mx:RemoteObject id="dataService" destination="dataService" showBusyCursor="true">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadLocationsResult(event)"/>
		<mx:method name="getInvoice" fault="handleFault(event)" result="handleLoadResult(event)"/>
	</mx:RemoteObject>

	<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'rStandardMenuText.Invoice')}: {_invoiceBase.invoiceNumber} {_invoiceBase.name}"/>
	
	<mx:Label text="(#{_invoiceBase.account.accountId}) {_invoiceBase.account.title}"/>
	
	<mx:HBox width="100%" horizontalAlign="right">
		<mx:Label text="{getJobsSize(_invoiceBase)}:" width="30%" textAlign="right"/>
		<mx:ComboBox id="job_combo" dataProvider="{jobsList}" labelFunction="jobLabelFunc" width="60%"
			change="{setJobLocation(event)}"/>
	</mx:HBox>
	
	<mx:HRule width="100%"/>
	
	<mx:HBox width="100%" horizontalAlign="right">
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'posDoneCmd.DocumentLocation')}:" width="30%" textAlign="right"/>
		<fc:AutoComplete id="doc_location" dataProvider="{productionLocationsList}" labelField="name" enabled="false" width="60%"/>
	</mx:HBox>
	
	<mx:HBox width="100%" horizontalAlign="right">
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'posDoneCmd.JobLocation')}:" width="30%" textAlign="right"/>
		<fc:AutoComplete id="job_location" dataProvider="{productionLocationsList}" labelField="name" width="60%"/>
	</mx:HBox>
                            
</mx:TitleWindow>