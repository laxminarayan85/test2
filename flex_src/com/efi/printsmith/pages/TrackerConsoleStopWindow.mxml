<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" layout="vertical" width="625" height="800"
	creationComplete="{initDetailsWindow()}" showCloseButton="true" close="{cancel()}" xmlns:components="com.efi.printsmith.common.components.*">
	
	<mx:Script source="../common/scripts/ComponentHelper.as"/>
	
	<mx:Script>
		<![CDATA[
			import mx.collections.ArrayCollection;
			import com.efi.printsmith.events.TrackerConsoleStopEvent;
			import com.efi.printsmith.data.TrackerConsolePasses;
			import mx.managers.PopUpManager;
			import com.efi.printsmith.data.JobBase;
			import com.efi.printsmith.data.Charge;
			import com.efi.printsmith.data.Job;
			import com.efi.printsmith.data.TrackerConsoleJobs;
			
			[Bindable] public var trackerConsoleJobs:TrackerConsoleJobs;
			
			[Bindable] public var nowDate:Date = new Date();
			
			[Bindable] public var exceptionsArray:ArrayCollection = new ArrayCollection();
			
			private function initDetailsWindow():void {
				PopUpManager.centerPopUp(this);
			}
			
			private function cancel():void {
				cancelStopJob();
			}
			
			private function closeWindow():void {
				PopUpManager.removePopUp(this);
			}
			
			private function getInvoiceNumber(object:Object):String {
				if(object is TrackerConsoleJobs){
					if(object.job!=null){
						object = object.job;
					} else {
						object = object.charge;
					}
				} 
				if(object is Job){
					var job:Job = object as Job;
					return String(job.parentInvoice.invoiceNumber);	
				}
				if(object is Charge){
					var charge:Charge = object as Charge;
					if(charge.parentInvoice!=null){
						return String(charge.parentInvoice.invoiceNumber);
					}
					if(charge.parentJob!=null){
						return String(charge.parentJob.jobNumber)+" / "+charge.parentJob.parentInvoice.invoiceNumber;
					}
				}
				return "";
			}
			
			private function getAccount(object:Object):String{
				if(object is TrackerConsoleJobs){
					if(object.job!=null){
						object = object.job;
					} else {
						object = object.charge;
					}
				} 
				if(object is Job){
					var job:Job = object as Job;
					return "#"+job.parentInvoice.account.id + " "+job.parentInvoice.account.title;	
				}
				if(object is Charge){
					var charge:Charge = object as Charge;
					if(charge.parentInvoice!=null){
						return "#"+charge.parentInvoice.account.id + " "+charge.parentInvoice.account.title;
					}
					if(charge.parentJob!=null){
						var jobBase:JobBase = charge.parentJob as JobBase;
						return "#"+jobBase.parentInvoice.account.id + " "+jobBase.parentInvoice.account.title;
					}
				}
				return "";
			}
			
			private function getDescription(object:Object):String{
				if(object is TrackerConsoleJobs){
					if(object.job!=null){
						object = object.job;
					} else {
						object = object.charge;
					}
				} 
				if(object is Job){
					var job:Job = object as Job;
					return job.description;	
				}
				if(object is Charge){
					var charge:Charge = object as Charge;
					return charge.description;
				}
				return "";
			}
			
			private function getStatus(object:TrackerConsoleJobs):String{
				if(object!=null){
					if(object.paused){
						return resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowCmd.Paused');	
					} 
					return resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowCmd.Active');
				}
				return "";
			}
			
			private function getTotalTime(object:TrackerConsoleJobs):String {
				var totalTime:Number = 0;
				for each(var trackerConsolePasses:TrackerConsolePasses in object.passesList){
					if(!(isNaN(trackerConsolePasses.setUpTime)) && trackerConsolePasses.setUpTime!=0){
						totalTime = totalTime + trackerConsolePasses.setUpTime;
					}
					if(!(isNaN(trackerConsolePasses.runTime)) && trackerConsolePasses.runTime!=0){
						totalTime = totalTime + trackerConsolePasses.runTime;
					}
					if(!(isNaN(trackerConsolePasses.setUpTime)) && trackerConsolePasses.setUpTime!=0){
						totalTime = totalTime + trackerConsolePasses.washUpTime;
					}
				}
				return convertMilliSecondsToString(totalTime,true);
			}
			
			private function getTotalSetUpTime(object:TrackerConsoleJobs):String {
				var totalSetUpTime:Number = 0;
				for each(var trackerConsolePasses:TrackerConsolePasses in object.passesList){
					if(!(isNaN(trackerConsolePasses.setUpTime)) && trackerConsolePasses.setUpTime!=0){
						totalSetUpTime = totalSetUpTime + trackerConsolePasses.setUpTime;
					}
				}
				return convertMilliSecondsToString(totalSetUpTime,true);
			}
			
			private function getTotalRunTime(object:TrackerConsoleJobs):String {
				var totalRunTime:Number = 0;
				for each(var trackerConsolePasses:TrackerConsolePasses in object.passesList){
					if(!(isNaN(trackerConsolePasses.runTime)) && trackerConsolePasses.runTime!=0){
						totalRunTime = totalRunTime + trackerConsolePasses.runTime;
					}
				}
				return convertMilliSecondsToString(totalRunTime,true);
			}
			
			private function getTotalWashUpTime(object:TrackerConsoleJobs):String {
				var totalWashUpTime:Number = 0;
				for each(var trackerConsolePasses:TrackerConsolePasses in object.passesList){
					if(!(isNaN(trackerConsolePasses.washUpTime)) && trackerConsolePasses.washUpTime!=0){
						totalWashUpTime = totalWashUpTime + trackerConsolePasses.washUpTime;
					}
				}
				return convertMilliSecondsToString(totalWashUpTime,true);
			}
			
			private function getOrderedQty(object:TrackerConsoleJobs):String {
				var ordered:String = "0";
				if(object.job!=null){
					if(isNaN(object.job.qtyOrdered)){
						ordered = "0";
					} 
					ordered = object.job.qtyOrdered.toString();
				} else if(object.charge!=null){
					if(isNaN(object.charge.quantity)){
						ordered = "0";
					} 
					ordered = object.charge.quantity.toString();
				}
				return ordered;
			}
			
			private function convertMilliSecondsToString(milliSeconds:Number, showSeconds:Boolean):String {
				var txtString:String = "";
				if(showSeconds){
					if(milliSeconds<60000){
						txtString = txtString + numFormatter.format(milliSeconds/1000)+" Second(s)";
					}
				}
				if(milliSeconds>=60000 && milliSeconds<60000*60){
			    	txtString = "0 Hrs ";
			    	txtString = txtString + numFormatter.format(milliSeconds/60000);
			    	if(showSeconds){
			    		txtString = txtString + ":" + numFormatter.format((milliSeconds%60000)/(1000));
			    	}
			    }
			    if(milliSeconds>=60000*60 && milliSeconds<60000*60*24){
			    	txtString = numFormatter.format(milliSeconds/(60000*60))+" Hrs ";
			    	txtString = txtString + numFormatter.format(milliSeconds%(60000*60)/(60000));
			    	if(showSeconds){
			    		txtString = txtString + ":" + numFormatter.format(milliSeconds%60000/1000);
			    	}
			    }
			    if(milliSeconds>=60000*60*24){
			    	txtString = numFormatter.format( milliSeconds/(60000*60*24))+" Day(s) ";
			    	txtString = txtString+numFormatter.format(milliSeconds%(60000*60*24)/(60000*60))+" Hrs ";
			    	txtString = txtString+numFormatter.format(milliSeconds%(60000*60)/(60000));
			    	if(showSeconds){
			    		txtString = txtString+":"+numFormatter.format(milliSeconds%60000/1000);
			    	}
			    }
			    if(txtString==""){
			    	txtString = "0:00";
			    }
			    return txtString;
			}
			
			private function getCurrentPassString(object:TrackerConsoleJobs):String {
				if(object!=null){
					if(object.noOfPasses>1){
						return resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowDetailsCmd.CurrentPass');
					}
				}
				return resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowDetailsCmd.Actuals');
			}
			
			private function stopJob():void {
				var trackerConsoleStopEvent:TrackerConsoleStopEvent = new TrackerConsoleStopEvent(TrackerConsoleStopEvent.STOP_JOB_EVENT,true,trackerConsoleJobs);
				dispatchEvent(trackerConsoleStopEvent);
				callLater(closeWindow);
			}
			
			private function cancelStopJob():void {
				var trackerConsoleStopEvent:TrackerConsoleStopEvent = new TrackerConsoleStopEvent(TrackerConsoleStopEvent.STOP_JOB_EVENT,false,trackerConsoleJobs);
				dispatchEvent(trackerConsoleStopEvent);
				callLater(closeWindow);
			}
		]]>
	</mx:Script>
	
	<mx:NumberFormatter id="numFormatter" precision="0" rounding="none"/>
	
	<mx:HBox width="100%">
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowDetailsCmd.Item')}"
			width="25%" textAlign="right"/>
		<mx:TextInput text="{getInvoiceNumber(trackerConsoleJobs)}" width="72%" enabled="false"/>
	</mx:HBox>
	<!--<mx:HBox width="100%">
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowCmd.Account')}"
			width="25%" textAlign="right"/>
		<mx:TextInput text="{getAccount(trackerConsoleJobs)}" width="72%" enabled="false"/>
	</mx:HBox>-->
	<mx:HBox width="100%">
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowDetailsCmd.Description')}"
			width="25%" textAlign="right"/>
		<mx:TextInput text="{getDescription(trackerConsoleJobs)}" width="72%" enabled="false"/>
	</mx:HBox>
	<mx:HBox width="100%">
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowDetailsCmd.Facility')}"
			width="25%" textAlign="right"/>
		<mx:TextInput text="{trackerConsoleJobs.productionFacilities.name}" width="72%" enabled="false"/>
	</mx:HBox>
	<mx:HBox width="100%">
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowDetailsCmd.Station')}"
			width="25%" textAlign="right"/>
		<mx:TextInput text="{trackerConsoleJobs.productionStations.name}" width="72%" enabled="false"/>
	</mx:HBox>
	<!--<mx:HBox width="100%">
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowDetailsCmd.Status')}"
			width="25%" textAlign="right"/>
		<mx:TextInput text="{getStatus(trackerConsoleJobs)}" width="72%" enabled="false"/>
	</mx:HBox>-->
	
	<mx:HBox width="100%">
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowDetailsCmd.Employee')}"
			width="25%" textAlign="right"/>
		<mx:TextInput text="{trackerConsoleJobs.employee.lastName}, {trackerConsoleJobs.employee.firstName}" width="72%" enabled="false"/>
	</mx:HBox>
	<mx:HBox width="100%">
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowDetailsCmd.Location')}"
			width="25%" textAlign="right"/>
		<mx:TextInput text="{trackerConsoleJobs.productionLocations.name}" width="33%" enabled="false"/>
		<components:CustomCheckBoxComponent width="39%" 
			label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowStopCmd.Markstepcompleteinro')}"
			dataHolder="{trackerConsoleJobs}" variableName="markStepComplete" customText="{trackerConsoleJobs.markStepComplete}"
			selectedValue="true" deSelectedValue="false" defaultValue="false"/>
	</mx:HBox>
	<mx:HBox width="100%">
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowStopCmd.NextLocation')}"
			width="25%" textAlign="right"/>
		<mx:TextInput width="33%" enabled="false"/>
		<components:CustomCheckBoxComponent width="39%" 
			label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowStopCmd.MovetothisNonProduct')}"
			dataHolder="{trackerConsoleJobs}" variableName="moveToNonProdStep" customText="{trackerConsoleJobs.moveToNonProdStep}"
			selectedValue="true" deSelectedValue="false" defaultValue="false"/>
	</mx:HBox>
	<mx:HBox width="100%">
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowDetailsCmd.Exceptioncode')}"
			width="25%" textAlign="right"/>
		<components:CustomComboBoxComponent
			masterList="{exceptionsArray}" updateObject="true" objectLabelFieldId="id" labelFieldId="id" labelFieldName="name"
			dataHolder="{trackerConsoleJobs}" variableName="productionExceptions" customText="{getCustomTextData(exceptionsArray,trackerConsoleJobs,trackerConsoleJobs.productionExceptions)}"/>
	</mx:HBox>
	
	<components:CustomCheckBoxComponent label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowMgrCmd.TreatasNonProduction')}"
		dataHolder="{trackerConsoleJobs}" variableName="treatAsNonProdStep" customText="{trackerConsoleJobs.treatAsNonProdStep}"
		selectedValue="true" deSelectedValue="false" defaultValue="false"/>
		
	<mx:HBox width="100%">
		<mx:Spacer width="25%"/>
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowDetailsCmd.Estimated')}" 
			fontWeight="bold" width="25%" textAlign="center"/>
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowDetailsCmd.Actuals')}" fontWeight="bold" width="25%" textAlign="center"/>
	</mx:HBox>
	<mx:HBox width="100%">
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowDetailsCmd.Totaltime')}:"
			width="25%" textAlign="right"/>
		<mx:TextInput text="{convertMilliSecondsToString((trackerConsoleJobs.actualSetUpTime+trackerConsoleJobs.actualRunTime+trackerConsoleJobs.actualWashTime),true)}" 
			width="25%" enabled="false"/>
		<mx:TextInput text="{getTotalTime(trackerConsoleJobs)}" width="25%" enabled="false"/>
	</mx:HBox>
	<mx:HBox width="100%">
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowDetailsCmd.Setup')}:"
			width="25%" textAlign="right"/>
		<mx:TextInput text="{convertMilliSecondsToString(trackerConsoleJobs.actualSetUpTime,true)}" 
			width="25%" enabled="false"/>
		<mx:TextInput text="{getTotalSetUpTime(trackerConsoleJobs)}" width="25%" enabled="false"/>
	</mx:HBox>
	<mx:HBox width="100%">
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowDetailsCmd.Runtime')}:"
			width="25%" textAlign="right"/>
		<mx:TextInput text="{convertMilliSecondsToString(trackerConsoleJobs.actualRunTime,true)}" 
			width="25%" enabled="false"/>
		<mx:TextInput text="{getTotalRunTime(trackerConsoleJobs)}" width="25%" enabled="false"/>
	</mx:HBox>
	<mx:HBox width="100%">
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowDetailsCmd.Washup')}:"
			width="25%" textAlign="right"/>
		<mx:TextInput text="{convertMilliSecondsToString(trackerConsoleJobs.actualWashTime,true)}" 
			width="25%" enabled="false"/>
		<mx:TextInput text="{getTotalWashUpTime(trackerConsoleJobs)}" width="25%" enabled="false"/>
	</mx:HBox>
	
	<mx:HBox width="100%">
		<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowStopCmd.Ordered')}:"
			width="25%" textAlign="right"/>
		<mx:TextInput text="{getOrderedQty(trackerConsoleJobs)}" width="25%" enabled="false"/>
		<mx:TextInput text="{getOrderedQty(trackerConsoleJobs)}" width="25%" enabled="false"/>
	</mx:HBox>
	
	<mx:HRule width="100%"/>
	
	<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowStopCmd.Notes')}"/>
	
	<components:CustomTextAreaComponent width="100%" height="25%"
		dataHolder="{trackerConsoleJobs}" customText="{trackerConsoleJobs.notes}" variableName="notes"/>
		
	<components:CustomCheckBoxComponent label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowStopCmd.Appendnotestojobtick')}"
		dataHolder="{trackerConsoleJobs}" variableName="appendNotesToJobTicketNotes" customText="{trackerConsoleJobs.appendNotesToJobTicketNotes}"
		selectedValue="true" deSelectedValue="false" defaultValue="false"/>
	
	<mx:HBox width="100%" horizontalAlign="center">
		<mx:Button label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'rButtonLabel.OK')}" click="{stopJob()}"/>
		<mx:Button label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'rButtonLabel.Cancel')}" click="{cancelStopJob()}"/>
	</mx:HBox>
</mx:TitleWindow>
