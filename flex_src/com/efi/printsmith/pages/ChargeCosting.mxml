<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:vo="com.efi.vo.*"
width="386" height="466" defaultButton="{submitButton}"
showCloseButton="true" creationComplete="creationCompleteHandler();"
    close="PopUpManager.removePopUp(this);"
    title="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Costing')}" xmlns:text="flash.text.*" fontSize="9">

<mx:RemoteObject id="dataService" destination="dataService">
	<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveResult(event)"/>
</mx:RemoteObject>
<mx:Script>
                                   
<![CDATA[
	import mx.collections.ArrayCollection;
	import com.efi.printsmith.data.ChargeCost;
    import com.efi.printsmith.data.enums.ChargeCostMethod;
    import com.efi.printsmith.events.ChargeCostingEvent;
    import com.efi.printsmith.events.PriceListPickerSelectEvent;    
    import com.efi.printsmith.view.PriceListPicker;   
    import com.efi.printsmith.data.SpeedTable;
    import com.efi.printsmith.data.PriceList;                     
	import mx.managers.PopUpManager;                                 
	import mx.controls.Alert;                          
	import mx.containers.Canvas;                                
	import mx.rpc.events.ResultEvent;                                 
	import mx.rpc.events.FaultEvent;                          
	import mx.events.ValidationResultEvent;                          
	import mx.validators.Validator;       
	import mx.messaging.messages.AsyncMessage;
	import mx.messaging.messages.IMessage;
	                             
	[Bindable]                             
	private var message:String;                                   
	[Bindable]                             
	private var formIsValid:Boolean = false;                               
	[Bindable]                                     
	public var formIsEmpty:Boolean;    
	[Bindable]
	public var chargeCost:ChargeCost;
	[Bindable]
	private var createdString:String = "";
	[Bindable]
	private var modifiedString:String = "";                      
	[Bindable]
	public var totalCost:Number = 0;
	[Bindable]
	private var totalSetup:Number= 0;
		       
	[Bindable]
	// Holds a reference to the currently focussed control on the form.
 	private var focusedFormControl:DisplayObject;                           
           
	                      
	private function handleSaveResult(ev:ResultEvent):void {                              
	     clearFormHandler();
	     validateForm(ev);
	                                      
		// Reload the list.                      
		//parentApplication.listUsers.loaderService.getUsers();                             
		PopUpManager.removePopUp(this);
	}
                                     
	private function handleFault(ev:FaultEvent):void {                               
		message = "Error: " + ev.fault.faultCode + " \n "                                            
		+ "Detail: " + ev.fault.faultDetail + " \n "                              
		+ "Message: " + ev.fault.faultString;                                    
	}
	                     
	public function saveUser():void {   
		MaptoChargeCost()                    
		var chargeCostingEvent:ChargeCostingEvent=new ChargeCostingEvent(ChargeCostingEvent.CHARGECOSTINGOK, chargeCost);
		dispatchEvent(chargeCostingEvent);
		PopUpManager.removePopUp(this);

//		dataService.addUpdate(chargeCost);        
	}
    private function MaptoChargeCost():void{
    	chargeCost.costingMethod = costing_method_combo.selectedItem as String
    	chargeCost.fixedMaterials = parseFloat(fixed_materials_edit.text);
    	chargeCost.laborRate = parseFloat(labor_rate_edit.text);
    	chargeCost.piecesPerHour = parseFloat(pieces_per_hour_edit.text);
    //	chargeCost.rateTable
    	chargeCost.setupCost = parseFloat(setup_cost_edit.text);
    	chargeCost.setupMinutes = parseFloat(setup_minutes_edit.text);
  //  	chargeCost.speedTable
    	chargeCost.totalUnitCost= totalCost;
    	chargeCost.unitCost = parseFloat(unit_cost_edit.text);
    	chargeCost.unitMaterials = parseFloat(unit_materials_edit.text);
    }                              
    private function  calculateTotalUnit(event:Event):void{
    	textFocusOut(event)
    	totalCost = parseFloat(labor_rate_edit.text)/parseFloat(pieces_per_hour_edit.text);
    	totalCost = totalCost + parseFloat(fixed_materials_edit.text)+ parseFloat(unit_materials_edit.text);
    	totalSetup = ((parseInt(setup_minutes_edit.text)/60) * parseFloat(labor_rate_edit.text))
    	if (totalSetup >0)
    		total_cost_text.text = Snowmass.getCurrencyFormatter(false,2).format(totalCost)+ " + " + Snowmass.getCurrencyFormatter(false, 2).format(totalSetup)
    	else
    		total_cost_text.text = Snowmass.getCurrencyFormatter(false,2).format(totalCost);
    		
    	if(ChargeCostMethod.UnitCost != costing_method_combo.selectedItem as String)
    		setup_cost_edit.text ="";
    	
    	
    }
	private function creationCompleteHandler():void { 
		costing_method_combo.selectedItem = chargeCost.costingMethod as String;
		updateControlState();
		updateDates();
		calculateTotalUnit(null);
	}
	                                
	private function resetFocus():void {                           
	}
	     
	// Validate the form
	                                         
	public function validateForm(event:Event):void  {
		focusedFormControl = event.target as DisplayObject;
	    formIsValid = true;
	
	     // Check if form is empty          
	     formIsEmpty = (setup_cost_edit.text == "" && unit_cost_edit.text == "" && fixed_materials_edit.text == "" && 
	     		unit_materials_edit.text == "" && labor_rate_edit.text == "" && setup_minutes_edit.text == "" && 
	     		pieces_per_hour_edit.text == "");
	     
	     validate(setupCostValidator);   
	     if ( unit_cost_edit.text != resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'pressDefCmd.variable') )         
	 	    validate(unitCostValidator);      
	     validate(fixedMaterialsValidator);                 
	     validate(unitMaterialsValidator);      
	     validate(laborRateValidator);                 
	     validate(setupMinutesValidator);   
	     if (pieces_per_hour_edit.text != resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'pressDefCmd.variable'))  
	    	 validate(piecesPerHourValidator);                 
	}
	    
	public function textFocusOut(event:Event):void {
		if (event != null) {
			focusedFormControl = event.currentTarget as DisplayObject;    
			
			if (focusedFormControl == pieces_per_hour_edit) {
			    if (isNaN(parseFloat((focusedFormControl as TextInput).text))) {
			     	(focusedFormControl as TextInput).text = ".001";
			  	}
			} else {
			    if (focusedFormControl is TextInput) {
			     	if (isNaN(parseFloat((focusedFormControl as TextInput).text))) {
			     		(focusedFormControl as TextInput).text = "0";
			     	}
			    }
			}
		}
	}
	
	private function validate(validator:Validator):Boolean {		   
		var validatorSource:DisplayObject = validator.source as DisplayObject;  
		var suppressEvents:Boolean = (validatorSource != focusedFormControl);  
		var event:ValidationResultEvent = validator.validate(null, suppressEvents); 
		                                               
		var currentControlIsValid:Boolean = (event.type ==
		ValidationResultEvent.VALID);
		                                         
		formIsValid = formIsValid && currentControlIsValid;
		updateControlState();                              
		return currentControlIsValid;	                                         
	}
	
	private function updateControlState():void{
		var temp:String	
		temp = costing_method_combo.selectedItem as String;
		switch (temp) {
			
			case ChargeCostMethod.HundredPercent:
			case ChargeCostMethod.NoCost:
				setup_cost_edit.enabled = false;
				unit_cost_edit.enabled = false;
				fixed_materials_edit.enabled = false;
				unit_materials_edit.enabled = false;
				labor_rate_edit.enabled = false;
				setup_minutes_edit.enabled = false;
				pieces_per_hour_edit.enabled = false;
				speed_button.enabled = false;
				rate_button.enabled = false;
			
			break;
			
			case ChargeCostMethod.TimeAndMaterial:
				setup_cost_edit.enabled = false;
				unit_cost_edit.enabled = false;
				rate_button.enabled = false;
				fixed_materials_edit.enabled = true;
				unit_materials_edit.enabled = true;
				labor_rate_edit.enabled = true;
				setup_minutes_edit.enabled = true;
				pieces_per_hour_edit.enabled = true;
				speed_button.enabled = true;
			break;
			
			case ChargeCostMethod.UnitCost:
				setup_cost_edit.enabled = true;
				unit_cost_edit.enabled = true;
				fixed_materials_edit.enabled = false;
				unit_materials_edit.enabled = false;
				labor_rate_edit.enabled = false;
				setup_minutes_edit.enabled = false;
				pieces_per_hour_edit.enabled = false;
				speed_button.enabled = false;
				rate_button.enabled = true;
			break;
		}
	
	
	}  
	private function doPriceList():void {
	    var priceListPickerWindow:PriceListPicker = PriceListPicker(PopUpManager.createPopUp(this, PriceListPicker, true));
	    priceListPickerWindow.setStyle("borderAlpha", 0.9);
	    priceListPickerWindow.itemType = "PriceList";
	    priceListPickerWindow.addEventListener(PriceListPickerSelectEvent.CANCELSELECTPRICELIST, handlePriceListPickerCancel);
	    priceListPickerWindow.addEventListener(PriceListPickerSelectEvent.SELECTPRICELIST, handleSelectPriceList);
	     priceListPickerWindow.addEventListener(PriceListPickerSelectEvent.CLEARPRICELIST, handleClearPriceList);
	}
	 private function handleClearPriceList(evt:PriceListPickerSelectEvent):void {
		chargeCost.rateTable = null;
		rate_table_link.label = priceListLabel();
		unit_cost_edit.enabled = true;
		unit_cost_edit.text = Snowmass.getCurrencyFormatter(false,4).format(chargeCost.unitCost);
		
    }
    private function handleSelectPriceList(evt:PriceListPickerSelectEvent):void {
 		if (evt.priceList != null) {
			chargeCost.rateTable = evt.priceList as PriceList;
			rate_table_link.label = priceListLabel();	
			unit_cost_edit.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'pressDefCmd.variable')
			unit_cost_edit.enabled = false;
		} else {
			chargeCost.rateTable = null;
			Alert.show("Price List Picker returned a null price list", "Error");
		}     	
    }
    private function priceListLabel():String {
		if (chargeCost.rateTable != null) {
			if (chargeCost.rateTable.name != null) {
				return chargeCost.rateTable.name;
			} else {
				return "No Name";
			}
		} else {
			return "None";
		}
	}
	private function speedTableLabel():String {
		if (chargeCost.speedTable != null) {
			if (chargeCost.speedTable.name != null) {
				return chargeCost.speedTable.name;
			} else {
				return "No Name";
			}
		} else {
			return "None";
		}
	}
    private function handlePriceListPickerCancel(evt:PriceListPickerSelectEvent):void {
    	
    }
     private function doSpeedTable():void {
	    var priceListPickerWindow:PriceListPicker = PriceListPicker(PopUpManager.createPopUp(this, PriceListPicker, true));
	    priceListPickerWindow.setStyle("borderAlpha", 0.9);
		priceListPickerWindow.itemType = "SpeedTable";
	    priceListPickerWindow.addEventListener(PriceListPickerSelectEvent.CANCELSELECTPRICELIST, handlePriceListPickerCancel);
	    priceListPickerWindow.addEventListener(PriceListPickerSelectEvent.SELECTPRICELIST, handleSelectSpeedTable);
	    priceListPickerWindow.addEventListener(PriceListPickerSelectEvent.CLEARPRICELIST, handleClearSpeedTable);
	}
	 private function handleClearSpeedTable(evt:PriceListPickerSelectEvent):void {
		chargeCost.speedTable = null;
		
		pieces_per_hour_edit.enabled = true;
		pieces_per_hour_edit.text = Snowmass.getCurrencyFormatter(false,4).format(chargeCost.piecesPerHour);
		total_cost_text.enabled = true;
		total_cost_text.text = Snowmass.getCurrencyFormatter(false,4).format(chargeCost.totalUnitCost);
    }
    private function handleSelectSpeedTable(evt:PriceListPickerSelectEvent):void {
		if (evt.priceList != null) {
			chargeCost.speedTable = evt.priceList as SpeedTable;
			speed_table_link.label = speedTableLabel();
			pieces_per_hour_edit.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'pressDefCmd.variable')
			pieces_per_hour_edit.enabled = false;
			total_cost_text.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'pressDefCmd.variable')
			total_cost_text.enabled = false;
			
		} else {
			chargeCost.speedTable = null;
			Alert.show("speed table Picker returned a null price list", "Error");
			pieces_per_hour_edit.enabled = true;
			pieces_per_hour_edit.text = Snowmass.getCurrencyFormatter(false,4).format(chargeCost.piecesPerHour);
			total_cost_text.enabled = true;
			total_cost_text.text = Snowmass.getCurrencyFormatter(false,4).format(chargeCost.totalUnitCost);
		}  
    }                         
	private function clearFormHandler():void {
		// Clear all input fields.
		updateDates();
		setup_cost_edit.text = "";
		unit_cost_edit.text = "";
		fixed_materials_edit.text = "";
		unit_materials_edit.text = "";
		labor_rate_edit.text = "";
		setup_minutes_edit.text = "";
		pieces_per_hour_edit.text = "";
		
		formIsEmpty = true;                           
		formIsValid = false;                                
		resetFocus();                             
	}     
	
	private function updateDates():void {
		if (chargeCost != null) {
			createdString = Snowmass.getDateFormatter().format(chargeCost.created);
			modifiedString = Snowmass.getDateFormatter().format(chargeCost.modified);			
		} else {
			createdString = "";
			modifiedString = "";
		} 
	}      
]]>        
</mx:Script>
                             

                             
<mx:CurrencyValidator id="setupCostValidator" source="{setup_cost_edit}"  precision="4" required="false" property="text"/>
<mx:CurrencyValidator id="unitCostValidator" source="{unit_cost_edit}" precision="4" required="false" property="text"/>
<mx:CurrencyValidator id="fixedMaterialsValidator" source="{fixed_materials_edit}" required="false" property="text"/>
<mx:CurrencyValidator id="unitMaterialsValidator" source="{unit_materials_edit}" required="false" property="text"/>
<mx:CurrencyValidator id="laborRateValidator" source="{labor_rate_edit}" required="false" property="text"/>
<mx:NumberValidator id="setupMinutesValidator" source="{setup_minutes_edit}" required="false" property="text"/>
<mx:NumberValidator id="piecesPerHourValidator" source="{pieces_per_hour_edit}" required="false" precision="3" allowNegative="false" property="text"/>
	<mx:Canvas width="100%" height="100%">
		<mx:ComboBox x="144" y="12" width="186" dataProvider="{ChargeCostMethod.toArray()}" id="costing_method_combo" change="validateForm(event);" ></mx:ComboBox>
		<mx:Label x="10" y="15" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.CostingMethod')}" textAlign="right" width="126"/>
		<mx:Label x="10" y="40" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.SetupCost')}" textAlign="right" width="126"/>
		<mx:Label x="10" y="64" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.UnitCost')}" textAlign="right" width="126"/>
		<mx:TextInput x="144" y="38" width="186" id="setup_cost_edit" text="{Snowmass.getCurrencyFormatter(false,4).format(chargeCost.setupCost)}" change="validateForm(event);" focusOut="textFocusOut(event)" textAlign="right" height="20" />
		<mx:TextInput x="144" y="62" width="186" id="unit_cost_edit" text="{chargeCost.unitCost}" change="validateForm(event);" focusOut="textFocusOut(event)" textAlign="right" height="20" />
		<mx:Label x="10" y="149" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.FixedMaterials')}" textAlign="right" width="126"/>
		<mx:TextInput x="144" y="147" width="186" id="fixed_materials_edit" text="{Snowmass.getCurrencyFormatter(false,2).format(chargeCost.fixedMaterials)}" change="validateForm(event);"  textAlign="right" height="20" focusOut="calculateTotalUnit(event)"/>
		<mx:Label x="10" y="173" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.UnitMaterials')}" textAlign="right" width="126"/>
		<mx:TextInput x="144" y="171" width="186" id="unit_materials_edit" text="{Snowmass.getCurrencyFormatter(false,2).format(chargeCost.unitMaterials)}" change="validateForm(event);"  textAlign="right" height="20" focusOut="calculateTotalUnit(event)"/>
		<mx:Label x="10" y="197" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.LaborRate')}" textAlign="right" width="126"/>
		<mx:TextInput x="144" y="195" width="186" id="labor_rate_edit" text="{Snowmass.getCurrencyFormatter(false,2).format(chargeCost.laborRate)}" change="validateForm(event);"  textAlign="right" height="20" focusOut="calculateTotalUnit(event)"/>
		<mx:Label x="10" y="221" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.Setupminutes')}" textAlign="right" width="126"/>
		<mx:TextInput x="144" y="219" width="186" id="setup_minutes_edit" text="{chargeCost.setupMinutes}" change="validateForm(event);"  textAlign="right" height="20" focusOut="calculateTotalUnit(event)"/>
		<mx:Label x="10" y="245" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.PiecesHour')}" textAlign="right" width="126"/>
		<mx:TextInput x="144" y="243" width="186" id="pieces_per_hour_edit" text="{chargeCost.piecesPerHour}" change="validateForm(event);"  textAlign="right" height="20" focusOut="calculateTotalUnit(event)"/>
		<mx:Label x="10" y="267" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.Totalunitcost')}" textAlign="right" width="126"/>
		<mx:Button x="12" y="90" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.Rate')}" width="106" click="doPriceList();" id="rate_button" />
		<mx:LinkButton x="144" y="91" id="rate_table_link" width="186"/>
		<mx:Button x="12" y="291" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.Speed')}" width="93" click="doSpeedTable();" id="speed_button"/>
		<mx:LinkButton x="144" y="292" id="speed_table_link" width="186"/>
		<mx:HRule x="0" y="130" width="339" height="0"/>
		<mx:HRule x="0" y="130" width="339" height="9"/>
		<mx:HRule x="0" y="320" width="348" height="9"/>
		<mx:Text x="144" y="267" text="{totalCost}" width="186" id="total_cost_text" textAlign="right"/>
		<mx:Label x="10" y="337" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.Created')}" textAlign="right" width="126"/>
		<mx:Text x="144" y="337" text="{createdString}" width="186" id="createDate"/>
		<mx:Label x="10" y="357" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.LastChange')}" textAlign="right" width="126"/>
		<mx:Text x="144" y="357" text="{modifiedString}" width="186" id="lastChangeDate"/>
	</mx:Canvas>

<mx:ControlBar horizontalAlign="center">                                   
     <mx:Button label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Save')}" id="submitButton" enabled="{formIsValid}" click="saveUser();" />                                   
     <mx:Button label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Cancel')}" click="PopUpManager.removePopUp(this);"/> 
</mx:ControlBar>

</mx:TitleWindow>