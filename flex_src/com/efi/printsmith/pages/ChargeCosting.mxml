<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:vo="com.efi.vo.*"
width="386" height="466" defaultButton="{submitButton}"
showCloseButton="true" creationComplete="creationCompleteHandler();"
    close="PopUpManager.removePopUp(this);"
    title="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Costing')}" xmlns:text="flash.text.*" fontSize="9">

<mx:RemoteObject id="dataService" destination="dataService">
	<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveResult(event)"/>
</mx:RemoteObject>
<mx:Script>
                                   
<![CDATA[
	import mx.collections.ArrayCollection;
	import com.efi.printsmith.data.ChargeCost;
    import com.efi.printsmith.data.enums.ChargeCostMethod;
                                
	import mx.managers.PopUpManager;                                 
	import mx.controls.Alert;                          
	import mx.containers.Canvas;                                
	import mx.rpc.events.ResultEvent;                                 
	import mx.rpc.events.FaultEvent;                          
	import mx.events.ValidationResultEvent;                          
	import mx.validators.Validator;       
	import mx.messaging.messages.AsyncMessage;
	import mx.messaging.messages.IMessage;
	                             
	[Bindable]                             
	private var message:String;                                   
	[Bindable]                             
	private var formIsValid:Boolean = false;                               
	[Bindable]                                     
	public var formIsEmpty:Boolean;    
	[Bindable]
	public var chargeCost:ChargeCost;
	[Bindable]
	private var createdString:String = "";
	[Bindable]
	private var modifiedString:String = "";                      
	[Bindable]
	public var totalCost:Number = 0;
		       
	[Bindable]
	// Holds a reference to the currently focussed control on the form.
 	private var focusedFormControl:DisplayObject;                           
           
	                      
	private function handleSaveResult(ev:ResultEvent):void {                              
	     clearFormHandler();
	     validateForm(ev);
	                                      
		// Reload the list.                      
		//parentApplication.listUsers.loaderService.getUsers();                             
		PopUpManager.removePopUp(this);
	}
                                     
	private function handleFault(ev:FaultEvent):void {                               
		message = "Error: " + ev.fault.faultCode + " \n "                                            
		+ "Detail: " + ev.fault.faultDetail + " \n "                              
		+ "Message: " + ev.fault.faultString;                                    
	}
	                     
	public function saveUser():void {   
		MaptoChargeCost()                                 
		dataService.addUpdate(chargeCost);                                        
	}
    private function MaptoChargeCost():void{
    	chargeCost.costingMethod = costing_method_combo.selectedItem as String
    	chargeCost.created = createDate.text as Date;
    	chargeCost.fixedMaterials = parseFloat(fixed_materials_edit.text);
    	chargeCost.laborRate = parseFloat(labor_rate_edit.text);
    	chargeCost.piecesPerHour = parseFloat(pieces_per_hour_edit.text);
    //	chargeCost.rateTable
    	chargeCost.setupCost = parseFloat(setup_cost_edit.text);
    	chargeCost.setupMinutes = parseFloat(setup_minutes_edit.text);
  //  	chargeCost.speedTable
    	chargeCost.totalUnitCost= parseFloat(total_cost_text.text);
    	chargeCost.unitCost = parseFloat(unit_cost_edit.text);
    	chargeCost.unitMaterials = parseFloat(unit_materials_edit.text);
    	chargeCost.modified = lastChangeDate.text as Date;
    }                              
    private function  CalculateTotalUnit():void{
    	var tempCost:Number;
    	tempCost = parseFloat(labor_rate_edit.text)/parseFloat(pieces_per_hour_edit.text);
    	tempCost = tempCost +parseFloat(fixed_materials_edit.text)+ parseFloat(unit_cost_edit.text);
    	
    }
	private function creationCompleteHandler():void { 
		costing_method_combo.selectedItem = chargeCost.costingMethod as String;
		UpdateControlState();
		updateDates();
	}
	                                
	private function resetFocus():void {                           
	}
	     
	// Validate the form
	                                         
	public function validateForm(event:Event):void  {
	     focusedFormControl = event.target as DisplayObject;    
	     formIsValid = true;
	
	     // Check if form is empty          
	     formIsEmpty = (setup_cost_edit.text == "" && unit_cost_edit.text == "" && fixed_materials_edit.text == "" && 
	     		unit_materials_edit.text == "" && labor_rate_edit.text == "" && setup_minutes_edit.text == "" && 
	     		pieces_per_hour_edit.text == "");
	     
	     validate(setupCostValidator);                 
	     validate(unitCostValidator);      
	     validate(fixedMaterialsValidator);                 
	     validate(unitMaterialsValidator);      
	     validate(laborRateValidator);                 
	     validate(setupMinutesValidator);      
	     validate(piecesPerHourValidator);                 
	}
	    
	private function validate(validator:Validator):Boolean {		   
		var validatorSource:DisplayObject = validator.source as DisplayObject;  
		var suppressEvents:Boolean = (validatorSource != focusedFormControl);  
		var event:ValidationResultEvent = validator.validate(null, suppressEvents); 
		                                               
		var currentControlIsValid:Boolean = (event.type ==
		ValidationResultEvent.VALID);
		                                         
		formIsValid = formIsValid && currentControlIsValid;
		UpdateControlState();                              
		return currentControlIsValid;	                                         
	}
	
	private function UpdateControlState():void{
		var temp:String	
		temp = costing_method_combo.selectedItem as String;
		switch (temp) {
			
			case ChargeCostMethod.HUNDREDPERCENT:
			case ChargeCostMethod.NOCOST:
				setup_cost_edit.enabled = false;
				unit_cost_edit.enabled = false;
				fixed_materials_edit.enabled = false;
				unit_materials_edit.enabled = false;
				labor_rate_edit.enabled = false;
				setup_minutes_edit.enabled = false;
				pieces_per_hour_edit.enabled = false;
			
			break;
			
			case ChargeCostMethod.TIMEANDMATERIAL:
				setup_cost_edit.enabled = false;
				unit_cost_edit.enabled = false;
				fixed_materials_edit.enabled = true;
				unit_materials_edit.enabled = true;
				labor_rate_edit.enabled = true;
				setup_minutes_edit.enabled = true;
				pieces_per_hour_edit.enabled = true;
			break;
			
			case ChargeCostMethod.UNITCOST:
				setup_cost_edit.enabled = true;
				unit_cost_edit.enabled = true;
				fixed_materials_edit.enabled = false;
				unit_materials_edit.enabled = false;
				labor_rate_edit.enabled = false;
				setup_minutes_edit.enabled = false;
				pieces_per_hour_edit.enabled = false;
			break;
		}
	
	
	}                                
	private function clearFormHandler():void {
		// Clear all input fields.
		updateDates();
		setup_cost_edit.text = "";
		unit_cost_edit.text = "";
		fixed_materials_edit.text = "";
		unit_materials_edit.text = "";
		labor_rate_edit.text = "";
		setup_minutes_edit.text = "";
		pieces_per_hour_edit.text = "";
		
		formIsEmpty = true;                           
		formIsValid = false;                                
		resetFocus();                             
	}     
	
	private function updateDates():void {
		if (chargeCost != null) {
			createdString = Snowmass.getDateFormatter().format(chargeCost.created);
			modifiedString = Snowmass.getDateFormatter().format(chargeCost.modified);			
		} else {
			createdString = "";
			modifiedString = "";
		} 
	}      
]]>        
</mx:Script>
                             

                             
<mx:CurrencyValidator id="setupCostValidator" source="{setup_cost_edit}" property="text"/>
<mx:CurrencyValidator id="unitCostValidator" source="{unit_cost_edit}" property="text"/>
<mx:CurrencyValidator id="fixedMaterialsValidator" source="{fixed_materials_edit}" property="text"/>
<mx:CurrencyValidator id="unitMaterialsValidator" source="{unit_materials_edit}" property="text"/>
<mx:CurrencyValidator id="laborRateValidator" source="{labor_rate_edit}" property="text"/>
<mx:NumberValidator id="setupMinutesValidator" source="{setup_minutes_edit}" property="text"/>
<mx:NumberValidator id="piecesPerHourValidator" source="{pieces_per_hour_edit}" precision="0" allowNegative="false" property="text"/>
	<mx:Canvas width="100%" height="100%">
		<mx:ComboBox x="144" y="8" width="186" dataProvider="{ChargeCostMethod.toArray()}" id="costing_method_combo" change="validateForm(event);" ></mx:ComboBox>
		<mx:Label x="10" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.CostingMethod')}" textAlign="right" width="126"/>
		<mx:Label x="10" y="40" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.SetupCost')}" textAlign="right" width="126"/>
		<mx:Label x="10" y="64" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.UnitCost')}" textAlign="right" width="126"/>
		<mx:TextInput x="144" y="38" width="186" id="setup_cost_edit" text="{chargeCost.setupCost}" change="validateForm(event);"  textAlign="right" height="20" focusOut="CalculateTotalUnit()"/>
		<mx:TextInput x="144" y="62" width="186" id="unit_cost_edit" text="{chargeCost.unitCost}" change="validateForm(event);"  textAlign="right" height="20" focusOut="CalculateTotalUnit()"/>
		<mx:Label x="10" y="149" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.FixedMaterials')}" textAlign="right" width="126"/>
		<mx:TextInput x="144" y="147" width="186" id="fixed_materials_edit" text="{chargeCost.fixedMaterials}" change="validateForm(event);"  textAlign="right" height="20" focusOut="CalculateTotalUnit()"/>
		<mx:Label x="10" y="173" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.UnitMaterials')}" textAlign="right" width="126"/>
		<mx:TextInput x="144" y="171" width="186" id="unit_materials_edit" text="{chargeCost.unitMaterials}" change="validateForm(event);"  textAlign="right" height="20" focusOut="CalculateTotalUnit()"/>
		<mx:Label x="10" y="197" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.LaborRate')}" textAlign="right" width="126"/>
		<mx:TextInput x="144" y="195" width="186" id="labor_rate_edit" text="{chargeCost.laborRate}" change="validateForm(event);"  textAlign="right" height="20" focusOut="CalculateTotalUnit()"/>
		<mx:Label x="10" y="221" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.Setupminutes')}" textAlign="right" width="126"/>
		<mx:TextInput x="144" y="219" width="186" id="setup_minutes_edit" text="{chargeCost.setupMinutes}" change="validateForm(event);"  textAlign="right" height="20" focusOut="CalculateTotalUnit()"/>
		<mx:Label x="10" y="245" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.PiecesHour')}" textAlign="right" width="126"/>
		<mx:TextInput x="144" y="243" width="186" id="pieces_per_hour_edit" text="{chargeCost.piecesPerHour}" change="validateForm(event);"  textAlign="right" height="20" focusOut="CalculateTotalUnit()"/>
		<mx:Label x="10" y="267" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.Totalunitcost')}" textAlign="right" width="126"/>
		<mx:Button x="12" y="90" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.Rate')}" width="93"/>
		<mx:LinkButton x="144" y="91" id="rate_table_link" width="186"/>
		<mx:Button x="12" y="291" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.Speed')}" width="93"/>
		<mx:LinkButton x="144" y="292" id="speed_table_link" width="186"/>
		<mx:HRule x="0" y="130" width="339" height="0"/>
		<mx:HRule x="0" y="130" width="339" height="9"/>
		<mx:HRule x="0" y="320" width="348" height="9"/>
		<mx:Text x="144" y="267" text="{totalCost}" width="186" id="total_cost_text" textAlign="right"/>
		<mx:Label x="10" y="337" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.Created')}" textAlign="right" width="126"/>
		<mx:Text x="144" y="337" text="{createdString}" width="186" id="createDate"/>
		<mx:Label x="10" y="357" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCostCmd.LastChange')}" textAlign="right" width="126"/>
		<mx:Text x="144" y="357" text="{modifiedString}" width="186" id="lastChangeDate"/>
	</mx:Canvas>

<mx:ControlBar horizontalAlign="center">                                   
     <mx:Button label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Save')}" id="submitButton" enabled="{formIsValid}" click="saveUser();" />                                   
     <mx:Button label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Cancel')}" click="PopUpManager.removePopUp(this);"/> 
</mx:ControlBar>

</mx:TitleWindow>