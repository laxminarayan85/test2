<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute" width="504" height="798"
	 close="PopUpManager.removePopUp(this);" showCloseButton="true" creationComplete="init();"
	 xmlns:fc="http://www.adobe.com/2006/fc" xmlns:vo="com.efi.printsmith.data.*"  verticalScrollPolicy="auto"
	title="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'taxCmd.SalesTax')}" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'taxCmd.SalesTax')}" name="Sales Tax">
	
	
	<mx:RemoteObject id="dataService" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadResult(event)"/>
		<mx:method name="getTaxTable" fault="handleFault(event)" result="handleGetResult(event)"/>
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveResult(event)"/>
		
	</mx:RemoteObject>
	
	
<mx:Script>                                   
<![CDATA[
	import com.efi.printsmith.data.TaxElement;
	import com.efi.printsmith.data.TaxTable;
	import mx.controls.DateField;                               
	import mx.managers.PopUpManager;                                         
	import mx.containers.TitleWindow;                                         
	import mx.collections.ArrayCollection;                                         
	import mx.rpc.events.ResultEvent;                                         
	import mx.rpc.events.FaultEvent;
	import mx.rpc.*; 
	import mx.controls.Alert;  
	import mx.utils.StringUtil;                                       
	import mx.messaging.messages.AsyncMessage;
	import mx.messaging.messages.IMessage;
    import mx.printing.FlexPrintJob;
    import mx.printing.PrintAdvancedDataGrid;
    import mx.printing.PrintDataGrid;
    import mx.core.Application;
    [Bindable]                                
    private var taxTables:ArrayCollection = new ArrayCollection();   
     [Bindable]                                
    private var taxTable:TaxTable;
    [Bindable]                                
		private var taxElements:ArrayCollection = new ArrayCollection();   
	[Bindable]                                
		private var taxElement:TaxElement;
	[Bindable]
		private var defaultTable:Boolean = false;
		
	public function init():void{
		taxTable = new TaxTable();
		dataService.getAll("TaxTable");
	}
	

	
	private function handleFault(ev:FaultEvent):void {  
		var message:String;
		              
		message = "Error: "                          
		+ ev.fault.faultCode + " - "                                  
		+ ev.fault.faultDetail + " - "                                  
		+ ev.fault.faultString;
		Alert.show(message, "Error");                                 
	}
	private function handleLoadResult(ev:ResultEvent):void{
		taxTables = ev.result as ArrayCollection;
	}
	private function doshiptax(item:Object, column:DataGridColumn):String{
		var tmpItem:TaxElement ;
	//	tmpItem = item as TaxElement;
		if (taxTable.taxShipping )
			return("*");
		return ("");
	}
	private function doTaxName(item:Object, column:DataGridColumn):String{
		var tmpItem:TaxElement ;
		tmpItem = item as TaxElement;
		if (tmpItem.tax != null)
			return tmpItem.tax.name
		return " ";
	}
	private function doDefault(item:Object, column:DataGridColumn):String{
		var tmpItem:TaxTable ;
		tmpItem = item as TaxTable;
		if (tmpItem.defaultTable)
			return("*");
		return ("");
	}
	private function doSelectTaxTable():void{
		taxElements = new ArrayCollection();
		taxTable=tableGrid.selectedItem as TaxTable;
		dataService.getTaxTable(taxTable.id)
		taxElements = taxTable.taxElements;
		 
	}
	
	private function handleGetResult(ev:ResultEvent):void{
		taxTable = ev.result as TaxTable;
		taxElements = taxTable.taxElements;
	}
	private function handleSaveResult(ev:ResultEvent):void{
		taxTable = ev.result as TaxTable;
		if ( taxTable.taxTableIsCurrent == false)
			SaveNewTax();
	}
	private function SaveNewTax():void{
	 var tempTax:TaxTable = new TaxTable;
		tempTax.separateShipping = seperate_shipping_check.selected;
		tempTax.taxShipping = tax_shipping_check.selected;
		tempTax.taxInPrice = tax_inPrice_check.selected;
		tempTax.effectiveTaxRate = parseInt(effect_rate.text);
		tempTax.minAmount = parseFloat(min_edit.text);
		tempTax.abbr = Abbr_edit.text;
		tempTax.name = name_edit.text;
		tempTax.taxElements = taxElements;
		tempTax.taxTableIsCurrent= true;
		//tempTax.tableCreateDateTime = 
		tempTax.defaultTable = defaultTable
		tempTax.disableTable = false
		tempTax.roundTaxUp = round_tax_check.selected;
		tempTax.taxOnTax = tax_on_tax_check.selected;
		dataService.addUpdate(tempTax);
		
	}	
	private function updatetax():void{
		
	}	
	private function doSave():void{
		var tempRate:int;
		tempRate = parseFloat(effect_rate.text);
		if ( tempRate != taxTable.effectiveTaxRate){
			taxTable.taxTableIsCurrent = false;
			if (taxTable.defaultTable){
				defaultTable = true;
				taxTable.defaultTable = false;
			}
			dataService.addUpdate(taxTable);
			
			
		}else{
			
		taxTable.separateShipping = seperate_shipping_check.selected;
		taxTable.taxShipping = tax_shipping_check.selected;
		taxTable.taxInPrice = tax_inPrice_check.selected;
		taxTable.effectiveTaxRate = parseInt(effect_rate.text);
		taxTable.minAmount = parseFloat(min_edit.text);
		taxTable.abbr = Abbr_edit.text;
		taxTable.name = name_edit.text;
		taxTable.disableTable = disable_check.selected;
		taxTable.roundTaxUp = round_tax_check.selected;
		taxTable.taxOnTax = tax_on_tax_check.selected;
		
		if (taxElements != null)
			taxTable.taxElements = taxElements;
		dataService.addUpdate(taxTable);
		}
		
	}
	private function doNewTaxElement():void{
		taxElement = new TaxElement;
		taxElements.addItem(taxElement);
	}
	private function doRemoveTaxElement():void {
		var deleteItem:TaxElement = elementGrid.selectedItem as TaxElement;
		taxElements.removeItemAt(taxElements.getItemIndex(deleteItem)); 
	}
]]>
                             
</mx:Script>		
	<mx:Button  enabled="{taxTable.taxTableIsCurrent}" x="10" y="10" width="38" height="38"  id="save_button" icon="@Embed(source='../../../../assets/save.png')" click="doSave()"/>
	<mx:Button x="97" y="10" width="38" height="38" id="new_button" icon="@Embed(source='../../../../assets/new.png')"/>
	<mx:Button x="195" y="10" width="38" height="38"  id="revert_button" icon="@Embed(source='../../../../assets/revert.png')"/>
	<mx:Label x="10" y="56" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Save')}" width="49"/>
	<mx:Label x="100" y="56" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.New')}" width="35"/>
	<mx:Label x="195" y="56" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Revert')}" width="57"/>
	<mx:Label x="17" y="84" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'taxCmd.TaxTable')}" width="67"/>
	<mx:Label x="17" y="114" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'taxCmd.Abbreviation')}" width="67"/>
	<mx:TextInput x="92" y="82" id="name_edit" text="{taxTable.name}"/>
	<mx:TextInput x="92" y="112" id="Abbr_edit" text="{taxTable.abbr}"/>
	<mx:DataGrid x="17" y="140" width="450" height="273"  editable="true" dataProvider="{taxElements}"  id="elementGrid">
		<mx:columns>
			<mx:DataGridColumn editorDataField="selectedItem" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'taxCmd.Description')}" labelFunction="doTaxName"
			itemEditor="com.efi.printsmith.itemRenderers.TaxElementsEditor" editable="true" dataField="tax"  >
		</mx:DataGridColumn>
			<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'taxCmd.TaxRate')}" dataField="rate"/>
			<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'taxCmd.Ship')}"  labelFunction="doshiptax"/>
			<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'taxCmd.Show')}" dataField="showTax"/>
		</mx:columns>
	</mx:DataGrid>
	<mx:LinkButton x="411"
				   id="remove_pricelistelement_button"
				   click="doRemoveTaxElement()"
				   icon="@Embed(source='../../../../assets/delete16.png')"
				   width="24"
				   bottom="317"/>
	<mx:LinkButton x="443"
				   id="add_pricelistelement_button"
				   click="doNewTaxElement()"
				   icon="@Embed(source='../../../../assets/add16.png')"
				   width="24"
				   bottom="317"/>
	<mx:Label x="191" y="449" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'taxCmd.EffectiveTaxRate')}"/>
	<mx:Label id="min_edit" x="182" y="475" textAlign="right" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'taxCmd.MinimumTaxableAmount')}"/>
	<mx:CheckBox x="6" y="504" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'taxCmd.TaxShipping')}" selected="{taxTable.taxShipping}" id="tax_shipping_check"/>
	<mx:CheckBox x="151" y="504" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'taxCmd.SeparateShipping')}" selected="{taxTable.separateShipping}" id="seperate_shipping_check"/>
	<mx:CheckBox x="293" y="504" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'taxCmd.TaxonTax')}" selected="{taxTable.taxOnTax}" id="tax_on_tax_check"/>
	<mx:CheckBox x="151" y="534" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'taxCmd.Buildtaxinprice')}" selected="{taxTable.taxInPrice}" id="tax_inPrice_check"/>
	<mx:CheckBox x="6" y="534" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'pricePrefCmd.Roundtaxup')}" selected="{taxTable.roundTaxUp}" width="144" id="round_tax_check"/>
	<mx:Text x="315" y="449" id="effect_rate" text="{taxTable.effectiveTaxRate}"/>
	<mx:Text x="315" y="475" id="min_tax" text="{taxTable.minAmount}" width="116" height="21"/>
	<mx:DataGrid x="-1" y="564" width="286"  id="tableGrid" dataProvider="{taxTables}" itemClick="doSelectTaxTable()" height="141">
		<mx:columns>
			<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'taxCmd.Default')}" labelFunction="doDefault" width="50"/>
			<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'taxCmd.TaxTable')}" dataField="name"/>
			<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'taxCmd.TaxRate')}" dataField="effectiveTaxRate"/>
		</mx:columns>
	</mx:DataGrid>
	<mx:CheckBox x="304" y="82" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'webDataCmd.Disable')}" id="disable_check"/>
</mx:TitleWindow>
