<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:vo="com.efi.printsmith.vo.*" width="424" height="400" 
	defaultButton="{select_button}" 
	showCloseButton="false" 
	creationComplete="init()"
    close="PopUpManager.removePopUp(this);" 
    title="Price List" xmlns:text="flash.text.*" borderThickness="3" borderStyle="solid" 
    horizontalScrollPolicy="off" 
    label="Price List" name="Price List"
    verticalScrollPolicy="off" fontSize="9">

<mx:RemoteObject id="dataService" destination="dataService">
	<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveResult(event)"/>
</mx:RemoteObject>

<mx:Producer id="producer" destination="pricelist"/>
<mx:Consumer id="consumer" destination="pricelist" message="messageHandler(event.message)"/>
<mx:Consumer id="notification_consumer" destination="notifications" message="messageHandler(event.message)"/>

<mx:states>
	<mx:State name="Price List" basedOn="">
		<mx:SetProperty name="title" value="Edit Price List {priceList.name}"/>
		<mx:SetProperty target="{title_edit}" name="height" value="20"/>
		<mx:SetProperty target="{label1}" name="x" value="164"/>
	</mx:State>
	<mx:State name="Speed Table" basedOn="Price List">
		<mx:SetProperty target="{chkIgnoreGlobalPriceChange}" name="enabled" value="false"/>
		<mx:SetProperty target="{chkProductionDiscount}" name="enabled" value="false"/>
		<mx:SetProperty target="{chkUseAsRateList}" name="enabled" value="false"/>
		<mx:SetProperty target="{radiobutton1}" name="enabled" value="false"/>
		<mx:SetProperty target="{radiobutton2}" name="enabled" value="false"/>
		<mx:SetProperty name="title" value="Edit Speed Table {priceList.name}"/>
		<mx:SetProperty target="{chkIgnoreGlobalPriceChange}" name="visible" value="false"/>
		<mx:SetProperty target="{chkProductionDiscount}" name="visible" value="false"/>
		<mx:SetProperty target="{chkUseAsRateList}" name="visible" value="false"/>
		<mx:SetProperty target="{radiobutton2}" name="visible" value="false"/>
		<mx:SetProperty target="{radiobutton1}" name="visible" value="false"/>
		<mx:SetProperty target="{chkInterpolate}" name="y" value="37"/>
		
	</mx:State>
	<mx:State name="Waste Chart" basedOn="Price List">
		<mx:SetProperty target="{chkIgnoreGlobalPriceChange}" name="enabled" value="false"/>
		<mx:SetProperty target="{chkProductionDiscount}" name="enabled" value="false"/>
		<mx:SetProperty target="{chkUseAsRateList}" name="enabled" value="false"/>
		<mx:SetProperty target="{chkInterpolate}" name="enabled" value="false"/>
		<mx:SetProperty target="{radiobutton1}" name="enabled" value="false"/>
		<mx:SetProperty target="{radiobutton2}" name="enabled" value="false"/>
		<mx:SetProperty name="title" value="Edit Waste Chart {priceList.name}"/>
		<mx:SetProperty target="{chkIgnoreGlobalPriceChange}" name="visible" value="false"/>
		<mx:SetProperty target="{chkProductionDiscount}" name="visible" value="false"/>
		<mx:SetProperty target="{chkUseAsRateList}" name="visible" value="false"/>
		<mx:SetProperty target="{chkInterpolate}" name="visible" value="false"/>
		<mx:SetProperty target="{radiobutton2}" name="visible" value="false"/>
		<mx:SetProperty target="{radiobutton1}" name="visible" value="false"/>
	</mx:State>
	<mx:State name="Paper Price" basedOn="Price List">
		<mx:SetProperty name="title" value="Edit Paper Price {priceList.name}"/>
		<mx:RemoveChild target="{radiobutton2}"/>
		<mx:RemoveChild target="{radiobutton1}"/>
		<mx:RemoveChild target="{chkUseAsRateList}"/>
		<mx:RemoveChild target="{chkInterpolate}"/>
		<mx:RemoveChild target="{chkProductionDiscount}"/>
		<mx:RemoveChild target="{chkIgnoreGlobalPriceChange}"/>

		<mx:SetProperty target="{colSide}" name="visible" value="true"/>
		<mx:SetProperty target="{colColor}" name="visible" value="true"/>
		<mx:SetProperty target="{dataGrid}" name="width" value="196"/>
		<mx:SetProperty target="{label1}" name="x" value="204"/>
		<mx:SetProperty target="{title_edit}" name="y" value="38"/>
		<mx:SetProperty target="{add_pricelistelement_button}" name="x" value="171"/>
		<mx:SetProperty target="{remove_pricelistelement_button}" name="x" value="139"/>
		<mx:AddChild relativeTo="{canvas1}" position="lastChild">
			<mx:ComboBox id="cboMethod" x="204" y="87" dataProvider="{PaperPriceMethodArray}" labelField="name" width="176"></mx:ComboBox>
		</mx:AddChild>
		<mx:AddChild relativeTo="{canvas1}" position="lastChild">
			<mx:Label x="204" y="66" text="Method:" textAlign="right"/>
		</mx:AddChild>
	</mx:State>
</mx:states>
<mx:Script>
                                   
<![CDATA[
	import com.efi.printsmith.data.SpeedTable;
	import com.efi.printsmith.data.PriceList;
	import com.efi.printsmith.data.PriceListElement;
	import com.efi.printsmith.view.CopierDefinitions;
    import com.efi.printsmith.view.PressDefinitions;
    import com.efi.printsmith.view.StockDefinitions;

	import com.efi.printsmith.data.WasteChart; 
	import com.efi.printsmith.data.PaperPrice;
	import com.efi.printsmith.data.PriceListBase;
	import mx.managers.PopUpManager;                                 
	import mx.controls.Alert;                          
	import mx.containers.Canvas;   
	import mx.core.Container;                      
	import mx.rpc.events.ResultEvent;                                 
	import mx.rpc.events.FaultEvent;                          
	import mx.events.ValidationResultEvent;                          
	import mx.validators.Validator;       
	import mx.messaging.messages.AsyncMessage;
	import mx.messaging.messages.IMessage;
	import mx.core.Application;
	import mx.collections.ArrayCollection;
	import com.efi.printsmith.itemRenderers.SidesEditor;
    import mx.events.DataGridEvent;
    import mx.events.DataGridEventReason;
	    
	[Bindable]                                
	public var priceList:PriceListBase;
		
	public var parentContainer:Container;

	[Bindable]
	private var PaperPriceMethodArray:ArrayCollection = new ArrayCollection();
	
    [Bindable]
    private var quantity_header:String = "Quantity";
    [Bindable]
    private var price_header:String = "Price";
    [Bindable]
	private var side_header:String = "Side";
    [Bindable]
	private var color_header:String = "Color";                                                     	         

	public var itemType:String;

	[Bindable]
	private var amountRadioValue:String = "amtiscurrency";
	
	// Holds a reference to the currently focussed control on the form.
 	private var focusedFormControl:DisplayObject;                           
   	
	private function handleFault(ev:FaultEvent):void {                               
		var message:String;
		message = "Error: "                          
		+ ev.fault.faultCode + " - "                                  
		+ ev.fault.faultDetail + " - "                                  
		+ ev.fault.faultString;
		Alert.show(message, "Error", 0, this, null);                                 
	}
	                                                       
	private function init():void {
		consumer.subscribe();
		notification_consumer.subscribe();     

	    PopUpManager.centerPopUp(this);

		parentContainer = Snowmass.getInstance().mainNavigator.selectedChild;
		fillArray();
	}

	private function fillArray():void {
		var PaperMethod1:Object = new Object;
		PaperMethod1.id = "1";
		PaperMethod1.name = "Use ordered quantity"
		PaperPriceMethodArray.addItem(PaperMethod1);

		var PaperMethod2:Object = new Object;
		PaperMethod2.id = "2";
		PaperMethod2.name = "Use press sheets"
		PaperPriceMethodArray.addItem(PaperMethod2);

		var PaperMethod3:Object = new Object;
		PaperMethod3.id = "3";
		PaperMethod3.name = "Use press sheets and bindery waste"
		PaperPriceMethodArray.addItem(PaperMethod3);

		var PaperMethod4:Object = new Object;
		PaperMethod4.id = "4";
		PaperMethod4.name = "Use ordered quantity per sheet (originals)"
		PaperPriceMethodArray.addItem(PaperMethod4);
	}	
	            
	public function setPriceList(priceList:PriceListBase):void {
		if (priceList == null) return;
		
		if (priceList is WasteChart) {
			itemType = "WasteChart";
			this.currentState = "Waste Chart"
			this.title = "Waste Chart"
			this.label = "Waste Chart"
			this.quantity_header = "Run Length";
			this.price_header = "Spoilage";
		} else if (priceList is SpeedTable) {
			itemType = "SpeedTable";
			this.currentState = "Speed Table";
			this.title = "Speed Table"
			this.label = "Speed Table"
			this.quantity_header = "Run Length";
			this.price_header = "Speed";
		} else if (priceList is PaperPrice) {
			itemType = "PaperPrice";
			this.currentState = "Paper Price";
			this.title = "Paper Price"
			this.label = "Paper Price"
			this.quantity_header = "Copies";
			this.price_header = "Price";
		} else {
			itemType = "PriceList";
			this.currentState = "Price List";
		}
		this.priceList = priceList;
	}   
	                 
	private function doSelect():void {	

		maptoPricelist();
//		var i:int;
//		if (priceList.elements != null) {
//			for (i = 0; i < priceList.elements.length; i++) {
//				var priceListElement:PriceListElement = priceList.elements.getItemAt(i) as PriceListElement;
//				priceListElement = dataService.addUpdate(priceListElement) as PriceListElement;
//			}
//		}
		dataService.addUpdate(priceList);
		PopUpManager.removePopUp(this);
	}     
	
	private function doNew():void {
	}
	
	private function doClear():void {
		PopUpManager.removePopUp(this);		
	}
	
	private function doDelete():void {
		 dataService.deleteItem(itemType,priceList.id);
	}
	
	private function maptoPricelist():void {
		priceList.name = title_edit.text;
		priceList.interpolate = chkInterpolate.selected;
		priceList.isRate = chkUseAsRateList.selected;
		priceList.isDiscount = chkProductionDiscount.selected;
		priceList.ignorePriceAdjustments = chkIgnoreGlobalPriceChange.selected;
	}
	
	
	private function messageHandler(message:IMessage):void
	{
	}

	private function handleSaveResult(ev:ResultEvent):void {
		if (itemType == "PriceList" || itemType == "PriceListBase") {
			priceList = ev.result as PriceList;
		} else if (itemType == "WasteChart") {
			priceList = ev.result as WasteChart;
		} else if (itemType == "SpeedTable") {
			priceList = ev.result as SpeedTable;
		} else if (itemType == "PaperPrice") {
			priceList = ev.result as PaperPrice;
		}

		var editPage:Container = parentContainer;
	}
		
	private function doNewPriceListElement():void {
		if (priceList.elements == null) priceList.elements = new ArrayCollection();
		var newItem:PriceListElement = new PriceListElement();
		newItem.id = 0;
		newItem.amount = 0;
		newItem.quantity = 0;
		priceList.elements.addItem(newItem);
	}
	
	private function doRemovePriceListElement():void {
		var deleteItem:PriceListElement = dataGrid.selectedItem as PriceListElement;
		priceList.elements.removeItemAt(priceList.elements.getItemIndex(deleteItem));
	}

	private function processSidesGridData(event:DataGridEvent):void {
        if (event.reason == DataGridEventReason.CANCELLED){
            // Do not update cell.
            return;
        }           

		if(event.dataField == "side")
		{
			// Disable copying data back to the control.
			event.preventDefault();

			// Get new category from editor.
			dataGrid.editedItemRenderer.data.side = SidesEditor(DataGrid(event.target).itemEditorInstance).pickSide.selectedItem;

			// Close the cell editor.
			dataGrid.destroyItemEditor();

			// Notify the list control to update its display.
			dataGrid.dataProvider.itemUpdated(event.itemRenderer.data);
		}	
	}
]]>        
</mx:Script>            
	<mx:Canvas width="100%" height="100%" verticalScrollPolicy="off" horizontalScrollPolicy="off" id="canvas1">
		<mx:DataGrid id="dataGrid" width="145" dataProvider="{priceList.elements}"
		showHeaders="true" borderStyle="solid" borderThickness="3" x="0" editable="true" enabled="true" bottom="25" top="0" rowHeight="20" alternatingItemColors="[#FFFFFF, #FFFFFF]"
		itemEditEnd="processSidesGridData(event);">
		<mx:columns>
		     <mx:DataGridColumn dataField="quantity" headerText="{quantity_header}" sortable="false"/>
		     <mx:DataGridColumn dataField="amount" headerText="{price_header}" sortable="false"/>
		     <mx:DataGridColumn id="colSide" dataField="side" headerText="{side_header}" sortable="false" visible="false" width="75"
 				itemEditor="com.efi.printsmith.itemRenderers.SidesEditor" editable="true">
 				
    			<mx:itemRenderer>
        			<mx:Component>
                		<mx:Text selectable="false" text="{data.side}"/>
        			</mx:Component>
    			</mx:itemRenderer>
			</mx:DataGridColumn>
		     <mx:DataGridColumn id="colColor" dataField="color" headerText="{color_header}" sortable="false" visible="false"/>
		</mx:columns>
		</mx:DataGrid>
		<mx:Button label="OK" id="select_button" enabled="true" click="doSelect()"  width="97" x="229" y="254"/>
		<mx:Button label="Cancel" enabled="true" click="doClear();" id="clear_button" width="97" x="229" y="284"/>
		<mx:TextInput x="204" y="10" id="title_edit" text="{priceList.name}" width="176"/>
		<mx:Label x="162" y="12" text="Title:" id="label1" textAlign="right"/>
		<mx:RadioButtonGroup id="amount_radio_group" selectedValue="{amountRadioValue}"/>
		<mx:RadioButton x="162" y="38" label="Amount is currency" groupName="amount_radio_group" value="amtiscurrency" id="radiobutton2"/>
		<mx:RadioButton x="162" y="58" label="Amount is percent" groupName="amount_radio_group" value="amtispercent" id="radiobutton1"/>
		<mx:CheckBox x="162" y="156" label="Ignore global price changes" selected="{priceList.ignorePriceAdjustments}" id="chkIgnoreGlobalPriceChange"/>
		<mx:CheckBox x="162" y="94" label="Interpolate" selected="{priceList.interpolate}" id="chkInterpolate"/>
		<mx:CheckBox x="185" y="134" label="Production discount" width="137" selected="{priceList.isDiscount}" id="chkProductionDiscount"/>
		<mx:CheckBox x="162" y="114" label="Use as rate list" selected="{priceList.isRate}" id="chkUseAsRateList"/>
		<mx:LinkButton x="89"
					   id="remove_pricelistelement_button"
					   click="doRemovePriceListElement()"
					   icon="@Embed(source='../../../../assets/delete16.png')"
					   width="24"
					   bottom="3"/>
		<mx:LinkButton x="121"
					   id="add_pricelistelement_button"
					   click="doNewPriceListElement()"
					   icon="@Embed(source='../../../../assets/add16.png')"
					   width="24"
					   bottom="3"/>
	</mx:Canvas>
<mx:Spacer height="10" />        

</mx:TitleWindow>