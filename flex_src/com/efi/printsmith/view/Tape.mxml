<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow 
	xmlns:mx="http://www.adobe.com/2006/mxml" 
	xmlns:comp="com.efi.printsmith.components.*" 
	layout="absolute" 
	width="100%" 
	height="100%"
	headerHeight="0" 
	title="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'tapeCmd.Tape')}" 
	label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'tapeCmd.Tape')}" 
	name="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'tapeCmd.Tape')}" 
		preinitialize="preInit();"
 	implements="com.efi.printsmith.security.ISecureComponent"
	xmlns:components="com.efi.printsmith.components.*" 
	xmlns:vo="com.efi.printsmith.vo.*">

<mx:Script source="../security/PSSecurityInclude.as" />

	<mx:RemoteObject id="dataServiceTapeBatch" destination="dataService">
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveTapeBatchResult(event)"/>
		<mx:method name="getCurrentTapeBatch" fault="handleFault(event)" result="handleLoadCurrentTapeBatch(event)"/>
	</mx:RemoteObject>

<mx:Script>                                   
<![CDATA[
	import com.efi.printsmith.data.Transaction;
	import mx.charts.series.ColumnSeries;
	import mx.events.FlexEvent;
	import com.efi.printsmith.security.PSSecurityCommands;
	import com.efi.mdi.view.window.MDIWindow;
	import mx.rpc.events.ResultEvent;
	import mx.collections.ArrayCollection;
	import mx.collections.XMLListCollection;
	import mx.rpc.events.ResultEvent;
	import mx.rpc.events.FaultEvent;
	import mx.controls.Alert;
    import mx.printing.FlexPrintJob;
    import mx.printing.PrintAdvancedDataGrid;
    import mx.printing.PrintDataGrid;
    import mx.core.Application;
	import mx.managers.PopUpManager;
	import mx.rpc.IResponder;
	import com.efi.printsmith.Constants;
	import mx.utils.StringUtil;
	
	import com.efi.printsmith.data.TaxTable;
	import com.efi.printsmith.data.TaxCodes;
	import com.efi.printsmith.data.TapeBatch;
	import com.efi.printsmith.data.TapeSessionBatch;
	import com.efi.printsmith.data.TapePaymentRecord;
	import com.efi.printsmith.data.TapeSaleRecord;
	import com.efi.printsmith.data.AccountHistoryData;
	import com.efi.printsmith.data.CreditCardTransactions;
	import com.efi.printsmith.data.CreditCard;	
	[Bindable]
	private var sessionBatch:TapeSessionBatch;
	[Bindable]
	private var tapeBatch:TapeBatch;
	[Bindable]
	private var tapeTreeData:XMLListCollection;
	
	public function getSecurityCommand():String {
    	return PSSecurityCommands.POS_OPENTAPE;
    }	
    
	public function init(event:FlexEvent=null):void{
		
	//	var mdiWin:MDIWindow = Snowmass.getInstance().containerManager.getWindowWithChild(this);
	//	mdiWin.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'tapeCmd.Tape');	
		
	//	this.throbber.visible = true;
	//	this.throbber.play();
		
		tapeBatch = new TapeBatch();
		tapeTreeData = new XMLListCollection();
		
		dataServiceTapeBatch.getCurrentTapeBatch();
	}
	
	private function handleLoadCurrentTapeBatch(evt:ResultEvent):void {		
		var i:int = 0;
		var batchList:XMLList = new XMLList;
		
		tapeBatch = evt.result as TapeBatch;
		
		if (tapeBatch.sessionBatches == null) {
			tapeBatch.sessionBatches = new ArrayCollection();
		}
		
	//	tapeTreeData = new XMLListCollection();
		
//		batchList. = tapeBatch.
		
		for (i = 0; i < tapeBatch.sessionBatches.length; i++) {
			
		}
		
		openTree();
	}
	
	private function handleSaveTapeBatchResult(ev:ResultEvent):void{
		tapeBatch = ev.result as TapeBatch;
		
		//
		// good save of Tape batch and all session layers
		//
	//	this.throbber.visible = false;
	//	this.throbber.stop();
	}
	
	private function handleFault(ev:FaultEvent):void
	{
		var message:String;

		message="Error: " + ev.fault.faultCode + " - " + ev.fault.faultDetail + " - " + ev.fault.faultString;
		Alert.show(message, "Error", 0, null);
	}
	
	private function doVoid():void 
	{
	}
	
	private function doRefresh():void 
	{
	}
	
	

	private function doPrintTape():void {
		var myPrintJob:FlexPrintJob = new FlexPrintJob();
	
		if (myPrintJob.start()) {
			var myPrintDataGrid:PrintDataGrid = new PrintDataGrid();
	
			//Set the print view properties.
			myPrintDataGrid.width = myPrintJob.pageWidth;
			myPrintDataGrid.height = myPrintJob.pageHeight;
	
			// Set the data provider of the FormPrintView component's data grid
			// to be the data provider of the displayed data grid.
			myPrintDataGrid.dataProvider = tvItems.dataProvider;
		//	myPrintDataGrid.columns = 
			myPrintDataGrid.visible = false;
			myPrintDataGrid.includeInLayout = false;
			
			Application.application.addChild(myPrintDataGrid);
	
			if(!myPrintDataGrid.validNextPage) {
				myPrintJob.addObject(myPrintDataGrid);
			} else {
				myPrintJob.addObject(myPrintDataGrid);
	
				while(true) {
					// Move the next page of data to the top of the print grid.
					myPrintDataGrid.nextPage();
	
					if(!myPrintDataGrid.validNextPage) {
						// This is the last page; queue it and exit the print loop.
						myPrintJob.addObject(myPrintDataGrid);
	
						break;
					} else {
						myPrintJob.addObject(myPrintDataGrid);
					}
				} 
	
			}
	
			Application.application.removeChild(myPrintDataGrid);
			myPrintJob.send();
	 	}
 	}
 	
 	private function dotreelabel(item:Object):String{
		var tempSale:TapeSaleRecord;
		var tempPayment:TapePaymentRecord;
	//	var baseTransation:Transaction;
		
		if (item is TapePaymentRecord) {
			tempPayment = item as TapePaymentRecord;
			return tempPayment.paymentMethod;
		} else if (item is TapeSaleRecord) {
			tempSale = item as TapeSaleRecord;
			return tempSale.department;
		}
		
		return "";
	} 
	
	private function treeSelect(event:Event):void {
	//	var treeItem:PreferencesCashRegister = tvItems.selectedItem as PreferencesCashRegister;
	
	}
	
	private function openTree():void {
		var nodeList:XMLListCollection = 
			tvItems.dataProvider as XMLListCollection;
		tvItems.selectedIndex = -1;

		var node:XML = XML(tvItems.selectedItem);
	}

]]>
                             
</mx:Script>
	<mx:Canvas width="100%" height="100%">
		<mx:Button x="30" y="10" width="38" height="38" click="doPrintTape()">
				<mx:icon>@Embed(source='../../../../assets/print.png')</mx:icon>
			</mx:Button>
		<mx:Button x="97" y="10" width="38" height="38" click="doRefresh()">
			<mx:icon>@Embed(source='../../../../assets/Refresh.png')</mx:icon>
			</mx:Button>
		<mx:Button x="169" y="10" width="38" height="38" click="doVoid()">
			<mx:icon>@Embed(source='../../../../assets/Delete.png')</mx:icon>
			</mx:Button>
		
		<mx:Tree x="0" y="135" width="100%"  
			id="tvItems" 
			dataProvider="{tapeBatch}"
			defaultLeafIcon="{null}"
			labelFunction="dotreelabel" height="460" change="treeSelect(event);">
		</mx:Tree>
	</mx:Canvas>
	
</mx:TitleWindow>
