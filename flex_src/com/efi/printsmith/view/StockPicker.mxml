<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:vo="com.efi.printsmith.data.*" width="630" height="612" defaultButton="{select_button}" showCloseButton="true" creationComplete="init()"
    close="PopUpManager.removePopUp(this);"
    title="Stock Picker" xmlns:text="flash.text.*" borderThickness="3" borderStyle="solid">
          
	<mx:RemoteObject id="dataService" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadResult(event)"/>
	</mx:RemoteObject>
    <mx:RemoteObject id="dataServicePreferencesStockDefinition" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadPreferencesStockDefinitionResult(event)"/>
	</mx:RemoteObject>

	<mx:Producer id="producer" destination="stockdefinitions"/>
	<mx:Consumer id="consumer" destination="stockdefinitions" message="messageHandler(event.message)"/>
	<mx:Consumer id="notification_consumer" destination="notifications" message="messageHandler(event.message)"/>

<mx:Script>
                                   
<![CDATA[
	import mx.controls.dataGridClasses.DataGridColumn;
	import mx.collections.ArrayCollection;           
	import com.efi.printsmith.events.StockPickerSelectEvent;
    import com.efi.printsmith.data.StockDefinition;   
    
    import com.efi.printsmith.data.PreferencesStockDefinition;
                 
	import mx.managers.PopUpManager;                                 
	import mx.controls.Alert;                          
	import mx.containers.Canvas;                                
	import mx.rpc.events.ResultEvent;                                 
	import mx.rpc.events.FaultEvent;                          
	import mx.events.ValidationResultEvent;                          
	import mx.validators.Validator;       
	import mx.messaging.messages.AsyncMessage;
	import mx.messaging.messages.IMessage;
	import mx.core.Application;
	                             
	[Bindable]                             
	private var message:String;                                   
	[Bindable]                             
	private var formIsValid:Boolean = false;                               
	[Bindable]                                     
	public var formIsEmpty:Boolean; 
	                                  
	[Bindable]                                
	private var stockDefinitions:ArrayCollection = new ArrayCollection();
    [Bindable]
    private var preferencesStockDefinitions:ArrayCollection = new ArrayCollection();
                                                                     
	[Bindable]                               
	private var stockDefinitionRecords:int = 0;
	         
	// Holds a reference to the currently focussed control on the form.
 	private var focusedFormControl:DisplayObject;                           
           
	private function handleLoadResult(event:ResultEvent):void {
		stockDefinitions = event.result as ArrayCollection;
	}

	private function handleLoadPreferencesStockDefinitionResult(event:ResultEvent):void {
		preferencesStockDefinitions = event.result as ArrayCollection;
		
		for each(var element:PreferencesStockDefinition in preferencesStockDefinitions)
		{
			
			for each(var column:DataGridColumn in dataGrid.columns)
			{
				if (column.headerText==element.columns.name)
				{
					column.visible = element.visible;
					break;
				}
			}
		} 
	}

	private function handleFault(ev:FaultEvent):void {                               
		message = "Error: " + ev.fault.faultCode + " \n "                                            
		+ "Detail: " + ev.fault.faultDetail + " \n "                              
		+ "Message: " + ev.fault.faultString;                                    
	}

  	private function messageHandler(message:IMessage):void
	{
		var messageBody:Object = message.body;// as com.efi.printsmith.messaging.MessageBody;
		
		var messageType:String = messageBody.messageType;
		if (messageType == "ADDUPDATE" || messageType == "DELETE") {
			var payloadType:String = messageBody.payloadType as String; // What kind of item was added/deleted
			var payload:Number = messageBody.payload as Number; // ID if item added or deleted
			if (payloadType == "StockDefinition") {
				dataService.getAll("StockDefinition");
			}
		}
	}
                                                     
	private function init():void {   
		consumer.subscribe();
		notification_consumer.subscribe();     
	    PopUpManager.centerPopUp(this);
		dataService.getAll("StockDefinition");
		dataServicePreferencesStockDefinition.getAll("PreferencesStockDefinition");
	}
	                                

	private function editStockDefinition():void {
		
	}   

	private function selectStockDefinition():void {	
		var selectEvent:StockPickerSelectEvent = new StockPickerSelectEvent(StockPickerSelectEvent.SELECTSTOCK, dataGrid.selectedItem as StockDefinition);
		dispatchEvent(selectEvent);
		PopUpManager.removePopUp(this);
	}     
	
	private function newStockDefinition():void {
		var newEvent:StockPickerSelectEvent = new StockPickerSelectEvent(StockPickerSelectEvent.SELECTNEWSTOCK, new StockDefinition());
		dispatchEvent(newEvent);
		PopUpManager.removePopUp(this);
	}
	
	private function cancelPicker():void {
		var cancelEvent:StockPickerSelectEvent = new StockPickerSelectEvent(StockPickerSelectEvent.CANCELSELECTSTOCK, null);
		dispatchEvent(cancelEvent);
		PopUpManager.removePopUp(this);
	}
	
	private function updateDataGrid():void {
		// loaderService.getStockDefinitionByPartialName(filter_field.text);
	}
	
	private function clearSearch():void{
		
	}
	
	private function doRollStockChanged():void{
		txtRollWidthMin.enabled = chkShowRollStock.selected;
		txtRollWidthMax.enabled = chkShowRollStock.selected;
	}
	
]]>        
</mx:Script>
                             

                             
	<mx:Canvas width="100%" height="100%" creationPolicy="all">
		<mx:DataGrid id="dataGrid" dataProvider="{stockDefinitions}"
		doubleClickEnabled="true" doubleClick="selectStockDefinition()" verticalScrollPolicy="auto" horizontalScrollPolicy="on" showHeaders="true" backgroundColor="#FFFFFF" borderStyle="solid" borderThickness="3" right="0" left="0" bottom="0" top="273">               
		<mx:columns>
		     <mx:DataGridColumn dataField="name" headerText="Name" width="100"/>
		     <mx:DataGridColumn dataField="weight" headerText="Weight"/>
		     <mx:DataGridColumn dataField="parentsize" headerText="Size"/>
		     <mx:DataGridColumn dataField="color" headerText="Color"/>
		     <mx:DataGridColumn dataField="genericColor" headerText="Generic Color"/>
		     <mx:DataGridColumn dataField="finish" headerText="Finish"/>
		     <mx:DataGridColumn dataField="thickness" headerText="Thickness"/>
		     <mx:DataGridColumn dataField="grade" headerText="Grade"/>
		     <mx:DataGridColumn dataField="cwt1" headerText="CWT"/>
		     <mx:DataGridColumn dataField="vendor" headerText="Vendor"/>
		     <mx:DataGridColumn dataField="stocknumber" headerText="Stock Number"/>
		     <mx:DataGridColumn dataField="id" headerText="Product ID"/>
		     <mx:DataGridColumn dataField="onHand" headerText="Quantity On Hand"/>
		     <mx:DataGridColumn dataField="committed" headerText="Committed"/>
		     <mx:DataGridColumn dataField="onOrder" headerText="Ordered"/>
		     <mx:DataGridColumn dataField="shellItem" headerText="Shell"/>
		     <mx:DataGridColumn dataField="normalRunSize" headerText="Run Size"/>
		     <mx:DataGridColumn dataField="basicsize" headerText="Basic Size"/>
		     <mx:DataGridColumn dataField="stkgroup" headerText="Group"/>
		     <mx:DataGridColumn dataField="coated" headerText="Coated Sides"/>
		     <mx:DataGridColumn dataField="minorder" headerText="Minimum Order"/>
		     <mx:DataGridColumn dataField="cost1" headerText="Price"/>
		     <mx:DataGridColumn dataField="priceExpires" headerText="Price Expires"/>
		     <mx:DataGridColumn dataField="forestManagement" headerText="Forest Management"/>
		     <mx:DataGridColumn dataField="pcwRecycledPercent" headerText="Recycle" />
		     <mx:DataGridColumn dataField="fscCertified" headerText="FSC"/>
		     <mx:DataGridColumn dataField="sfiCertified" headerText="SFI"/>
		     <mx:DataGridColumn dataField="greenSealCertified" headerText="GreenSeal"/>
		</mx:columns>
		</mx:DataGrid>
		<mx:Button label="Select" id="select_button" enabled="{(dataGrid.selectedItem != null)}" click="selectStockDefinition();"  width="108" x="10" y="10"/>
		<mx:Button label="New" enabled="true" click="newStockDefinition();" id="new_button" width="108" x="242" y="10"/>
		<mx:Button label="Cancel" click="cancelPicker();" id="cancel_button" width="108" x="478" y="10"/>
		<mx:Button label="Clear Search" click="clearSearch();" id="clear_button" width="108" x="126" y="10" enabled="false"/>
		<mx:Label x="57" y="64" text="Group:"/>
		<mx:Label x="58" y="116" text="Name:"/>
		<mx:Label x="58" y="142" text="Finish:"/>
		<mx:Label x="61" y="168" text="Color:"/>
		<mx:Label x="57" y="194" text="Grade:"/>
		<mx:Label x="4" y="220" text="Minimum Order:"/>
		<mx:Label x="51" y="246" text="Vendor:"/>
		<mx:Label x="258" y="64" text="Type:"/>
		<mx:Label x="227" y="116" text="Product ID:"/>
		<mx:Label x="211" y="142" text="Coated Sides:"/>
		<mx:Label x="211" y="168" text="Generic Color:"/>
		<mx:Label x="230" y="194" text="Thickness:"/>
		<mx:Label x="212" y="220" text="# Sheets/Set:"/>
		<mx:Label x="208" y="246" text="Stock Number:"/>
		<mx:Label x="445" y="64" text="Size:"/>
		<mx:Label x="490" y="40" text="Min"/>
		<mx:Label x="545" y="40" text="Max"/>
		<mx:Label x="429" y="90" text="Weight:"/>
		<mx:Label x="442" y="116" text="CWT:"/>
		<mx:Label x="396" y="142" text="Qty On Hand:"/>
		<mx:Label x="411" y="168" text="Roll Width:"/>
		<mx:CheckBox x="418" y="192" label="Show Roll Stock" id="chkShowRollStock" change="doRollStockChanged();"/>
		<mx:CheckBox x="418" y="207" label="Show Large Format Stock" id="chkShowLargeFormatStock"/>
		<mx:CheckBox x="418" y="222" label="Show Rigid Substrate" id="chkShowRigidSubstrate"/>
		<mx:CheckBox x="418" y="237" label="Show Inventoried Stock" id="chkShowInventoriedStock"/>
		<mx:CheckBox x="418" y="252" label="Show Shells (Account: All)" id="chkShowShells"/>
		<mx:TextInput x="99" y="62" width="98" id="txtGroup"/>
		<mx:TextInput x="99" y="114" width="98" id="txtName"/>
		<mx:TextInput x="99" y="140" width="98" id="txtFinish"/>
		<mx:TextInput x="99" y="166" width="98" id="txtColor"/>
		<mx:TextInput x="99" y="192" width="98" id="txtGrade"/>
		<mx:TextInput x="99" y="218" width="98" id="txtMinOrder"/>
		<mx:TextInput x="99" y="244" width="98" id="txtVendor"/>
		<mx:TextInput x="295" y="62" width="98" id="txtStockType"/>
		<mx:TextInput x="478" y="62" width="48" id="txtSizeMin"/>
		<mx:TextInput x="478" y="88" width="48" id="txtWeightMin"/>
		<mx:TextInput x="534" y="88" width="48" id="txtWeightMax"/>
		<mx:TextInput x="478" y="114" width="48" id="txtCwtMin"/>
		<mx:TextInput x="534" y="114" width="48" id="txtCwtMax"/>
		<mx:TextInput x="478" y="140" width="48" id="txtQtyOnHandMin"/>
		<mx:TextInput x="534" y="140" width="48" id="txtQtyOnHandMax"/>
		<mx:TextInput x="478" y="166" width="48" enabled="false" id="txtRollWidthMin"/>
		<mx:TextInput x="534" y="166" width="48" enabled="false" id="txtRollWidthMax"/>
		<mx:TextInput x="534" y="62" width="48" id="txtSizeMax"/>
		<mx:TextInput x="295" y="114" width="98" id="txtProductId"/>
		<mx:TextInput x="295" y="140" width="98" id="txtCoatedSides"/>
		<mx:TextInput x="295" y="166" width="98" id="txtGenericColors"/>
		<mx:TextInput x="295" y="192" width="98" id="txtThickness"/>
		<mx:TextInput x="295" y="218" width="98" id="txtSheetsPerSet"/>
		<mx:TextInput x="295" y="244" width="98" id="txtStockNumber"/>
	</mx:Canvas>
<mx:Spacer height="10" />        

</mx:TitleWindow>