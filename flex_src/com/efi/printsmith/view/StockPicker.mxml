<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" 
	xmlns:vo="com.efi.printsmith.data.*" width="888" height="612" 
	defaultButton="{select_button}" showCloseButton="true" creationComplete="init()"
    close="cancelPicker();"
    title="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.StockPicker')}" 
    xmlns:flexlib="flexlib.containers.*"
    xmlns:text="flash.text.*" xmlns:comp="com.efi.printsmith.components.*" borderThickness="3" borderStyle="solid" fontSize="9" xmlns:components="com.efi.printsmith.common.components.*">
          
	<mx:RemoteObject id="dataService" destination="dataService" showBusyCursor="true">
		<mx:method name="getAllNameIDOnly" fault="handleFault(event)" result="handleLoadResult(event)"/>
		<mx:method name="getStockPicker" fault="handleFault(event)" result="handleLoadResult(event)"/>
		<mx:method name="getById" fault="handleFault(event)" result="handleGetResult(event)"/>
		<mx:method name="deleteItem" fault="handleFault(event)" result="handleDeleteResult(event)"/>
	</mx:RemoteObject>
     

	<mx:Producer id="producer" destination="stockdefinitions"/>
<!--
	<mx:Consumer id="co  mnsumer" destination="stockdefinitions" message="messageHandler(event.message)"/>
	<mx:Consumer id="notification_consumer" destination="notifications" message="messageHandler(event.message)"/>
-->	
<mx:Script>
                                   
<![CDATA[
	import mx.events.DataGridEvent;
	import com.hillelcoren.utils.StringUtils;
	import com.efi.printsmith.data.StockType;

	import mx.collections.SortField;
	import mx.collections.Sort;
	import mx.utils.StringUtil;
	
	import com.efi.printsmith.data.StockGrade;
	import com.efi.printsmith.data.StockGroup;
	import com.efi.printsmith.data.Vendor;
	import com.efi.printsmith.data.StockFinish;
	import com.efi.printsmith.data.GenericColors;
	import com.efi.printsmith.data.StockColors;
	import com.efi.printsmith.data.Dimension;
	import mx.controls.dataGridClasses.DataGridColumn;
	import mx.collections.ArrayCollection;           
	import com.efi.printsmith.events.StockPickerSelectEvent;
    import com.efi.printsmith.data.StockDefinition;   
    import com.efi.printsmith.view.XpdexStockAvailability;
    import com.efi.printsmith.data.PreferencesStockDefinition;
                 
	import mx.managers.PopUpManager;                                 
	import mx.controls.Alert;                          
	import mx.containers.Canvas;                                
	import mx.rpc.events.ResultEvent;                                 
	import mx.rpc.events.FaultEvent;                          
	import mx.events.ValidationResultEvent;                          
	import mx.validators.Validator;       
	import mx.messaging.messages.AsyncMessage;
	import mx.messaging.messages.IMessage;
	import mx.core.Application;
	                             
	[Bindable]                             
	private var message:String;                                   
	[Bindable]                             
	private var formIsValid:Boolean = false;                               
	[Bindable]                                     
	public var formIsEmpty:Boolean; 
	                                  
	[Bindable]                                
	private var stockDefinitions:ArrayCollection = new ArrayCollection();
    [Bindable]
    private var preferencesStockDefinitions:ArrayCollection = new ArrayCollection();
                                                                     
	[Bindable]                               
	private var stockDefinitionRecords:int = 0;
	
	[Bindable] private var stockGroups:ArrayCollection;
	[Bindable] private var stockTypes:ArrayCollection;
	[Bindable] private var finishes:ArrayCollection;
	[Bindable] private var colors:ArrayCollection;
	[Bindable] private var genericColors:ArrayCollection;
	[Bindable] private var grades:ArrayCollection;
	[Bindable] private var vendors:ArrayCollection;
	[Bindable] private var uoms:ArrayCollection;
	[Bindable] private var coatedSides:ArrayCollection;
	
	private var deleteCounter:int=0; 
	
	private var itemsDeleted:int=0;
	private var deletedStockDefinitions:ArrayCollection = new ArrayCollection(); 
	
	[Bindable]
    [Embed(source="assets/DisclosureDown.png")]
    public var downIcon:Class;

    [Bindable]
    [Embed(source="assets/DisclosureUp.png")]
    public var upIcon:Class;
	         
	// Holds a reference to the currently focussed control on the form.
 	private var focusedFormControl:DisplayObject;                           
           
	private function handleLoadResult(event:ResultEvent):void {
		stockDefinitions = event.result as ArrayCollection;
		defaultSortGrid();
	}

	
	private function handleFault(ev:FaultEvent):void {                               
		message = "Error: " + ev.fault.faultCode + " \n "                                            
		+ "Detail: " + ev.fault.faultDetail + " \n "                              
		+ "Message: " + ev.fault.faultString;                                    
	}
	private function handleGetResult(ev:ResultEvent):void {
		var stockDef:StockDefinition;
		stockDef = ev.result as StockDefinition;
		var selectEvent:StockPickerSelectEvent = new StockPickerSelectEvent(StockPickerSelectEvent.SELECTSTOCK, stockDef);
		dispatchEvent(selectEvent);
		PopUpManager.removePopUp(this);
	     
	}
	
	private function handleDeleteResult(event:ResultEvent):void {
		if(deleteCounter!=0){
			itemsDeleted++;
			if(itemsDeleted==deleteCounter){
				itemsDeleted=0;
				deleteCounter=0;
				for each(var id:Number in deletedStockDefinitions){
					var counter:int=0;
					var checkFlag:Boolean = false;
					for each(var stockDefinitionObj:Object in stockDefinitions){
						if(id==stockDefinitionObj.id){
							checkFlag = true;
							break;
						}
						counter++;
					}
					if(checkFlag){
						stockDefinitions.removeItemAt(counter);
						//stockDefinitions.refresh();
					}
				}
				deletedStockDefinitions = new ArrayCollection();
			}
		}
		//dataService.getStockPicker();
	}
	
	private function doEnableWebStatus():void {
		var tempStock:StockDefinition;
		tempStock = dataGrid.selectedItem as StockDefinition;
		if (tempStock.vendor.name == "xpedx" || tempStock.vendor.name == "Xpedx") {
			this.web_status.visible = true;
			this.status_button.enabled = true;
		} else {
			this.web_status.visible = false;
			this.status_button.enabled = false;
		}
		lblCount.text = (dataGrid.selectedIndex+1) + " / " + (dataGrid.dataProvider as ArrayCollection).length;
	}
	
  	private function messageHandler(message:IMessage):void
	{
		var messageBody:Object = message.body;// as com.efi.printsmith.messaging.MessageBody;
		
		var messageType:String = messageBody.messageType;
		if (messageType == "ADDUPDATE" || messageType == "DELETE") {
			var payloadType:String = messageBody.payloadType as String; // What kind of item was added/deleted
			var payload:Number = messageBody.payload as Number; // ID if item added or deleted
			if (payloadType == "StockDefinition") {
				dataService.getAllNameIDOnly("StockDefinition");
			}
		}
	}
                                                     
	private function init():void {   
//		consumer.subscribe();
//		notification_consumer.subscribe();     
	    PopUpManager.centerPopUp(this);
	    ShellLabel();
	    showSearchBox.setStyle("icon", downIcon);
	  // dataService.getAllNameIDOnly("StockDefinition");
	//	dataServicePreferencesStockDefinition.getAll("PreferencesStockDefinition");
	}
	                                
	private function ShellLabel():void{
		chkShowShells.label = StringUtil.substitute(chkShowShells.label,resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'statementCmd.All'))
	}	
	private function editStockDefinition():void {
		
	}  
	
	private function deleteStockDefinition():void {
		itemsDeleted = 0;
		deleteCounter = dataGrid.selectedItems.length;
		deletedStockDefinitions = new ArrayCollection();
		for (var i:int = 0;i<dataGrid.selectedItems.length;i++) {
			var temp:StockDefinition
			temp = dataGrid.selectedItems[i] as StockDefinition;
			if (temp != null) {
				deletedStockDefinitions.addItem(temp.id);
				dataService.deleteItem("StockDefinition", temp.id);
			}
		}
	} 

	private function selectStockDefinition():void {	
		
		var temp:StockDefinition
		temp = dataGrid.selectedItem as StockDefinition;
		if (temp != null)
			dataService.getById("StockDefinition", temp.id );
		
	}     
	
	private function newStockDefinition():void {
		var newEvent:StockPickerSelectEvent = new StockPickerSelectEvent(StockPickerSelectEvent.SELECTNEWSTOCK, new StockDefinition());
		dispatchEvent(newEvent);
		PopUpManager.removePopUp(this);
	}
	
	private function cancelPicker():void {
		var cancelEvent:StockPickerSelectEvent = new StockPickerSelectEvent(StockPickerSelectEvent.CANCELSELECTSTOCK, null);
		dispatchEvent(cancelEvent);
		PopUpManager.removePopUp(this);
	}
	
	private function updateDataGrid():void {
		// loaderService.getStockDefinitionByPartialName(filter_field.text);
	}
	
	private function clearSearch():void{
		txtGroup.selectedIndex = 0;
		txtName.text = "";
		txtColor.selectedIndex = 0;
		txtGenericColors.selectedIndex = 0;
		txtFinish.selectedIndex = 0;
		txtGrade.selectedIndex = 0;
		txtMinOrder.text = "";
		txtVendor.selectedIndex = 0;
		txtStockType.selectedIndex = 0;
		txtProductId.text = "";
		txtCoatedSides.text = "";
		txtThickness.text = "";
		txtThicknessUOM.selectedIndex = 0;
		txtSheetsPerSet.text = "";
		txtStockNumber.text = "";
		txtSizeMin.text = "";
		txtSizeMax.text = "";
		txtWeightMin.text = "";
		txtWeightMax.text = "";
		txtCwtMin.text = "";
		txtCwtMax.text = "";
		txtQtyOnHandMin.text = "";
		txtQtyOnHandMax.text = "";
		txtRollWidthMin.text = "";
		txtRollWidthMax.text = "";
		chkShowRollStock.selected = false;
		chkShowLargeFormatStock.selected = false;
		chkShowRigidSubstrate.selected = false;
		chkShowRollStock.selected = false;
		chkShowShells.selected = false;
		chkShowInventoriedStock.selected = false;
		
		chkShowRollStock.enabled = true;
		chkShowLargeFormatStock.enabled = true;
		chkShowRigidSubstrate.enabled = true;
		chkShowRollStock.enabled = true;
		chkShowShells.enabled = true;
		chkShowInventoriedStock.enabled = true;
		
		txtRollWidthMax.enabled = false;
		txtRollWidthMin.enabled = false;		
		txtSizeMax.enabled = true;
		txtSizeMin.enabled = true;
		
		search();
		
		clear_button.enabled = false;
		
	}
	private function UpdateSize():void{
		if (chkShowRollStock.selected || chkShowLargeFormatStock.selected || chkShowRigidSubstrate.selected){
			txtSizeMin.enabled = false;
			txtSizeMax.enabled = false;
			txtRollWidthMin.enabled = true;
			txtRollWidthMax.enabled =true;
			txtSheetsPerSet.text = "";
			txtSheetsPerSet.enabled = false;
		} else {
			txtSizeMin.enabled = true;
			txtSizeMax.enabled = true;
			txtRollWidthMin.enabled = false;
			txtRollWidthMax.enabled =false;
			txtSheetsPerSet.text = "";
			txtSheetsPerSet.enabled = true;
		}
	}
	private function doLargeFormatChange():void{
		
		if ((chkShowLargeFormatStock.selected) || (chkShowRigidSubstrate.selected))	{
			chkShowRollStock.enabled = false;
		}
		else	{
			chkShowRollStock.enabled = true;
		}
		UpdateSize();
		search();
	}
	
	private function doShellsChange():void	{
		if (chkShowShells.selected)	{
			chkShowRollStock.enabled = false;
		}
		else	{
			chkShowRollStock.enabled = true;
		}
		search();
	}
	private function doRollStockChanged():void{
		
		if (chkShowRollStock.selected)	{
			chkShowLargeFormatStock.enabled = false;
			chkShowShells.enabled = false;
		}
		else	{
			chkShowLargeFormatStock.enabled = true;
			chkShowShells.enabled = true;
		}
		UpdateSize();
		search();	
	}
	private function doStatus():void{
		var statusWindow:XpdexStockAvailability = XpdexStockAvailability(PopUpManager.createPopUp(this,XpdexStockAvailability,true));
		statusWindow.setStyle("borderAlpha", 0.9);
		var temp:StockDefinition
		temp = dataGrid.selectedItem as StockDefinition;
	 	statusWindow.setStock(temp);
	 }
	 
	 public function setStockArray(data:ArrayCollection)	{
	 	this.stockDefinitions = data;
	 }
	 
	 private function containsBlank(ac:ArrayCollection, field:String)	{
	 	for (var i:int = 0; i<ac.length; i++)	{
	 		if (StringUtil.trim(ac.getItemAt(i)[field] as String) == "")	{
	 			return true;
	 		}
	 	}
	 	return false;
	 }
	public function setStocksData(stockDefs:ArrayCollection, groups:ArrayCollection, types:ArrayCollection,
					finishes:ArrayCollection, colors:ArrayCollection, genericColors:ArrayCollection, 
					grades:ArrayCollection, vendors:ArrayCollection, uoms:ArrayCollection, coated:ArrayCollection):void{
		this.stockDefinitions = stockDefs;
		defaultSortGrid();
		
		if (!containsBlank(groups,"name"))	{
			var group:StockGroup = new StockGroup();
			group.name = "";
			groups.addItemAt(group, 0);
		}
		this.stockGroups = groups;
		if (!containsBlank(types,"name"))	{
			var st:StockType = new StockType();
			st.name = "";
			types.addItemAt(st, 0);
		}
		this.stockTypes = types;
		if (!containsBlank(finishes,"name"))	{
			var fin:StockFinish = new StockFinish();
			fin.name = "";
			finishes.addItemAt(fin, 0);
		}
		this.finishes = finishes;
		if (!containsBlank(colors,"name"))	{
			var col:StockColors = new StockColors();
			col.name = "";
			colors.addItemAt(col, 0);
		}
		this.colors = colors;
		if (!containsBlank(genericColors,"name"))	{
			var gcol:GenericColors = new GenericColors();
			gcol.name = "";
			genericColors.addItemAt(gcol, 0);
		}
		this.genericColors = genericColors;
		if (!containsBlank(grades,"name"))	{
			var gr:StockGrade = new StockGrade();
			gr.name = "";
			grades.addItemAt(gr, 0);
		}
		this.grades = grades;
		if (!containsBlank(vendors,"name"))	{
			var ven:Vendor= new Vendor();
			ven.name = "";
			vendors.addItemAt(ven, 0);
		}
		this.vendors = vendors;
		if (!containsBlank(uoms,"name"))	{
			var u:Object= new Object();
			u.name = "";
			uoms.addItemAt(u, 0);
		}
		this.uoms = uoms;
		if (!containsBlank(coated,"name"))	{
			var u:Object= new Object();
			u.name = "";
			coated.addItemAt(u, 0);
		}
		this.coatedSides = coated;
	}
	public function setStockPref(temp:ArrayCollection):void{
		
		preferencesStockDefinitions = temp;

		var dataSortField:SortField = new SortField();
		dataSortField.name = "columnOrder";
		dataSortField.numeric = true;

		/* Create the Sort object and add the SortField object created earlier to the array of fields to sort on. */
		var numericDataSort:Sort = new Sort();
		numericDataSort.fields = [dataSortField];

		/* Set the ArrayCollection object's sort property to our custom sort, and refresh the ArrayCollection. */
		preferencesStockDefinitions.sort = numericDataSort;
		preferencesStockDefinitions.refresh();

		var dgColumns:ArrayCollection = new ArrayCollection();
		
		for each(var element:PreferencesStockDefinition in preferencesStockDefinitions)
		{
			for each(var column:DataGridColumn in dataGrid.columns)
			{
				if (column.headerText== resourceManager.getString(Snowmass.RESOURCE_BUNDLE, element.columns.name))
				{
					column.visible = element.visible;
					dgColumns.addItem(column);
					break;
				}
			}
		}
		dataGrid.invalidateList();

		var newCols:Array = new Array()
		for each(var newcolumns:DataGridColumn in dgColumns)
		{
			newCols.push(newcolumns)
		}
		dataGrid.columns = newCols;
		dataGrid.invalidateDisplayList();
		dataGrid.invalidateList();

	}
	public function getColorLabel(item:Object, column:DataGridColumn):String{
		var tmpItem:StockColors ;
		tmpItem = item.color as StockColors;
		
		if (tmpItem != null && tmpItem.name != null && tmpItem.name != "") {
			return tmpItem.name;
		} else {
			return "None";
		}
	}   
	
	private function getCompareResult(c1:String, c2:String):int	{
		if (c1.toUpperCase() < c2.toUpperCase())
			return -1;
		if (c1.toUpperCase() > c2.toUpperCase())
			return 1;
		if (c1.toUpperCase() == c2.toUpperCase())
			return 0;
		return 0;		
	}	
	public function sortColor(obj1:Object, obj2:Object):int	{
		var	c1:StockColors = (obj1 as StockDefinition).color;
		var	c2:StockColors = (obj2 as StockDefinition).color;
		
		if (c1 == null)
			return -1;
		if (c2 == null)
			return 1;
			
		return getCompareResult(c1.name, c2.name);
	}
	public function sortGenColor(obj1:Object, obj2:Object):int	{
		var	c1:GenericColors = (obj1 as StockDefinition).genericColor;
		var	c2:GenericColors = (obj2 as StockDefinition).genericColor;
		
		if (c1 == null)
			return -1;
		if (c2 == null)
			return 1;
			
		return getCompareResult(c1.name, c2.name);	
	}

	public function sortFinish(obj1:Object, obj2:Object):int	{
		var	c1:StockFinish = (obj1 as StockDefinition).finish;
		var	c2:StockFinish = (obj2 as StockDefinition).finish;
		
		if (c1 == null)
			return -1;
		if (c2 == null)
			return 1;
		return getCompareResult(c1.name, c2.name);
	}

	public function sortGrade(obj1:Object, obj2:Object):int	{
		var	c1:StockGrade = (obj1 as StockDefinition).grade;
		var	c2:StockGrade = (obj2 as StockDefinition).grade;
		if (c1 == null)
			return -1;
		if (c2 == null)
			return 1;		
		return getCompareResult(c1.name, c2.name);
	}

	public function sortGroup(obj1:Object, obj2:Object):int	{
		var	c1:StockGroup = (obj1 as StockDefinition).stkgroup;
		var	c2:StockGroup = (obj2 as StockDefinition).stkgroup;
		if (c1 == null)
			return -1;
		if (c2 == null)
			return 1;		
		return getCompareResult(c1.name, c2.name);	
	}
	
	
	public function sortVendor(obj1:Object, obj2:Object):int	{
		var	c1:Vendor = (obj1 as StockDefinition).vendor;
		var	c2:Vendor= (obj2 as StockDefinition).vendor;
		if (c1 == null)
			return -1;
		if (c2 == null)
			return 1;		
		return getCompareResult(c1.name, c2.name);	
	}

	public function getSizeLabel(item:Object, column:DataGridColumn):String{
		var tmpItem:Dimension ;
		tmpItem = item.parentsize as Dimension;
		
		if (tmpItem != null && tmpItem.name != null && tmpItem.name != "") {
			return tmpItem.name;
		} else {
			return "None";
		}
	}  
	public function getNormalSizeLabel(item:Object, column:DataGridColumn):String{
		var tmpItem:Dimension ;
		tmpItem = item.normalRunSize as Dimension;
		
		if (tmpItem != null && tmpItem.name != null && tmpItem.name != "") {
			return tmpItem.name;
		} else {
			return "None";
		}
	}    
	public function getGenericColorLabel(item:Object, column:DataGridColumn):String{
		var tmpItem:GenericColors ;
		tmpItem = item.genericColor as GenericColors;
		
		if (tmpItem != null && tmpItem.name != null && tmpItem.name != "") {
			return tmpItem.name;
		} else {
			return "None";
		}
	}   

	public function getFinishLabel(item:Object, column:DataGridColumn):String{
		var tmpItem:StockFinish ;
		tmpItem = item.finish as StockFinish;
		
		if (tmpItem != null && tmpItem.name != null && tmpItem.name != "") {
			return tmpItem.name;
		} else {
			return "None";
		}
	}   

	public function getGradeLabel(item:Object, column:DataGridColumn):String{
		var tmpItem:StockGrade ;
		tmpItem = item.grade as StockGrade;
		
		if (tmpItem != null && tmpItem.name != null && tmpItem.name != "") {
			return tmpItem.name;
		} else {
			return "None";
		}
	}   
	
	public function getGroupLabel(item:Object, column:DataGridColumn):String{
		var tmpItem:StockGroup;
		tmpItem = item.stkgroup as StockGroup;
		
		if (tmpItem != null && tmpItem.name != null && tmpItem.name != "") {
			return tmpItem.name;
		} else {
			return "None";
		}
	}   
	
	public function getVendorLabel(item:Object, column:DataGridColumn):String{
		var tmpItem:Vendor ;
		tmpItem = item.vendor as Vendor;
		
		if (tmpItem != null && tmpItem.name != null && tmpItem.name != "") {
			return tmpItem.name;
		} else {
			return "None";
		}
	}   
	
	private function search():void	{
		clear_button.enabled = true;
		
		var ac:ArrayCollection = stockDefinitions;
		var acFiltered:ArrayCollection = new ArrayCollection();
		if (ac != null)	{
			for (var i:int=0; i<ac.length; i++)	{
				
				var stock:StockDefinition = ac.getItemAt(i) as StockDefinition;
				
				if (stock == null)	
					continue;
					
				if (txtGroup.text != "")	{
					if ((stock.stkgroup != null) 
							&& ((stock.stkgroup as StockGroup).name != null)
							&& (match((stock.stkgroup as StockGroup).name, txtGroup.text,true) == false)	)
							continue;		
				}
				if (txtName.text != "")	{
					if ((stock.name != null) 
							&& (match(stock.name, txtName.text) == false)	)
							continue;	
				}
				if (txtFinish.text != "")	{
					if ((stock.finish != null) 
							&& ((stock.finish as StockFinish).name != null)
							&& (match((stock.finish as StockFinish).name, txtFinish.text, true) == false)	)
							continue;	
				}
				if (txtColor.text != "")	{
					if ((stock.color != null) 
							&& ((stock.color as StockColors).name != null)
							&& (match((stock.color as StockColors).name, txtColor.text, true) == false)	)
							continue;	
				}
				if (txtGrade.text != "")	{
					if ((stock.grade != null) 
							&& ((stock.grade as StockGrade).name != null)
							&& (match((stock.grade as StockGrade).name, txtGrade.text, true) == false)	)
							continue;	
				}
				if (txtMinOrder.text != "")	{
					if (match(stock.minorder, txtMinOrder.text) == false)	
							continue;	
				}
				if (txtVendor.text != "")	{
					if ((stock.vendor != null) 
							&& ((stock.vendor as Vendor).name != null)
							&& (match((stock.vendor as Vendor).name, txtVendor.text, true) == false)	)
							continue;	
				}
				if (txtStockType.text != "")	{
					if ((stock.stktype != null) 
							&& ((stock.stktype as StockType).name != null)
							&& (match((stock.stktype as StockType).name, txtStockType.text, true) == false)	)
							continue;	
				}
				if (txtProductId.text != "")	{
					if (match(stock.id + "" , txtProductId.text) == false)	
							continue;	
				}
				if (txtCoatedSides.text != "")	{
					if ((stock.coated != null) 
							&& (match(stock.coated , txtCoatedSides.text) == false)	)
							continue;	
				}
				if (txtGenericColors.text != "")	{
					if ((stock.genericColor != null) 
							&& ((stock.genericColor as GenericColors).name != null)
							&& (match((stock.genericColor as GenericColors).name, txtGenericColors.text, true) == false)	)
							continue;	
				}
				if (txtThickness.text != "")	{
					if (match(stock.thickness, txtThickness.text) == false)	
							continue;	
				}
				if (txtThicknessUOM.text != "")	{
					if (match(stock.uom, txtThicknessUOM.text, true) == false)	
							continue;	
				}
				if (txtSheetsPerSet.text != "")	{
					if (match(stock.sheetsPerSet, txtSheetsPerSet.text) == false)	
							continue;
				}
				if (txtStockNumber.text != "")	{
					if ((stock.stocknumber != null) 
							&& (match(stock.stocknumber, txtStockNumber.text) == false)	)
							continue;
				}
				if (!chkShowRollStock.selected && !chkShowLargeFormatStock.selected 
					&& (txtSizeMin.text != ""))	{
						if (stock.parentsize != null)	{
							if (matchMin(stock.parentsize, txtSizeMin.text) == false)		
								continue;
							
						}	
				}
				if (!chkShowRollStock.selected && !chkShowLargeFormatStock.selected 
					&& (txtSizeMax.text != ""))	{
						if (stock.parentsize != null)	{
							if (matchMax(stock.parentsize, txtSizeMax.text) == false)		
								continue;						
						}	
				}
				if ((chkShowRollStock.selected || chkShowLargeFormatStock.selected) 
					&& (txtRollWidthMin.text != ""))	{
						if (stock.parentsize != null)	{
							if (matchMin(stock.parentsize.width, txtRollWidthMin.text) == false)		
								continue;						
						}	
				}
				if ((chkShowRollStock.selected || chkShowLargeFormatStock.selected) 
					&& (txtRollWidthMax.text != ""))	{
						if (stock.parentsize != null)	{
							if (matchMax(stock.parentsize.width, txtRollWidthMax.text) == false)		
								continue;						
						}	
				}
				if (txtWeightMax.text != "")	{
					if (matchMax(stock.weight, txtWeightMax.text) == false)	
							continue;
				}
				if (txtWeightMin.text != "")	{
					if (matchMin(stock.weight, txtWeightMin.text) == false)	
							continue;
				}
				if (txtQtyOnHandMax.text != "")	{
					if (matchMax(stock.onHand, txtQtyOnHandMax.text) == false)	
							continue;
				}
				if (txtQtyOnHandMin.text != "")	{
					if (matchMin(stock.onHand, txtQtyOnHandMin.text) == false)	
							continue;
				}
				if (txtCwtMax.text != "")	{
					if (matchMax(stock.cwt1, txtCwtMax.text) == false)	
							continue;
				}
				if (txtCwtMin.text != "")	{
					if (matchMin(stock.cwt1, txtCwtMin.text) == false)	
							continue;
				}
				if (chkShowRigidSubstrate.selected)	{
					if (stock.stockunit != 4)
						continue;
				}
				if (chkShowLargeFormatStock.selected)	{
					if (stock.stockunit != 3)
						continue;
				}
				if (chkShowRollStock.selected)	{
					if (stock.stockunit != 2)
						continue;
				}
				if (chkShowShells.selected)	{
					if (stock.shellItem != null)	{
						var strShellItem:String = "t";
						if (stock.shellItem == false)	
							strShellItem = "f";
						if (match(strShellItem, "t") == false) 	
							continue;
					}
				}	
				if (chkShowInventoriedStock.selected)	{
					if (stock.standardItem != null)	{
						var strStdItem:String = "t";
						if (stock.standardItem == false)	
							strStdItem = "f";
						if (match(strStdItem, "t") == false) 	
							continue;
					}
				}			 
				acFiltered.addItem(stock);
			}
		}
		dataGrid.dataProvider = acFiltered;
		lblCount.text = acFiltered.length + " stocks found";
		
		defaultSortGrid();
	}
	
	private function defaultSortGrid():void	{
		dataGrid.dispatchEvent
			(
				new DataGridEvent
				(
					DataGridEvent.HEADER_RELEASE,
					false,
					true,
					0,	// The zero-based index of the column to sort in the DataGrid object's columns array.
					null,
					0,
					null,
					null,
					0
				)
			);
	}
	private function match(data:Object, searchString:String, exactIfString:Boolean=false):Boolean	{
		if (data is String)	{
			if (!exactIfString)	{
				if ((data as String).toLowerCase().indexOf(StringUtil.trim(searchString).toLowerCase()) == -1)
					return false;
			}
			else	{
				if (StringUtil.trim((data as String).toLowerCase()) != StringUtil.trim(searchString).toLowerCase())
					return false;
			}
		}
		if ((data is int) || (data is Number))	{
			if (Number(searchString) != data)
				return false;
		}
		
		return true;
	}
	
	private function matchMax(data:Object, searchString:String):Boolean	{ 
		if (data is Number)	{
			if (Number(searchString) < Number(data))
				return false;
		}
		if (data is Dimension)	{
			var dataDim:Dimension = data as Dimension;
			var arr:Array = searchString.split("x");
			var wid:Number = parseFloat(StringUtil.trim(arr[0] as String));
			var ht:Number = -1;
			if (arr.length > 1)	{
				ht =  parseFloat(StringUtil.trim(arr[1] as String));
				if ((dataDim.width > wid) || (dataDim.height > ht))
					return false;
			}
			else	{
				if (
						(StringUtil.trim(searchString).charAt(0) == 'x') 
							|| (StringUtil.trim(searchString).charAt(0) == 'X') 
					)	{
							if (dataDim.height > ht)	
								return false;	
					}
				else	{
					 if (dataDim.width > wid)	
						return false;
				}
			} 
		}
		return true;		
	}
	
	private function matchMin(data:Object, searchString:String):Boolean	{
		if (data is Number)	{
			if (Number(searchString) > Number(data))
				return false;
		}
		if (data is Dimension)	{
			var dataDim:Dimension = data as Dimension;
			var arr:Array = searchString.split("x");
			var wid:Number = parseFloat(StringUtil.trim(arr[0] as String));
			var ht:Number = -1;
			if (arr.length > 1)	{
				ht =  parseFloat(StringUtil.trim(arr[1] as String));
				if ((dataDim.width < wid) || (dataDim.height < ht))
					return false;
			}
			else	{
				if (
						(StringUtil.trim(searchString).charAt(0) == 'x') 
							|| (StringUtil.trim(searchString).charAt(0) == 'X') 
					)	{
						
						if (dataDim.height < ht) 
							return false;
					}
				else {
					 if (dataDim.width < wid) 
						return false;	
				}
			} 
		}		
		return true;		
	}
	

	private function sortSize(obj1:Object, obj2:Object):int{
		var dim1:Dimension = (obj1 as StockDefinition).parentsize;
		var dim2:Dimension = (obj2 as StockDefinition).parentsize;
		
		if (dim1 == null)
			return -1;
		if (dim2 == null)
			return 1;
			
		if (dim1.width < dim2.width)
			return -1;
		if (dim1.width > dim2.width)
			return 1;
		else	{
			if (dim1.height < dim2.height)	
				return -1;
			if (dim1.height > dim2.height)
				return 1;
			else
				return 0;
		}
				
		return 0;
	}
	
	private function sortNormal(obj1:Object, obj2:Object):int{
		var dim1:Dimension = (obj1 as StockDefinition).normalRunSize;
		var dim2:Dimension = (obj2 as StockDefinition).normalRunSize;
		
		if (dim1 == null)
			return -1;
		if (dim2 == null)
			return 1;
			
		if (dim1.width < dim2.width)
			return -1;
		if (dim1.width > dim2.width)
			return 1;
		else	{
			if (dim1.height < dim2.height)	
				return -1;
			if (dim1.height > dim2.height)
				return 1;
			else
				return 0;
		}
				
		return 0;
	}
	
	private function toggleSearchBox():void	{
		if (base.getChildByName("searcharea") == null)	{
			base.addChildAt(searcharea, 2);
			showSearchBox.setStyle("icon", downIcon);
			//showSearchBox.label = "Show Search";
		}
		else	{
			base.removeChild(searcharea);
			showSearchBox.setStyle("icon", upIcon);
			//showSearchBox.label = "Hide Search";
		}
	} 

]]>        
</mx:Script> 

	<mx:VBox id="base" width="100%" height="100%" creationPolicy="all">
		<mx:HBox id="toolbar" width="100%" height="5%" >
			<mx:Button label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.SelectStock')}" id="select_button" enabled="{(dataGrid.selectedItem != null) &amp;&amp; dataGrid.selectedItems.length==1}" click="selectStockDefinition();"  width="12%" />
			<mx:Button label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.ClearSearch')}" click="clearSearch();" id="clear_button" width="100" x="118" y="10" enabled="false"/>
			<mx:Button label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.New')}" enabled="true" click="newStockDefinition();" id="new_button" width="12%" />
			<mx:Button label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'consoleCmd.WebStatus')}" width="12%" id="status_button" click="doStatus()"/>
			<mx:Spacer width="6%" />
			<mx:Button label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Cancel')}" click="cancelPicker();" id="cancel_button" width="12%" />
			<components:CustomDeleteButtonComponent
				label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Delete')}" 
				id="select_button0" enabled="{(dataGrid.selectedItem != null)}" isIcon="false" clickFuncName="deleteStockDefinition" width="12%"
				deleteLabel="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'changePriceCmd.StockDefinitions')}"/>
			<!--<mx:Button label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Delete')}" id="select_button0" enabled="{(dataGrid.selectedItem != null)}" click="deleteStockDefinition();" width="12%" />-->
		</mx:HBox>
		<mx:LinkButton id="showSearchBox" click="toggleSearchBox();" textAlign="left" label="Search Stocks" width="100%" height="5%"/>
		<mx:HBox id="searcharea" width="100%" height="30%" >
			<mx:Form id="col1" width="30%" >
				<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Group')}" width="100%">
					<mx:ComboBox width="100%" id="txtGroup" dataProvider="{stockGroups}" labelField="name" change="search();"/>
				</mx:FormItem>
				<mx:Label width="100%" height="10%" />
				<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Name')}" width="100%">
					<mx:TextInput id="txtName" width="100%" change="search();"/>
				</mx:FormItem>
				<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Finish')}" width="100%">
					<mx:ComboBox width="100%" id="txtFinish" dataProvider="{finishes}" labelField="name"  change="search();"/>
				</mx:FormItem>
				<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Color')}" width="100%" >
					<mx:ComboBox width="100%" id="txtColor" dataProvider="{colors}" labelField="name" change="search();"/>
				</mx:FormItem>
				<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Grade')}" width="100%">
					<mx:ComboBox width="100%" id="txtGrade" dataProvider="{grades}" labelField="name" change="search();"/>
				</mx:FormItem>
				<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.MinimumOrder')}" width="100%" >
					<mx:TextInput id="txtMinOrder" width="100%" change="search();"/>
				</mx:FormItem>
				<mx:Label width="100%" height="10%" />
				<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Vendor')}" width="100%" >
					<mx:HBox width="100%">
						<mx:ComboBox width="90%" id="txtVendor" dataProvider="{vendors}" labelField="name" change="search();"/>
						<mx:Image width="10%" visible="false" source="assets/WebStatus.png" id="web_status"/>
					</mx:HBox>
				</mx:FormItem>				
			</mx:Form>
			<mx:Form id="col2" width="30%" >
				<mx:FormItem label="Type" width="100%">
					<mx:ComboBox width="100%" id="txtStockType" dataProvider="{stockTypes}" labelField="name" change="search();"/>
				</mx:FormItem>
				<mx:Label width="100%" height="10%" />
				<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.ProductID')}" width="100%">
					<mx:TextInput width="100%" id="txtProductId" change="search();"/>
				
				</mx:FormItem>
				<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.CoatedSides')}" width="100%">
					<mx:ComboBox width="100%"  id="txtCoatedSides" dataProvider="{coatedSides}" labelField="name" change="search();"/>
				
				</mx:FormItem>
				<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.GenericColor')}" width="100%">
					<mx:ComboBox width="100%"  id="txtGenericColors" dataProvider="{genericColors}" labelField="name" change="search();"/>
				
				</mx:FormItem>
				<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Thickness')}" width="100%">
					<mx:HBox width="100%">
						<mx:TextInput  width="25%" id="txtThickness" change="search();"/>
						<mx:ComboBox  width="75%" id="txtThicknessUOM" dataProvider="{uoms}" labelField="name" change="search();"/>	
					</mx:HBox>
				
				</mx:FormItem>
				<mx:FormItem label="# Sheets/Set" width="100%">
					<mx:TextInput width="100%" id="txtSheetsPerSet" change="search();"/>
				
				</mx:FormItem>
				<mx:Label width="100%" height="10%" />
				<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.StockNumber')}" width="100%">
					<mx:TextInput width="100%"  id="txtStockNumber" change="search();"/>
				</mx:FormItem>
			</mx:Form>

			<mx:VBox id="rtPane" width="40%" height="100%" verticalGap="1" horizontalAlign="left" >
				
				<mx:Form width="80%" height="50%" verticalGap="1">
					<mx:FormItem width="100%" >
						<mx:HBox width="100%">
							<mx:Label width="50%" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Min')}" textAlign="center"/>
							<mx:Label width="50%" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Max')}" textAlign="center"/>
						</mx:HBox>
					</mx:FormItem>
					<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Size')}" width="100%">
						<mx:HBox width="100%">
							<mx:TextInput width="50%"   id="txtSizeMin" change="search();"/>
							<mx:TextInput width="50%"  id="txtSizeMax" change="search();"/>
						</mx:HBox>
					</mx:FormItem>
					<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Weight')}" width="100%">
						<mx:HBox width="100%">
							<mx:TextInput width="50%" id="txtWeightMin" change="search();"/>
							<mx:TextInput width="50%" id="txtWeightMax" change="search();"/>
						</mx:HBox>
					</mx:FormItem>
					<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.CWT')}" width="100%">
						<mx:HBox width="100%">
							<mx:TextInput width="50%" id="txtCwtMin" change="search();"/>
							<mx:TextInput width="50%" id="txtCwtMax" change="search();"/>
						</mx:HBox>
					</mx:FormItem>
					<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.QtyOnHand')}" width="100%">
						<mx:HBox width="100%">
							<mx:TextInput width="50%" id="txtQtyOnHandMin" change="search();"/>
							<mx:TextInput width="50%" id="txtQtyOnHandMax" change="search();"/>
						
						</mx:HBox>
					</mx:FormItem>
					<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.RollWidth')}" width="100%">
						<mx:HBox width="100%">
							<mx:TextInput width="50%" enabled="false" id="txtRollWidthMin" change="search();"/>
							<mx:TextInput width="50%" enabled="false" id="txtRollWidthMax" change="search();"/>
						</mx:HBox>
					</mx:FormItem>
					
					
				</mx:Form>
				
				<mx:VBox width="80%" height="50%" verticalGap="1">
					<mx:CheckBox  height="20%" width="100%" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.ShowRollStock')}" id="chkShowRollStock" change="doRollStockChanged();"/>
					<mx:CheckBox height="20%" width="100%" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.ShowLargeFormatStock')}" id="chkShowLargeFormatStock" change="doLargeFormatChange();"/>
					<mx:CheckBox height="20%" width="100%"  label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.ShowRigidSubstrate')}" id="chkShowRigidSubstrate" change="doLargeFormatChange();"/>
					<mx:CheckBox height="20%" width="100%"  label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.ShowInventoriedStock')}" id="chkShowInventoriedStock" change="search();"/>
					<mx:CheckBox height="20%" width="100%"  label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.ShowShellsAccount0')}" id="chkShowShells" change="doShellsChange();"/>
				</mx:VBox>
				
			</mx:VBox>
		</mx:HBox>

		<mx:DataGrid id="dataGrid" width="100%" height="90%" dataProvider="{stockDefinitions}"
		doubleClickEnabled="true" allowMultipleSelection="true" doubleClick="selectStockDefinition()" verticalScrollPolicy="auto" horizontalScrollPolicy="on" showHeaders="true" backgroundColor="#FFFFFF" borderStyle="solid" borderThickness="3" right="0" left="0" bottom="0" top="273" change="doEnableWebStatus();">               
		<mx:columns>
		     <mx:DataGridColumn dataField="name" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Name')}" width="100"/>
		     <mx:DataGridColumn dataField="weight" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Weight')}"/>
		     <mx:DataGridColumn labelFunction ="getSizeLabel" sortCompareFunction="sortSize" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Size')}"/>
		     <mx:DataGridColumn labelFunction="getColorLabel" sortCompareFunction="sortColor" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Color')}"/>
		     <mx:DataGridColumn labelFunction="getGenericColorLabel" sortCompareFunction="sortGenColor" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.GenericColor')}"/>
		     <mx:DataGridColumn labelFunction="getFinishLabel" sortCompareFunction="sortFinish" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Finish')}"/>
		     <mx:DataGridColumn dataField="thickness" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Thickness')}"/>
		     <mx:DataGridColumn labelFunction="getGradeLabel" sortCompareFunction="sortGrade" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Grade')}"/>
		     <mx:DataGridColumn dataField="cwt1" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.CWT')}"/>
		     <mx:DataGridColumn labelFunction="getVendorLabel" sortCompareFunction="sortVendor" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Vendor')}"/>
		     <mx:DataGridColumn dataField="stocknumber" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.StockNumber')}"/>
		     <mx:DataGridColumn dataField="id" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.ProductID')}"/>
		     <mx:DataGridColumn dataField="onHand" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.QtyOnHand')}"/>
		     <mx:DataGridColumn dataField="committed" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Committed')}"/>
		     <mx:DataGridColumn dataField="onOrder" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Ordered')}"/>
		     <mx:DataGridColumn dataField="shellItem" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Shell')}"/>
		     <mx:DataGridColumn  labelFunction="getNormalSizeLabel" sortCompareFunction="sortNormal" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.RunSize')}"/>
		     <mx:DataGridColumn dataField="basicsize" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.BasicSize')}"/>
		     <mx:DataGridColumn labelFunction="getGroupLabel" sortCompareFunction="sortGroup" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Group')}"/>
		     <mx:DataGridColumn dataField="coated" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.CoatedSides')}"/>
		     <mx:DataGridColumn dataField="minorder" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.MinimumOrder')}"/>
		     <mx:DataGridColumn dataField="cost1" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Price')}"/>
		     <mx:DataGridColumn dataField="priceExpires" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.PriceExpires')}"/>
		     <mx:DataGridColumn dataField="forestManagement" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.ForestMgmt')}"/>
		     <mx:DataGridColumn dataField="pcwRecycledPercent" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.Recycle')}"/>
		     <mx:DataGridColumn dataField="fscCertified" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.FSC')}"/>
		     <mx:DataGridColumn dataField="sfiCertified" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.SFI')}"/>
		     <mx:DataGridColumn dataField="greenSealCertified" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'stockPickerCmd.GreenSeal')}"/>
		</mx:columns>
		</mx:DataGrid>
		<mx:Label height="5%" id="lblCount" />
	</mx:VBox>
	
	
</mx:TitleWindow>