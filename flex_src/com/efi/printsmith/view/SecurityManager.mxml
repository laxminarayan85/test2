<?xml version="1.0" encoding="utf-8"?>
<mx:Panel xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute" width="100%" height="100%"
	title="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rStandardMenuText.SecuritySetup')}" 
	label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rStandardMenuText.SecuritySetup')}" 
	xmlns:ns1="com.adobe.flex.extras.controls.*" xmlns:fc="http://www.adobe.com/2006/fc"
	headerHeight="0" 
	implements="com.efi.printsmith.security.ISecureComponent" preinitialize="preInit();"
	xmlns:ns2="flexlib.controls.*" 
	 >
	<mx:states>
		<mx:State name="newItem">
			<mx:RemoveChild target="{button1}"/>
			<mx:RemoveChild target="{label1}"/>
			<mx:RemoveChild target="{button2}"/>
			<mx:RemoveChild target="{label2}"/>
			<mx:RemoveChild target="{label3}"/>
			<mx:RemoveChild target="{button3}"/>
			<mx:AddChild position="lastChild">
				<mx:TextInput x="315" y="24" id="txtNewItem" focusOut="doAccessGroupEdit();"/>
			</mx:AddChild>
			<mx:AddChild position="lastChild">
				<mx:Label x="208" y="26" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'usecCmd.AccessGroup')}" textAlign="right" width="99"/>
			</mx:AddChild>
			<mx:RemoveChild target="{button4}"/>
			<mx:RemoveChild target="{label4}"/>
			<mx:AddChild position="lastChild">
				<mx:Button x="502" y="24" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.OK')}" click="doOKNewGroup();"/>
			</mx:AddChild>
			<mx:AddChild position="lastChild">
				<mx:Button x="626" y="24" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Cancel')}" click="doCancelNewGroup();"/>
			</mx:AddChild>
		</mx:State>
	</mx:states>
	 
<mx:RemoteObject id="dataService" destination="dataService">
	<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveResult(event)"/>
	<mx:method name="getAll" fault="handleFault(event)" result="handleLoadResult(event)"/>
	<mx:method name="deleteItem" fault="handleFault(event)" result="handleDeleteResult(event)"/>
</mx:RemoteObject>
<mx:RemoteObject id="SecuritydataService" destination="dataService">
	<mx:method name="getByAccessGroup" fault="handleFault(event)" result="handleLoadSecurityResult(event)"/>
	<mx:method name="getFromParent" fault="handleFault(event)" result="handleLoadSecurityResult(event)"/>
	<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveSecurityResult(event)"/>
</mx:RemoteObject>
<mx:RemoteObject id="dataServiceSecurityCommands" destination="dataService">
	<mx:method name="getAll" fault="handleFault(event)" result="handleLoadSecurityCommandsResult(event)"/>
</mx:RemoteObject>

	<mx:Producer id="producer" destination="accessgroup"/>
	<mx:Consumer id="consumer" destination="accessgroup" message="messageHandler(event.message)"/>
	<mx:Consumer id="notification_consumer" destination="notifications" message="messageHandler(event.message)"/>
<mx:Script source="../security/PSSecurityInclude.as" />


<mx:Script>  	
<![CDATA[
	import mx.events.FlexEvent;
	import com.efi.printsmith.security.PSSecurityCommands;
	import com.efi.mdi.view.window.MDIWindow;
	import com.adobe.cairngorm.commands.Command;
	import mx.containers.Panel;
	import mx.managers.PopUpManager;
	import flash.net.navigateToURL;
 	import com.efi.printsmith.data.AccessGroup;
 	import mx.collections.ArrayCollection;   
	import mx.containers.TitleWindow; 
	import mx.rpc.events.ResultEvent;                                         
	import mx.rpc.events.FaultEvent;
	import com.efi.printsmith.data.SecuritySetup;
	import com.efi.printsmith.data.SecurityCommands;                                 
    import mx.events.DataGridEvent;
    import mx.events.DataGridEventReason;
	import mx.messaging.messages.AsyncMessage;
	import mx.messaging.messages.IMessage;
	import mx.utils.StringUtil;
 	
 	[Bindable]
   	private var accessGroupLists:ArrayCollection = new ArrayCollection();
   	
   	private var securitySetupLists:ArrayCollection = new ArrayCollection();
    
    [Bindable]
   	private var securityCommandsLists:ArrayCollection = new ArrayCollection();
	
	[Bindable]                             
	private var access:AccessGroup;  
	
	[Bindable]                             
	private var rename:Boolean;   
	
	[Bindable]                             
	private var org_pos:int;   
	
	[Bindable]                             
	private var security:SecuritySetup;     
	
	[Bindable]
	private var securityCommands:SecurityCommands;
	
	private var rawSecurityCommands:ArrayCollection;
	private var _commandsRecd:Boolean = false;
	private var _setupRecd:Boolean = false;
			
	           
	public function getSecurityCommand():String {
		return PSSecurityCommands.ADMIN_SECURITYSETUP;
	}		
	public function init(event:FlexEvent=null):void {
		consumer.subscribe();
		notification_consumer.subscribe();
	//	PopUpManager.centerPopUp(this);

		var mdiWin:MDIWindow = Snowmass.getInstance().containerManager.getWindowWithChild(this);
		mdiWin.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rStandardMenuText.SecuritySetup');
	              
		dataService.getAll("AccessGroup"); 
		dataServiceSecurityCommands.getAll("SecurityCommands");
		
	}                

	private function handleFault(ev:FaultEvent):void {      
		var message:String;                         
		message = "Error: " + ev.fault.faultCode + " \n "                                            
		+ "Detail: " + ev.fault.faultDetail + " \n "                              
		+ "Message: " + ev.fault.faultString;                                    
	}

	private function handleLoadResult(ev:ResultEvent):void {
		accessGroupLists = ev.result as ArrayCollection;
		if (access == null){
			access = accessGroupLists.getItemAt(0,0) as AccessGroup;
			this.tvAccessGroups.selectedIndex = 0
		}
		SecuritydataService.getFromParent("SecuritySetup", "accessgroup",access.id);
	}

	private function handleSaveResult(ev:ResultEvent):void {
		mapToSecurityData();
	}	
	private function handleDeleteResult(ev:ResultEvent):void{
		dataService.getAll("AccessGroup");
	}
	private function handleSaveSecurityResult(ev:ResultEvent):void {
	}	
	
	private function handleLoadSecurityResult(ev:ResultEvent):void {
		securitySetupLists = ev.result as ArrayCollection;
		setupRecd = true;
//		if (securitySetupLists != null)
//			if (securitySetupLists.length == 0){
//				addCommands();
//			}
//		
//		dataGrid.invalidateDisplayList();
//		ArrayCollection(dataGrid.dataProvider).refresh();
	}	

    private function filterForTestData(item:Object):Boolean{
		if(item.commandName!="rStandardMenuText.1") return true;
			else return false;      
	}

	private function handleLoadSecurityCommandsResult(ev:ResultEvent):void {
		rawSecurityCommands = ev.result as ArrayCollection;
//		if (rawSecurityCommands != null)	{
//			for (var i:int=0; i<rawSecurityCommands.length; i++)	{
//				var sc:SecurityCommands = rawSecurityCommands.getItemAt(i) as SecurityCommands;
//				if (sc.commandName == "rStandardMenuText.1")	{
//					rawSecurityCommands.removeItemAt(i);
//					continue;
//				}			
//				sc["enable"] = false;
//			}
//		}
		
		commandsRecd = true;
	}	
	
	private function set commandsRecd(val:Boolean): void	{
		_commandsRecd = val;
		if (_commandsRecd && _setupRecd)	{
			populateDataProvider();
		}
	}
	private function set setupRecd(val:Boolean): void	{
		_setupRecd = val;
		if (_commandsRecd && _setupRecd)	{
			populateDataProvider();
		}
	}
	
	private function populateDataProvider():void	{
		for (var i:int=0; i<rawSecurityCommands.length; i++)	{
			var sc:SecurityCommands = rawSecurityCommands.getItemAt(i) as SecurityCommands;
			if (sc.commandName == "rStandardMenuText.1")	{
				rawSecurityCommands.removeItemAt(i);
				continue;
			}
			sc["enable"] = false;
			for (var j:int=0; j <securitySetupLists.length; j++)	{
				var ss:SecuritySetup = securitySetupLists.getItemAt(j) as SecuritySetup;
				if (ss.securityCmd.commandId == sc.commandId)	{
					sc["enable"] = true;
					break;
				}
			} 
		}
		securityCommandsLists = rawSecurityCommands;
	}
  	private function messageHandler(message:IMessage):void
	{
		var messageBody:Object = message.body;// as com.efi.messaging.MessageBody;
		
		var messageType:String = messageBody.messageType;
		if (messageType == "ADDUPDATE" || messageType == "DELETE") {
			var payloadType:String = messageBody.payloadType as String; // What kind of item was added/deleted
			var payload:Number = messageBody.payload as Number; // ID if item added or deleted
			if (payloadType == "AccessGroup") {
				dataService.getAll("AccessGroup"); 
			}
		}
	}

    private function tree_labelFunc(item:Object):String {
        return item.name;
    }

	private function mapToSecurityData():void{
		var i:int;
		for (i= 0 ; i < securitySetupLists.length ; i++)
		{
			security = securitySetupLists.getItemAt(i,0) as SecuritySetup;
		 	SecuritydataService.addUpdate(security);
		}
	
	}   

	private function mapToAccessGroup():void{
		dataService.addUpdate(access);
	}

	private function addCommands():void{
		for each(var item:SecurityCommands in securityCommandsLists){
			security = new SecuritySetup();
			security.accessGroup = access;
			security.commandName = item.commandName;
			security.commandId = item.commandId;
			security.menu = item.menu;
			security.enable = false;
		 	securitySetupLists.addItem(security);
		} 

	}
	public function doSave():void {                                    
		mapToAccessGroup()
	}  
	public function doAccessGroupEdit():void{ 
		var index:int;
		if (rename == true){
			if (txtNewItem.text != access.name)
			{
				index = findItem(txtNewItem.text,accessGroupLists)
				if( index == -1){
					access.name = txtNewItem.text;
					rename = false;
					this.currentState = "";
					accessGroupLists.setItemAt(access,org_pos);
				}
				else{
					txtNewItem.text= ""
					doRename();
				}
			}
			this.currentState = "";
		}else{
			index = findItem(txtNewItem.text,accessGroupLists)
			if( index == -1){
				addItem(txtNewItem.text);
			}
			else{
				doNew();
			}
		}
		
	}
	public function doNew():void {
		this.currentState = "newItem";
		txtNewItem.text= "";
		
	} 
	
	public function doOKNewGroup():void {
		if (this.rename == false)
			this.access = new AccessGroup();
		this.access.name = txtNewItem.text;
		this.currentState = "";
		this.mapToAccessGroup();
		this.rename = false;
	}
	
	public function doCancelNewGroup():void {
		this.rename = false;
		this.currentState = "";
	}
	
	public function doRename():void{
		//var access:AccessGroup = event.currentTarget.selectedItem as AccessGroup
		this.currentState = "newItem";
		rename = true;
		txtNewItem.text= access.name;
		org_pos = findItem(access.name , accessGroupLists);
	}
	private function findItem(name:String, array:ArrayCollection):int {
		for each(var element:Object in array) {
			if (name == element.name) {
				return array.getItemIndex(element);
			}
		}
		return -1;
	}
  
	public function doDelete():void{
		var index:int;
		index = findItem(access.name, accessGroupLists);
		accessGroupLists.removeItemAt(index);
		dataService.deleteItem("AccessGroup", access.id);
		
	}
	private function addItem(itemName:String):void {
		this.currentState = "";
		if (itemName != '') {
			securitySetupLists.removeAll();
			access = new AccessGroup();
			access.name = itemName;
			accessGroupLists.addItem(access)
			this.tvAccessGroups.selectedIndex = accessGroupLists.length;
			addCommands();                      
		}		
	}
	private function treeSelect(event:Event):void {
	    access = event.currentTarget.selectedItem as AccessGroup
		if (access!=null)
			SecuritydataService.getFromParent("SecuritySetup", "accessgroup",access.id);
	}

	private function gridDisplayLabelCommand(item:Object, column:DataGridColumn):String{
		var tmpItem:SecurityCommands = item as SecurityCommands;
		var returnvalue:String = "";
		if (tmpItem != null) {
			returnvalue = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, tmpItem.commandName.toString())
			if(returnvalue == null){ 
				returnvalue = "\t"+resourceManager.getString(Snowmass.RESOURCE_BUNDLE, StringUtil.trim(tmpItem.commandName.toString()))
			}
		} else {
			returnvalue="Item Not Found"
		}
		return returnvalue;
	}
	private function gridDisplayLabelMenu(item:Object, column:DataGridColumn):String{
		var tmpItem:SecurityCommands = item as SecurityCommands;
		var returnvalue:String = "";
		if (tmpItem != null) {
			returnvalue = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, tmpItem.menu.toString())
			if(returnvalue == null){
				"\t"+resourceManager.getString(Snowmass.RESOURCE_BUNDLE, StringUtil.trim(tmpItem.menu.toString()))
			}
		} else {
			returnvalue="Item Not Found"
		}
		return returnvalue;
	}

]]>
</mx:Script>
	
		<mx:Button x="215" y="10" width="38" height="38" click="doSave();"  id="button2">
			<mx:icon>@Embed(source='../../../../assets/file.png')</mx:icon>
		</mx:Button>
		<mx:Label x="215" y="46" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Save')}" width="38" textAlign="center" id="label2"/>
		<mx:Button x="264" y="10" width="38" height="38"  click="doNew()" id="button3">
			<mx:icon>@Embed(source='../../../../assets/new.png')</mx:icon>
		</mx:Button>
		<mx:Button x="310" y="10" width="38" height="38" id="button1" click="doDelete();">
			<mx:icon>@Embed(source='../../../../assets/delete.png')</mx:icon>
		</mx:Button>
		<mx:Label x="310" y="46" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Delete')}" width="47" textAlign="center" id="label1"/>
		<mx:Label x="264" y="46" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.New')}" width="38" textAlign="center" id="label3"/>
		<mx:VBox bottom="0" right="0" left="200" top="80">
			<mx:DataGrid id="dataGrid"  
				dataProvider="{securityCommandsLists}"  sortableColumns="false" width="100%" height="100%" editable="true">
				<mx:columns> 
					<mx:DataGridColumn  sortable="false" width="50"  textAlign="center" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'mensecCmd.Enabled')}" dataField="enable"
						editorDataField="selected"
							itemEditor="mx.controls.CheckBox">
					   <mx:itemRenderer>
					      <mx:Component>
					         <mx:CheckBox click="data.enable=!data.enable"  selected="{data.enable}"/>
					      </mx:Component>						
					   </mx:itemRenderer> 
					</mx:DataGridColumn>

						<mx:DataGridColumn  sortable="false" width="300" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'mensecCmd.Menu')}" labelFunction="gridDisplayLabelMenu"  editable="false"/>
						<mx:DataGridColumn  sortable="false" width="300" headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'mensecCmd.CommandName')}" labelFunction="gridDisplayLabelCommand" editable="false"/>
				</mx:columns>
			</mx:DataGrid>

		</mx:VBox>
		<mx:HBox x="0" y="0" width="200" height="100%">
				<mx:Tree id="tvAccessGroups" width="100%" height="100%" 
					change="treeSelect(event);" 
    		        dataProvider="{accessGroupLists}"
		            labelFunction="tree_labelFunc"
				></mx:Tree>
		</mx:HBox>
		<mx:Button x="365" y="10" label="Button" height="38" width="38" click="doRename();" id="button4">
			<mx:icon>@Embed(source='../../../../assets/rename.png')</mx:icon>
		</mx:Button>
		<mx:Label x="365" y="46" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'mensecCmd.Rename')}" width="59" id="label4"/>
		
		
</mx:Panel>