<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow 
	xmlns:mx="http://www.adobe.com/2006/mxml" 
	layout="absolute" 
	width="100%" 
	height="100%"
	headerHeight="0" 
	title="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CashRegister')}" 
	label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CashRegister')}" 
	name="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CashRegister')}" 
	creationComplete="init()" 
	xmlns:components="com.efi.printsmith.components.*" 
	xmlns:vo="com.efi.printsmith.vo.*">

	<mx:CurrencyFormatter precision="2" id="currencyFormatter"/>
	<mx:NumberFormatter precision="2" id="numberFormatter"/>
	<mx:NumberFormatter precision="0" id="quantityFormatter"/>
	
 	<mx:states>
 	 	<mx:State name="invoiceState">
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="40" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Invoice')}" id="invstate_label1"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="38" y="35" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.TotalDue')}" id="invstate_label2"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="31" y="60" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Description')}" id="invstate_label3"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:TextInput x="105" y="8" width="75" id="txtInvoiceNumber"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:TextInput x="105" y="33" width="75" id="txtInvoiceTotalDue"/>
 	 	 	</mx:AddChild>


 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="68" y="110" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Paid')}" id="invstate_label4"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="46" y="135" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.StillDue')}" id="invstate_label5"/>
 	 	 	</mx:AddChild>

 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:TextInput x="105" y="108" width="75" id="txtInvoicePaid"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:TextInput x="105" y="133" width="75" id="txtInvoiceStillDue"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:SetProperty target="{pickTaxTable}" name="enabled" value="false"/>
 	 	 	<mx:SetProperty target="{pickTaxCode}" name="enabled" value="false"/>
 	 	 	<mx:SetEventHandler target="{tax_canvas1}" name="activate"/>
 	 	 	<mx:SetProperty target="{chkNonTax}" name="enabled" value="false"/>

 	 	</mx:State>
 	 	<mx:State name="paymentState">
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Label x="46" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Quantity')}" id="label1"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Label x="41" y="35" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.UnitPrice')}" id="label2"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Label x="65" y="60" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Total')}" id="label3"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:TextInput  restrict="0-9\." x="105" y="8" width="75" id="txtPaymentQuantity" text="{numberFormatter.format(itemQty)}" focusOut="UpdateCashRegister()"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:TextInput  restrict="0-9\."  x="105" y="33" width="75" id="txtPaymentUnitPrice" text="{numberFormatter.format(itemUnitPrice)}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:TextInput restrict="0-9\."  x="105" y="58" width="75" id="txtPaymentTotal" text="{numberFormatter.format(itemTotal)}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="86" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Description')}" id="label4"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:TextArea x="10" y="112" width="170" height="62" id="txtPaymentDescription"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:SetProperty target="{chkNonTax}" name="enabled" value="true"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="x" value="10"/>
 	 	 	<mx:SetProperty target="{subtotal_edit}" name="editable" value="false"/>
 	 	 	<mx:SetProperty target="{tax_edit}" name="editable" value="false"/>
 	 	 	<mx:SetProperty target="{total_edit}" name="editable" value="false"/>
 	 	 	<mx:SetProperty target="{tender_edit}" name="editable" value="false"/>
 	 	 	<mx:SetProperty target="{change_edit}" name="editable" value="false"/>
 	 	</mx:State>
 	 	<mx:State name="invoicePaymentMethod" basedOn="invoiceState">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="65" y="154" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Amount')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="152" width="75"/>
 	 	 	</mx:AddChild>
 	 	</mx:State>
 	 	<mx:State name="paymentPaymentMethod" basedOn="paymentState">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="65" y="154" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Amount')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput  restrict="0-9\." x="121" y="152" width="75" id="payment_cash_edit" change="UpdateBatchNumbers()"/>
 	 	 	</mx:AddChild>
 	 	</mx:State>
 	 	<mx:State name="paymentCash" basedOn="paymentPaymentMethod">
 	 	 	<mx:SetProperty target="{button1}" name="y" value="608"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="y" value="420"/>
 	 	 	<mx:SetProperty name="height" value="760"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="width" value="668"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="x" value="0"/>
 	 	</mx:State>
 	 	<mx:State name="paymentCreditCard" basedOn="paymentPaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="90" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.CardType')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="72" y="116" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.Ref')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:ComboBox x="76" y="88" width="171"  labelField="cardType" dataProvider="{creditCardPreferencesArray}" id="card_type"></mx:ComboBox>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="114" width="75"  id="card_ref"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="x" value="0"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="y" value="414"/>
 	 	 	<!--<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild" target="{checkbox1}"/>
 	 	 	<mx:SetProperty target="{checkbox1}" name="x" value="267"/>
 	 	 	<mx:SetProperty target="{checkbox1}" name="y" value="230"/>-->
 	 	</mx:State>
 	 	<mx:State name="paymentCheck" basedOn="paymentPaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="62" y="116" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.Check')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="114" width="75" id="check_num"/>
 	 	 	</mx:AddChild>
 	 	</mx:State>
 	 	<mx:State name="paymentCharge" basedOn="paymentPaymentMethod"/>
 	 	<mx:State name="invoiceCash" basedOn="invoicePaymentMethod">
 	 	</mx:State>
 	 	<mx:State name="invoiceCreditCard" basedOn="invoicePaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="90" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.CardType')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="72" y="116" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.Ref')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:ComboBox x="76" y="88" width="120"></mx:ComboBox>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="114" width="75"/>
 	 	 	</mx:AddChild>
 	 	</mx:State>
 	 	<mx:State name="invoiceCheck" basedOn="invoicePaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="62" y="116" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.Check')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="114" width="75"/>
 	 	 	</mx:AddChild>
 	 	</mx:State>
 	 	<mx:State name="invoiceCharge" basedOn="invoicePaymentMethod">
 	 	</mx:State>
 	</mx:states>
 
 	<mx:RemoteObject id="dataService" destination="dataService">
 		<mx:method name="getAccountPicker" fault="handleFault(event)" result="handleLoadAccountsResult(event)"/>
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadResult(event)"/>
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveResult(event)"/>
		<mx:method name="getAccount" fault="handleFault(event)" result="handleGetResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceUnPurchase" destination="dataService">
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveUnPurchaseResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceCashDrawer" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadCashDrawerResult(event)"/>
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveCashDrawerResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceTape" destination="dataService">
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveTapeResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceCashRegisterBatch" destination="dataService">
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleBatchSaveResult(event)"/>
	</mx:RemoteObject>
 	<mx:RemoteObject id="dataServiceTaxCodes" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadTaxCodesResult(event)"/>
	</mx:RemoteObject>
 	<mx:RemoteObject id="dataServiceTaxTable" destination="dataService">
		<mx:method name="getCurrentTaxTables" fault="handleFault(event)" result="handleLoadTaxTableResult(event)"/>
	</mx:RemoteObject>

	<mx:RemoteObject id="dataServiceSystemPreferences" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadSystemPreferencesResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceCashPreferences" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadCashRegPreferencesResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="taxCalculatorService" destination="taxService">
		<mx:method name="calculateTax" fault="handleFault(event)" result="handleTaxResult(event)"/>
	</mx:RemoteObject>
<mx:RemoteObject id="dataServiceCreditCardPreferences" destination="dataService">
	<mx:method name="getAll" fault="handleFault(event)" result="handleLoadCreditCardPreferencesResult(event)"/>
</mx:RemoteObject>
	<mx:Producer id="producer" destination="cashregister"/>
	<mx:Consumer id="consumer" destination="cashregister" message="messageHandler(event.message)"/>
	<mx:Consumer id="notification_consumer" destination="notifications" message="messageHandler(event.message)"/>
<mx:Script>
<![CDATA[
	import com.efi.mdi.view.window.MDIWindow;
	import com.efi.printsmith.data.CashDrawer;
	import com.efi.printsmith.data.Tape;
	import com.efi.printsmith.data.UnpurchasedMerchandise;
	import com.hillelcoren.utils.ArrayCollectionUtils;
	import com.efi.printsmith.data.PreferencesCashRegister;
	import mx.events.StateChangeEvent;
	import mx.controls.Text;

	import com.efi.printsmith.data.TaxTable;
	import com.efi.printsmith.data.TaxCodes;
	import com.efi.printsmith.data.CashRegister;
	import com.efi.printsmith.data.CashRegisterBatch;
	import com.efi.printsmith.data.PreferencesSystem;
	import com.efi.printsmith.events.AccountPickerSelectEvent;
	import com.efi.printsmith.data.PreferencesCreditCard;
	import com.efi.printsmith.data.Account;
	import com.efi.printsmith.data.UnpurchasedMerchandise;

	import mx.controls.Alert;                                         
	import mx.managers.PopUpManager;                                         
	import mx.containers.TitleWindow;                                         
	import mx.collections.ArrayCollection;                                         
	import mx.rpc.events.ResultEvent;                                         
	import mx.rpc.events.FaultEvent;                                         
	import mx.messaging.messages.AsyncMessage;
	import mx.messaging.messages.IMessage;
	import mx.collections.XMLListCollection;

	[Bindable]
	private var enableSave:Boolean = true;

	[Bindable]                                         
    private var systemPreferences:PreferencesSystem;
    [Bindable]  
 	private var accounts:ArrayCollection = new ArrayCollection();
	[Bindable]                                
	private var systemPreferencesArray:ArrayCollection = new ArrayCollection();

	[Bindable]
	private var cashRegisterTransacations:ArrayCollection = new ArrayCollection();
	[Bindable]
	private var systemCashPreferencesArray:ArrayCollection = new ArrayCollection();
	
	[Bindable]
	private var itemQty:String;
	[Bindable]
	private var customerAccount:Account;
	[Bindable]
	private var itemUnitPrice:Number;
	[Bindable]
	private var itemTotal:String;

	[Bindable]
	private var subTotal:String;
	[Bindable]
	private var taxTotal:String;
	[Bindable]
	private var payTotal:String;
	[Bindable]
	private var payTendered:String;
	[Bindable]
	private var payChange:String;
	[Bindable]
	private var AustrailianRounding:Boolean;
	[Bindable]
	private	var unPurchase:UnpurchasedMerchandise;
	[Bindable]
	private var posTransactions:ArrayCollection;
	
//Data field arrays
	[Bindable]
	private var CashRegisterArray:ArrayCollection = new ArrayCollection();
	[Bindable]
	private var TaxTableArray:ArrayCollection = new ArrayCollection();
	[Bindable]
	private var TaxCodesArray:ArrayCollection = new ArrayCollection();
	[Bindable]
	private var FormatArray:ArrayCollection = new ArrayCollection();
	[Bindable]
    private var creditCardPreferencesArray:ArrayCollection = new ArrayCollection();
   [Bindable]
	private var cashDrawer:CashDrawer;
//Data view variables
	[Bindable]
	private var batch:CashRegisterBatch;
	[Bindable]
	private var tape:Tape;
	[Bindable]
	private var cashRegister:CashRegister;
	[Bindable]
	private var payment:CashRegister;
//Tree view XML table
	
	private function handleLoadTaxTableResult(ev:ResultEvent):void {
	     TaxTableArray = ev.result as ArrayCollection;
	}
	private function handleLoadTaxCodesResult(ev:ResultEvent):void {
	     TaxCodesArray = ev.result as ArrayCollection;
	}
	private function handleLoadCashDrawerResult(ev:ResultEvent):void {
	     cashDrawer = ev.result as CashDrawer;
	}
	private function handleSaveCashDrawerResult(ev:ResultEvent):void {
		cashDrawer = ev.result as CashDrawer;
	}
	private function handleLoadCashRegPreferencesResult(ev:ResultEvent):void{
		systemCashPreferencesArray = ev.result as ArrayCollection;
	}
	private function handleLoadSystemPreferencesResult(ev:ResultEvent):void {
		systemPreferencesArray = ev.result as ArrayCollection;
		if (systemPreferencesArray.length > 0)
		{
			systemPreferences = systemPreferencesArray.getItemAt(0) as PreferencesSystem;
			AustrailianRounding = systemPreferences.austrailianInvoiceRounding;
		}else {
			AustrailianRounding = false;
		}

	}	                                 
	private function handleTaxResult(ev:ResultEvent):void{
		var tax:Number;
		var tempString:String;
		cashRegister = ev.result as CashRegister;
		tempString = numberFormatter.format(cashRegister.subtotal + cashRegister.taxamount);
		cashRegister.totalprice = parseFloat(tempString.replace(",",""));
		
		batch.subTotal = batch.subTotal+ cashRegister.subtotal;
		batch.totalPrice= batch.totalPrice+ cashRegister.totalprice;
		batch.taxAmount = batch.taxAmount + cashRegister.taxamount;
		batch.change = batch.tendered - batch.totalPrice;
			
		
	}
	private function UpdateBatchNumbers():void{
		payment.paymentAmount = parseFloat(payment_cash_edit.text.replace(",",""));	
			//payment.subtotal = parseFloat(payment_cash_edit.text);
			batch.tendered = batch.tendered+ payment.paymentAmount;
			batch.change = batch.tendered - batch.totalPrice;
	}	
	public function init():void {
		consumer.subscribe();
		notification_consumer.subscribe();
		

		var mdiWin:MDIWindow = Snowmass.getInstance().containerManager.getWindowWithChild(this);
		mdiWin.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CashRegister');
		
		batch = new CashRegisterBatch();
		tape = new Tape();
		unPurchase = new UnpurchasedMerchandise();
		batch.transactions = new ArrayCollection();
		cashRegister = new CashRegister();
		cashDrawer = new CashDrawer();
		cashRegister.cashRegisterDept = new PreferencesCashRegister();
		//batch.name = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'salesCmd.POS');
		cashRegister.customerAccount = new Account();

		dataServiceSystemPreferences.getAll("PreferencesSystem");
		dataServiceCashPreferences.getAll("PreferencesCashRegister");
		dataServiceCreditCardPreferences.getAll("PreferencesCreditCard");
		dataServiceCashDrawer.getAll("CashDrawer");
		dataService.getAccountPicker();
		//openTree();
		setup();
	}
	
	private function setup():void{
		dataServiceTaxCodes.getAll("TaxCodes")	
		dataServiceTaxTable.getCurrentTaxTables("TaxTable")
		fillDefaultDocumentsArray(FormatArray);
		this.addEventListener(mx.events.StateChangeEvent.CURRENT_STATE_CHANGE, paymentStateHandler);
	}
	
	private function messageHandler(message:IMessage):void{
		var messageBody:Object = message.body;// as com.efi.messaging.MessageBody;
		
		var messageType:String = messageBody.messageType;
		if (messageType == "ADDUPDATE" || messageType == "DELETE") {
			var payloadType:String = messageBody.payloadType as String; // What kind of item was added/deleted
			var payload:Number = messageBody.payload as Number; // ID if item added or deleted
			if (payloadType == "TaxTable") {
				dataServiceTaxTable.getAll("TaxTable")
			}
			if (payloadType == "TaxCodes") {
				dataServiceTaxCodes.getAll("TaxCodes")
			}
		}
	}
      private function handleLoadCreditCardPreferencesResult(ev:ResultEvent):void {
		creditCardPreferencesArray = ev.result as ArrayCollection;
		
	}	            
	private function handleFault(ev:FaultEvent):void {  
		var message:String;
		              
		message = "Error: "                          
		+ ev.fault.faultCode + " - "                                  
		+ ev.fault.faultDetail + " - "                                  
		+ ev.fault.faultString;
		Alert.show(message, "Error", 0, null, null, null, 4);                                 
	}


// Data Load Handlers
	private function handleLoadResult(ev:ResultEvent):void {
		CashRegisterArray = ev.result as ArrayCollection;
	}
	private function handleLoadAccountsResult(ev:ResultEvent):void {
		accounts = ev.result as ArrayCollection;
	}
// Data Save Handlers
	private function handleSaveResult(ev:ResultEvent):void {
    	//dataService.getAll("PreferencesSystem");
	}
	private function handleSaveUnPurchaseResult(ev:ResultEvent):void{
		unPurchase = new UnpurchasedMerchandise();
	}
	private function handleSaveTapeResult(ev:ResultEvent):void{
		tape = ev.result as Tape;
	}
	private function handleBatchSaveResult(ev:ResultEvent):void{
		batch = new CashRegisterBatch();
		batch.transactions = new ArrayCollection();
	}
	private function UpdateCashRegister():void{
		var temp:Number;
		var tempString:String;
		var tempQuantity:Number;
		tempQuantity = parseFloat(txtPaymentQuantity.text.replace(",",""));
		temp = parseFloat(txtPaymentUnitPrice.text.replace(",",""))* tempQuantity
		if ( tempQuantity >0 )
			accept_button.enabled =  true;
		else
			accept_button.enabled = false;
		txtPaymentTotal.text = numberFormatter.format(temp) ;
		cashRegister.taxTable = pickTaxTable.selectedItem as TaxTable;
		cashRegister.taxCode = pickTaxCode.selectedItem as TaxCodes;
		cashRegister.subtotal = temp;
		//subtotal_edit.text = txtPaymentTotal.text;
		if (chkNonTax.selected){
			batch.subTotal = batch.subTotal+ cashRegister.subtotal;
			batch.totalPrice= batch.totalPrice+ cashRegister.totalprice;
			batch.change = batch.tendered - batch.totalPrice;
		}
		else
			taxCalculatorService.calculateTax(cashRegister);
	}
	
	private function openTree():void {
		var nodeList:XMLListCollection = 
			tvItems.dataProvider as XMLListCollection;
		tvItems.selectedIndex = -1;

		var node:XML = XML(tvItems.selectedItem);
	}

	private var treeStateString:String = "";
	private function treeSelect(event:Event):void {
		var treeItem:PreferencesCashRegister = tvItems.selectedItem as PreferencesCashRegister;
	
		accept_button.enabled = false;
		this.currentState = "";
		
		this.currentState = "paymentState";
		treeStateString = this.currentState;
		txtPaymentUnitPrice.text = Snowmass.getCurrencyFormatter(false,2).format(treeItem.rate);
		txtPaymentDescription.text = treeItem.title;
		txtPaymentQuantity.text ="";
		txtPaymentTotal.text = "";
		cashRegister = new CashRegister;
		cashRegister.cashRegisterDept = treeItem;
		if (treeItem.taxTable != null)
			pickTaxTable.selectedIndex = findItem(treeItem.taxTable.name, TaxTableArray);
		if (treeItem.taxCodes != null)
			pickTaxCode.selectedIndex = findItem(treeItem.taxCodes.name, TaxCodesArray)
	
	}
	private function findItem(name:String, array:ArrayCollection):int {
		for each(var element:Object in array) {
			if (name == element.name) {
				return array.getItemIndex(element);
			}
		}
		return -1;
	}
	private function doInvoice():void {
		this.currentState = "invoiceState";
	}
	private var paymentMethodStateString:String = "";
	private function paymentMethodChanged(event:Event):void {
		var rbvalue:String = event.currentTarget.selectedValue;
		payment = new CashRegister();
		
		this.currentState = "";
		paymentMethodStateString = "";
		if (rbvalue == "Cash")
		{	payment.paymentMethod= "Cash"
			if (treeStateString == "invoiceState")
			{
				this.currentState = "invoiceCash";
			} 
			else 
			{
				this.currentState = "paymentCash";
			}
			btPayment.enabled = true;
		}
		if (rbvalue == "Credit Card")
		{
			payment.paymentMethod = "Credit Card";
			if (treeStateString == "invoiceState")
			{
				this.currentState = "invoiceCreditCard";
			} 
			else 
			{
				this.currentState = "paymentCreditCard";
			}
			btPayment.enabled = true;
		}
		if (rbvalue == "Check")
		{
			payment.paymentMethod= "Check"
			if (treeStateString == "invoiceState")
			{
				this.currentState = "invoiceCheck";
			} 
			else 
			{
				this.currentState = "paymentCheck";
			}
			btPayment.enabled = true;
		}
		if (rbvalue == "Charge")
		{
			if (customerAccount == null){
				Alert.show(resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'messages.149'));
				btPayment.enabled = false;
			}
			else{
				payment.paymentMethod= "Charge"
				if (treeStateString == "invoiceState")
				{
					this.currentState = "invoiceCharge";
				} 
				else 
				{
					this.currentState = "paymentCharge";
				}
				btPayment.enabled = true;
			}
		}
		payment_cash_edit.text = Snowmass.getCurrencyFormatter(false,2).format(batch.totalPrice)
	}
	
	private function paymentStateHandler (e:Event):void {
		if (this.currentState == "paymentState")
		{
			var node:XML = XML(tvItems.selectedItem);
			txtPaymentDescription.text = node.@label;
		}
	}

	private function doPayment():void{
		if ((this.currentState = "invoiceCash") && (AustrailianRounding == true)) {
			
		}else{
			 payment.paymentAmount = parseFloat(payment_cash_edit.text.replace(",",""));	
			//payment.subtotal = parseFloat(payment_cash_edit.text);
			batch.tendered = batch.tendered+ payment.paymentAmount;
			batch.change = batch.tendered - batch.totalPrice; 
			if (payment.paymentMethod=="Check"){
				payment.checkNumber = check_num.text;
			}
			if (payment.paymentMethod=="Credit Card"){
				payment.creditCard = card_type.selectedItem as PreferencesCreditCard;
				payment.refNumber = card_ref.text;
			}
			if (payment.paymentMethod=="Charge"){
				unPurchase.account = customerAccount
				unPurchase.amount =unPurchase.amount + payment.paymentAmount;
				unPurchase.tax =  unPurchase.tax + cashRegister.taxamount;
				unPurchase.taxCode = cashRegister.taxCode;
				unPurchase.taxTable = cashRegister.taxTable;
				unPurchase.subtotal = cashRegister.subtotal;
				
				/* customerAccount.balance=  customerAccount.balance+ payment.paymentAmount;
				dataService.addUpdate(customerAccount); */
				payment.customerAccount = customerAccount;
				
				
			}
			batch.transactions.addItem(payment);
		}
		this.currentState = "";
		openTree();
		rgPaymentMethod.selection = null;
		btPayment.enabled= false;
		payment_cash_edit.text ="";
	}	
	private function doAccount():void{
		 var accountPickerWindow:AccountPicker = AccountPicker(PopUpManager.createPopUp(this, AccountPicker, true));
	    accountPickerWindow.setStyle("borderAlpha", 0.9);
	    accountPickerWindow.formIsEmpty = true;
	    accountPickerWindow.prospect_boolean = false;
	    accountPickerWindow.contact_boolean = false;
	    accountPickerWindow.setAccounts(accounts);
	    accountPickerWindow.addEventListener(AccountPickerSelectEvent.CANCELSELECTACCOUNT, handleAccountPickerCancel);
	    accountPickerWindow.addEventListener(AccountPickerSelectEvent.SELECTACCOUNT, handleAccountPickerSelect);
	    	   	    
	}
	private function handleAccountPickerSelect(evt:AccountPickerSelectEvent):void {
		
		dataService.getAccount(evt.account.id);
			
	}
	private function doTotalPrice(item:Object,column:DataGridColumn):String{
		var temp:CashRegister;
		temp = item as CashRegister;
		if (temp.paymentAmount > 0)
			return("");
		else
			return(numberFormatter.format(temp.totalprice));
		
	}
	private function doSubtotalPrice(item:Object,column:DataGridColumn):String{
		var temp:CashRegister;
		temp = item as CashRegister;
		
		if (temp.subtotal == 0)
			 return(numberFormatter.format(temp.paymentAmount));
		else
			return(numberFormatter.format(temp.subtotal));
		
	}
	private function doDescript(item:Object, column:DataGridColumn):String{
		var temp:CashRegister;
		var tempString:String;
		temp = item as CashRegister;
		if (temp.paymentMethod != "" && temp.paymentAmount >0){
			tempString = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Payment')+" " + temp.paymentMethod
		}else{
			if ( temp.cashRegisterDept.title != resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'salesCmd.POS'))
				tempString = temp.cashRegisterDept.title + " " + temp.quantity.toString() + "x"+ temp.unitprice.toString();
			else
				tempString = temp.cashRegisterDept.title;
		}
		return tempString;
	}
	private function doAccept():void{
	
		cashRegister.quantity = parseInt(txtPaymentQuantity.text);
		cashRegister.unitprice = parseFloat(txtPaymentUnitPrice.text.replace(",",""));
		cashRegister.subtotal = parseFloat(txtPaymentTotal.text.replace(",",""));
		
		batch.transactions.addItem(cashRegister);			
		
		this.currentState = "";
		openTree();
	}
	private function doVoid():void{
		var temp :CashRegister;
		var index:int;
		temp = new CashRegister();
		temp  = cashReg_grid.selectedItem as CashRegister;
		if ( temp != null){
			index= batch.transactions.getItemIndex(temp)
			batch.subTotal = batch.subTotal - temp.subtotal;
			batch.totalPrice= batch.totalPrice- temp.totalprice;
			batch.taxAmount = batch.taxAmount -temp.taxamount;
			batch.change = batch.tendered - batch.totalPrice;
			batch.transactions.removeItemAt(index);
		}
	}
	private function handleAccountPickerCancel(evt:AccountPickerSelectEvent):void {
		
		
	}
	private function handleGetResult(ev:ResultEvent):void {
		customerAccount = new Account();
		customerAccount = ev.result as Account;
		
	     
	}
	
	private function doSave():void{
		var tempT : CashRegister;
		batch.posted = true;
		batch.postedDate = new Date();
		for( var i:int = 0; i< batch.transactions.length; i++)
		{
			tempT  = batch.transactions.getItemAt(i) as CashRegister;
			tape.aR = false
			tape.pOS = true;
			tape.transactionDate = new Date();
			
			switch (tempT.paymentMethod){
				case "Cash":{
					tape.ar = false
					tape.pos = true;
					tape.type = "Cash";
				}
				case "Credit Card":{
					tape.ar = false
					tape.pos = true;
					tape.ref = tempT.refNumber;
					tape.type = "Credit"
				}
				case "Check":{
					tape.ar= false
					tape.pos = true;
					tape.checkNum = tempT.checkNumber;
					tape.type = "Check"
				}
				case "Charge":{
					tape.ar = true
					tape.pos = false;
					tape.type = "Charge"
				}
			}
			tape.paymentAmount = tempT.paymentAmount;
			tape.subTotal = tempT.subtotal;
			tape.taxAmount = tempT.taxamount;
			tape.taxCode = tempT.taxCode;
			tape.taxTable = tempT.taxTable;
			tape.total = tempT.totalprice;
		
			dataServiceTape.addUpdate(tape);
		}
		
		dataServiceCashRegisterBatch.addUpdate(batch);
		dataServiceUnPurchase.addUpdate(unPurchase);
	}
	
	private function doRevert():void{
		batch = new CashRegisterBatch();
		batch.transactions = new ArrayCollection();
	}
	
	private function fillDefaultDocumentsArray(fillArray:ArrayCollection):void{
		var setting:Object = new Object();
		setting.name="No default specified";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Alternate Currency";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Credit Memo";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Estimate - Long Form";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Estimate - Short Form";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Fax Form";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Invoice - Long Form";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Invoice - Short Form";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Quote Form";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Quote Letter";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Standard";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Thank You Letter";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Unit Price / each";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Unit Price / thousand";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="[en]!TaxName !Remarks";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="[en]!TaxName +Remarks";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="[en]+TaxName !Remarks";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="[en]+TaxName +Remarks";
		fillArray.addItem(setting);
	}
	private function dotreelabel(item:Object):String{
		var tmpItem:PreferencesCashRegister ;
		tmpItem = item as PreferencesCashRegister;
		
		if (tmpItem != null && tmpItem.title != null && tmpItem.title != "") {
			return tmpItem.title;
		} else {
			return "";
		}
	} 
	private function doTransactionGrid():void{
		button1.enabled = true;
	} 
]]>
                             
</mx:Script>

	

	<mx:Label x="20" y="20" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.DEPARTMENT')}" textAlign="right"/>	
	<mx:Tree x="0" y="80" width="130"  
		id="tvItems" 
		dataProvider="{systemCashPreferencesArray}"
		labelFunction="dotreelabel" height="100%" change="treeSelect(event);"></mx:Tree>

	<mx:Button x="150" y="10" width="38" height="38" click="doSave();" enabled="{enableSave}" id="btnSave">
		<mx:icon>@Embed(source='../../../../assets/file.png')</mx:icon>
	</mx:Button>
	<mx:Button x="196" y="10" width="38" height="38" click="doRevert();" enabled="{enableSave}" id="btnRevert">
		<mx:icon>@Embed(source='../../../../assets/cancel.png')</mx:icon>
	</mx:Button>
	<mx:Button x="242" y="10" width="38" height="38" click="doInvoice();" enabled="{enableSave}" id="btnInvoice">
		<mx:icon>@Embed(source='../../../../assets/InvoiceWONotes.png')</mx:icon>
	</mx:Button>

	<mx:Canvas x="130" y="80" width="100%" height="100%" id="cashregister_canvas" hideEffect="effect" showEffect="effect">
		<mx:Button x="19" y="10" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CustAcct')}" click="doAccount();"/>
		<mx:TextInput x="158" y="10" text="{customerAccount.title}" width="252"/>
		<mx:Canvas x="0" y="40" width="200" height="95" id="tax_canvas" borderStyle="inset">
			<mx:Label x="5" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.TaxTable')}"/>
			<mx:Label x="5" y="35" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.TaxCode')}"/>

		    <mx:ComboBox x="77" y="8" change="UpdateCashRegister()" id="pickTaxTable" width="100" dataProvider="{TaxTableArray}" labelField="name" selectedItem="{data.name}"/>
		    <mx:ComboBox x="77" y="33" change="UpdateCashRegister()" id="pickTaxCode" width="100" dataProvider="{TaxCodesArray}" labelField="name" selectedItem="{data.name}"/>
		    <mx:CheckBox x="77" y="63" label="Non-Tax" id="chkNonTax" />
		</mx:Canvas>
		<mx:Canvas x="198" y="40" width="210" height="95" id="tax_canvas0" hideEffect="effect" showEffect="effect" borderStyle="inset">
			<mx:Label x="10" y="12" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'labelCmd.Format')}"/>
			<mx:ComboBox x="58" y="10" id="cboFormat"  dataProvider="{FormatArray}" labelField="name" width="132"/>
			<mx:CheckBox x="10" y="35" id="chkPrintInvoice" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.PrintInvoice')}"/>
				
		</mx:Canvas>
		<mx:Canvas x="0" y="133" width="408" height="279" id="tax_canvas1" hideEffect="effect" showEffect="effect" borderStyle="inset">
			<mx:Button x="10" y="200" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Accept')}" click="doAccept();" width="176" enabled="false" id="accept_button"/>
			<mx:CheckBox x="10" y="243" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.PrintReceipt')}" id="checkbox1"/>
		</mx:Canvas>
		<mx:Canvas x="407" y="40" width="261" height="216" id="tax_canvas2" hideEffect="effect" showEffect="effect" borderStyle="inset">
			<mx:Label x="50" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.PAYMENTMETHOD')}"/>
			<mx:Button x="10" y="180" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Payment')}" width="186" id="btPayment" click="doPayment();" enabled="false"/>
			<mx:RadioButtonGroup id="rgPaymentMethod" change="paymentMethodChanged(event)"/>
			<mx:RadioButton x="10" y="34" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CASH')}" id="rbCash" groupName="rgPaymentMethod" value="Cash"/>
			<mx:RadioButton x="10" y="60" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CRCARD')}" id="rbCreditCard" groupName="rgPaymentMethod" value="Credit Card"/>
			<mx:RadioButton x="131" y="34" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CHECK')}" id="rbCheck" groupName="rgPaymentMethod" value="Check"/>
			<mx:RadioButton x="131" y="60" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CHARGE')}" id="rbCharge" groupName="rgPaymentMethod" value="Charge"/>

		</mx:Canvas>
		<mx:Canvas x="407" y="252" width="261" height="160" id="tax_canvas3" hideEffect="effect" showEffect="effect" borderStyle="inset">
			<mx:Label x="43" y="12" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.SubTotal')}"/>
			<mx:Label x="76" y="38" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Tax')}"/>
			<mx:Label x="69" y="64" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Total')}"/>
			<mx:Label x="44" y="90" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Tendered')}"/>
			<mx:Label x="54" y="116" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Change')}"/>
			<mx:TextInput   id="subtotal_edit" x="110" y="10" width="86" text="{Snowmass.getCurrencyFormatter(false,2).format(batch.subTotal)}"/>
			<mx:TextInput id="tax_edit" x="110" y="36" width="86" text="{Snowmass.getCurrencyFormatter(false,2).format(batch.taxAmount)}"/>
			<mx:TextInput  id="total_edit" x="110" y="62" width="86" text="{Snowmass.getCurrencyFormatter(false,2).format(batch.totalPrice)}"/>
			<mx:TextInput id="tender_edit" x="110" y="88" width="86" text="{Snowmass.getCurrencyFormatter(false,2).format(batch.tendered)}"/>
			<mx:TextInput  id="change_edit" x="110" y="114" width="86" text="{Snowmass.getCurrencyFormatter(false,2).format(batch.change)}"/>

		</mx:Canvas>
		<mx:DataGrid x="0" y="420" width="666" id="cashReg_grid" dataProvider="{batch.transactions}" height="119" itemClick="doTransactionGrid();">
			<mx:columns>
				<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rChargeLabel.Description')}" labelFunction="doDescript"/>
				<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invTotalCmd.Subtotal')}" labelFunction="doSubtotalPrice"/>
				<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invTotalCmd.Total')}"  labelFunction="doTotalPrice" />
			</mx:columns>
		</mx:DataGrid>
		<mx:Button x="10" y="558" click="doVoid();" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'tapeCmd.VoidTransaction')}" width="154"  enabled="false" id="button1"/>
		
	</mx:Canvas>
	<mx:Label x="150" y="54" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Post')}"/>
	<mx:Label x="199" y="54" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'listerCmd.Cancel')}"/>
	<mx:Label x="242" y="54" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'barcodeCmd.Invoice')}"/>
</mx:TitleWindow>
