<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow 
	xmlns:mx="http://www.adobe.com/2006/mxml" 
	xmlns:comp="com.efi.printsmith.components.*" 
	layout="absolute" 
	width="100%" 
	height="100%"
	headerHeight="0" 
	title="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CashRegister')}" 
	label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CashRegister')}" 
	name="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CashRegister')}" 
		preinitialize="preInit();"
 	implements="com.efi.printsmith.security.ISecureComponent"
	xmlns:components="com.efi.printsmith.components.*" 
	xmlns:vo="com.efi.printsmith.vo.*">
<mx:Script source="../security/PSSecurityInclude.as" />
	<mx:CurrencyFormatter precision="2" id="currencyFormatter"/>
	<mx:NumberFormatter precision="2" id="numberFormatter"/>
	<mx:NumberFormatter precision="0" id="quantityFormatter"/>
	
 	<mx:states>
 	 	<mx:State name="">
 			<mx:RemoveChild target="{txtSaleDescription}"/>
  	 	</mx:State>
 	
 	 	<mx:State name="invoiceState">
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="10" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Invoice')}" id="invstate_label1" width="87" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="10" y="35" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.TotalDue')}" id="invstate_label2" width="87" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="10" y="61" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Description')}" id="invstate_label3"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:TextInput x="105" y="8" width="75" text="{invoice.invoiceNumber}" id="txtInvoiceNumber" focusOut="doGetInvoice()"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Text x="105" y="33" width="75" text="{invoice.totalCost}" id="txtInvoiceTotalDue"/>
 	 	 	</mx:AddChild>


 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="10" y="140" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Paid')}" id="invstate_label4" width="81" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="12" y="165" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.StillDue')}" id="invstate_label5" width="79" textAlign="right"/>
 	 	 	</mx:AddChild>

 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Text x="99" y="138" width="75" id="txtInvoicePaid"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Text x="99" y="163" width="75" id="txtInvoiceStillDue"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:SetProperty target="{pickTaxTable}" name="enabled" value="false"/>
 	 	 	<mx:SetProperty target="{pickTaxCode}" name="enabled" value="false"/>
 	 	 	<mx:SetEventHandler target="{tax_canvas1}" name="activate"/>
 	 	 	<mx:SetProperty target="{chkNonTax}" name="enabled" value="false"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="x" value="10"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="y" value="85"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="width" value="349"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="height" value="45"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="enabled" value="true"/>

 	 	</mx:State>
 	 	<mx:State name="departmentState">
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Quantity')}" id="label1" width="87" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="35" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.UnitPrice')}" id="label2" width="87" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="60" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Total')}" id="label3" width="87" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:TextInput  restrict="0-9\." x="105" y="8" width="75" id="txtSaleQuantity" focusOut="UpdateCashRegister()" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:TextInput  restrict="0-9\."  x="105" y="33" width="75" id="txtSaleUnitPrice" focusOut="UpdateCashRegister()" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:TextInput restrict="0-9\."  x="105" y="58" width="75" id="txtSaleTotal" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="86" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Description')}" id="label4"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:SetProperty target="{chkNonTax}" name="enabled" value="true"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="x" value="10"/>
 	 	 	<mx:SetProperty target="{label5}" name="width" value="92"/>
 	 	 	<mx:SetProperty target="{label5}" name="x" value="10"/>
 	 	 	<mx:SetProperty target="{label6}" name="x" value="10"/>
 	 	 	<mx:SetProperty target="{label6}" name="y" value="114"/>
 	 	 	<mx:SetProperty target="{label6}" name="width" value="92"/>
 	 	 	<mx:SetProperty target="{label7}" name="x" value="10"/>
 	 	 	<mx:SetProperty target="{label7}" name="y" value="62"/>
 	 	 	<mx:SetProperty target="{label8}" name="x" value="10"/>
 	 	 	<mx:SetProperty target="{label8}" name="y" value="36"/>
 	 	 	<mx:SetProperty target="{label9}" name="x" value="10"/>
 	 	 	<mx:SetProperty target="{label9}" name="y" value="10"/>
 	 	 	<mx:SetProperty target="{label9}" name="width" value="92"/>
 	 	 	<mx:SetProperty target="{label8}" name="width" value="92"/>
 	 	 	<mx:SetProperty target="{label7}" name="width" value="92"/>
 	 	 	<mx:SetStyle target="{label6}" name="textAlign" value="right"/>
 	 	 	<mx:SetStyle target="{label5}" name="textAlign" value="right"/>
 	 	 	<mx:SetStyle target="{label7}" name="textAlign" value="right"/>
 	 	 	<mx:SetStyle target="{label8}" name="textAlign" value="right"/>
 	 	 	<mx:SetStyle target="{label9}" name="textAlign" value="right"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="enabled" value="true"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="x" value="10"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="y" value="112"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="width" value="170"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="height" value="53"/>
 	 	</mx:State>
 	 	<mx:State name="invoicePaymentMethod" basedOn="invoiceState">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="154" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Amount')}" width="103" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="152" width="75" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	</mx:State>
 	 	<mx:State name="paymentPaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="154" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Amount')}" width="103" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput  restrict="0-9\." x="121" y="152" width="75" id="payment_cash_edit" change="UpdateBatchNumbers()" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:RemoveChild target="{txtSaleDescription}"/>
 	 	</mx:State>
 	 	<mx:State name="paymentCash" basedOn="paymentPaymentMethod">
 	 	 	<mx:SetProperty target="{button1}" name="y" value="547"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="y" value="420"/>
 	 	 	<mx:SetProperty name="height" value="760"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="width" value="668"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="x" value="0"/>
 	 	 	<mx:SetProperty target="{cashregister_canvas}" name="height" value="577"/>
 	 	 	<mx:SetProperty target="{cashregister_canvas}" name="width" value="687"/>
 	 	 	<mx:SetProperty name="width" value="857"/>
 	 	</mx:State>
 	 	<mx:State name="paymentCreditCard" basedOn="paymentPaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="90" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.CardType')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="72" y="116" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.Ref')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:ComboBox x="76" y="88" width="171"  labelField="cardType" dataProvider="{creditCardPreferencesArray}" id="card_type"></mx:ComboBox>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="114" width="75"  id="card_ref"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="x" value="0"/>
 	 	 	<!--<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild" target="{checkbox1}"/>
 	 	 	<mx:SetProperty target="{checkbox1}" name="x" value="267"/>
 	 	 	<mx:SetProperty target="{checkbox1}" name="y" value="230"/>-->
 	 	</mx:State>
 	 	<mx:State name="paymentCheck" basedOn="paymentPaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="62" y="116" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.Check')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="114" width="75" id="check_num"/>
 	 	 	</mx:AddChild>
 	 	</mx:State>
 	 	<mx:State name="paymentCharge" basedOn="paymentPaymentMethod"/>
 	 	<mx:State name="invoiceCash" basedOn="invoicePaymentMethod">
 	 	</mx:State>
 	 	<mx:State name="invoiceCreditCard" basedOn="invoicePaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="90" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.CardType')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="72" y="116" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.Ref')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:ComboBox x="76" y="88" width="120"></mx:ComboBox>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="114" width="75"/>
 	 	 	</mx:AddChild>
 	 	</mx:State>
 	 	<mx:State name="invoiceCheck" basedOn="invoicePaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="62" y="116" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.Check')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="114" width="75"/>
 	 	 	</mx:AddChild>
 	 	</mx:State>
 	 	<mx:State name="invoiceCharge" basedOn="invoicePaymentMethod">
 	 	</mx:State>
 	</mx:states>
 
 	<mx:RemoteObject id="dataService" destination="dataService">
 		<mx:method name="getAccountPicker" fault="handleFault(event)" result="handleLoadAccountsResult(event)"/>
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadResult(event)"/>
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveResult(event)"/>
		<mx:method name="getAccount" fault="handleFault(event)" result="handleGetResult(event)"/>
		<mx:method name="getInvoiceByInvoiceNumber" fault="handleFault(event)" result="handleLoadInvoice(event)"/>
	</mx:RemoteObject>
<!--	<mx:RemoteObject id="dataServiceUnPurchase" destination="dataService">
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveUnPurchaseResult(event)"/>
	</mx:RemoteObject>-->
	<mx:RemoteObject id="dataServiceCashDrawer" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadCashDrawerResult(event)"/>
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveCashDrawerResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceTape" destination="dataService">
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveTapeResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceCashRegisterBatch" destination="dataService">
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleBatchSaveResult(event)"/>
	</mx:RemoteObject>
 	<mx:RemoteObject id="dataServiceTaxCodes" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadTaxCodesResult(event)"/>
	</mx:RemoteObject>
 	<mx:RemoteObject id="dataServiceTaxTable" destination="dataService">
		<mx:method name="getCurrentTaxTables" fault="handleFault(event)" result="handleLoadTaxTableResult(event)"/>
	</mx:RemoteObject>

	<mx:RemoteObject id="dataServiceSystemPreferences" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadSystemPreferencesResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceCashPreferences" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadCashRegPreferencesResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="taxCalculatorService" destination="taxService">
		<mx:method name="calculateTax" fault="handleFault(event)" result="handleTaxResult(event)"/>
	</mx:RemoteObject>
<mx:RemoteObject id="dataServiceCreditCardPreferences" destination="dataService">
	<mx:method name="getAll" fault="handleFault(event)" result="handleLoadCreditCardPreferencesResult(event)"/>
</mx:RemoteObject>
<!--	<mx:RemoteObject id="dataServiceInvoice" destination="InvoiceService">
	<mx:method name="getInvoice" fault="handleFault(event)" result="handleLoadInvoice(event)"/>
</mx:RemoteObject>-->
	<mx:Producer id="producer" destination="cashregister"/>
	<mx:Consumer id="consumer" destination="cashregister" message="messageHandler(event.message)"/>
	<mx:Consumer id="notification_consumer" destination="notifications" message="messageHandler(event.message)"/>
<mx:Script>
<![CDATA[
	import mx.events.ListEvent;
	import mx.events.TreeEvent;
	import mx.events.FlexEvent;
	import com.efi.printsmith.security.PSSecurityCommands;
	import com.efi.printsmith.data.InvoiceBase;
	import com.efi.printsmith.data.JobBase;
	import com.efi.mdi.view.window.MDIWindow;
	import com.efi.printsmith.data.CashDrawer;
	import com.efi.printsmith.data.Tape;
	import com.hillelcoren.utils.ArrayCollectionUtils;
	import com.efi.printsmith.data.PreferencesCashRegister;
	import mx.events.StateChangeEvent;
	import mx.controls.Text;
	import mx.managers.FocusManager;

	import com.efi.printsmith.data.TaxTable;
	import com.efi.printsmith.data.TaxCodes;
	
	import com.efi.printsmith.data.TapeSessionBatch;
	import com.efi.printsmith.data.TapePaymentRecord;
	import com.efi.printsmith.data.TapeSaleRecord;
	
	import com.efi.printsmith.data.PreferencesSystem;
	import com.efi.printsmith.events.AccountPickerSelectEvent;
	import com.efi.printsmith.data.PreferencesCreditCard;
	import com.efi.printsmith.data.Account;
//	import com.efi.printsmith.data.UnpurchasedMerchandise;

	import com.efi.printsmith.events.JobEditCompleteEvent;

	import mx.controls.Alert;                                         
	import mx.managers.PopUpManager;                                         
	import mx.containers.TitleWindow;                                         
	import mx.collections.ArrayCollection;                                         
	import mx.rpc.events.ResultEvent;                                         
	import mx.rpc.events.FaultEvent;                                         
	import mx.messaging.messages.AsyncMessage;
	import mx.messaging.messages.IMessage;
	import mx.collections.XMLListCollection;

	[Bindable]
	private var enableSave:Boolean = true;

	[Bindable]                                         
    private var systemPreferences:PreferencesSystem;
    [Bindable]  
 	private var accounts:ArrayCollection = new ArrayCollection();
	[Bindable]                                
	private var systemPreferencesArray:ArrayCollection = new ArrayCollection();

	[Bindable]
	private var cashRegisterTransacations:ArrayCollection = new ArrayCollection();
	[Bindable]
	private var systemCashPreferencesArray:ArrayCollection = new ArrayCollection();
	
	
[Bindable]
//	private var itemQty:String;
//	[Bindable]
	private var invoice:InvoiceBase;
	[Bindable]
	private var customerAccount:Account;
//	[Bindable]
//	private var itemUnitPrice:Number;
//	[Bindable]
//	private var itemTotal:String;

//	[Bindable]
//	private var subTotal:String;
//	[Bindable]
//	private var taxTotal:String;
//	[Bindable]
//	private var payTotal:String;
//	[Bindable]
//	private var payTendered:String;
//	[Bindable]
//	private var payChange:String;
	[Bindable]
	private var AustrailianRounding:Boolean;
//	[Bindable]
//	private	var unPurchase:UnpurchasedMerchandise;
	[Bindable]
	private var posTransactions:ArrayCollection;
	
//Data field arrays
	[Bindable]
	private var CashRegisterArray:ArrayCollection = new ArrayCollection();
	[Bindable]
	private var TaxTableArray:ArrayCollection = new ArrayCollection();
	[Bindable]
	private var TaxCodesArray:ArrayCollection = new ArrayCollection();
	[Bindable]
	private var FormatArray:ArrayCollection = new ArrayCollection();
	[Bindable]
    private var creditCardPreferencesArray:ArrayCollection = new ArrayCollection();
   [Bindable]
	private var cashDrawer:CashDrawer;
//Data view variables
	[Bindable]
	private var batch:TapeSessionBatch;
	[Bindable]
	private var tape:Tape;
	[Bindable]
	private var activeSale:TapeSaleRecord;
	[Bindable]
	private var activePayment:TapePaymentRecord;
//Tree view XML table
	
	private function handleLoadTaxTableResult(ev:ResultEvent):void {
	     TaxTableArray = ev.result as ArrayCollection;
	}
	private function handleLoadTaxCodesResult(ev:ResultEvent):void {
	     TaxCodesArray = ev.result as ArrayCollection;
	}
	private function handleLoadCashDrawerResult(ev:ResultEvent):void {
	     cashDrawer = ev.result as CashDrawer;
	}
	private function handleSaveCashDrawerResult(ev:ResultEvent):void {
		cashDrawer = ev.result as CashDrawer;
	}
	private function handleLoadCashRegPreferencesResult(ev:ResultEvent):void{
		systemCashPreferencesArray = ev.result as ArrayCollection;
		
		this.throbber.visible = false;
		this.throbber.stop();
	}
	private function handleLoadSystemPreferencesResult(ev:ResultEvent):void {
		systemPreferencesArray = ev.result as ArrayCollection;
		if (systemPreferencesArray.length > 0)
		{
			systemPreferences = systemPreferencesArray.getItemAt(0) as PreferencesSystem;
			AustrailianRounding = systemPreferences.austrailianInvoiceRounding;
		}else {
			AustrailianRounding = false;
		}

	}	                                 
	private function handleTaxResult(ev:ResultEvent):void{
		var tax:Number;
	//	var tempString:String;
	
		activeSale.taxAmount = ev.result as Number;
		activeSale.total = activeSale.subTotal + activeSale.taxAmount;
		
		//tempString = numberFormatter.format(activeSale.subtotal + activeSale.taxamount);
		//activeSale.totalprice = parseFloat(tempString.replace(",",""));
		
	//	batch.subTotal = batch.subTotal+ activeSale.subtotal;
	//	batch.totalPrice= batch.totalPrice+ activeSale.totalprice;
	//	batch.taxAmount = batch.taxAmount + activeSale.taxamount;
	//	batch.change = batch.tendered - batch.totalPrice;
			
		UpdateBatchNumbers();
	}
	
	private function UpdateBatchNumbers():void {
		
	//	if (payment_cash_edit != null && payment_cash_edit.text != null) {
	//		activePayment.total = parseFloat(payment_cash_edit.text.replace(",",""));
	//	} else
	//		activePayment.total = 0;
			
			//activePayment.subtotal = parseFloat(payment_cash_edit.text);
		//	batch.tendered = batch.tendered+ activePayment.paymentAmount;
		//	batch.change = batch.tendered - batch.totalPrice;
		
		batch.accumChange = (batch.accumTendered + activePayment.total) - batch.accumTotal;
		
		// update the batch numbers with the current SALE and Payment transactions (before any accept)
		//
		subtotal_edit.text = Snowmass.getCurrencyFormatter(false,2).format(batch.accumSubTotal + activeSale.subTotal);
		tax_edit.text = Snowmass.getCurrencyFormatter(false,2).format(batch.accumTaxTotal + activeSale.taxAmount);
		total_edit.text = Snowmass.getCurrencyFormatter(false,2).format(batch.accumTotal + activeSale.total);
		tender_edit.text = Snowmass.getCurrencyFormatter(false,2).format(batch.accumTendered + activePayment.total);
		change_edit.text = Snowmass.getCurrencyFormatter(false,2).format(batch.accumChange);
	}	
	
	public function getSecurityCommand():String {
    	return PSSecurityCommands.POS_OPENCASHREGISTER;
    }
    
    private function InitPaymentRecord():void {
    	activePayment = new TapePaymentRecord();
    }
    
     private function InitSaleRecord():void {
    	InitPaymentRecord();
    	
 		activeSale = new TapeSaleRecord();
 		activeSale.cashRegisterDept = new PreferencesCashRegister();
		activeSale.customerAccount = new Account();
   }
   
 	//
	private function myKeyDownHandler(event:KeyboardEvent):void {
		var	stringChar:String;
		var curKeyCode:int;
		var goodKeyEquiv:Boolean;
		
		// ONLY WHEN ALT IS DOWN
		//
		if( event.altKey == false && event.ctrlKey == true && event.shiftKey == true){
			curKeyCode = event.keyCode;
			stringChar = String.fromCharCode(event.charCode);
			
			//
			// look for the first charcater in the radio button titles as a match
			//
			if (stringChar == rbCash.label.substr(0,1)) {
				rbCash.dispatchEvent(new MouseEvent(MouseEvent.CLICK , false, false));
			} else if (stringChar == rbCreditCard.label.substr(0,1)) {
				rbCreditCard.dispatchEvent(new MouseEvent(MouseEvent.CLICK , false, false));
			} else if (stringChar == rbCheck.label.substr(0,1)) {
				rbCheck.dispatchEvent(new MouseEvent(MouseEvent.CLICK , false, false));
			} else if (stringChar == rbCharge.label.substr(0,1)) {
				rbCharge.dispatchEvent(new MouseEvent(MouseEvent.CLICK , false, false));
			} else {
				goodKeyEquiv = false;
				switch(stringChar) {
				case "1":
				case "2":
				case "3":
				case "4":
				case "5":
				case "6":
				case "7":
				case "8":
				case "9":
					tvItems.selectedIndex = (parseInt(stringChar) - 1);
					goodKeyEquiv = true;
					break;
				default:;
				}
				
				if(goodKeyEquiv == true) {
					this.stage.focus = null;
					
					tvItems.validateNow();
					tvItems.dispatchEvent(new ListEvent("change"));
					
					if (txtSaleQuantity != null && txtSaleQuantity.enabled)
						txtSaleQuantity.setFocus();
				}
			}
		}
	}

  
	public function init(event:FlexEvent = null):void {
		consumer.subscribe();
		notification_consumer.subscribe();
		
		this.throbber.visible = true;
		this.throbber.play();

		var mdiWin:MDIWindow = Snowmass.getInstance().containerManager.getWindowWithChild(this);
		mdiWin.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CashRegister');
		
		stage.addEventListener(KeyboardEvent.KEY_DOWN, myKeyDownHandler);
		
		batch = new TapeSessionBatch();
		batch.transactions = new ArrayCollection();
		
		tape = new Tape();
//		unPurchase = new UnpurchasedMerchandise();
		cashDrawer = new CashDrawer();

		dataServiceSystemPreferences.getAll("PreferencesSystem");
		dataServiceCashPreferences.getAll("PreferencesCashRegister");
		dataServiceCreditCardPreferences.getAll("PreferencesCreditCard");
		dataServiceCashDrawer.getAll("CashDrawer");
		dataService.getAccountPicker();
		
		InitSaleRecord();			// setup for the first sale transaction
		
		//openTree();
		setup();
	}
	
	private function setup():void{
		dataServiceTaxCodes.getAll("TaxCodes")	
		dataServiceTaxTable.getCurrentTaxTables("TaxTable")
		fillDefaultDocumentsArray(FormatArray);
		this.addEventListener(mx.events.StateChangeEvent.CURRENT_STATE_CHANGE, paymentStateHandler);
	}
	
	private function messageHandler(message:IMessage):void{
		var messageBody:Object = message.body;// as com.efi.messaging.MessageBody;
		
		var messageType:String = messageBody.messageType;
		if (messageType == "ADDUPDATE" || messageType == "DELETE") {
			var payloadType:String = messageBody.payloadType as String; // What kind of item was added/deleted
			var payload:Number = messageBody.payload as Number; // ID if item added or deleted
			if (payloadType == "TaxTable") {
				dataServiceTaxTable.getAll("TaxTable")
			}
			if (payloadType == "TaxCodes") {
				dataServiceTaxCodes.getAll("TaxCodes")
			}
		}
	}
      private function handleLoadCreditCardPreferencesResult(ev:ResultEvent):void {
		creditCardPreferencesArray = ev.result as ArrayCollection;
		
	}	            
	private function handleFault(ev:FaultEvent):void {  
		var message:String;
		              
		message = "Error: "                          
		+ ev.fault.faultCode + " - "                                  
		+ ev.fault.faultDetail + " - "                                  
		+ ev.fault.faultString;
		Alert.show(message, "Error", 0, null, null, null, 4);                                 
	}


// Data Load Handlers
	private function handleLoadResult(ev:ResultEvent):void {
		CashRegisterArray = ev.result as ArrayCollection;
	}
	private function handleLoadAccountsResult(ev:ResultEvent):void {
		accounts = ev.result as ArrayCollection;
	}
// Data Save Handlers
	private function handleSaveResult(ev:ResultEvent):void {
    	//dataService.getAll("PreferencesSystem");
	}
//	private function handleSaveUnPurchaseResult(ev:ResultEvent):void{
//		unPurchase = new UnpurchasedMerchandise();
//	}
	private function handleSaveTapeResult(ev:ResultEvent):void{
		tape = ev.result as Tape;
	}
	private function handleBatchSaveResult(ev:ResultEvent):void{
		batch = new TapeSessionBatch();
		batch.transactions = new ArrayCollection();
		
		UpdateBatchNumbers();
	}
	private function UpdateCashRegister():void{
		var temp:Number;
		var tempString:String;
		var tempQuantity:Number;
		
		if (txtSaleQuantity.text != "")
			tempQuantity = parseInt(txtSaleQuantity.text.replace(",",""));
		else
			tempQuantity = 0;
			
		if (txtSaleUnitPrice.text != "")
			temp = parseFloat(txtSaleUnitPrice.text.replace(",","")) * tempQuantity;
		else
			temp = 0;
		
		if ( tempQuantity > 0) {
			accept_button.enabled =  true;
			this.focusManager.defaultButton = accept_button;
		}	
		else {
			accept_button.enabled = false;
			this.focusManager.defaultButton = null;
		}
		
		txtSaleTotal.text = numberFormatter.format(temp) ;
		activeSale.subTotal = temp;		// no tax at this point

		activeSale.taxTable = pickTaxTable.selectedItem as TaxTable;
		activeSale.taxCode = pickTaxCode.selectedItem as TaxCodes;
		
		if (chkNonTax.selected){
			activeSale.taxAmount = 0;
			UpdateBatchNumbers();
		}
		else
			taxCalculatorService.calculateTax(activeSale.taxTable, activeSale.subTotal);
	}
		
	private function openTree():void {
		var nodeList:XMLListCollection = 
			tvItems.dataProvider as XMLListCollection;
		tvItems.selectedIndex = -1;

		var node:XML = XML(tvItems.selectedItem);
	}

	private var treeStateString:String = "";
	private function treeSelect(event:Event):void {
		var treeItem:PreferencesCashRegister = tvItems.selectedItem as PreferencesCashRegister;
	
		accept_button.enabled = false;
		this.currentState = "";
		
		this.currentState = "departmentState";
		treeStateString = this.currentState;
		txtSaleUnitPrice.text = Snowmass.getCurrencyFormatter(false,2).format(treeItem.rate);
		txtSaleDescription.text = treeItem.title;
		txtSaleQuantity.text ="";
		txtSaleTotal.text = "";
	//	activeSale = new TapeSaleRecord;
		
		InitSaleRecord();
		
		activeSale.cashRegisterDept = treeItem;

		if (treeItem.taxTable != null)
			pickTaxTable.selectedIndex = findItem(treeItem.taxTable.name, TaxTableArray);
		if (treeItem.taxCodes != null)
			pickTaxCode.selectedIndex = findItem(treeItem.taxCodes.name, TaxCodesArray)
		
		if (txtSaleQuantity != null && txtSaleQuantity.enabled)
			txtSaleQuantity.setFocus();
	}
	
	private function findItem(name:String, array:ArrayCollection):int {
		for each(var element:Object in array) {
			if (name == element.name) {
				return array.getItemIndex(element);
			}
		}
		return -1;
	}
	private function doInvoice():void {
		this.currentState = "invoiceState";
	}
	
	private function doAddJob():void {
		var editJobWindow:EditJob= new EditJob();
		var parentId:int = Snowmass.getInstance().containerManager.getWindowWithChild(this).windowID;
		Snowmass.getInstance().containerManager.openNewMDIWindow(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'jobCmd.NewJob'),editJobWindow, -1,-1,-1,-1, parentId);
		editJobWindow.addEventListener(JobEditCompleteEvent.SAVE, addNewJob);
	}

	private function addNewJob(event:Event):void
	{
		var target:EditJob=event.target as EditJob;

		paymentMethodStateString = "";
		
		if (target.job != null) {
			activeSale.quantity = 1;
			activeSale.unitPrice = target.job.pricingRecord.unitPrice;
			activeSale.subTotal = target.job.pricingRecord.totalPrice;
				
			doAccept();
		}
	}
	
	private var paymentMethodStateString:String = "";
	private function paymentMethodChanged(event:Event):void {
		var rbvalue:String = event.currentTarget.selectedValue;
	//	activePayment = new CashRegister();
						
		this.currentState = "";
		paymentMethodStateString = "";
		
		if (rbvalue == "Cash")
		{	
			activePayment.paymentMethod= "Cash"
			if (treeStateString == "invoiceState")
			{
				this.currentState = "invoiceCash";
			} 
			else 
			{
				this.currentState = "paymentCash";
			}
			btPayment.enabled = true;
			payment_cash_edit.setFocus();
		}
		if (rbvalue == "Credit Card")
		{
			activePayment.paymentMethod = "Credit Card";
			if (treeStateString == "invoiceState")
			{
				this.currentState = "invoiceCreditCard";
			} 
			else 
			{
				this.currentState = "paymentCreditCard";
			}
			btPayment.enabled = true;
			card_ref.setFocus();
		}
		if (rbvalue == "Check")
		{
			activePayment.paymentMethod= "Check"
			if (treeStateString == "invoiceState")
			{
				this.currentState = "invoiceCheck";
			} 
			else 
			{
				this.currentState = "paymentCheck";
			}
			btPayment.enabled = true;
			check_num.setFocus();
		}
		if (rbvalue == "Charge")
		{
			if (customerAccount == null){
				Alert.show(resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'msg_Youmustselectanaccou'));
				btPayment.enabled = false;
			} else
				btPayment.enabled = true;
			
			activePayment.paymentMethod= "Charge"
			if (treeStateString == "invoiceState")
			{
				this.currentState = "invoiceCharge";
			} 
			else 
			{
				this.currentState = "paymentCharge";
			}
		}
		//
		// how much is left to pay
		//
		payment_cash_edit.text = Snowmass.getCurrencyFormatter(false,2).format((batch.accumTotal - batch.accumTendered));
		
		this.focusManager.setFocus(btPayment);
		this.focusManager.defaultButton = btPayment;
	}
	
	private function paymentStateHandler (e:Event):void {
		if (this.currentState == "departmentState")
		{
			var node:XML = XML(tvItems.selectedItem);
			txtSaleDescription.text = node.@label;
		}
	}

	private function doPayment():void{
		if ((this.currentState = "invoiceCash") && (AustrailianRounding == true)) {
			
		}else{
			 activePayment.total = parseFloat(payment_cash_edit.text.replace(",",""));	
			//activePayment.subtotal = parseFloat(payment_cash_edit.text);
			batch.accumTendered = batch.accumTendered+ activePayment.total;
			batch.accumChange = batch.accumTendered - batch.accumTotal; 
			if (activePayment.paymentMethod=="Check"){
				activePayment.checkNumber = check_num.text;
			}
			if (activePayment.paymentMethod=="Credit Card"){
				activePayment.creditCard = card_type.selectedItem as PreferencesCreditCard;
				activePayment.refNumber = card_ref.text;
			}
			if (activePayment.paymentMethod=="Charge"){
			//	unPurchase.account = customerAccount
			//	unPurchase.amount =unPurchase.amount + activePayment.paymentAmount;
			//	unPurchase.tax =  unPurchase.tax + activeSale.taxamount;
			//	unPurchase.taxCode = activeSale.taxCode;
			//	unPurchase.taxTable = activeSale.taxTable;
			//	unPurchase.subtotal = activeSale.subtotal;
				
				/* customerAccount.balance=  customerAccount.balance+ activePayment.paymentAmount;
				dataService.addUpdate(customerAccount); */
				activePayment.customerAccount = customerAccount;				
			}
			batch.transactions.addItem(activePayment);
			
			InitPaymentRecord();
		}
		this.currentState = "";
		openTree();
		rgPaymentMethod.selection = null;
		btPayment.enabled= false;
		payment_cash_edit.text ="";
		UpdateBatchNumbers();
	}	
	
	private function doAccount():void{
		 var accountPickerWindow:AccountPicker = AccountPicker(PopUpManager.createPopUp(this, AccountPicker, true));
	    accountPickerWindow.setStyle("borderAlpha", 0.9);
	    accountPickerWindow.formIsEmpty = true;
	    accountPickerWindow.prospect_boolean = false;
	    accountPickerWindow.contact_boolean = false;
	    accountPickerWindow.setAccounts(accounts);
	    accountPickerWindow.addEventListener(AccountPickerSelectEvent.CANCELSELECTACCOUNT, handleAccountPickerCancel);
	    accountPickerWindow.addEventListener(AccountPickerSelectEvent.SELECTACCOUNT, handleAccountPickerSelect);
	    	   	    
	}
	private function handleAccountPickerSelect(evt:AccountPickerSelectEvent):void {
		
		dataService.getAccount(evt.account.id);
			
	}
	private function doTotalPrice(item:Object,column:DataGridColumn):String{
		var tempString:String;
		
		if (item is TapePaymentRecord) {
			var tempPayment:TapePaymentRecord;
			tempPayment = item as TapePaymentRecord;
			if (tempPayment != null){
				tempString = numberFormatter.format(tempPayment.total);
			} else
				tempString = "";
		} else if (item is TapeSaleRecord) {
			var tempSale:TapeSaleRecord = item as TapeSaleRecord;
			
			if (tempSale != null){
				tempString = numberFormatter.format(tempSale.total);
			} else
				tempString = "";
		}
		
		return tempString;
		
	}
	private function doSubtotalPrice(item:Object,column:DataGridColumn):String{
		var tempString:String;
		
		if (item is TapePaymentRecord) {
			var tempPayment:TapePaymentRecord;
			tempPayment = item as TapePaymentRecord;
			if (tempPayment != null){
				tempString = numberFormatter.format(tempPayment.subTotal);
			} else
				tempString = "";
		} else if (item is TapeSaleRecord) {
			var tempSale:TapeSaleRecord = item as TapeSaleRecord;
			
			if (tempSale != null){
				tempString = numberFormatter.format(tempSale.subTotal);
			} else
				tempString = "";
		}
		
		return tempString;
	}
	private function doDescript(item:Object, column:DataGridColumn):String{
		var tempString:String;
		
		if (item is TapePaymentRecord) {
			var tempPayment:TapePaymentRecord;
			tempPayment = item as TapePaymentRecord;
			if (tempPayment.paymentMethod != "" && tempPayment.total > 0){
				tempString = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Payment')+" " + tempPayment.paymentMethod;
			} else
				tempString = "";
		} else if (item is TapeSaleRecord) {
			var tempSale:TapeSaleRecord = item as TapeSaleRecord;
			
			if (activeSale.isPickup == false)		// && tempSale.cashRegisterDept.title != resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'salesCmd.POS')
				tempString = tempSale.cashRegisterDept.title + " " + tempSale.quantity.toString() + "x"+ tempSale.unitPrice.toString();
			else
				tempString = tempSale.cashRegisterDept.title;
		}
		
		return tempString;
	}
	
	private function doAccept():void{
	
		activeSale.quantity = parseInt(txtSaleQuantity.text);
		activeSale.unitPrice = parseFloat(txtSaleUnitPrice.text.replace(",",""));
		activeSale.subTotal = parseFloat(txtSaleTotal.text.replace(",",""));
		
		batch.accumSubTotal = batch.accumSubTotal + activeSale.subTotal;
		batch.accumTotal = batch.accumTotal + activeSale.total;
		batch.accumTaxTotal = batch.accumTaxTotal + activeSale.taxAmount;
		batch.accumChange = batch.accumTendered - batch.accumTotal;

		batch.transactions.addItem(activeSale);			
		
		InitSaleRecord();		// setup for another sale
		
		this.currentState = "";
		txtSaleDescription.text = "";
		openTree();
		
		UpdateBatchNumbers();
	}
	
	private function doVoid():void{
		var temp :Object;
		var index:int;
		
		temp = new Object();
		temp  = cashReg_grid.selectedItem as Object;
		
		if ( temp != null){
			index= batch.transactions.getItemIndex(temp);
			
			if (temp is TapePaymentRecord) {
				var tempPayment:TapePaymentRecord;
				tempPayment = temp as TapePaymentRecord;				
				batch.accumTendered = batch.accumTendered - tempPayment.total;
				batch.accumChange = batch.accumTendered - batch.accumTotal; 
			} else if (temp is TapeSaleRecord) {
				var tempSale:TapeSaleRecord = temp as TapeSaleRecord;
				batch.accumSubTotal = batch.accumSubTotal - tempSale.subTotal;
				batch.accumTotal = batch.accumTotal - tempSale.total;
				batch.accumTaxTotal = batch.accumTaxTotal - tempSale.taxAmount;
				batch.accumChange = batch.accumTendered - batch.accumTotal;
			}
			
			batch.transactions.removeItemAt(index);
			
			UpdateBatchNumbers();
		}
	}
	
	private function handleAccountPickerCancel(evt:AccountPickerSelectEvent):void {
		
		
	}
	private function handleGetResult(ev:ResultEvent):void {
		customerAccount = new Account();
		customerAccount = ev.result as Account;
		
	     
	}
	
	private function doApplyPayments():Boolean {
		var unApplied:Number = 0;
		var i:int = 0;
		var currentPaymentIndex:int = 0;
		var temp:Object;
		var totalPay:Number = 0;
		var totalCharge:Number = 0;
		var totalTransactionPay:Number = 0;
		var totalApplied:Number = 0;
		var refund:Number = 0;
		var payAmount:Number = 0;
		var diff:Number = 0;
		var tempPayment:TapePaymentRecord = new TapePaymentRecord();
		var paymentList:ArrayCollection = new ArrayCollection();
		var message:String;
		
		totalPay = batch.accumTendered;
		refund = batch.accumChange;
		
		if (refund > 0) {		// change amount still due to give back
			totalPay = totalPay - refund;
		}

		// make a local list of just the payments
		for(i = 0; i< batch.transactions.length; i++)
		{
			temp  = batch.transactions.getItemAt(i) as Object;
			if (temp is TapePaymentRecord) {
				paymentList.addItem(temp);
			}	
		}
			
		if (totalPay > 0 && paymentList.length > 0) {
			// get the first payment
			tempPayment = paymentList.getItemAt(currentPaymentIndex) as TapePaymentRecord;
			payAmount = tempPayment.total;
			
			//
			// balance out any refund amount that would go back to payee
			//
			if (refund > 0 && tempPayment.paymentMethod != "Charge") {
				if (payAmount >= refund) {
					payAmount -= refund;
					refund = 0;
				} else {
					refund -= payAmount;
					payAmount = 0;
				}
			}
			
			totalApplied += payAmount;
			
			for(i = 0; i < batch.transactions.length && tempPayment != null; i++)
			{
				temp  = batch.transactions.getItemAt(i) as Object;
				
				if (temp is TapePaymentRecord) {
					// ignore while appling to sales
				} else if (temp is TapeSaleRecord) {
					var tempSale:TapeSaleRecord = temp as TapeSaleRecord;
											
					unApplied = tempSale.total - tempSale.amountPaid;
					
					// is sale a invoice pickup
					// record invoice data into the payment record
					if (tempSale.isPickup == true) {
						tempPayment.invoice = tempSale.invoice;
					//	tempPayment.postAR = true;
					}
					
					//
					// money still owed on this sale record
					//
					if (unApplied > 0) {
						
						// 
						// any left over charge to account value, whe no payments are left
						//
						if (tempSale.isPickup == true && tempPayment == null && totalCharge > 0.01) {
							totalTransactionPay += unApplied;
							totalCharge -= unApplied;
							unApplied = 0;
						} 
						// 
						// the current pay record can pay off the whole amount due
						//
						else if (unApplied <= payAmount) {
						
							// charge to account
							if (tempPayment.paymentMethod == "Charge") {
								if (tempPayment != null) {
									totalCharge += payAmount;
									payAmount = 0;
								} else {
									totalTransactionPay += unApplied;
									totalCharge -= unApplied;
									unApplied = 0;
								}
							} 
							// cash, check or credit card
							else {
								tempSale.amountPaid += unApplied;
								totalTransactionPay += unApplied;
								payAmount -= unApplied;
								unApplied = 0;
							}
						}
						// 
						// the sale requires more money to pay off than is available from current pay record
						//
						else {
							// charge to account
							if (tempPayment.paymentMethod == "Charge") {
								if (tempPayment != null) {
									totalCharge += payAmount;
									payAmount = 0;
								} else {
									totalTransactionPay += unApplied;
									totalCharge -= unApplied;
									unApplied = 0;
								}
							} 
							// cash, check or credit card
							else {

								tempSale.amountPaid += payAmount;
								totalTransactionPay += payAmount;
								unApplied -= payAmount;
								payAmount = 0;
							}
						}
						
						// assign the payment type to the sale record
						//
						if (tempSale.paymode == "") {
							tempSale.paymode = tempPayment.paymentMethod;
							if (tempPayment.paymentMethod != "Charge") {
								tempSale.checkNumber = tempPayment.checkNumber;
								tempSale.cct = tempPayment.cct;
								tempSale.refNumber = tempPayment.refNumber;		// cct
							}
						}
					}
				}
				
				if (payAmount <= .01) {
					currentPaymentIndex += 1;
					if (currentPaymentIndex < paymentList.length) {
						tempPayment = paymentList.getItemAt(currentPaymentIndex) as TapePaymentRecord;
					} else
						tempPayment = null;
						
					if (tempPayment != null) {
						payAmount = tempPayment.total;
					} else {
						payAmount = 0;
					}
					
					//
					// balance out any refund amount that would go back to payee
					//
					if (refund > 0 && tempPayment.paymentMethod != "Charge") {
						if (payAmount >= refund) {
							payAmount -= refund;
							refund = 0;
						} else {
							refund -= payAmount;
							payAmount = 0;
						}
					}
				
					totalApplied += payAmount;
				}
			}
			
			//
			// all sale records have been processed
			//
			//totalTransactionPay += roundAmount;
			
			//
			// un-balanced amount of sales .vs. payments
			//
			if (totalTransactionPay != totalApplied) {
				message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_WARNINGThistransacti");
				Alert.show(message, "Warning", 0, null, null, null, 4); 
				return(false);
			}
		} else {
			message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_WARNINGThistransacti");
			Alert.show(message, "Warning", 0, null, null, null, 4); 
			return(false);
		}
		
		return(true);
	}
	
	private function doPostBatch():void{
		var temp : Object;
		
		// make sure the payments balance with the sales
		//
		if (doApplyPayments() == true) {
		
			batch.posted = true;
			batch.postedDate = new Date();
			
			for( var i:int = 0; i< batch.transactions.length; i++)
			{
				temp  = batch.transactions.getItemAt(i) as Object;
				tape.aR = false
				tape.pOS = true;
				tape.transactionDate = new Date();
				tape.user = Snowmass.getInstance().currentUser;
				
				if (temp is TapePaymentRecord) {
					var tempPayment:TapePaymentRecord;
					tempPayment = temp as TapePaymentRecord;
									
					switch (tempPayment.paymentMethod){
						case "Cash":{
							tape.ar = false
							tape.pos = true;
							tape.type = "Cash";
						}
						case "Credit Card":{
							tape.ar = false
							tape.pos = true;
							tape.ref = tempPayment.refNumber;
							tape.type = "Credit"
						}
						case "Check":{
							tape.ar= false
							tape.pos = true;
							tape.checkNum = tempPayment.checkNumber;
							tape.type = "Check"
						}
						case "Charge":{
							tape.ar = true
							tape.pos = false;
							tape.type = "Charge"
						}
					}
					tape.paymentAmount = tempPayment.paymentAmount;
					tape.subTotal = tempPayment.subTotal;
					tape.taxAmount = tempPayment.taxAmount;
					tape.taxCode = tempPayment.taxCode;
					tape.taxTable = tempPayment.taxTable;
					tape.total = tempPayment.total;

				} else if (temp is TapeSaleRecord) {
					var tempSale:TapeSaleRecord = temp as TapeSaleRecord;
					
				}
			
			
			//	dataServiceTape.addUpdate(tape);
			}
			
		//	dataServiceCashRegisterBatch.addUpdate(batch);
		//	dataServiceUnPurchase.addUpdate(unPurchase);
		}
	}
	
	private function doRevert():void{
		batch = new TapeSessionBatch();
		batch.transactions = new ArrayCollection();
		
		InitSaleRecord();		// setup for another sale
		InitPaymentRecord();
		
		this.currentState = "";
		txtSaleDescription.text = "";
		openTree();
		
		UpdateBatchNumbers();		
	}
	
	private function fillDefaultDocumentsArray(fillArray:ArrayCollection):void{
		var setting:Object = new Object();
		setting.name="No default specified";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Alternate Currency";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Credit Memo";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Estimate - Long Form";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Estimate - Short Form";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Fax Form";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Invoice - Long Form";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Invoice - Short Form";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Quote Form";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Quote Letter";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Standard";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Thank You Letter";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Unit Price / each";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="Unit Price / thousand";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="[en]!TaxName !Remarks";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="[en]!TaxName +Remarks";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="[en]+TaxName !Remarks";
		fillArray.addItem(setting);
		setting = new Object();
		setting.name="[en]+TaxName +Remarks";
		fillArray.addItem(setting);
	}
	private function dotreelabel(item:Object):String{
		var tmpItem:PreferencesCashRegister ;
		tmpItem = item as PreferencesCashRegister;
		
		if (tmpItem != null && tmpItem.title != null && tmpItem.title != "") {
			return tmpItem.displayId.toString() + " " + tmpItem.title;
		} else {
			return "";
		}
	} 
	private function doTransactionGrid():void{
		button1.enabled = true;
	} 
	
	private function doGetInvoice():void {	
		this.throbber.visible = true;
		this.throbber.play();
	
		dataService.getInvoiceByInvoiceNumber(txtInvoiceNumber.text,"I");
	}
	
	private function handleLoadInvoice(evt:ResultEvent):void {
		var invoiceTmp:InvoiceBase = evt.result as InvoiceBase;
		var message:String;       
		
		if (invoiceTmp != null) {
			var goodPickup:Boolean = true;
			
			invoice = invoiceTmp;
			
			if (invoice.pickupDate != null && invoice.pickupDate.getDate() != 0) {
				message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_ErrorduringpickupAni");
				Alert.show(message, "Warning", 0, null, null, null, 4); 
				goodPickup = false;
			}
			
			if (invoice.amountDue < 0) {
				message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Sorrybutthisinvoiceh");
				Alert.show(message, "Warning", 0, null, null, null, 4); 
				goodPickup = false;
			}
			
			if (invoice.account == null || invoice.account.accountId == "") {
				message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Cantpickupaninvoiceu");
				Alert.show(message, "Warning", 0, null, null, null, 4); 
				goodPickup = false;
			}
			
			// TODO: test for delayed payment from PSS
			
			if (goodPickup && customerAccount != null && invoice.account != null && customerAccount.id != invoice.account.id) {
				message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Transactionalreadyin");
				Alert.show(message, "Warning", 0, null, null, null, 4); 
				goodPickup = false;
			}
			
			if (goodPickup) {
				customerAccount = invoice.account;			// active account for charging
				activeSale.isPickup = true;
				activeSale.taxTable = invoice.taxTable
			//	activeSale.taxCode = invoice.
				activeSale.subTotal = invoice.subTotal;
				activeSale.total = invoice.amountDue;
				activeSale.taxAmount = invoice.tax;
				activeSale.cashRegisterDept.title = invoice.name;
				activeSale.noTax = invoice.notTaxable;
				
				if (invoice.taxTable != null) {
					pickTaxTable.selectedIndex = findItem(invoice.taxTable.name, TaxTableArray);
					pickTaxCode.selectedIndex = findItem(invoice.taxCode.name, TaxCodesArray)
				}
				
				// TODO: capture invoice ID, Invoice Number, Previous deposits
				
			}			
		}
		
		this.throbber.visible = false;
		this.throbber.stop();

	}
]]>
                             
</mx:Script>

	

	<mx:Label x="0" y="64" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.DEPARTMENT')}" textAlign="center"/>	
	<mx:Tree x="0" y="80" width="130"  
		id="tvItems" 
		dataProvider="{systemCashPreferencesArray}"
		labelFunction="dotreelabel" height="100%" change="treeSelect(event);"></mx:Tree>
	
	<comp:Throbber id="throbber" height="40" width="40" visible="true" horizontalCenter="0" verticalCenter="0"/>

	<mx:Button x="150" y="10" width="38" height="38" click="doPostBatch();" enabled="{enableSave}" id="btnSave">
		<mx:icon>@Embed(source='../../../../assets/file.png')</mx:icon>
	</mx:Button>
	<mx:Button x="196" y="10" width="38" height="38" click="doRevert();" enabled="{enableSave}" id="btnRevert">
		<mx:icon>@Embed(source='../../../../assets/cancel.png')</mx:icon>
	</mx:Button>
	<mx:Button x="242" y="10" width="38" height="38" click="doInvoice();" enabled="{enableSave}" id="btnInvoice">
		<mx:icon>@Embed(source='../../../../assets/InvoiceWONotes.png')</mx:icon>
	</mx:Button>
	<mx:Button x="288" y="10" width="38" height="38" click="doAddJob();" enabled="{enableSave}" id="btnAddJob">
		<mx:icon>@Embed(source='../../../../assets/new_job.png')</mx:icon>
	</mx:Button>

	<mx:Canvas x="130" y="80" width="100%" height="100%" id="cashregister_canvas" hideEffect="effect" showEffect="effect">
		<mx:Button x="19" y="10" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CustAcct')}" click="doAccount();"/>
		<mx:TextInput x="158" y="10" text="{customerAccount.title}" width="252"/>
		<mx:Canvas x="0" y="40" width="200" height="95" id="tax_canvas" borderStyle="inset">
			<mx:Label x="5" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.TaxTable')}" width="64" textAlign="right"/>
			<mx:Label x="5" y="35" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.TaxCode')}" width="64" textAlign="right"/>

		    <mx:ComboBox x="77" y="8" change="UpdateCashRegister()" id="pickTaxTable" width="100" dataProvider="{TaxTableArray}" labelField="name" selectedItem="{data.name}"/>
		    <mx:ComboBox x="77" y="33" change="UpdateCashRegister()" id="pickTaxCode" width="100" dataProvider="{TaxCodesArray}" labelField="name" selectedItem="{data.name}"/>
		    <mx:CheckBox x="77" y="63" label="Non-Tax" id="chkNonTax" />
		</mx:Canvas>
		<mx:Canvas x="198" y="40" width="210" height="95" id="tax_canvas0" hideEffect="effect" showEffect="effect" borderStyle="inset">
			<mx:Label x="0" y="12" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'labelCmd.Format')}" width="59" textAlign="right"/>
			<mx:ComboBox x="67" y="10" id="cboFormat"  dataProvider="{FormatArray}" labelField="name" width="128"/>
			<mx:CheckBox x="10" y="35" id="chkPrintInvoice" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.PrintInvoice')}"/>
				
		</mx:Canvas>
		<mx:Canvas x="0" y="133" width="408" height="279" id="tax_canvas1" hideEffect="effect" showEffect="effect" borderStyle="inset">
			<mx:Button x="10" y="200" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Accept')}" click="doAccept();" width="176" enabled="false" id="accept_button"/>
			<mx:CheckBox x="10" y="243" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.PrintReceipt')}" id="checkbox1"/>
			<mx:TextArea x="384" y="244" width="10" height="8" id="txtSaleDescription" enabled="true"/>
		</mx:Canvas>
		<mx:Canvas x="407" y="40" width="261" height="216" id="tax_canvas2" hideEffect="effect" showEffect="effect" borderStyle="inset">
			<mx:Label x="50" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.PAYMENTMETHOD')}"/>
			<mx:Button x="10" y="180" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Payment')}" width="186" id="btPayment" click="doPayment();" enabled="false"/>
			<mx:RadioButtonGroup id="rgPaymentMethod" change="paymentMethodChanged(event)"/>
			<mx:RadioButton x="10" y="34" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CASH')}" id="rbCash" groupName="rgPaymentMethod" value="Cash"/>
			<mx:RadioButton x="10" y="60" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CRCARD')}" id="rbCreditCard" groupName="rgPaymentMethod" value="Credit Card"/>
			<mx:RadioButton x="131" y="34" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CHECK')}" id="rbCheck" groupName="rgPaymentMethod" value="Check"/>
			<mx:RadioButton x="131" y="60" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CHARGE')}" id="rbCharge" groupName="rgPaymentMethod" value="Charge"/>

		</mx:Canvas>
		<mx:Canvas x="407" y="252" width="261" height="160" id="tax_canvas3" hideEffect="effect" showEffect="effect" borderStyle="inset">
			<mx:Label x="10" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.SubTotal')}" id="label9" width="92" textAlign="right"/>
			<mx:Label x="11" y="36" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Tax')}" id="label8" width="91" textAlign="right"/>
			<mx:Label x="10" y="62" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Total')}" id="label7" width="92" textAlign="right"/>
			<mx:Label x="10" y="88" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Tendered')}" id="label5" width="92" textAlign="right"/>
			<mx:Label x="9" y="114" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Change')}" id="label6" width="93" textAlign="right"/>
			<mx:Text id="subtotal_edit" x="110" y="10" width="86"  textAlign="right"/>
			<mx:Text id="tax_edit" x="110" y="36" width="86" textAlign="right"/>
			<mx:Text id="total_edit" x="110" y="62" width="86" textAlign="right"/>
			<mx:Text id="tender_edit" x="110" y="88" width="86" textAlign="right"/>
			<mx:Text id="change_edit" x="110" y="114" width="86" textAlign="right"/>

		</mx:Canvas>
		<mx:DataGrid x="0" y="420" width="666" id="cashReg_grid" dataProvider="{batch.transactions}" height="119" itemClick="doTransactionGrid();">
			<mx:columns>
				<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rChargeLabel.Description')}" labelFunction="doDescript"/>
				<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invTotalCmd.Subtotal')}" labelFunction="doSubtotalPrice"/>
				<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invTotalCmd.Total')}"  labelFunction="doTotalPrice" />
			</mx:columns>
		</mx:DataGrid>
		<mx:Button x="10" y="558" click="doVoid();" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'tapeCmd.VoidTransaction')}" width="154"  enabled="false" id="button1"/>
		
	</mx:Canvas>
	<mx:Label x="150" y="54" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Post')}"/>
	<mx:Label x="199" y="54" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'listerCmd.Cancel')}"/>
	<mx:Label x="242" y="54" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'barcodeCmd.Invoice')}"/>
	<mx:Label x="288" y="54" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'jobCmd.NewJob')}"/>
</mx:TitleWindow>
