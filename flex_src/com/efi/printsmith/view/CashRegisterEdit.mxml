<?xml version="1.0" encoding="utf-8"?>
<mx:Panel 
	xmlns:mx="http://www.adobe.com/2006/mxml" 
	xmlns:comp="com.efi.printsmith.components.*" 
	layout="absolute" 
	width="100%" 
	name="cashRegister"
	height="100%"
	headerHeight="0" 
	title="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CashRegister')}" 
	label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CashRegister')}" 
		preinitialize="preInit();"
 	implements="com.efi.printsmith.security.ISecureComponent"
	xmlns:components="com.efi.printsmith.components.*" 
	xmlns:vo="com.efi.printsmith.vo.*">
<mx:Script source="../security/PSSecurityInclude.as" />
	<mx:CurrencyFormatter precision="2" id="currencyFormatter"/>
	<mx:NumberFormatter precision="2" id="numberFormatter"/>
	<mx:NumberFormatter precision="0" id="quantityFormatter"/>
	
 	<mx:states>
 	 	<mx:State name="">
 			<mx:RemoveChild target="{txtSaleDescription}"/>
  	 	</mx:State>
 	
 	 	<mx:State name="invoiceState">
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="10" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Invoice')}" id="invstate_label1" width="87" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="10" y="35" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.TotalDue')}" id="invstate_label2" width="87" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="10" y="61" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Description')}" id="invstate_label3"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:TextInput x="105" y="8" width="75" text="{invoice.invoiceNumber}" id="txtInvoiceNumber" focusOut="doGetInvoice()"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Text x="105" y="33" width="75" id="txtInvoiceTotalDue"/>
 	 	 	</mx:AddChild>


 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="10" y="140" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Paid')}" id="invstate_label4" width="81" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="12" y="165" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.StillDue')}" id="invstate_label5" width="79" textAlign="right"/>
 	 	 	</mx:AddChild>

 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Text x="99" y="138" width="75" id="txtInvoicePaid"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Text x="99" y="163" width="75" id="txtInvoiceStillDue"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:SetProperty target="{pickTaxTable}" name="enabled" value="false"/>
 	 	 	<mx:SetProperty target="{pickTaxCode}" name="enabled" value="false"/>
 	 	 	<mx:SetEventHandler target="{tax_canvas1}" name="activate"/>
 	 	 	<mx:SetProperty target="{chkNonTax}" name="enabled" value="false"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="x" value="10"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="y" value="85"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="width" value="349"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="height" value="45"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="enabled" value="true"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="editable" value="false"/>

 	 	</mx:State>
 	 	<mx:State name="departmentState">
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Quantity')}" id="label1" width="87" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="35" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.UnitPrice')}" id="label2" width="87" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="60" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Total')}" id="label3" width="87" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:TextInput  restrict="0-9\." x="105" y="8" width="75" id="txtSaleQuantity" tabIndex="1" focusOut="UpdateCashRegister()" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:TextInput  restrict="0-9\."  x="105" y="33" width="75" id="txtSaleUnitPrice" tabIndex="2" focusOut="UpdateCashRegister()" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:TextInput restrict="0-9\."  x="105" y="58" width="75" id="txtSaleTotal" textAlign="right" tabIndex="3" focusOut="doChangeTotalPrice()"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="86" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Description')}" id="label4"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:SetProperty target="{chkNonTax}" name="enabled" value="true"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="x" value="10"/>
 	 	 	<mx:SetProperty target="{label5}" name="width" value="92"/>
 	 	 	<mx:SetProperty target="{label6}" name="x" value="45"/>
 	 	 	<mx:SetProperty target="{label6}" name="width" value="92"/>
 	 	 	<mx:SetProperty target="{label8}" name="x" value="45"/>
 	 	 	<mx:SetProperty target="{label9}" name="width" value="92"/>
 	 	 	<mx:SetProperty target="{label8}" name="width" value="92"/>
 	 	 	<mx:SetProperty target="{label7}" name="width" value="92"/>
 	 	 	<mx:SetStyle target="{label6}" name="textAlign" value="right"/>
 	 	 	<mx:SetStyle target="{label5}" name="textAlign" value="right"/>
 	 	 	<mx:SetStyle target="{label7}" name="textAlign" value="right"/>
 	 	 	<mx:SetStyle target="{label8}" name="textAlign" value="right"/>
 	 	 	<mx:SetStyle target="{label9}" name="textAlign" value="right"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="enabled" value="true"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="x" value="10"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="y" value="112"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="width" value="170"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="height" value="53"/>
 	 	</mx:State>
 	 	<mx:State name="invoicePaymentMethod" basedOn="invoiceState">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="154" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Amount')}" width="103" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="152" width="75" textAlign="right" id="invoice_payment"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:RemoveChild target="{invstate_label1}"/>
 	 	 	<mx:RemoveChild target="{txtInvoiceNumber}"/>
 	 	 	<mx:RemoveChild target="{invstate_label2}"/>
 	 	 	<mx:RemoveChild target="{txtInvoiceTotalDue}"/>
 	 	 	<mx:RemoveChild target="{invstate_label3}"/>
 	 	 	<mx:RemoveChild target="{txtSaleDescription}"/>
 	 	 	<mx:RemoveChild target="{invstate_label4}"/>
 	 	 	<mx:RemoveChild target="{txtInvoicePaid}"/>
 	 	 	<mx:RemoveChild target="{invstate_label5}"/>
 	 	 	<mx:RemoveChild target="{txtInvoiceStillDue}"/>
 	 	</mx:State>
 	 	<mx:State name="paymentPaymentMethod" basedOn="departmentState">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="154" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Amount')}" width="103" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput  restrict="0-9\.\-" x="121" y="152" width="75" id="payment_cash_edit" change="UpdateBatchNumbers()" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:RemoveChild target="{txtSaleDescription}"/>
 	 	 	<mx:SetProperty target="{tax_canvas1}" name="height" value="278"/>
 	 	 	<mx:SetProperty target="{tax_canvas3}" name="height" value="157"/>
 	 	 	<mx:RemoveChild target="{label1}"/>
 	 	 	<mx:RemoveChild target="{txtSaleQuantity}"/>
 	 	 	<mx:RemoveChild target="{txtSaleUnitPrice}"/>
 	 	 	<mx:RemoveChild target="{txtSaleTotal}"/>
 	 	 	<mx:RemoveChild target="{label2}"/>
 	 	 	<mx:RemoveChild target="{label3}"/>
 	 	 	<mx:RemoveChild target="{label4}"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="x" value="1"/>
 	 	</mx:State>
 	 	<mx:State name="paymentCash" basedOn="paymentPaymentMethod">
 	 	 	<mx:SetProperty target="{button1}" name="y" value="547"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="y" value="420"/>
 	 	 	<mx:SetProperty name="height" value="760"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="width" value="668"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="x" value="0"/>
 	 	 	<mx:SetProperty target="{cashregister_canvas}" name="height" value="577"/>
 	 	 	<mx:SetProperty target="{cashregister_canvas}" name="width" value="687"/>
 	 	 	<mx:SetProperty name="width" value="857"/>
 	 	 	<mx:SetProperty target="{accept_button}" name="enabled" value="true"/>
 	 	</mx:State>
 	 	<mx:State name="paymentCreditCard" basedOn="paymentPaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="90" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.CardType')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="72" y="116" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.Ref')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:ComboBox x="76" y="88" width="171"  labelField="cardType" dataProvider="{creditCardPreferencesArray}" id="card_type"></mx:ComboBox>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="114" width="75"  id="card_ref" focusOut="UpdateCashRegister()"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:SetProperty target="{accept_button}" name="enabled" value="true"/>
 	 <!-- 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Button x="204" y="115" width="19" height="19" click="doCreditCardManualApproval()" enabled="{enableCCApproval}" id="btnCCmanualApprove0">
 	 	 	 		<mx:icon>@Embed(source='../../../../assets/CreditCardManualApproval.png')</mx:icon>
 	 	 	 	</mx:Button>
 	 	 	</mx:AddChild>	-->
 	 	 	<!--<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild" target="{checkbox1}"/>
 	 	 	<mx:SetProperty target="{checkbox1}" name="x" value="267"/>
 	 	 	<mx:SetProperty target="{checkbox1}" name="y" value="230"/>-->
 	 	</mx:State>
 	 	<mx:State name="paymentCheck" basedOn="paymentPaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="62" y="116" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.Check')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="114" width="75" id="check_num" focusOut="UpdateCashRegister()"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:SetProperty target="{accept_button}" name="enabled" value="true"/>
 	 	</mx:State>
 	 	<mx:State name="paymentCharge" basedOn="paymentPaymentMethod">
 	 	 	<mx:SetProperty target="{accept_button}" name="enabled" value="true"/>
 	 	</mx:State>
 	 	<mx:State name="invoiceCash" basedOn="invoicePaymentMethod">
 	 	</mx:State>
 	 	<mx:State name="invoiceCreditCard" basedOn="invoicePaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="90" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.CardType')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="72" y="116" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.Ref')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:ComboBox x="76" y="88" width="120"  labelField="cardType" dataProvider="{creditCardPreferencesArray}" id="invoice_card_type"></mx:ComboBox>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="114" width="75" id="invoice_card" focusOut="UpdateCashRegister()"/>
 	 	 	</mx:AddChild>
 	 	<!-- 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Button x="204" y="115" width="19" height="19" click="doCreditCardManualApproval()" enabled="{enableCCApproval}" id="btnCCmanualApprove">
 	 	 	 		<mx:icon>@Embed(source='../../../../assets/CreditCardManualApproval.png')</mx:icon>
 	 	 	 	</mx:Button>
 	 	 	</mx:AddChild>	-->
 	 	</mx:State>
 	 	<mx:State name="invoiceCheck" basedOn="invoicePaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="62" y="116" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.Check')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="114" width="75" id="invoice_check" focusOut="UpdateCashRegister()"/>
 	 	 	</mx:AddChild>
 	 	</mx:State>
 	 	<mx:State name="invoiceCharge" basedOn="invoicePaymentMethod">
 	 	</mx:State>
 	</mx:states>
 
 	<mx:RemoteObject id="dataService" destination="dataService">
 		<mx:method name="getAccountPicker" fault="handleFault(event)" result="handleLoadAccountsResult(event)"/>
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveResult(event)"/>
		<mx:method name="getAccount" fault="handleFault(event)" result="handleGetResult(event)"/>
		<mx:method name="getInvoiceByInvoiceNumber" fault="handleFault(event)" result="handleLoadInvoice(event)"/>
		<mx:method name="saveInvoice" fault="handleFault(event)" result="handleSaveResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceUnPurchase" destination="dataService">
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveUnPurchaseResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="invoiceRepositoryService" destination="invoiceRepositoryService">
		<mx:method name="getItemList"
					fault="handleFault(event)"
					result="handleLoadInvoiceTemplates(event)"/>		
	</mx:RemoteObject>

	<mx:RemoteObject id="dataServiceCashDrawer" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadCashDrawerResult(event)"/>
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveCashDrawerResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceCCT" destination="dataService">
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleCCTSaveResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceSessionBatch" destination="dataService">
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveSessionBatchResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceAccount" destination="dataService">
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleAccountSaveResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceTapeBatch" destination="dataService">
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveTapeBatchResult(event)"/>
		<mx:method name="getCurrentTapeBatch" fault="handleFault(event)" result="handleLoadCurrentTapeBatch(event)"/>
	</mx:RemoteObject>
 	<mx:RemoteObject id="dataServiceTaxCodes" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadTaxCodesResult(event)"/>
	</mx:RemoteObject>
 	<mx:RemoteObject id="dataServiceTaxTable" destination="dataService">
		<mx:method name="getCurrentTaxTables" fault="handleFault(event)" result="handleLoadTaxTableResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceSystemPreferences" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadSystemPreferencesResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceCashPreferences" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadCashRegPreferencesResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="taxCalculatorService" destination="taxService">
		<mx:method name="calculateTax" fault="handleFault(event)" result="handleTaxResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceCreditCardPreferences" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadCreditCardPreferencesResult(event)"/>
	</mx:RemoteObject>
	<mx:Producer id="producer" destination="cashregister"/>
	<mx:Consumer id="consumer" destination="cashregister" message="messageHandler(event.message)"/>
	<mx:Consumer id="notification_consumer" destination="notifications" message="messageHandler(event.message)"/>
<mx:Script>
<![CDATA[
	import com.efi.printsmith.data.Charge;
	import mx.events.ListEvent;
	import mx.events.TreeEvent;
	import mx.events.FlexEvent;
	import com.efi.printsmith.security.PSSecurityCommands;
	import com.efi.printsmith.data.InvoiceBase;
	import com.efi.printsmith.data.JobBase;
	import com.efi.mdi.view.window.MDIWindow;
	import com.efi.printsmith.data.CashDrawer;
	import com.efi.printsmith.data.Tape;
	import com.hillelcoren.utils.ArrayCollectionUtils;
	import com.efi.printsmith.data.PreferencesCashRegister;
    import mx.events.*;
	import mx.controls.Text;
	import mx.utils.StringUtil;
	import mx.managers.FocusManager;
	import com.efi.printsmith.security.PSSecurityCommands;
	import com.efi.printsmith.security.PSSecurityUtils;
	import com.efi.printsmith.components.AskUserForDescriptionPopup;

	import com.efi.printsmith.data.TaxTable;
	import com.efi.printsmith.data.TaxCodes;
	
	import com.efi.printsmith.data.TapeBatch;
	import com.efi.printsmith.data.TapeSessionBatch;
	import com.efi.printsmith.data.TapePaymentRecord;
	import com.efi.printsmith.data.TapeSaleRecord;
	import com.efi.printsmith.data.TapeDepositAppliedRecord;
	
	import com.efi.printsmith.data.AccountHistoryData;
	import com.efi.printsmith.data.CreditCardTransactions;
	import com.efi.printsmith.data.CreditCard;
	import com.efi.printsmith.data.Charge;
	
	import com.efi.printsmith.data.PreferencesSystem;
	import com.efi.printsmith.events.AccountPickerSelectEvent;
	import com.efi.printsmith.data.PreferencesCreditCard;
	import com.efi.printsmith.data.Account;
	import com.efi.printsmith.data.UnpurchasedMerchandise;
	import com.efi.printsmith.data.DepositEntry;

	import com.efi.printsmith.events.JobEditCompleteEvent;
	import com.efi.printsmith.events.CreditCardTrackReadEvent;
	import com.efi.printsmith.events.CreditCardTransEvent;
	import com.efi.printsmith.events.ChargeDefinitionSelectEvent;
	import com.efi.printsmith.events.SaveAskUserDescriptionEvent;
	
	import com.efi.printsmith.Constants;

	import mx.controls.Alert;                                         
	import mx.managers.PopUpManager;                                         
	import mx.containers.TitleWindow;                                         
	import mx.collections.ArrayCollection;                                         
	import mx.rpc.events.ResultEvent;                                         
	import mx.rpc.events.FaultEvent;                                         
	import mx.messaging.messages.AsyncMessage;
	import mx.messaging.messages.IMessage;
	import mx.collections.XMLListCollection;
	import mx.formatters.NumberBaseRoundType;

	[Bindable]
	private var enableSave:Boolean = false;
	[Bindable]
	private var enableCCApproval:Boolean = true;
	[Bindable]
	private var waitOnNewCashDrawer:Boolean = false;

	[Bindable]                                         
    private var systemPreferences:PreferencesSystem;
    [Bindable]  
 	private var accounts:ArrayCollection = new ArrayCollection();
	[Bindable]                                
	private var systemPreferencesArray:ArrayCollection = new ArrayCollection();

	[Bindable]
	private var systemCashPreferencesArray:ArrayCollection = new ArrayCollection();
	
	private var printList:ArrayCollection = new ArrayCollection();
	
	
[Bindable]
	private var invoice:InvoiceBase;
	[Bindable]
	private var customerAccount:Account;
	[Bindable]
	private var creditLimit:Number;
	[Bindable]
	private var AustrailianRounding:Boolean;
	[Bindable]
	private	var unPurchase:UnpurchasedMerchandise;
	[Bindable]
	private var charges:ArrayCollection=new ArrayCollection();
	[Bindable]
	private var TaxTableArray:ArrayCollection = new ArrayCollection();
	[Bindable]
	private var TaxCodesArray:ArrayCollection = new ArrayCollection();
	[Bindable]
	private var FormatArray:ArrayCollection = new ArrayCollection();
	[Bindable]
    private var creditCardPreferencesArray:ArrayCollection = new ArrayCollection();
   [Bindable]
	private var cashDrawer:CashDrawer;
	[Bindable]
	private var sessionBatch:TapeSessionBatch;
	[Bindable]
	private var tapeBatch:TapeBatch;
	[Bindable]
	private var activeSale:TapeSaleRecord;
	[Bindable]
	private var activePayment:TapePaymentRecord;
//Tree view XML table
	
	public function CashRegisterInvPickup(inv:InvoiceBase):void {
		if (inv != null) {
			invoice = inv;
		}
	}
	
	private function handleLoadTaxTableResult(ev:ResultEvent):void {
		var i:int;
		var temp:TaxTable = new TaxTable();
	     TaxTableArray = ev.result as ArrayCollection;
	     for(i = 0; i< TaxTableArray.length; i++) {
	     	temp = TaxTableArray.getItemAt(i) as TaxTable;
	     	if ( temp.defaultTable)
	    	 	pickTaxTable.selectedIndex = i
	     }
	    	  
	}
	private function handleLoadTaxCodesResult(ev:ResultEvent):void {
	     TaxCodesArray = ev.result as ArrayCollection;
	}
	private function handleLoadCashDrawerResult(ev:ResultEvent):void {
	    var cashDrawerArray:ArrayCollection = ev.result as ArrayCollection;
	    
	    //
	    // should never be more than one cash drawer in the current design
	    //
		if (cashDrawerArray.length > 0)
		{
			cashDrawer = cashDrawerArray.getItemAt(0) as CashDrawer;
		} else {
			waitOnNewCashDrawer = true;
	     	cashDrawer = new CashDrawer();
	     	dataServiceCashDrawer.addUpdate(cashDrawer);
		}
	}
	
	private function handleSaveCashDrawerResult(ev:ResultEvent):void {
		var i:int = 0;
		cashDrawer = ev.result as CashDrawer;
		
		//
		// first time startup, no cash drawer exist.
		//
		if (waitOnNewCashDrawer == true) {
			waitOnNewCashDrawer = false;
		} 
		//
		// normal SAVE of the cash drawer after a session is POST'ed
		//
		else {
			InitSessionBatch();		// new session
			InitSaleRecord();		// setup for another sale
			invoice = null;
			this.currentState = "";
			if (chkNonTax.selected == true)
				chkNonTax.dispatchEvent(new MouseEvent(MouseEvent.CLICK , false, false));
			openTree();
			charges = new ArrayCollection();
			UpdateBatchNumbers();	
			
			//
			// print the invoices that have been pick-up WHILE the print option was turn ON
			//
			if (printList != null && printList.length > 0) {
				var reportName:String = cboFormat.selectedItem as String;
				
				for(i = 0; i< printList.length; i++) {
					invoice = printList.getItemAt(i) as InvoiceBase;
					if (invoice != null) {
						var urlRequest:URLRequest = new URLRequest("http://localhost:8080/Snowmass/reportservlet?invoiceName="+reportName +"&reportParameter="+invoice.id);
               		 	navigateToURL(urlRequest, "_blank");
     				}
  				 }
			}
			
			printList.removeAll();
		}
		
		//
		//  all saves have been completed
		//
		this.throbber.visible = false;
		this.throbber.stop();
	}
	
	private function handleAccountSaveResult(ev:ResultEvent):void {
		customerAccount = null;		// no longer needed after a POST
		acct_type.text = "";
		acct_status_text.text = "";
		acct_title.text = "";
	}

	private function handleLoadCashRegPreferencesResult(ev:ResultEvent):void{
		systemCashPreferencesArray = ev.result as ArrayCollection;
		
		//
		// in a normal startup, this is the last record to wait on, but if a new cash drawer is built
		//	then we must wait on it as well.
		//
		if (waitOnNewCashDrawer == false) {
			this.throbber.visible = false;
			this.throbber.stop();
		}
	}
	
	public function handleLoadInvoiceTemplates(evt:ResultEvent):void {
		if (evt.result != null) {
			FormatArray = evt.result as ArrayCollection;
		}

		dataService.getAccountPicker();
		
		// invoice came in with the window OPEN, like a pending list pickup request
		if (invoice != null) {
			doInvoice();
			handlePickupInvoice(invoice);
		}
	}

	// call back AFTER the credit card charge is complete
	private function handleCreditCardTransWrite(ev:CreditCardTransEvent):void 
	{
		var temp:CreditCardTransactions = ev.theData as CreditCardTransactions;
		
		if (temp != null) {
			activePayment.cct = temp;
			card_ref.text = activePayment.cct.approvalCode;
		}
		
		UpdateCashRegister();
	}

	private function handleLoadSystemPreferencesResult(ev:ResultEvent):void {
		systemPreferencesArray = ev.result as ArrayCollection;
		if (systemPreferencesArray.length > 0)
		{
			systemPreferences = systemPreferencesArray.getItemAt(0) as PreferencesSystem;
			AustrailianRounding = systemPreferences.austrailianInvoiceRounding;
		}else {
			AustrailianRounding = false;
		}

	}	                                 
	private function handleTaxResult(ev:ResultEvent):void{
		
		this.throbber.visible = false;
		this.throbber.stop();
		
		if (ev.result != null) {
			var results:ArrayCollection = ev.result as ArrayCollection;
		    var taxStr:String;
		    
		    taxStr = results.getItemAt(0) as String;		// tax amount calculated
		    activeSale.taxAmount = parseFloat(taxStr.replace(",",""));
			activeSale.taxAmount = roundToCurrency(activeSale.taxAmount);
			
			if (activeSale.opPrice == false) {
				activeSale.total = activeSale.subTotal + activeSale.taxAmount;
				activeSale.total = roundToCurrency(activeSale.total);
			}
			UpdateBatchNumbers();
		}
	}
	
	private function UpdateBatchNumbers():void {
				
		sessionBatch.accumChange = roundToCurrency(((sessionBatch.accumTendered + activePayment.total) - sessionBatch.accumTotal));
		
		// update the batch numbers with the current SALE and Payment transactions (before any accept)
		//
		subtotal_edit.text = Snowmass.getCurrencyFormatter(false,2).format(sessionBatch.accumSubTotal + activeSale.subTotal);
		tax_edit.text = Snowmass.getCurrencyFormatter(false,2).format(sessionBatch.accumTaxTotal + activeSale.taxAmount);
		total_edit.text = Snowmass.getCurrencyFormatter(false,2).format(sessionBatch.accumTotal + activeSale.total);
		tender_edit.text = Snowmass.getCurrencyFormatter(false,2).format(sessionBatch.accumTendered + activePayment.total);
		change_edit.text = Snowmass.getCurrencyFormatter(false,2).format(sessionBatch.accumChange);
	}	
	
	public function getSecurityCommand():String {
    	return PSSecurityCommands.POS_OPENCASHREGISTER;
    }
    
    private function InitPaymentRecord():void {    	
    	activePayment = new TapePaymentRecord();
    	
    	if (payment_cash_edit != null)
    		payment_cash_edit.text = "";
    	if (check_num != null)
    		check_num.text = "";
    	if (card_ref != null)
    		card_ref.text = "";
    	
    	rgPaymentMethod.selection = null;		// no radio button selections
    }
    
    private function InitSaleRecord():void {
    	InitPaymentRecord();
    	
 		activeSale = new TapeSaleRecord();
 		activeSale.cashRegisterDept = null;
		activeSale.customerAccount = new Account();
		creditLimit = 0;
		
		if (txtSaleDescription != null)
			txtSaleDescription.text = "";
		if (txtSaleQuantity != null)
			txtSaleQuantity.text = "";
		if (txtSaleUnitPrice != null)
			txtSaleUnitPrice.text = "";
		if (txtSaleTotal != null) {
			txtSaleTotal.text = "";
			setOverrideForField(txtSaleTotal, activeSale.opPrice);
		}
		if (txtInvoiceTotalDue != null) {
			txtInvoiceTotalDue.text = "";
		}
		
   }
   
   private function InitSessionBatch():void {
   		sessionBatch = new TapeSessionBatch();   		
   		//
   		// array of Transactions, could be Sale or Payments
   		//
		sessionBatch.transactions = new ArrayCollection();
		
		// the user was logged in during the session
		sessionBatch.user = Snowmass.getInstance().currentUser;
		
		// date that appears in register tape UI
		sessionBatch.created = new Date();
		
		// this session came from the cash register
		sessionBatch.isPOSbatch = true;
   }
   
 	//
	private function myKeyDownHandler(event:KeyboardEvent):void {
		var	stringChar:String;
		var curKeyCode:int;
		var goodKeyEquiv:Boolean;
		var tmpItem:PreferencesCashRegister ;
		var i:int = 0;

		
		// ONLY WHEN command and shift keys are down
		//
		if( event.altKey == false && event.ctrlKey == true && event.shiftKey == true){
			curKeyCode = event.keyCode;
			stringChar = String.fromCharCode(event.charCode);
			
			if (stringChar != "") {
				//
				// look for the first charcater in the radio button titles as a match
				//
				if (stringChar == "+") {
					rbCash.dispatchEvent(new MouseEvent(MouseEvent.CLICK , false, false));
				} else if (stringChar == rbCreditCard.label.substr(0,1)) {
					rbCreditCard.dispatchEvent(new MouseEvent(MouseEvent.CLICK , false, false));
				} else if (stringChar == rbCheck.label.substr(0,1)) {
					rbCheck.dispatchEvent(new MouseEvent(MouseEvent.CLICK , false, false));
					rbCheck.selected = true;
				} else if (stringChar == rbCharge.label.substr(0,1)) {
					rbCharge.dispatchEvent(new MouseEvent(MouseEvent.CLICK , false, false));
				} else {
					//
					// search the preffix character in the department list
					//
					for (i = 0; i < systemCashPreferencesArray.length; ++i) {
						tmpItem = systemCashPreferencesArray.getItemAt(i) as PreferencesCashRegister;
						if (tmpItem != null && tmpItem.buttonPrefixCharacter != null) {
							if (tmpItem.buttonPrefixCharacter.toString() == stringChar) {
								tvItems.selectedIndex = i;					
								this.stage.focus = null;
								
								tvItems.validateNow();
								tvItems.dispatchEvent(new ListEvent("change"));
								
								if (txtSaleQuantity != null && txtSaleQuantity.enabled)
									txtSaleQuantity.setFocus();
								
								event.stopImmediatePropagation();
								break;
							}
						}
					}
				}
			}
		}
	}

  	//
	// this is used to change the font in the active field to show a override state
	//
	private function setOverrideForField(field:TextInput, overrideActive:Boolean):void
	{
		if (overrideActive)
		{
			field.setStyle("fontStyle","italic");
			field.setStyle("textDecoration","underline");
		} else {
			field.setStyle("fontStyle","normal");
			field.setStyle("textDecoration","none");
		}
	}

	public function init(event:FlexEvent = null):void {
		consumer.subscribe();
		notification_consumer.subscribe();
		
		this.throbber.visible = true;
		this.throbber.play();

		var mdiWin:MDIWindow = Snowmass.getInstance().containerManager.getWindowWithChild(this);
		mdiWin.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CashRegister');
		
		stage.addEventListener(KeyboardEvent.KEY_DOWN, myKeyDownHandler);
				
		// these will be appeaded to the open tape
		tapeBatch = null;
		
		//
		// this is the session that is appeaded to the open tape batch
		//
		InitSessionBatch();
		
		// current monies held in the cash drawer
		cashDrawer = new CashDrawer();
		
		dataServiceCashDrawer.getAll("CashDrawer");
		dataServiceSystemPreferences.getAll("PreferencesSystem");
		dataServiceCreditCardPreferences.getAll("PreferencesCreditCard");
		dataServiceTaxCodes.getAll("TaxCodes")	;
		dataServiceTaxTable.getCurrentTaxTables("TaxTable");
		dataServiceCashPreferences.getAll("PreferencesCashRegister");
		
		dataServiceTapeBatch.getCurrentTapeBatch();
		
		InitSaleRecord();			// setup for the first sale transaction
		
		// perform the account load in the background, the button will come alive when list is loaded
		invoiceRepositoryService.getItemList();
		btnCustAcct.enabled = false;
		
		this.addEventListener(mx.events.StateChangeEvent.CURRENT_STATE_CHANGE, paymentStateHandler);
	}
	
	private function messageHandler(message:IMessage):void{
		var messageBody:Object = message.body;// as com.efi.messaging.MessageBody;
		
		var messageType:String = messageBody.messageType;
		if (messageType == "ADDUPDATE" || messageType == "DELETE") {
			var payloadType:String = messageBody.payloadType as String; // What kind of item was added/deleted
			var payload:Number = messageBody.payload as Number; // ID if item added or deleted
			if (payloadType == "TaxTable") {
				dataServiceTaxTable.getAll("TaxTable")
			}
			if (payloadType == "TaxCodes") {
				dataServiceTaxCodes.getAll("TaxCodes")
			}
		}
	}
      private function handleLoadCreditCardPreferencesResult(ev:ResultEvent):void {
		creditCardPreferencesArray = ev.result as ArrayCollection;
		
	}	            
	private function handleFault(ev:FaultEvent):void {  
		var message:String;
		              
		message = "Error: "                          
		+ ev.fault.faultCode + " - "                                  
		+ ev.fault.faultDetail + " - "                                  
		+ ev.fault.faultString;
		Alert.show(message, "Error", 0, null, null, null, 4);                                 
	}


	private function handleLoadAccountsResult(ev:ResultEvent):void {
		accounts = ev.result as ArrayCollection;
		
		btnCustAcct.enabled = true;
	}

	private function handleSaveResult(ev:ResultEvent):void {

	}
	
	private function handleSaveUnPurchaseResult(ev:ResultEvent):void{

	}

	private function handleSaveSessionBatchResult(ev:ResultEvent):void {
		var sessionBatch:TapeSessionBatch = ev.result as TapeSessionBatch;
		var i:int = 0;
		var temp:Object = null;
		var tempSale:TapeSaleRecord = null;
		var accountChanged:Boolean = false;
		var tempPayment:TapePaymentRecord;
		var arRecord:AccountHistoryData;
		
		if (sessionBatch != null && sessionBatch.transactions!= null) {
			for(i = 0; i< sessionBatch.transactions.length; i++) {
				temp  = sessionBatch.transactions.getItemAt(i) as Object;
				
			if (temp is TapePaymentRecord) {
					tempPayment = temp as TapePaymentRecord;
					
					tempPayment.changeAmount = sessionBatch.accumChange;		// track how much was given back
					
					// post the invoice (payment record to the account history
					//
					if (tempPayment.postAR == true) {
						arRecord = new AccountHistoryData();
						tempPayment.accountHistoryData = arRecord;			// record AR history record into tape
						
						arRecord.recordType = Constants.ACCOUNT_HISTORY_TYPE_PAYMENT;
						arRecord.account = sessionBatch.account;
						arRecord.postedDate = new Date();
						
						// TODO - calculate the payment due date
						//arRecord.paymentDueDate = 
						
						arRecord.invoice = tempPayment.invoice;
						arRecord.custPO = tempPayment.invoice.customerPO;
						arRecord.salesRep = tempPayment.invoice.salesRep;
						arRecord.name = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"posRegisterCmd.Payment");
						
						arRecord.finalPayPaydate = new Date();
						arRecord.finalPayPayMethod = tempPayment.paymentMethod;
						arRecord.finalPayCCT = tempPayment.cct;
						arRecord.finalPayRefNumber = tempPayment.refNumber;
						arRecord.finalPayCheckNumber = tempPayment.checkNumber;
						arRecord.finalPayTotal = -(tempPayment.total);			// show as negative in history
						arRecord.taxDetail = tempPayment.taxTable;
						arRecord.refundTotal = tempPayment.changeAmount;
						arRecord.balance = tempPayment.amountBalance;
						// TODO
						//arRecord.storeNumber = 
						
						if (sessionBatch.account != null) {
							sessionBatch.account.lastPaymentDate = new Date();
							accountChanged = true;
						}
					}
					
					//
					// put payment in the cash drawer 
					//
					switch(tempPayment.paymentMethod)
					{
						case Constants.POS_CASH_REGISTER_PAYMODE_CASH:
							cashDrawer.cashTotal += tempPayment.total;
							break;
							
						case Constants.POS_CASH_REGISTER_PAYMODE_CHECK:
						case Constants.POS_CASH_REGISTER_PAYMODE_DRAFT:	// i.e., check
							cashDrawer.checkCount++;
							cashDrawer.checkTotal += tempPayment.total;
							break;
							
						case Constants.POS_CASH_REGISTER_PAYMODE_CREDITCARD:
							cashDrawer.cardCount++;
							cashDrawer.cardTotal += tempPayment.total;
							break;
							
						case Constants.POS_CASH_REGISTER_PAYMODE_CHARGE:
							cashDrawer.arBalance += tempPayment.total;
							
							if (sessionBatch.account != null) {
								sessionBatch.account.balance += tempPayment.total;
								accountChanged = true;
							}
							break;
					}

				} else if (temp is TapeSaleRecord) {
					tempSale = temp as TapeSaleRecord;
					
					// invoice pickup
					//
					if (tempSale.isPickup) {
						if (tempSale.invoice != null) {
						// moved to save results of the ArHistRecord
						//	tempSale.invoice.pickupDate = new Date();
						//	tempSale.invoice.offPendingDate = tempSale.invoice.pickupDate;
						//	tempSale.invoice.onPendingList = false;
						//	tempSale.invoice.locked = true;
						//	dataService.addUpdate(tempSale.invoice);
							
							// TODO - costing the invoice is needed
							
							// TODO - Consume stock if needed
														
							//
							// make entry in Account History for invoice pickup and amount due
							//
							arRecord = new AccountHistoryData();
							arRecord.recordType = Constants.ACCOUNT_HISTORY_TYPE_INVPICKUP;
							arRecord.account = sessionBatch.account;
							arRecord.created = new Date();
							arRecord.invoice = tempSale.invoice;
							
							// TODO - need name from account block WHEN cash account,in place of invoice name
							arRecord.name = tempSale.invoice.name;
							arRecord.total = tempSale.invoice.amountDue;
							arRecord.subTotalPosted = tempSale.invoice.grandTotal;
							arRecord.balance = (tempSale.total - tempSale.amountPaid);
							arRecord.balance = roundToCurrency(arRecord.balance);
							
							 if (tempSale.paymode != "") {	// some payment applied
								// still has outstanding balance
								if (arRecord.balance > 0) {
									// classic tracks partial pay in static way
									arRecord.partialPayPayMethod = tempSale.paymode;
									arRecord.partialPayCCT = tempSale.cct;
									arRecord.partialPayRefNumber = tempSale.refNumber;
									arRecord.partialPayCheckNumber = tempSale.checkNumber;
									arRecord.partialPayTotal = tempSale.amountPaid;
									arRecord.taxDetail = tempSale.taxTable;
									arRecord.partialPayCnt = 1;
								} 
								// all paid for
								else {
									arRecord.finalPaymentDate = new Date();
									arRecord.finalPayPayMethod = tempSale.paymode;
									arRecord.finalPayCCT = tempSale.cct;
									arRecord.finalPayRefNumber = tempSale.refNumber;
									arRecord.finalPayCheckNumber = tempSale.checkNumber;
									arRecord.finalPayTotal = tempSale.amountPaid;
									arRecord.taxDetail = tempSale.taxTable;
								}
							} 
							//
							// full deposit, no payment needed
							//
							else if (arRecord.balance == 0) {
								arRecord.finalPaymentDate = new Date();
								arRecord.finalPayPayMethod = Constants.POS_CASH_REGISTER_PAYMODE_DEPOSIT;
								arRecord.finalPayCheckNumber = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"depositCmd.Deposit");
							} 
							
							tempSale.accountHistoryData = arRecord;			// record AR history record into tape
														
							if (sessionBatch.account != null) {
								var amountForThisPosting:Number = roundToCurrency(tempSale.subTotal - tempSale.taxAmount);
								
								if (sessionBatch.account.firstInvoiceDate == null) {
									sessionBatch.account.firstInvoiceDate = new Date();
								}
								sessionBatch.account.ordersMonth += 1;
								sessionBatch.account.ordersYear += 1;
								sessionBatch.account.ordersTotal += 1;
								sessionBatch.account.salesMonth += amountForThisPosting;
								sessionBatch.account.salesYear += amountForThisPosting;
								sessionBatch.account.termsDiscount += amountForThisPosting;
						//		sessionBatch.account.lastPostingDate = new Date();		// TODO (wrong type right now)
								accountChanged = true;
							}
						}
					} 
					//
					// are there any merchandise charges that need to be logged
					//
					else  {
						if (tempSale.paymode == Constants.POS_CASH_REGISTER_PAYMODE_CHARGE) {
							// not compleletly paid for
							if (tempSale.amountPaid == 0 || tempSale.total > tempSale.amountPaid) {
								unPurchase = new UnpurchasedMerchandise();
								unPurchase.account = sessionBatch.account;
								unPurchase.saleRecord = tempSale;		// not valid at this point, need to wait until after save
								unPurchase.transactionDate = new Date();
								unPurchase.amountDue = roundToCurrency(tempSale.total - tempSale.amountPaid);
								
								dataServiceUnPurchase.addupdate(unPurchase);
							}
						}
					}
				}
			}
			
			// keep a running count as the session ID
			//	for the register tape to give a scrolling index
			//	and for a reference of a tape VOID number.
			sessionBatch.sessionID = tapeBatch.sessionBatches.length + 1;
			
			tapeBatch.sessionBatches.addItem(sessionBatch);
			dataServiceTapeBatch.addUpdate(tapeBatch); 
		}
		
		if (chkPrintInvoice.selected == true) {
			printList.addItem(tempPayment.invoice);
		}	
		
		if (sessionBatch.account != null) {
			var amountForThisPosting2:Number = roundToCurrency(tempSale.subTotal - tempSale.taxAmount);
					
			if (sessionBatch.account.firstInvoiceDate == null) {
				sessionBatch.account.firstInvoiceDate = new Date();
			}
     		sessionBatch.account.ordersMonth += 1;
			sessionBatch.account.ordersYear += 1;
			sessionBatch.account.ordersTotal += 1;
			sessionBatch.account.salesMonth += amountForThisPosting2;
			sessionBatch.account.salesYear += amountForThisPosting2;
			sessionBatch.account.termsDiscount += amountForThisPosting2;
			//	sessionBatch.account.lastPostingDate = new Date();		// TODO (wrong type right now)
			accountChanged = true;
		}	
				
		if (accountChanged == true) {
			dataServiceAccount.addUpdate(customerAccount);
		}	
	}
	
	private function handleSaveTapeBatchResult(ev:ResultEvent):void{
		var tapeBatch:TapeBatch = ev.result as TapeBatch;
		var i:int = 0;
		var temp:Object = null;
		var tempSale:TapeSaleRecord = null;
		
		// session batch was saved before now.
		// attach any history records to the effected invoices
		//
		if (sessionBatch != null && sessionBatch.transactions!= null) {
			for(i = 0; i< sessionBatch.transactions.length; i++) {
				temp  = sessionBatch.transactions.getItemAt(i) as Object;
				
				if (temp is TapeSaleRecord) {
					tempSale = temp as TapeSaleRecord;
					//
					// invoice pickup, place a record into the invoice that points at the history record
					//		that was created for the pick.  this is where invoice balance will come from.
					//
					if (tempSale.isPickup) {
						if (tempSale.invoice != null) {
							tempSale.invoice.pickupDate = new Date();
							tempSale.invoice.offPendingDate = tempSale.invoice.pickupDate;
							tempSale.invoice.onPendingList = false;
							tempSale.invoice.locked = true;
							tempSale.invoice.accountHistoryData = tempSale.accountHistoryData;
							dataService.saveInvoice(tempSale.invoice);
						} 
					}
				}
			}
		}
		
		//
		// save the cash drawer, when complete the register will be reset back to inital state
		// see "handleSaveCashDrawerResult"
		//
		dataServiceCashDrawer.addUpdate(cashDrawer);
	}
		
	private function UpdateCashRegister():void{
		var temp:Number;
		var tempString:String;
		var tempQuantity:Number;
		
		if (txtSaleQuantity != null && txtSaleQuantity.text != "")
			tempQuantity = parseInt(txtSaleQuantity.text.replace(",",""));
		else
			tempQuantity = 0;
			
		if (txtSaleUnitPrice != null && txtSaleUnitPrice.text != "")
			temp = parseFloat(txtSaleUnitPrice.text.replace(",","")) * tempQuantity;
		else
			temp = 0;
		
		if (this.currentState == "quickEst") {
			
		}
		else if (this.currentState == "invoiceState") {
			accept_button.enabled =  true;
			this.focusManager.defaultButton = accept_button;
			UpdateBatchNumbers();
		} else {
			if (this.currentState == "departmentState" && tempQuantity > 0) {
				accept_button.enabled =  true;
				accept_button.tabIndex = 5;
				this.focusManager.defaultButton = accept_button;
			}	
			else {
				accept_button.enabled = false;
				this.focusManager.defaultButton = null;
			}
		
			// total price can be overridden
			if (activeSale != null && activeSale.opPrice == false && txtSaleTotal != null) {
				txtSaleTotal.text = Snowmass.getCurrencyFormatter(false,2).format(temp);
			}
			
			if (activeSale.opPrice == false) {
				activeSale.subTotal = temp;		// no tax at this point
			}
			
			activeSale.taxTable = pickTaxTable.selectedItem as TaxTable;
			activeSale.taxCode = pickTaxCode.selectedItem as TaxCodes;
			
			// assume zero tax under these conditions
			if (chkNonTax.selected || activeSale.taxTable == null || activeSale.subTotal < .01){
				activeSale.taxAmount = 0;
				if (activeSale.opPrice == false) {
					activeSale.total = activeSale.subTotal + activeSale.taxAmount;
					activeSale.total = roundToCurrency(activeSale.total);
				}
				UpdateBatchNumbers();
			}
			else {
				this.throbber.visible = true;
				this.throbber.play();
				taxCalculatorService.calculateTax(activeSale.taxTable, activeSale.subTotal);
			}
		}
		
		//
		// can the payment button be pressed
		//
		if (btPayment != null) {
			if (this.currentState == "paymentCreditCard") {
				if (card_ref != null && card_ref.text.length == 0)
					btPayment.enabled = false;
				else
					btPayment.enabled = true;
			}
			else if (this.currentState == "invoiceCreditCard") {
				if (invoice_card != null && invoice_card.text.length == 0)
					btPayment.enabled = false;
				else
					btPayment.enabled = true;
			}
			else if (this.currentState == "paymentCheck") {
				if (check_num != null && check_num.text.length == 0)
					btPayment.enabled = false;
				else
					btPayment.enabled = true;
			}		
			else if (this.currentState == "invoiceCheck") {
				if (invoice_check != null && invoice_check.text.length == 0)
					btPayment.enabled = false;
				else
					btPayment.enabled = true;
			}	
		}
		
		//
		// window is NOT in a good state, like the current batch would not load
		//
		if (tapeBatch == null || tapeBatch.sessionBatches == null) {
			btnSave.enabled = false;
		}	
	}
		
	private function openTree():void {
		var nodeList:XMLListCollection = 
			tvItems.dataProvider as XMLListCollection;
		tvItems.selectedIndex = -1;

		var node:XML = XML(tvItems.selectedItem);
	}

	private var treeStateString:String = "";
	private function treeSelect(event:Event):void {
		var treeItem:PreferencesCashRegister = tvItems.selectedItem as PreferencesCashRegister;
	
		accept_button.enabled = false;
		this.currentState = "";
		
		this.currentState = "departmentState";
		
		InitSaleRecord();
		
		treeStateString = this.currentState;
		txtSaleUnitPrice.text = Snowmass.getCurrencyFormatter(false,2).format(treeItem.rate);
		txtSaleDescription.text = treeItem.title;
		
		activeSale.cashRegisterDept = treeItem;
		if (activeSale.cashRegisterDept != null) {
			activeSale.description = activeSale.cashRegisterDept.title;
		}
		
		if (treeItem.taxTable != null)
			pickTaxTable.selectedIndex = findItem(treeItem.taxTable.name, TaxTableArray);
		if (treeItem.taxCodes != null)
			pickTaxCode.selectedIndex = findItem(treeItem.taxCodes.name, TaxCodesArray);
		
		if (txtSaleQuantity != null && txtSaleQuantity.enabled)
			txtSaleQuantity.setFocus();
		
		txtSaleQuantity.tabIndex = 1;
		txtSaleUnitPrice.tabIndex = 2;
		txtSaleTotal.tabIndex = 3;
		txtSaleDescription.tabIndex = 4;
		accept_button.tabIndex = 5;
		
		btnSave.tabIndex = -1;
		btPayment.tabIndex = -1;
	}
	
	private function findItem(name:String, array:ArrayCollection):int {
		for each(var element:Object in array) {
			if (name == element.name) {
				return array.getItemIndex(element);
			}
		}
		return -1;
	}
	private function doInvoice():void {
		this.currentState = "invoiceState";
		treeStateString = "invoiceState";
	}
	
	private function doAddJob():void {
		var editJobWindow:EditJob= new EditJob();
		var parentId:int = Snowmass.getInstance().containerManager.getWindowWithChild(this, true).windowID;
		editJobWindow.addEventListener(JobEditCompleteEvent.SAVE, addNewJob);
		Snowmass.getInstance().containerManager.openNewMDIWindow(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'jobCmd.NewJob'),editJobWindow, -1,-1,-1,-1, parentId);
	}
	
	private function doAddCharge():void {
		var chargePicker:ChargePicker=ChargePicker(PopUpManager.createPopUp(this, ChargePicker, true));
		chargePicker.charges = this.charges;
		chargePicker.job = null;
		chargePicker.setStyle("borderAlpha", 0.9);
		chargePicker.addEventListener(ChargeDefinitionSelectEvent.CHARGEDEFINITIONCOMPLETE, handleChargeDefinitionComplete);
	}
	
	private function doCreditCardManualApproval():void {
		var creditCardManualApproveWindow:CreditCardDataEntry = CreditCardDataEntry(PopUpManager.createPopUp(this, CreditCardDataEntry, true));
		creditCardManualApproveWindow.setStyle("borderAlpha", 0.9);
		creditCardManualApproveWindow.addEventListener(CreditCardTransEvent.COMPLETE, handleCreditCardTransWrite);
		creditCardManualApproveWindow.setAmount(payment_cash_edit.text);
		creditCardManualApproveWindow.setTax(activePayment.taxAmount.toString());
	}
	
	private function handleChargeDefinitionComplete(evt:ChargeDefinitionSelectEvent):void
	{
		var localCharge:Charge;
		var i:int;
		this.charges = evt.chargeArray;
		
		if (this.charges != null && activeSale != null) {
			
			// create a Sale Record for each charge the user assigned
			//
			for (i = 0; i < this.charges.length; ++i) {
				localCharge = this.charges.getItemAt(i) as Charge;
				if (localCharge != null) {
					activeSale.subTotal = localCharge.price;
					activeSale.total = activeSale.subTotal;
					activeSale.quantity = localCharge.quantity;
					activeSale.opPrice = true;
					activeSale.unitPrice = 0;
					activeSale.description = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'tapeCmd.QuickEst') + " " + localCharge.description;
					
					if (txtSaleDescription != null)
						txtSaleDescription.text = activeSale.description;
					if (txtSaleQuantity != null)
						txtSaleQuantity.text = activeSale.quantity.toString();
					if (txtSaleUnitPrice != null)
						txtSaleUnitPrice.text = Snowmass.getCurrencyFormatter(false,2).format(activeSale.unitPrice);
					if (txtSaleTotal != null)
						txtSaleTotal.text = Snowmass.getCurrencyFormatter(false,2).format(activeSale.subTotal);
		
					activeSale.taxTable = pickTaxTable.selectedItem as TaxTable;
					activeSale.taxCode = pickTaxCode.selectedItem as TaxCodes;
		
					if (localCharge.taxable == false || activeSale.taxTable == null){
						activeSale.taxAmount = 0;
					}
					else {
						// cannot wait on Tax service here, in a loop adding each charge
						//
						if (activeSale.taxTable.minAmount > 0 && activeSale.subTotal < activeSale.taxTable.minAmount) {
							activeSale.taxAmount = 0;
						}
						else{
							activeSale.taxAmount = (activeSale.taxTable.effectiveTaxRate * activeSale.subTotal);
						}
					}
					
					activeSale.total = activeSale.subTotal + activeSale.taxAmount;
					activeSale.total = roundToCurrency(activeSale.total);
					UpdateBatchNumbers();
					
					// auto accept to add the transactions to the list
					doAccept(true);	
					
					this.currentState == "quickEst";
				}
			}
			
			this.charges = null;		// all done with them
		}
	}

	private function addNewJob(event:Event):void
	{
		var target:EditJob=event.target as EditJob;
		
		if (target.job != null) {
			activeSale.quantity = target.job.qtyOrdered;
			activeSale.opPrice = true;
			activeSale.unitPrice = target.job.pricingRecord.unitPrice;
			activeSale.subTotal = target.job.pricingRecord.totalPrice;
			activeSale.total = activeSale.subTotal;
			activeSale.description = target.job.description;
			if (activeSale.description.length == 0)
				activeSale.description = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'tapeCmd.QuickEst');
			
			if (txtSaleDescription != null)
				txtSaleDescription.text = activeSale.description;
			if (txtSaleQuantity != null)
				txtSaleQuantity.text = activeSale.quantity.toString();
			if (txtSaleUnitPrice != null)
				txtSaleUnitPrice.text = Snowmass.getCurrencyFormatter(false,2).format(activeSale.unitPrice);
			if (txtSaleTotal != null)
				txtSaleTotal.text = Snowmass.getCurrencyFormatter(false,2).format(activeSale.subTotal);
			
			activeSale.taxTable = pickTaxTable.selectedItem as TaxTable;
			activeSale.taxCode = pickTaxCode.selectedItem as TaxCodes;

			if (target.job.taxable == false || activeSale.taxTable == null){
				activeSale.taxAmount = 0;
			}
			else {
				// cannot wait on Tax service here, in a loop adding each charge
				//
				if (activeSale.taxTable.minAmount > 0 && activeSale.subTotal < activeSale.taxTable.minAmount) {
					activeSale.taxAmount = 0;
				}
				else{
					activeSale.taxAmount = (activeSale.taxTable.effectiveTaxRate * activeSale.subTotal);
				}
			}
			
			activeSale.total = activeSale.subTotal + activeSale.taxAmount;
			activeSale.total = roundToCurrency(activeSale.total);
			UpdateBatchNumbers();
			this.currentState == "quickEst";
			
			doAccept(true);
		}
	}
	
	private function paymentMethodChanged(event:Event):void {
		var rbvalue:String = event.currentTarget.selectedValue;
						
		
		if ( customerAccount != null){
			switch ( customerAccount.type){
	 		case Constants.ACCOUNT_TYPE_CASH_CHECK_CREDIT:
	 			
	 			break;
	 		case Constants.ACCOUNT_TYPE_FULL_DEPOSIT:
	 		
	 			break;
	 		case Constants.ACCOUNT_TYPE_CASH_ONLY:
	 			if( "Cash" != rbvalue){
	 				Alert.show(resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'msg_Onlycashisacceptedas'));
	 				event.currentTarget.selectedValue = "";
	 				return
	 			}
	 			break;
	 		case Constants.ACCOUNT_TYPE_CHARGE:
	 			
	 			break;
	 		case Constants.ACCOUNT_TYPE_CARD_ON_FILE:
	 	
	 			break;
	 		}
 		}
		doAccept(false);
		
		//
		// reverse any external values that could have already been completed, ie.. a Credit Card charge
		//
		doCancelPayment(activePayment);
		
		if (rbvalue == "Cash")
		{	
			activePayment.paymentMethod = Constants.POS_CASH_REGISTER_PAYMODE_CASH;
			if (treeStateString == "invoiceState")
			{
				this.currentState = "invoiceCash";
				invoice_payment.setFocus()
				invoice_payment.tabIndex = 1;
			} 
			else 
			{
				this.currentState = "paymentCash";
				payment_cash_edit.setFocus();
				payment_cash_edit.tabIndex = 1;
			}
			btPayment.enabled = true;
			btPayment.tabIndex = 2;
			btnSave.tabIndex = 3;
			rbCash.selected = true;
		}
		if (rbvalue == "Credit Card")
		{
			activePayment.paymentMethod = Constants.POS_CASH_REGISTER_PAYMODE_CREDITCARD;
			if (treeStateString == "invoiceState")
			{
				this.currentState = "invoiceCreditCard";
				
				invoice_card.setFocus()
				invoice_card.tabIndex = 1
				invoice_payment.tabIndex = 2
			} 
			else 
			{
				this.currentState = "paymentCreditCard";
				card_ref.setFocus();
				card_ref.tabIndex = 1;
				payment_cash_edit.tabIndex = 2;
			}
			btPayment.enabled = true;
			btPayment.tabIndex = 3;
			btnSave.tabIndex = 4;
		}
		if (rbvalue == "Check")
		{
			activePayment.paymentMethod = Constants.POS_CASH_REGISTER_PAYMODE_CHECK;
			if (treeStateString == "invoiceState")
			{
				this.currentState = "invoiceCheck";
				invoice_check.setFocus();
				invoice_check.tabIndex = 1;
				invoice_payment.tabIndex = 2;
			} 
			else 
			{
				this.currentState = "paymentCheck";
				check_num.setFocus();
				check_num.tabIndex = 1;
				payment_cash_edit.tabIndex = 2;
			}
			btPayment.enabled = true;
			
			btPayment.tabIndex = 3;
			btnSave.tabIndex = 4;
		}
		if (rbvalue == "Charge")
		{
			if (customerAccount == null){
				Alert.show(resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'msg_Youmustselectanaccou'));
				btPayment.enabled = false;
			} else
				btPayment.enabled = true;
			
			activePayment.paymentMethod = Constants.POS_CASH_REGISTER_PAYMODE_CHARGE;
			if (treeStateString == "invoiceState")
			{
				this.currentState = "invoiceCharge";
				invoice_payment.setFocus();
				invoice_payment.tabIndex;
			} 
			else 
			{
				this.currentState = "paymentCharge";
				payment_cash_edit.setFocus();
				payment_cash_edit.tabIndex = 1;
			}
			
			btPayment.tabIndex = 2;
			btnSave.tabIndex = 3;
		}
		
		accept_button.tabIndex = -1;
		//
		// how much is left to pay 	if ( treeStateString == "invoiceState")
		//
		if ( treeStateString == "invoiceState") {
			invoice_payment.text = Snowmass.getCurrencyFormatter(false,2).format(roundToCurrency(sessionBatch.accumTotal - sessionBatch.accumTendered));
			invoice_payment.setSelection(0, invoice_payment.length);
		}
		else {
			payment_cash_edit.text = Snowmass.getCurrencyFormatter(false,2).format(roundToCurrency(sessionBatch.accumTotal - sessionBatch.accumTendered));
			payment_cash_edit.setSelection(0, payment_cash_edit.length);
		}
		
		this.focusManager.defaultButton = btPayment;
		
		UpdateCashRegister();		// button state (disabled/Enabled)
		enableSave = true;
	}
	
	private function paymentStateHandler (e:Event):void {
		if (this.currentState == "departmentState")
		{
			var node:XML = XML(tvItems.selectedItem);
			txtSaleDescription.text = node.@label;
		}
	}

	private function doPayment():void{
		var payOK:Boolean = true;
		var message:String;
		var temp:Number;
	

		if ( treeStateString == "invoiceState")
			temp = parseFloat(invoice_payment.text.replace(",",""));
		else
			temp = parseFloat(payment_cash_edit.text.replace(",",""));
			
		if ((this.currentState == "invoiceCash") && (AustrailianRounding == true)) {
			 
		} else {
			// ensure that variable content is the same as formatted screen content
			
			var tempStr:String = Snowmass.getCurrencyFormatter(false,2).format(temp);
			activePayment.total = parseFloat(tempStr.replace(",",""));	

			//
			// cash register pay out, ask for description from user
			//
			if (activePayment.total < 0 && activePayment.refNumber == "") {
				completeTransationDescription(activePayment, 1);
				return;			// don't continue with payment
			}
			
			sessionBatch.accumTendered = roundToCurrency((sessionBatch.accumTendered + activePayment.total));
			sessionBatch.accumChange = roundToCurrency((sessionBatch.accumTendered - sessionBatch.accumTotal)); 
			
			if (activePayment.paymentMethod==Constants.POS_CASH_REGISTER_PAYMODE_CHECK){
				if (this.currentState == "invoiceCheck") {
					activePayment.checkNumber = invoice_check.text;
				} else {
					activePayment.checkNumber = check_num.text;
				}
				
				if (customerAccount != null) {
					if (customerAccount.type == Constants.ACCOUNT_TYPE_CASH_ONLY || customerAccount.type == Constants.ACCOUNT_TYPE_FULL_DEPOSIT) {
						message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Onlycashisacceptedas");
						Alert.show(message, "Warning", 0, null, null, null, 4); 
						payOK = false;
					}
				}
			}
			if (activePayment.paymentMethod == Constants.POS_CASH_REGISTER_PAYMODE_CREDITCARD){
				if (this.currentState == "invoiceCreditCard") {
					activePayment.creditCard = invoice_card_type.selectedItem as PreferencesCreditCard;
					activePayment.refNumber = invoice_card.text;
				} else {
					activePayment.creditCard = card_type.selectedItem as PreferencesCreditCard;
					activePayment.refNumber = card_ref.text;
				}
			}
			if (activePayment.paymentMethod == Constants.POS_CASH_REGISTER_PAYMODE_CHARGE) {
				activePayment.customerAccount = customerAccount;	
				
				if (customerAccount != null) {
					if (customerAccount.status == Constants.ACCOUNT_STATUS_FROZEN) {
						message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_CustomeraccountisFRO");
						Alert.show(message, "Warning", 0, null, null, null, 4); 
						payOK = false;
					} else if (customerAccount.type != Constants.ACCOUNT_TYPE_CHARGE) {
						message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Theselectedaccountdo");
						Alert.show(message, "Warning", 0, null, null, null, 4); 
						payOK = false;
					}
				}
				
				if (payOK) {
					if ((creditLimit > 0 && (creditLimit - activePayment.total)) < 0 || creditLimit < 0) {
						//TODO - some users can override credit limit
						
						message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Chargingthiswouldexc");
						message = StringUtil.substitute(message,numberFormatter.format(creditLimit)); 
						Alert.show(message, "Warning", 0, null, null, null, 4); 
						payOK = false;
					}
					
					if (payOK == true && creditLimit != 0) {
						creditLimit -= activePayment.total;
						if (creditLimit == 0)
							creditLimit = -1;		// so not to be zero
					}
				}
			}
			
			if (payOK == true) {	
				activePayment.taxTable = pickTaxTable.selectedItem as TaxTable;
				activePayment.taxCode = pickTaxCode.selectedItem as TaxCodes;
			
				sessionBatch.transactions.addItem(activePayment);
				InitPaymentRecord();
			}
		}
		this.currentState = "";
		openTree();
		rgPaymentMethod.selection = null;
		btPayment.enabled= false;
		UpdateBatchNumbers();
		enableSave = true;
	}	
	
	private function doAccount():void{
		 var accountPickerWindow:AccountPicker = AccountPicker(PopUpManager.createPopUp(this, AccountPicker, true));
	    accountPickerWindow.setStyle("borderAlpha", 0.9);
	    accountPickerWindow.formIsEmpty = true;
	    accountPickerWindow.prospect_boolean = false;
	    accountPickerWindow.contact_boolean = false;
	    accountPickerWindow.setAccounts(accounts);
	    accountPickerWindow.addEventListener(AccountPickerSelectEvent.CANCELSELECTACCOUNT, handleAccountPickerCancel);
	    accountPickerWindow.addEventListener(AccountPickerSelectEvent.SELECTACCOUNT, handleAccountPickerSelect);
	    	   	    
	}
	private function handleAccountPickerSelect(evt:AccountPickerSelectEvent):void {
		
		dataService.getAccount(evt.account.id);
			
	}
	private function doTotalPrice(item:Object,column:DataGridColumn):String{
		var tempString:String;
		
		if (item is TapePaymentRecord) {
			var tempPayment:TapePaymentRecord;
			tempPayment = item as TapePaymentRecord;
			if (tempPayment != null){
				tempString = numberFormatter.format(tempPayment.total);
			} else
				tempString = "";
		} else if (item is TapeSaleRecord) {
			var tempSale:TapeSaleRecord = item as TapeSaleRecord;
			
			if (tempSale != null){
				tempString = numberFormatter.format(tempSale.total);
			} else
				tempString = "";
		}
		
		return tempString;
		
	}
	private function doSubtotalPrice(item:Object,column:DataGridColumn):String{
		var tempString:String;
		
		if (item is TapePaymentRecord) {
			var tempPayment:TapePaymentRecord;
			tempPayment = item as TapePaymentRecord;
			tempString = "";
		} else if (item is TapeSaleRecord) {
			var tempSale:TapeSaleRecord = item as TapeSaleRecord;
			
			if (tempSale != null){
				tempString = numberFormatter.format(tempSale.subTotal);
			} else
				tempString = "";
		}
		
		return tempString;
	}
	
	private function doTaxPrice(item:Object,column:DataGridColumn):String{
		var tempString:String;
		
		if (item is TapePaymentRecord) {
			var tempPayment:TapePaymentRecord;
			tempPayment = item as TapePaymentRecord;
			tempString = "";
		} else if (item is TapeSaleRecord) {
			var tempSale:TapeSaleRecord = item as TapeSaleRecord;
			
			if (tempSale != null){
				tempString = numberFormatter.format(tempSale.taxAmount);
			} else
				tempString = "";
		}
		
		return tempString;
	}	
	
	private function doDescript(item:Object, column:DataGridColumn):String{
		var tempString:String;
		
		if (item is TapePaymentRecord) {
			var tempPayment:TapePaymentRecord;
			tempPayment = item as TapePaymentRecord;
			if (tempPayment.paymentMethod != "" && tempPayment.total > 0){
				tempString = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Payment')+" " + tempPayment.paymentMethod;
			} else if (tempPayment.refNumber != "") {		// could be a payout (negative amount)
				tempString = tempPayment.refNumber;
			} else
				tempString = "";
		} else if (item is TapeSaleRecord) {
			var tempSale:TapeSaleRecord = item as TapeSaleRecord;
			
			if (activeSale.isPickup == false)
				tempString = tempSale.description + " " + tempSale.quantity.toString() + "x"+ tempSale.unitPrice.toString();
			else
				tempString = tempSale.description;
		}
		
		return tempString;
	}
	
	private function doAccept(quickEst:Boolean):void{
		
		if (quickEst || this.currentState == "invoiceState" || this.currentState == "departmentState") {
			if (txtSaleDescription != null)
				activeSale.description = txtSaleDescription.text;
			if (txtSaleQuantity != null)
				activeSale.quantity = parseInt(txtSaleQuantity.text);
			if (txtSaleUnitPrice != null)
				activeSale.unitPrice = parseFloat(txtSaleUnitPrice.text.replace(",",""));
			if (txtSaleTotal != null)	
				activeSale.subTotal = parseFloat(txtSaleTotal.text.replace(",",""));
			
			//
			// don't add a ZERO sale item to the transaction list
			//
			if (activeSale.subTotal != 0) {
				sessionBatch.accumSubTotal = roundToCurrency((sessionBatch.accumSubTotal + activeSale.subTotal));
				sessionBatch.accumTotal = roundToCurrency((sessionBatch.accumTotal + activeSale.total));
				sessionBatch.accumTaxTotal = roundToCurrency((sessionBatch.accumTaxTotal + activeSale.taxAmount));
				sessionBatch.accumChange = roundToCurrency((sessionBatch.accumTendered - sessionBatch.accumTotal));
				if ( activeSale.isPickup)
					activeSale.cashRegisterDept = null;
				
				sessionBatch.transactions.addItem(activeSale);			
			}
			
			InitSaleRecord();		// setup for another sale
		}
		
		this.currentState = "";
		openTree();
		UpdateBatchNumbers();
		UpdateCashRegister();
		enableSave = true;
	}
	
	
	private function handleCCTSaveResult(ev:ResultEvent):void{
		// nothing to do, the record has been initilized already
		
		this.throbber.visible = false;
		this.throbber.stop();
	}
	
	private function doCancelPayment(tempPayment:TapePaymentRecord) :void {
		
		//
		// for credit card payments, the sale must be reveresed
		//
		if (activePayment != null && activePayment.paymentMethod == Constants.POS_CASH_REGISTER_PAYMODE_CREDITCARD) {
			if (tempPayment.cct != null && tempPayment.cct.transactionType == Constants.CREDIT_CARD_TRANSACTION_TYPE_kTransactionTypePurchase &&
				tempPayment.cct.transactionResults == Constants.CREDIT_CARD_TRANSACTION_RESULTS_kTransactionResultsApproved) {
				
				var temp:CreditCardTransactions = new CreditCardTransactions;
				temp.accountNumber = tempPayment.cct.accountNumber;
				temp.creditCard = tempPayment.cct.creditCard;
				temp.isCurrentTransaction = 1;
				temp.orderNumber = tempPayment.cct.orderNumber;
				temp.orderName = tempPayment.cct.orderName;
				temp.referenceNumber = tempPayment.cct.referenceNumber;
				temp.firstNumberPrefix = tempPayment.cct.firstNumberPrefix;
				temp.tax = tempPayment.cct.tax;
				temp.amount = tempPayment.cct.amount;
				temp.transactionType = Constants.CREDIT_CARD_TRANSACTION_TYPE_kTransactionTypeReversal;
				temp.transactionStatus = Constants.CREDIT_CARD_TRANSACTION_STATUS_kTransactionStatusWaiting;
				if (Snowmass.getInstance().currentUser != null) {
					temp.userName = Snowmass.getInstance().currentUser.name;
				}
				// save data
				// see "handleCCTSaveResult" for next processing step
				//
				dataServiceCCT.addUpdate(temp);
				
				this.throbber.visible = true;
				this.throbber.play();
				
				card_ref.text = "";
			}
		}
	}

	private function doVoid():void{
		var temp :Object;
		var index:int;
		temp = new Object();
		temp  = cashReg_grid.selectedItem as Object;
		
		if ( temp != null){
			index= sessionBatch.transactions.getItemIndex(temp);
			
			if (temp is TapePaymentRecord) {
				var tempPayment:TapePaymentRecord;
				tempPayment = temp as TapePaymentRecord;				
				sessionBatch.accumTendered = roundToCurrency((sessionBatch.accumTendered - tempPayment.total));
				sessionBatch.accumChange = roundToCurrency((sessionBatch.accumTendered - sessionBatch.accumTotal)); 
				
				// reverse any external actions that the payment may have performed
				doCancelPayment(tempPayment);
			} else if (temp is TapeSaleRecord) {
				var tempSale:TapeSaleRecord = temp as TapeSaleRecord;
				sessionBatch.accumSubTotal = roundToCurrency((sessionBatch.accumSubTotal - tempSale.subTotal));
				sessionBatch.accumTotal = roundToCurrency((sessionBatch.accumTotal - tempSale.total));
				sessionBatch.accumTaxTotal = roundToCurrency((sessionBatch.accumTaxTotal - tempSale.taxAmount));
				sessionBatch.accumChange = roundToCurrency((sessionBatch.accumTendered - sessionBatch.accumTotal));
			}
			
			sessionBatch.transactions.removeItemAt(index);
			
			UpdateBatchNumbers();
		}
	}
	
	private function handleAccountPickerCancel(evt:AccountPickerSelectEvent):void {
		
		
	}
	private function handleGetResult(ev:ResultEvent):void {
		customerAccount = new Account();
		customerAccount = ev.result as Account;
		
		if (customerAccount.type == Constants.ACCOUNT_TYPE_CHARGE) {
			creditLimit = customerAccount.creditLimit;
			
			// any outstanding AR balance can effect available credit
			if (creditLimit != 0) {
				creditLimit -= customerAccount.balance;
			}
		} else {
			creditLimit = 0;
		}
		
		if (customerAccount.taxTable != null)
			pickTaxTable.selectedIndex = findItem(customerAccount.taxTable.name, TaxTableArray);
		if (customerAccount.taxCode != null)
			pickTaxCode.selectedIndex = findItem(customerAccount.taxCode.name, TaxCodesArray);
		
		// sync up the non tax button with the account status
		if (customerAccount.taxExempt == true) {
			if (chkNonTax.selected == false)
				chkNonTax.dispatchEvent(new MouseEvent(MouseEvent.CLICK , false, false));
		} else {
			if (chkNonTax.selected == true)
				chkNonTax.dispatchEvent(new MouseEvent(MouseEvent.CLICK , false, false));
		}
		sessionBatch.account = customerAccount;
		
		acct_title.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posStatusCmd.3');
		acct_title.text = StringUtil.substitute(acct_title.text,customerAccount.title,customerAccount.accountId); 
		
		switch ( customerAccount.status){
 		case Constants.ACCOUNT_STATUS_NEW:
 			acct_status_text.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custStatus.New');
 			break;
 		case Constants.ACCOUNT_STATUS_CURRENT:
 			acct_status_text.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custStatus.Current');
 			break;
 		case Constants.ACCOUNT_STATUS_DELIQUENT:
 			acct_status_text.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custStatus.Delinquent');
 			break;
 		case Constants.ACCOUNT_STATUS_INACTIVE:
 			acct_status_text.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custStatus.Inactive');
 			break;
 		case Constants.ACCOUNT_STATUS_FROZEN:
 			acct_status_text.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custStatus.Frozen');
 			break;
 		case Constants.ACCOUNT_STATUS_PASTDUE:
 			acct_status_text.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custStatus.PastDue')
 			break;
 		}
		
 		switch ( customerAccount.type){
 		case Constants.ACCOUNT_TYPE_CASH_CHECK_CREDIT:
 			acct_type.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custType.CashCheckCreditCard');
 			break;
 		case Constants.ACCOUNT_TYPE_FULL_DEPOSIT:
 			acct_type.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custType.FullDeposit');
 			break;
 		case Constants.ACCOUNT_TYPE_CASH_ONLY:
 			acct_type.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custType.CashOnly');
 			break;
 		case Constants.ACCOUNT_TYPE_CHARGE:
 			acct_type.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custType.ChargeAccount');
 			break;
 		case Constants.ACCOUNT_TYPE_CARD_ON_FILE:
 			acct_type.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custType.CreditCardonFile')
 			break;
 		}
	
		// TODO - assign default invoice format from account
	}
	
	private function doApplyPayments(isPaidOut:Boolean):Boolean {
		var results:Boolean = true;
		var unApplied:Number = 0;
		var i:int = 0;
		var currentPaymentIndex:int = 0;
		var temp:Object;
		var totalPay:Number = 0;
		var totalCharge:Number = 0;
		var totalTransactionPay:Number = 0;
		var totalApplied:Number = 0;
		var refund:Number = 0;
		var payAmount:Number = 0;
		var totalPayAndCharge:Number = 0;
		var diff:Number = 0;
		var tempSale:TapeSaleRecord;
		var tempPayment:TapePaymentRecord = new TapePaymentRecord();
		var paymentList:ArrayCollection = new ArrayCollection();
		var message:String;
		
		totalPay = sessionBatch.accumTendered;
		refund = sessionBatch.accumChange;
		
		if (refund > 0) {		// change amount still due to give back
			totalPay = roundToCurrency(totalPay - refund);
		}

		// make a local list of just the payments
		for(i = 0; i< sessionBatch.transactions.length; i++)
		{
			temp  = sessionBatch.transactions.getItemAt(i) as Object;
			if (temp is TapePaymentRecord) {
				paymentList.addItem(temp);
			}	
		}
			
		if (totalPay > 0 && paymentList.length > 0) {
			// get the first payment
			tempPayment = paymentList.getItemAt(currentPaymentIndex) as TapePaymentRecord;
			payAmount = tempPayment.total;
			
			//
			// balance out any refund amount that would go back to payee
			//
			if (refund > 0 && tempPayment.paymentMethod != Constants.POS_CASH_REGISTER_PAYMODE_CHARGE) {
				if (payAmount >= refund) {
					payAmount -= refund;
					refund = 0;
				} else {
					refund -= payAmount;
					payAmount = 0;
				}
			}
			
			totalApplied += payAmount;
			
			for(i = 0; i < sessionBatch.transactions.length && tempPayment != null; i++)
			{
				temp  = sessionBatch.transactions.getItemAt(i) as Object;
				
				if (temp is TapePaymentRecord) {
					// ignore while appling to sales
				} else if (temp is TapeSaleRecord) {
					tempSale = temp as TapeSaleRecord;
											
					unApplied = roundToCurrency(tempSale.total - tempSale.amountPaid);
					
					// is sale a invoice pickup
					// record invoice data into the payment record
					if (tempSale.isPickup == true) {
						tempPayment.invoice = tempSale.invoice;
						tempPayment.postAR = true;
					}
					
					//
					// money still owed on this sale record
					//
					if (unApplied > 0) {
						
						// 
						// any left over charge to account value, whe no payments are left
						//
						if (tempSale.isPickup == true && tempPayment == null && totalCharge > 0.01) {
							totalTransactionPay += unApplied;
							totalCharge -= unApplied;
							unApplied = 0;
						} 
						// 
						// the current pay record can pay off the whole amount due
						//
						else if (unApplied <= payAmount) {
						
							// charge to account
							if (tempPayment.paymentMethod == Constants.POS_CASH_REGISTER_PAYMODE_CHARGE) {
								if (tempPayment != null) {
									totalCharge += unApplied;
									payAmount -= unApplied;
								} else {
									totalTransactionPay += unApplied;
									totalCharge -= unApplied;
									unApplied = 0;
								}
							} 
							// cash, check or credit card
							else {
								tempSale.amountPaid += unApplied;
								totalTransactionPay += unApplied;
								payAmount -= unApplied;
								unApplied = 0;
							}
						}
						// 
						// the sale requires more money to pay off than is available from current pay record
						//
						else {
							// charge to account
							if (tempPayment.paymentMethod == Constants.POS_CASH_REGISTER_PAYMODE_CHARGE) {
							//	if (tempPayment != null) {
									totalCharge += unApplied;
									payAmount = 0;
							//	} 
							//	else {
							//		totalTransactionPay += unApplied;
							//		totalCharge -= unApplied;
							//		unApplied = 0;
							//	}
							} 
							// cash, check or credit card
							else {
								tempSale.amountPaid += payAmount;
								totalTransactionPay += payAmount;
								unApplied -= payAmount;
								unApplied = roundToCurrency(unApplied);
								payAmount = 0;
							}
							
							--i;		// stay on the same sale record, not finished paying off
						}
						
						// assign the payment type to the sale record
						//
						if (tempSale.paymode == "") {
							tempSale.paymode = tempPayment.paymentMethod;
							if (tempPayment.paymentMethod != Constants.POS_CASH_REGISTER_PAYMODE_CHARGE) {
								tempSale.checkNumber = tempPayment.checkNumber;
								tempSale.cct = tempPayment.cct;
								tempSale.refNumber = tempPayment.refNumber;	
							}
						}
					}
				}
				
				// math above will cause the number of decimal positions to increase
				//	this will force it back to currency rounded numbers
				//
				totalTransactionPay = roundToCurrency(totalTransactionPay);
				totalCharge = roundToCurrency(totalCharge);
				payAmount = roundToCurrency(payAmount);
				
				// is there any more money to play with
				//
				if (payAmount <= .01) {
					currentPaymentIndex += 1;
					if (currentPaymentIndex < paymentList.length) {
						tempPayment = paymentList.getItemAt(currentPaymentIndex) as TapePaymentRecord;
					} else
						tempPayment = null;
						
					if (tempPayment != null) {
						payAmount = tempPayment.total;
					} else {
						payAmount = 0;
					}
					
					//
					// balance out any refund amount that would go back to payee
					//
					if (refund > 0 && tempPayment.paymentMethod != Constants.POS_CASH_REGISTER_PAYMODE_CHARGE) {
						if (payAmount >= refund) {
							payAmount -= refund;
							refund = 0;
						} else {
							refund -= payAmount;
							payAmount = 0;
						}
						refund = roundToCurrency(refund);
					}
					
					payAmount = roundToCurrency(payAmount);
				
					totalApplied += payAmount;
					totalApplied = roundToCurrency(totalApplied);
				}
			}
			
			//
			// all sale records have been processed
			//
			//totalTransactionPay += roundAmount;
			
		} else if (isPaidOut == false) {
			message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_WARNINGThistransacti");
			Alert.show(message, "Warning", 0, null, null, null, 4); 
			results = false;
		}

		if (results == true) {
			totalPayAndCharge = roundToCurrency(totalTransactionPay + totalCharge);
			
			if (totalPayAndCharge != totalApplied) {
				//msg_WARNINGThistransacti=WARNING: This transaction did not balance!r	Total Payments: ${0}r	Total Transactions: ${1}rPlease review the transaction and contact your PrintSmith support center and report it in detail. r	OK to post transaction?
				//
				// un-balanced amount of sales .vs. payments
				//
				if (isPaidOut == true) {
					// ask for description
					tempPayment = paymentList.getItemAt(currentPaymentIndex) as TapePaymentRecord;
					if (tempPayment.refNumber == "") {
						completeTransationDescription(tempPayment, 2);
						results = false;		// stop posting
					} else {
						tempPayment.isPaidOut = true;
					}
				} else {
					message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_WARNINGThistransacti");
					message = StringUtil.substitute(message,numberFormatter.format((totalTransactionPay + totalCharge)),numberFormatter.format(totalApplied)); 
					Alert.show(message, "Warning", 0, null, null, null, 4); 
					if (Alert.NO)
						results = false;
				}
			}
		}
		
		// roll back any payments and sales changes from above
		if (results == false) {
			for(i = 0; i< sessionBatch.transactions.length; i++)
			{
				temp  = sessionBatch.transactions.getItemAt(i) as Object;
				if (temp is TapePaymentRecord) {
					tempPayment = temp as TapePaymentRecord;
					tempPayment.invoice = null;
				} else if (temp is TapeSaleRecord) {
					tempSale = temp as TapeSaleRecord;
					tempSale.amountPaid = 0;
					tempSale.checkNumber = "";
					tempSale.cct = null;
					tempSale.refNumber = "";
				}
			}
		} 

		return(results);
	}
	
	private function calculateTotalChargesInBatch():Number {
		var tempPayment:TapePaymentRecord;
		var temp:Object;
		var results:Number = 0;
		var i:int;
		
		if (sessionBatch != null && sessionBatch.transactions != null) {
			for(i = 0; i< sessionBatch.transactions.length; i++)
			{
				temp  = sessionBatch.transactions.getItemAt(i) as Object;
				if (temp is TapePaymentRecord) {
					tempPayment = temp as TapePaymentRecord;
					if (tempPayment.paymentMethod == Constants.POS_CASH_REGISTER_PAYMODE_CHARGE) {
						results += tempPayment.total;
					}
				}	
			}
		}
		return(results);
	}	

	private function calculateTotalCashInBatch():Number {
		var tempPayment:TapePaymentRecord;
		var temp:Object;
		var results:Number = 0;
		var i:int;
		
		if (sessionBatch != null && sessionBatch.transactions != null) {
			for(i = 0; i< sessionBatch.transactions.length; i++)
			{
				temp  = sessionBatch.transactions.getItemAt(i) as Object;
				if (temp is TapePaymentRecord) {
					tempPayment = temp as TapePaymentRecord;
					if (tempPayment.paymentMethod != Constants.POS_CASH_REGISTER_PAYMODE_CHARGE) {
						results += tempPayment.total;
					}
				}	
			}
		}
		return(results);
	}	
	
	private function doPostBatch():void{
		var goodBatch:Boolean = true;
		var accountChanged:Boolean = false;
		var temp : Object;
		var tempSale:TapeSaleRecord;
		var tempPayment:TapePaymentRecord;
		var arRecord:AccountHistoryData;
		var isPaidOut:Boolean = false;
		var totalCharges:Number;
		var totalCash:Number;
		var totalDeposits:Number;
		var message:String;
		var format:String;
		var i:int = 0;
		
		//
		// no left open transactions
		//
		doAccept(false);
		
		//
		// make sure the session batch has the current account picked in the UI
		//
		sessionBatch.account = customerAccount;	
	
		//
		// the cash register is used as a PAID OUT as well, like a cash back method
		// The current user must be allowed this security feature.
		//
		if (sessionBatch.transactions.length > 0 && sessionBatch.accumTendered < 0) {
			tempPayment  = sessionBatch.transactions.getItemAt(0) as TapePaymentRecord;
			if (tempPayment != null && (tempPayment.paymentMethod == Constants.POS_CASH_REGISTER_PAYMODE_CASH ||
										tempPayment.paymentMethod == Constants.POS_CASH_REGISTER_PAYMODE_CHECK)) {
				if (sessionBatch.user != null && sessionBatch.user.noCashReturn == false)
					isPaidOut = true;
			}
		}
					
		totalCharges = calculateTotalChargesInBatch();
		totalCash = calculateTotalCashInBatch();
		
		// more charged than total can cover
		if (totalCharges > sessionBatch.accumTotal) {
			message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Sorrybutyouaretrying");
			Alert.show(message, "Warning", 0, null, null, null, 4); 
			goodBatch = false;
		}
		
		// does not balance - negative change
		if (goodBatch && !isPaidOut && sessionBatch.accumTendered < sessionBatch.accumTotal) {
			message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Thistransactiondoesn");
			Alert.show(message, "Warning", 0, null, null, null, 4); 
			goodBatch = false;
		}
		
		//
		// can the exccess refund be returned as CHECK
		if (goodBatch && totalCash < sessionBatch.accumChange) {	/* excess change */
			if (sessionBatch.user != null && sessionBatch.user.noCashReturn) {	// TODO (*currUser)->noCashChecks
				message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"rUtilText.Sorryyouarenotallowe");
				Alert.show(message, "Warning", 0, null, null, null, 4); 
				goodBatch = false;
			} else {
				//msg_WarningThereis0incas=Warning: There is {0} in cash in this transaction and the amount of change given is {1}.rrThe rest of the change ({2}) will be taken from the cash drawer.rr	Ok to continue?
				format = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_WarningThereis0incas");
				format = StringUtil.substitute(format,numberFormatter.format(totalCash),numberFormatter.format(sessionBatch.accumChange),numberFormatter.format((totalCash - sessionBatch.accumChange))); 
				Alert.show(format, "Warning", 0, null, null, null, 4); 
				if (Alert.NO) {
					goodBatch = false;
				}
			}
		}
		
		// user not allowed to charge this to an account
		if (PSSecurityUtils.getInstance().hasPermission(PSSecurityCommands.POS_POSTCHARGES) == false) {
			message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"rUtilText.Sorryyouarenotallowe");
			Alert.show(message, "Warning", 0, null, null, null, 4); 
			goodBatch = false;
		}
		
		// no tranbsactions to process
		if (sessionBatch.transactions.length == 0) {
			goodBatch = false;
		}
		
		// make sure the payments balance with the sales
		//
		if (goodBatch && doApplyPayments(isPaidOut) == true) {
			this.throbber.visible = true;
			this.throbber.play();
			
			printList.removeAll();

			cashDrawer.fund -= sessionBatch.accumChange;
			
			//
			// Look for any desposits on invoices that need to be applied to Tape
			//
			totalDeposits = 0;
			for(i = 0; i< sessionBatch.transactions.length; i++)
			{
				temp  = sessionBatch.transactions.getItemAt(i) as Object;
				if (temp is TapeSaleRecord) {
					tempSale = temp as TapeSaleRecord;
					//
					// invoice pickup, may need to create desposit applied transactions
					//
					if (tempSale.isPickup) {
						if (tempSale.invoice != null) {
							
							for (var j:int=0; j < tempSale.invoice.deposits.length; j++)	{
								var deposit:DepositEntry = tempSale.invoice.deposits.getItemAt(j) as DepositEntry;
								if (deposit != null && deposit.amount > 0)	{
									totalDeposits += deposit.amount;
								}
							}
							
							//
							// insert desposit applied transaction after the Sale (Pickup)
							//
							if (totalDeposits > 0) {
								var depApplied:TapeDepositAppliedRecord = new TapeDepositAppliedRecord();
								depApplied.totalDeposits = totalDeposits;
								depApplied.invoice = tempSale.invoice;		// which invoice applied to
								sessionBatch.transactions.addItemAt(depApplied,i);
							}
						}		
					}
				}
			}
					
			//
			// assign position index to each record, so order can be known later
			//
			for(i = 0; i< sessionBatch.transactions.length; i++)
			{
				temp  = sessionBatch.transactions.getItemAt(i) as Object;
				if (temp is TapePaymentRecord) {
					tempPayment = temp as TapePaymentRecord;
					tempPayment.index = i + 1;
				} else if (temp is TapeSaleRecord) {
					tempSale = temp as TapeSaleRecord;
					tempSale.index = i + 1;
				}
			}
			
			//
			// Write transactions out to current session and wait on complete to do any invoices to history.
			// Then perform any printing of receipts or invoice forms
			//
			dataServiceSessionBatch.addUpdate(sessionBatch);
		}
		enableSave = false;
	}
	
	private function doRevert():void{
		InitSessionBatch();
		
		doCancelPayment(activePayment);		// in case a credit card transaction needs to be reveresed
		InitSaleRecord();		// setup for another sale
		
		invoice = null;
		customerAccount = null;
		this.currentState = "";
		acct_type.text = "";
		acct_status_text.text = "";
		acct_title.text = "";
		
		if (chkNonTax.selected == true)
			chkNonTax.dispatchEvent(new MouseEvent(MouseEvent.CLICK , false, false));

		openTree();
		UpdateBatchNumbers();					
	}
	
	private function dotreelabel(item:Object):String{
		var tmpItem:PreferencesCashRegister ;
		tmpItem = item as PreferencesCashRegister;
		
		if (tmpItem != null && tmpItem.title != null && tmpItem.title != "") {
			if ( tmpItem.buttonPrefixCharacter != null)
				return tmpItem.buttonPrefixCharacter.toString() + " " + tmpItem.title;
			else
				return tmpItem.title;
		} else {
			return "";
		}
	} 
	private function doTransactionGrid():void{
		button1.enabled = true;
	} 
	
	//
	// call back function when the user changes the value in the total price field
	// 
	private function doChangeTotalPrice():void
	{				
		// current value is EMPTY string, remove override
		if (txtSaleTotal.text == "")
			activeSale.opPrice = false;
		else {
			// price override format as currency
			var temp:Number = parseFloat(txtSaleTotal.text.replace(",",""))
			var tempStr:String = Snowmass.getCurrencyFormatter(false,2).format(temp);
			
			// data is different than calculated version
			if (tempStr != txtSaleTotal.text) {
				activeSale.opPrice = true;
				activeSale.subTotal = activeSale.total = temp;
			} else {
				activeSale.subTotal = activeSale.total = 0;			// WILL be computed by tax calculation
			}
			txtSaleTotal.text = tempStr;
		}
		
		// update the field font state to match
		setOverrideForField(txtSaleTotal, activeSale.opPrice);
		
		UpdateCashRegister();
	}
	
	private function doGetInvoice():void {	
		this.throbber.visible = true;
		this.throbber.play();
	
		dataService.getInvoiceByInvoiceNumber(txtInvoiceNumber.text,"I");
	}
	
	private function handleLoadCurrentTapeBatch(evt:ResultEvent):void {		
		tapeBatch = evt.result as TapeBatch;
		
		if (tapeBatch.sessionBatches == null) {
			tapeBatch.sessionBatches = new ArrayCollection();
		}
	}
	
	private function handlePickupInvoice(invoiceTmp:InvoiceBase):void {
		var message:String;   

		if (invoiceTmp != null) {
			var goodPickup:Boolean = true;
			
			invoice = invoiceTmp;
			
			if (invoice.pickupDate != null && invoice.pickupDate.getDate() != 0) {
				message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_ErrorduringpickupAni");
				Alert.show(message, "Warning", 0, null, null, null, 4); 
				goodPickup = false;
			}
			
			if (invoice.amountDue < 0) {
				message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Sorrybutthisinvoiceh");
				Alert.show(message, "Warning", 0, null, null, null, 4); 
				goodPickup = false;
			} 
			
			if (invoice.account == null || invoice.account.accountId == "") {
				message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Cantpickupaninvoiceu");
				Alert.show(message, "Warning", 0, null, null, null, 4); 
				goodPickup = false;
			}
						
			//
			// attempting to pickup invoice from a different account
			//
			if (goodPickup && customerAccount != null) {
				if (invoice.account != null && customerAccount.id != invoice.account.id) {
					message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Transactionalreadyin");
					Alert.show(message, "Warning", 0, null, null, null, 4); 
					goodPickup = false;
				}
			}
			
			if (goodPickup) {
				// TODO: test for delayed payment from PSS
				
				dataService.getAccount(invoice.account.id);
				customerAccount = invoice.account;			// active account for charging
				activeSale.isPickup = true;
				activeSale.invoice = invoice;
				activeSale.taxTable = invoice.taxTable
			//	activeSale.taxCode = invoice.
				activeSale.subTotal = invoice.subTotal;
				activeSale.total = invoice.amountDue;
				if (activeSale.total == 0)
					activeSale.total = invoice.priceTotal;		// TEMP  TODO - remove this (amount due is currently not imported properly)
					
				activeSale.taxAmount = invoice.tax;
				activeSale.description = invoice.name;
			
				if (activeSale.description.length == 0)
					activeSale.description = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'posPendCmd.PickUp');
				
				activeSale.noTax = invoice.notTaxable;
				
				if (invoice.taxTable != null) {
					pickTaxTable.selectedIndex = findItem(invoice.taxTable.name, TaxTableArray);
					
				}
				if ( invoice.taxCode != null)
					pickTaxCode.selectedIndex = findItem(invoice.taxCode.name, TaxCodesArray)
				
				if (txtSaleDescription != null)
					txtSaleDescription.text = activeSale.description;
				if (txtSaleQuantity != null)
					txtSaleQuantity.text = activeSale.quantity.toString();
				if (txtSaleUnitPrice != null) 
					txtSaleUnitPrice.text = Snowmass.getCurrencyFormatter(false,2).format(activeSale.unitPrice);
				if (txtSaleTotal != null)
					txtSaleTotal.text = Snowmass.getCurrencyFormatter(false,2).format(activeSale.subTotal);

				if (txtInvoiceTotalDue != null)
					txtInvoiceTotalDue.text = Snowmass.getCurrencyFormatter(false,2).format(activeSale.total);
					
				// TODO: capture invoice ID, Invoice Number, Previous deposits
				
				// make sure total areas are updated
				UpdateCashRegister();
				
				// except this sale transaction
				doAccept(false);
				if( goodPickup)
					txtSaleDescription.text = invoice.name;
				
				//
				// ACCOUNT is a charge account, pre set payment button
				//
				if (invoice.account != null && invoice.account.type == Constants.ACCOUNT_TYPE_CHARGE) {
					rbCharge.dispatchEvent(new MouseEvent(MouseEvent.CLICK , false, false));
				}
			}			
		}
	}
	
	
	private function askUserPopupClose(event:CloseEvent):void
	{
		titleWindow = null;
	}

	private function saveUserDescriptionHandler(evt:SaveAskUserDescriptionEvent):void {
 		if (evt.placeHolder is TapePaymentRecord) {
			var tempPayment:TapePaymentRecord = evt.placeHolder as TapePaymentRecord;
			tempPayment.refNumber = evt.description;
			tempPayment.isPaidOut = true;
		} else if (evt.placeHolder is TapeSaleRecord) {
			var tempSale:TapeSaleRecord = evt.placeHolder as TapeSaleRecord;
			tempSale.description = evt.description;
		}
		
		//
		// sence the prompting is not true MODAL, we had to halt any processing and ask user
		//		this is a way to continue on with the process after SAVE of the description.
		//
		switch(evt.opCode) {
		case 1:			// from a payment accept process
			doPayment();
			break;
		case 2:			// from a POST process halt
			doPostBatch();
			break;
		}
	}
	
	private var titleWindow:AskUserForDescriptionPopup=null;
	
	private function completeTransationDescription(transObject:Object, functionHalted:int):void {

		titleWindow = AskUserForDescriptionPopup(PopUpManager.createPopUp(this, AskUserForDescriptionPopup,true));
		titleWindow.SetPlaceHolder(transObject);
		titleWindow.SetOpCode(functionHalted);
		titleWindow.SetLabel(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'posRegisterCmd.Description'));
		titleWindow.SetDefaultDescription("");
		titleWindow.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'posRegisterCmd.Pleasedescribetransa');
		titleWindow.addEventListener(CloseEvent.CLOSE, askUserPopupClose, false, 1);
		titleWindow.addEventListener("SaveAskUserDescriptionEvent", saveUserDescriptionHandler, false, 1);
	}

	private function handleLoadInvoice(evt:ResultEvent):void {
		var invoiceTmp:InvoiceBase = evt.result as InvoiceBase;
		    
		handlePickupInvoice(invoiceTmp);
		
		this.throbber.visible = false;
		this.throbber.stop();
	}
	
	private function doDescriptionActivate():void {
		txtSaleDescription.setFocus();
		txtSaleDescription.setSelection(0, txtSaleDescription.length);
	}
	
	private function roundToCurrency(temp:Number):Number {
		var tempStr:String;
		var results:Number;
		
		// round direction
		numberFormatter.rounding = NumberBaseRoundType.NEAREST;
		// keep 4 places so round has something to work with
        tempStr = numberFormatter.format(temp.toFixed(4));
        // number formatter will come back with (2) places after decimal
        // turn back into a floating point number
		results = parseFloat(tempStr.replace(",",""));
		return(results);
	}
		
	
]]>
                             
</mx:Script>

<mx:VBox width="100%" height="100%">
	<mx:Canvas id="mainbox" width="100%" height="100%">
	

	<mx:Label x="0" y="64" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.DEPARTMENT')}" width="130" textAlign="center"/>	
	<mx:Tree x="0" y="80" width="130"  
		id="tvItems" 
		dataProvider="{systemCashPreferencesArray}"
		defaultLeafIcon="{null}"
		labelFunction="dotreelabel" height="100%" change="treeSelect(event);"></mx:Tree>
	
	<comp:Throbber id="throbber" height="40" width="40" visible="true" horizontalCenter="0" verticalCenter="0"/>

	<mx:Button x="150" y="10" width="38" height="38" click="doPostBatch();" enabled="{enableSave}" id="btnSave">
		<mx:icon>@Embed(source='../../../../assets/file.png')</mx:icon>
	</mx:Button>
	<mx:Button x="214" y="10" width="38" height="38" click="doRevert();" enabled="{enableSave}" id="btnRevert">
		<mx:icon>@Embed(source='../../../../assets/cancel.png')</mx:icon>
	</mx:Button>
	<mx:Button x="280" y="10" width="38" height="38" click="doInvoice();" id="btnInvoice">
		<mx:icon>@Embed(source='../../../../assets/InvoiceWONotes.png')</mx:icon>
	</mx:Button>
	<mx:Button x="345" y="10" width="38" height="38" click="doAddJob();"  id="btnAddJob">
		<mx:icon>@Embed(source='../../../../assets/new_job.png')</mx:icon>
	</mx:Button>
	<mx:Button x="413" y="10" width="38" height="38" click="doAddCharge();" id="btnAddCharge">
		<mx:icon>@Embed(source='../../../../assets/new_job.png')</mx:icon>
	</mx:Button>

	<mx:Canvas x="130" y="80" width="100%" height="100%" id="cashregister_canvas" hideEffect="effect" showEffect="effect">
		<mx:Button x="10" y="10" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CustAcct')}" id="btnCustAcct" click="doAccount();"/>
		<mx:Text x="161" y="6" id="acct_title" width="304" fontSize="9" fontWeight="bold" height="20"/>
		
		<mx:Text x="210" y="25" id="acct_type" width="284" fontSize="9" fontWeight="bold" height="20"/>
		<mx:Text x="550" y="25" id="acct_status_text" width="85" fontSize="9" fontWeight="bold" height="20"/>
		<mx:Label x="163" y="25" width="50" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Type')}" textAlign="right" fontSize="9"/>
		<mx:Label x="502" y="25" width="50" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Status')}" textAlign="right" fontSize="9"/>
		
		<mx:Canvas x="0" y="50" width="200" height="95" id="tax_canvas" borderStyle="inset">
			<mx:Label x="5" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.TaxTable')}" width="64" textAlign="right"/>
			<mx:Label x="5" y="35" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.TaxCode')}" width="64" textAlign="right"/>

		    <mx:ComboBox x="77" y="8" change="UpdateCashRegister()" id="pickTaxTable" width="100" dataProvider="{TaxTableArray}" labelField="name" selectedItem="{data.name}"/>
		    <mx:ComboBox x="77" y="33" change="UpdateCashRegister()" id="pickTaxCode" width="100" dataProvider="{TaxCodesArray}" labelField="name" selectedItem="{data.name}"/>
		    <mx:CheckBox x="77" y="63" label="Non-Tax" id="chkNonTax" change="UpdateCashRegister()"/>
		</mx:Canvas>
		<mx:Canvas x="198" y="50" width="210" height="95" id="tax_canvas0" hideEffect="effect" showEffect="effect" borderStyle="inset">
			<mx:Label x="0" y="12" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'labelCmd.Format')}" width="59" textAlign="right"/>
			<mx:ComboBox x="67" y="10" id="cboFormat"  dataProvider="{FormatArray}" labelField="name" width="128"/>
			<mx:CheckBox x="10" y="35" id="chkPrintInvoice" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.PrintInvoice')}"/>
				
		</mx:Canvas>
		<mx:Canvas x="0" y="143" width="408" height="278" id="tax_canvas1" hideEffect="effect" showEffect="effect" borderStyle="inset">
			<mx:Button x="10" y="200" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Accept')}" click="doAccept(false);" width="176" enabled="false" id="accept_button"/>
			<mx:CheckBox x="10" y="243" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.PrintReceipt')}" id="checkbox1"/>
			<mx:TextArea x="396" y="266" width="4.8" height="4.8" focusIn="doDescriptionActivate()" id="txtSaleDescription" tabIndex="4" enabled="true"/>
		</mx:Canvas>
		<mx:Canvas x="407" y="50" width="261" height="215" id="tax_canvas2" hideEffect="effect" showEffect="effect" borderStyle="inset">
			<mx:Label x="50" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.PAYMENTMETHOD')}"/>
			<mx:Button x="10" y="180" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Payment')}" width="186" id="btPayment" click="doPayment();" enabled="false"/>
			<mx:RadioButtonGroup id="rgPaymentMethod" change="paymentMethodChanged(event)"/>
			<mx:RadioButton x="10" y="34" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CASH')}" id="rbCash" groupName="rgPaymentMethod" value="Cash"/>
			<mx:RadioButton x="10" y="60" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CRCARD')}" id="rbCreditCard" groupName="rgPaymentMethod" value="Credit Card"/>
			<mx:RadioButton x="131" y="34" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CHECK')}" id="rbCheck" groupName="rgPaymentMethod" value="Check"/>
			<mx:RadioButton x="131" y="60" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CHARGE')}" id="rbCharge" groupName="rgPaymentMethod" value="Charge"/>

		</mx:Canvas>
		<mx:Canvas x="407" y="264" width="261" height="157" id="tax_canvas3" hideEffect="effect" showEffect="effect" borderStyle="inset">
			<mx:Label x="45" y="22" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.SubTotal')}" id="label9" width="92" textAlign="right"/>
			<mx:Label x="46" y="48" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Tax')}" id="label8" width="91" textAlign="right"/>
			<mx:Label x="45" y="74" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Total')}" id="label7" width="92" textAlign="right"/>
			<mx:Label x="45" y="100" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Tendered')}" id="label5" width="92" textAlign="right"/>
			<mx:Label x="44" y="126" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Change')}" id="label6" width="93" textAlign="right"/>
			<mx:Text id="subtotal_edit" x="145" y="22" width="86"  textAlign="right"/>
			<mx:Text id="tax_edit" x="145" y="48" width="86" textAlign="right"/>
			<mx:Text id="total_edit" x="145" y="74" width="86" textAlign="right"/>
			<mx:Text id="tender_edit" x="145" y="100" width="86" textAlign="right"/>
			<mx:Text id="change_edit" x="145" y="126" width="86" textAlign="right"/>

		</mx:Canvas>
		<mx:DataGrid x="0" y="420" width="666" id="cashReg_grid" dataProvider="{sessionBatch.transactions}" height="119" itemClick="doTransactionGrid();">
			<mx:columns>
				<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rChargeLabel.Description')}" labelFunction="doDescript"/>
				<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invTotalCmd.Subtotal')}" labelFunction="doSubtotalPrice"/>
				<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invTotalCmd.SalesTax')}" labelFunction="doTaxPrice"/>
				<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invTotalCmd.Total')}"  labelFunction="doTotalPrice" />
			</mx:columns>
		</mx:DataGrid>
		<mx:Button x="10" y="558" click="doVoid();" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'tapeCmd.VoidTransaction')}" width="154"  enabled="false" id="button1"/>
		
	</mx:Canvas>
	<mx:Label x="110" y="54" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Post')}" width="114" textAlign="center"/>
	<mx:Label x="175" y="54" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'listerCmd.Cancel')}" width="115" textAlign="center"/>
	<mx:Label x="242" y="54" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'barcodeCmd.Invoice')}" width="119" textAlign="center"/>
	<mx:Label x="300" y="54" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'jobCmd.NewJob')}"  width="130" textAlign="center"/>
	<mx:Label x="369" y="54" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Addcharges')}"  width="130" textAlign="center"/>
	</mx:Canvas>
</mx:VBox>

</mx:Panel>
