<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow 
	xmlns:mx="http://www.adobe.com/2006/mxml" 
	xmlns:comp="com.efi.printsmith.components.*" 
	layout="absolute" 
	width="100%" 
	height="100%"
	headerHeight="0" 
	title="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CashRegister')}" 
	label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CashRegister')}" 
	name="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CashRegister')}" 
		preinitialize="preInit();"
 	implements="com.efi.printsmith.security.ISecureComponent"
	xmlns:components="com.efi.printsmith.components.*" 
	xmlns:vo="com.efi.printsmith.vo.*">
<mx:Script source="../security/PSSecurityInclude.as" />
	<mx:CurrencyFormatter precision="2" id="currencyFormatter"/>
	<mx:NumberFormatter precision="2" id="numberFormatter"/>
	<mx:NumberFormatter precision="0" id="quantityFormatter"/>
	
 	<mx:states>
 	 	<mx:State name="">
 			<mx:RemoveChild target="{txtSaleDescription}"/>
  	 	</mx:State>
 	
 	 	<mx:State name="invoiceState">
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="10" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Invoice')}" id="invstate_label1" width="87" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="10" y="35" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.TotalDue')}" id="invstate_label2" width="87" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="10" y="61" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Description')}" id="invstate_label3"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:TextInput x="105" y="8" width="75" text="{invoice.invoiceNumber}" id="txtInvoiceNumber" focusOut="doGetInvoice()"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Text x="105" y="33" width="75" text="{invoice.totalCost}" id="txtInvoiceTotalDue"/>
 	 	 	</mx:AddChild>


 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="10" y="140" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Paid')}" id="invstate_label4" width="81" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Label x="12" y="165" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.StillDue')}" id="invstate_label5" width="79" textAlign="right"/>
 	 	 	</mx:AddChild>

 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
				<mx:Text x="99" y="138" width="75" id="txtInvoicePaid"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Text x="99" y="163" width="75" id="txtInvoiceStillDue"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:SetProperty target="{pickTaxTable}" name="enabled" value="false"/>
 	 	 	<mx:SetProperty target="{pickTaxCode}" name="enabled" value="false"/>
 	 	 	<mx:SetEventHandler target="{tax_canvas1}" name="activate"/>
 	 	 	<mx:SetProperty target="{chkNonTax}" name="enabled" value="false"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="x" value="10"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="y" value="85"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="width" value="349"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="height" value="45"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="enabled" value="true"/>

 	 	</mx:State>
 	 	<mx:State name="departmentState">
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Quantity')}" id="label1" width="87" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="35" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.UnitPrice')}" id="label2" width="87" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="60" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Total')}" id="label3" width="87" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:TextInput  restrict="0-9\." x="105" y="8" width="75" id="txtSaleQuantity" tabIndex="1" focusOut="UpdateCashRegister()" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:TextInput  restrict="0-9\."  x="105" y="33" width="75" id="txtSaleUnitPrice" tabIndex="2" focusOut="UpdateCashRegister()" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:TextInput restrict="0-9\."  x="105" y="58" width="75" id="txtSaleTotal" textAlign="right" tabIndex="3" focusOut="doChangeTotalPrice()"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="86" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Description')}" id="label4"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:SetProperty target="{chkNonTax}" name="enabled" value="true"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="x" value="10"/>
 	 	 	<mx:SetProperty target="{label5}" name="width" value="92"/>
 	 	 	<mx:SetProperty target="{label6}" name="x" value="45"/>
 	 	 	<mx:SetProperty target="{label6}" name="width" value="92"/>
 	 	 	<mx:SetProperty target="{label8}" name="x" value="45"/>
 	 	 	<mx:SetProperty target="{label9}" name="width" value="92"/>
 	 	 	<mx:SetProperty target="{label8}" name="width" value="92"/>
 	 	 	<mx:SetProperty target="{label7}" name="width" value="92"/>
 	 	 	<mx:SetStyle target="{label6}" name="textAlign" value="right"/>
 	 	 	<mx:SetStyle target="{label5}" name="textAlign" value="right"/>
 	 	 	<mx:SetStyle target="{label7}" name="textAlign" value="right"/>
 	 	 	<mx:SetStyle target="{label8}" name="textAlign" value="right"/>
 	 	 	<mx:SetStyle target="{label9}" name="textAlign" value="right"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="enabled" value="true"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="x" value="10"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="y" value="112"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="width" value="170"/>
 	 	 	<mx:SetProperty target="{txtSaleDescription}" name="height" value="53"/>
 	 	</mx:State>
 	 	<mx:State name="invoicePaymentMethod" basedOn="invoiceState">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="154" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Amount')}" width="103" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="152" width="75" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	</mx:State>
 	 	<mx:State name="paymentPaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="154" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Amount')}" width="103" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput  restrict="0-9\." x="121" y="152" width="75" id="payment_cash_edit" change="UpdateBatchNumbers()" textAlign="right"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:RemoveChild target="{txtSaleDescription}"/>
 	 	 	<mx:SetProperty target="{tax_canvas1}" name="height" value="278"/>
 	 	 	<mx:SetProperty target="{tax_canvas3}" name="height" value="157"/>
 	 	</mx:State>
 	 	<mx:State name="paymentCash" basedOn="paymentPaymentMethod">
 	 	 	<mx:SetProperty target="{button1}" name="y" value="547"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="y" value="420"/>
 	 	 	<mx:SetProperty name="height" value="760"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="width" value="668"/>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="x" value="0"/>
 	 	 	<mx:SetProperty target="{cashregister_canvas}" name="height" value="577"/>
 	 	 	<mx:SetProperty target="{cashregister_canvas}" name="width" value="687"/>
 	 	 	<mx:SetProperty name="width" value="857"/>
 	 	</mx:State>
 	 	<mx:State name="paymentCreditCard" basedOn="paymentPaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="90" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.CardType')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="72" y="116" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.Ref')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:ComboBox x="76" y="88" width="171"  labelField="cardType" dataProvider="{creditCardPreferencesArray}" id="card_type"></mx:ComboBox>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="114" width="75"  id="card_ref" focusOut="UpdateCashRegister()"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:SetProperty target="{cashReg_grid}" name="x" value="0"/>
 	 <!-- 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Button x="204" y="115" width="19" height="19" click="doCreditCardManualApproval()" enabled="{enableCCApproval}" id="btnCCmanualApprove0">
 	 	 	 		<mx:icon>@Embed(source='../../../../assets/CreditCardManualApproval.png')</mx:icon>
 	 	 	 	</mx:Button>
 	 	 	</mx:AddChild>	-->
 	 	 	<!--<mx:AddChild relativeTo="{tax_canvas1}" position="lastChild" target="{checkbox1}"/>
 	 	 	<mx:SetProperty target="{checkbox1}" name="x" value="267"/>
 	 	 	<mx:SetProperty target="{checkbox1}" name="y" value="230"/>-->
 	 	</mx:State>
 	 	<mx:State name="paymentCheck" basedOn="paymentPaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="62" y="116" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.Check')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="114" width="75" id="check_num"/>
 	 	 	</mx:AddChild>
 	 	</mx:State>
 	 	<mx:State name="paymentCharge" basedOn="paymentPaymentMethod"/>
 	 	<mx:State name="invoiceCash" basedOn="invoicePaymentMethod">
 	 	</mx:State>
 	 	<mx:State name="invoiceCreditCard" basedOn="invoicePaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="10" y="90" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.CardType')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="72" y="116" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.Ref')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:ComboBox x="76" y="88" width="120"></mx:ComboBox>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="114" width="75"/>
 	 	 	</mx:AddChild>
 	 	<!-- 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Button x="204" y="115" width="19" height="19" click="doCreditCardManualApproval()" enabled="{enableCCApproval}" id="btnCCmanualApprove">
 	 	 	 		<mx:icon>@Embed(source='../../../../assets/CreditCardManualApproval.png')</mx:icon>
 	 	 	 	</mx:Button>
 	 	 	</mx:AddChild>	-->
 	 	</mx:State>
 	 	<mx:State name="invoiceCheck" basedOn="invoicePaymentMethod">
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:Label x="62" y="116" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'paymentsCmd.Check')}"/>
 	 	 	</mx:AddChild>
 	 	 	<mx:AddChild relativeTo="{tax_canvas2}" position="lastChild">
 	 	 	 	<mx:TextInput x="121" y="114" width="75"/>
 	 	 	</mx:AddChild>
 	 	</mx:State>
 	 	<mx:State name="invoiceCharge" basedOn="invoicePaymentMethod">
 	 	</mx:State>
 	</mx:states>
 
 	<mx:RemoteObject id="dataService" destination="dataService">
 		<mx:method name="getAccountPicker" fault="handleFault(event)" result="handleLoadAccountsResult(event)"/>
	<!--	<mx:method name="getAll" fault="handleFault(event)" result="handleLoadResult(event)"/>-->
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveResult(event)"/>
		<mx:method name="getAccount" fault="handleFault(event)" result="handleGetResult(event)"/>
		<mx:method name="getInvoiceByInvoiceNumber" fault="handleFault(event)" result="handleLoadInvoice(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceUnPurchase" destination="dataService">
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveUnPurchaseResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="invoiceRepositoryService" destination="invoiceRepositoryService">
		<mx:method name="getItemList"
					fault="handleFault(event)"
					result="handleLoadInvoiceTemplates(event)"/>		
	</mx:RemoteObject>

	<mx:RemoteObject id="dataServiceCashDrawer" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadCashDrawerResult(event)"/>
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveCashDrawerResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceCCT" destination="dataService">
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleCCTSaveResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceTapeBatch" destination="dataService">
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleSaveTapeBatchResult(event)"/>
		<mx:method name="getCurrentTapeBatch" fault="handleFault(event)" result="handleLoadCurrentTapeBatch(event)"/>
	</mx:RemoteObject>
<!--	<mx:RemoteObject id="dataServiceCashRegisterBatch" destination="dataService">
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleBatchSaveResult(event)"/>
	</mx:RemoteObject>-->
 	<mx:RemoteObject id="dataServiceTaxCodes" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadTaxCodesResult(event)"/>
	</mx:RemoteObject>
 <!--	<mx:RemoteObject id="dataServiceTape" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadTape(event)"/>
		<mx:method name="addUpdate" fault="handleFault(event)" result="handleTapeSaveResult(event)"/>
	</mx:RemoteObject>-->
 	<mx:RemoteObject id="dataServiceTaxTable" destination="dataService">
		<mx:method name="getCurrentTaxTables" fault="handleFault(event)" result="handleLoadTaxTableResult(event)"/>
	</mx:RemoteObject>

	<mx:RemoteObject id="dataServiceSystemPreferences" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadSystemPreferencesResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceCashPreferences" destination="dataService">
		<mx:method name="getAll" fault="handleFault(event)" result="handleLoadCashRegPreferencesResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="taxCalculatorService" destination="taxService">
		<mx:method name="calculateTax" fault="handleFault(event)" result="handleTaxResult(event)"/>
	</mx:RemoteObject>
<mx:RemoteObject id="dataServiceCreditCardPreferences" destination="dataService">
	<mx:method name="getAll" fault="handleFault(event)" result="handleLoadCreditCardPreferencesResult(event)"/>
</mx:RemoteObject>
<!--	<mx:RemoteObject id="dataServiceInvoice" destination="InvoiceService">
	<mx:method name="getInvoice" fault="handleFault(event)" result="handleLoadInvoice(event)"/>
</mx:RemoteObject>-->
	<mx:Producer id="producer" destination="cashregister"/>
	<mx:Consumer id="consumer" destination="cashregister" message="messageHandler(event.message)"/>
	<mx:Consumer id="notification_consumer" destination="notifications" message="messageHandler(event.message)"/>
<mx:Script>
<![CDATA[
	import mx.events.ListEvent;
	import mx.events.TreeEvent;
	import mx.events.FlexEvent;
	import com.efi.printsmith.security.PSSecurityCommands;
	import com.efi.printsmith.data.InvoiceBase;
	import com.efi.printsmith.data.JobBase;
	import com.efi.mdi.view.window.MDIWindow;
	import com.efi.printsmith.data.CashDrawer;
	import com.efi.printsmith.data.Tape;
	import com.hillelcoren.utils.ArrayCollectionUtils;
	import com.efi.printsmith.data.PreferencesCashRegister;
	import mx.events.StateChangeEvent;
	import mx.controls.Text;
	import mx.utils.StringUtil;
	import mx.managers.FocusManager;
	import com.efi.printsmith.security.PSSecurityCommands;
	import com.efi.printsmith.security.PSSecurityUtils;

	import com.efi.printsmith.data.TaxTable;
	import com.efi.printsmith.data.TaxCodes;
	
	import com.efi.printsmith.data.TapeBatch;
	import com.efi.printsmith.data.TapeSessionBatch;
	import com.efi.printsmith.data.TapePaymentRecord;
	import com.efi.printsmith.data.TapeSaleRecord;
	import com.efi.printsmith.data.AccountHistoryData;
	import com.efi.printsmith.data.CreditCardTransactions;
	import com.efi.printsmith.data.CreditCard;
	
	import com.efi.printsmith.data.PreferencesSystem;
	import com.efi.printsmith.events.AccountPickerSelectEvent;
	import com.efi.printsmith.data.PreferencesCreditCard;
	import com.efi.printsmith.data.Account;
	import com.efi.printsmith.data.UnpurchasedMerchandise;

	import com.efi.printsmith.events.JobEditCompleteEvent;
	import com.efi.printsmith.events.CreditCardTrackReadEvent;
	import com.efi.printsmith.events.CreditCardTransEvent;
	import com.efi.printsmith.Constants;

	import mx.controls.Alert;                                         
	import mx.managers.PopUpManager;                                         
	import mx.containers.TitleWindow;                                         
	import mx.collections.ArrayCollection;                                         
	import mx.rpc.events.ResultEvent;                                         
	import mx.rpc.events.FaultEvent;                                         
	import mx.messaging.messages.AsyncMessage;
	import mx.messaging.messages.IMessage;
	import mx.collections.XMLListCollection;

	[Bindable]
	private var enableSave:Boolean = true;
	[Bindable]
	private var enableCCApproval:Boolean = true;
	[Bindable]
	private var waitOnNewCashDrawer:Boolean = false;

	[Bindable]                                         
    private var systemPreferences:PreferencesSystem;
    [Bindable]  
 	private var accounts:ArrayCollection = new ArrayCollection();
	[Bindable]                                
	private var systemPreferencesArray:ArrayCollection = new ArrayCollection();

//	[Bindable]
//	private var cashRegisterTransacations:ArrayCollection = new ArrayCollection();
	[Bindable]
	private var systemCashPreferencesArray:ArrayCollection = new ArrayCollection();
	
	
[Bindable]
//	private var itemQty:String;
//	[Bindable]
	private var invoice:InvoiceBase;
	[Bindable]
	private var customerAccount:Account;
	[Bindable]
	private var creditLimit:Number;
		
//	[Bindable]
//	private var itemUnitPrice:Number;
//	[Bindable]
//	private var itemTotal:String;

//	[Bindable]
//	private var subTotal:String;
//	[Bindable]
//	private var taxTotal:String;
//	[Bindable]
//	private var payTotal:String;
//	[Bindable]
//	private var payTendered:String;
//	[Bindable]
//	private var payChange:String;
	[Bindable]
	private var AustrailianRounding:Boolean;
	[Bindable]
	private	var unPurchase:UnpurchasedMerchandise;
//	[Bindable]
//	private var posTransactions:ArrayCollection;
	
//Data field arrays
//	[Bindable]
//	private var CashRegisterArray:ArrayCollection = new ArrayCollection();
	[Bindable]
	private var TaxTableArray:ArrayCollection = new ArrayCollection();
	[Bindable]
	private var TaxCodesArray:ArrayCollection = new ArrayCollection();
	[Bindable]
	private var FormatArray:ArrayCollection = new ArrayCollection();
	[Bindable]
    private var creditCardPreferencesArray:ArrayCollection = new ArrayCollection();
   [Bindable]
	private var cashDrawer:CashDrawer;
//Data view variables
//	[Bindable]
//	private var tape:Tape;
	[Bindable]
	private var sessionBatch:TapeSessionBatch;
	[Bindable]
	private var tapeBatch:TapeBatch;
	[Bindable]
	private var activeSale:TapeSaleRecord;
	[Bindable]
	private var activePayment:TapePaymentRecord;
//Tree view XML table
	
	public function CashRegisterInvPickup(inv:InvoiceBase):void {
		if (inv != null) {
			invoice = inv;
		}
	}
	
//	private function handleLoadTape(ev:ResultEvent):void {
//	     tape = ev.result as Tape;
//	}
//	private function handleTapeSaveResult(ev:ResultEvent):void {
//	     tape = ev.result as Tape;
//	}
	
	private function handleLoadTaxTableResult(ev:ResultEvent):void {
	     TaxTableArray = ev.result as ArrayCollection;
	}
	private function handleLoadTaxCodesResult(ev:ResultEvent):void {
	     TaxCodesArray = ev.result as ArrayCollection;
	}
	private function handleLoadCashDrawerResult(ev:ResultEvent):void {
	    var cashDrawerArray:ArrayCollection = ev.result as ArrayCollection;
	    
	    //
	    // should never be more than one cash drawer in the current design
	    //
		if (cashDrawerArray.length > 0)
		{
			cashDrawer = cashDrawerArray.getItemAt(0) as CashDrawer;
		} else {
			waitOnNewCashDrawer = true;
	     	cashDrawer = new CashDrawer();
	     	dataServiceCashDrawer.addUpdate(cashDrawer);
		}
	}
	
	private function handleSaveCashDrawerResult(ev:ResultEvent):void {
		cashDrawer = ev.result as CashDrawer;
		
		//
		// first time startup, no cash drawer exist.
		//
		if (waitOnNewCashDrawer == true) {
			waitOnNewCashDrawer = false;
			this.throbber.visible = false;
			this.throbber.stop();
		} 
		//
		// normal SAVE of the cash drawer after a session is POST'ed
		//
		else {
			InitSessionBatch();		// new session
			InitSaleRecord();		// setup for another sale
			invoice = null;
			customerAccount = null;
			this.currentState = "";
			openTree();
			UpdateBatchNumbers();	
		}	
	}
	
	private function handleLoadCashRegPreferencesResult(ev:ResultEvent):void{
		systemCashPreferencesArray = ev.result as ArrayCollection;
		
		//
		// in a normal startup, this is the last record to wait on, but if a new cash drawer is built
		//	then we must wait on it as well.
		//
		if (waitOnNewCashDrawer == false) {
			this.throbber.visible = false;
			this.throbber.stop();
		}
	}
	
	public function handleLoadInvoiceTemplates(evt:ResultEvent):void {
		if (evt.result != null) {
			FormatArray = evt.result as ArrayCollection;
		}

		dataService.getAccountPicker();
		
		// invoice came in with the window OPEN, like a pending list pickup request
		if (invoice != null) {
			doInvoice();
			handlePickupInvoice(invoice);
		}
	}

	// call back AFTER the credit card charge is complete
	private function handleCreditCardTransWrite(ev:CreditCardTransEvent):void 
	{
		var temp:CreditCardTransactions = ev.theData as CreditCardTransactions;
		
		if (temp != null) {
			activePayment.cct = temp;
			card_ref.text = activePayment.cct.approvalCode;
		}
		
		UpdateCashRegister();
	}

	private function handleLoadSystemPreferencesResult(ev:ResultEvent):void {
		systemPreferencesArray = ev.result as ArrayCollection;
		if (systemPreferencesArray.length > 0)
		{
			systemPreferences = systemPreferencesArray.getItemAt(0) as PreferencesSystem;
			AustrailianRounding = systemPreferences.austrailianInvoiceRounding;
		}else {
			AustrailianRounding = false;
		}

	}	                                 
	private function handleTaxResult(ev:ResultEvent):void{
		var tax:Number;
	//	var tempString:String;
	
		activeSale.taxAmount = ev.result as Number;
		
		if (activeSale.opPrice == false)
			activeSale.total = activeSale.subTotal + activeSale.taxAmount;
			
		UpdateBatchNumbers();
	}
	
	private function UpdateBatchNumbers():void {
				
		sessionBatch.accumChange = (sessionBatch.accumTendered + activePayment.total) - sessionBatch.accumTotal;
		
		// update the batch numbers with the current SALE and Payment transactions (before any accept)
		//
		subtotal_edit.text = Snowmass.getCurrencyFormatter(false,2).format(sessionBatch.accumSubTotal + activeSale.subTotal);
		tax_edit.text = Snowmass.getCurrencyFormatter(false,2).format(sessionBatch.accumTaxTotal + activeSale.taxAmount);
		total_edit.text = Snowmass.getCurrencyFormatter(false,2).format(sessionBatch.accumTotal + activeSale.total);
		tender_edit.text = Snowmass.getCurrencyFormatter(false,2).format(sessionBatch.accumTendered + activePayment.total);
		change_edit.text = Snowmass.getCurrencyFormatter(false,2).format(sessionBatch.accumChange);
	}	
	
	public function getSecurityCommand():String {
    	return PSSecurityCommands.POS_OPENCASHREGISTER;
    }
    
    private function InitPaymentRecord():void {    	
    	activePayment = new TapePaymentRecord();
    	
    	if (payment_cash_edit != null)
    		payment_cash_edit.text = "";
    	if (check_num != null)
    		check_num.text = "";
    	if (card_ref != null)
    		card_ref.text = "";
    }
    
    private function InitSaleRecord():void {
    	InitPaymentRecord();
    	
 		activeSale = new TapeSaleRecord();
 		activeSale.cashRegisterDept = new PreferencesCashRegister();
		activeSale.customerAccount = new Account();
		creditLimit = 0;
		
		if (txtSaleDescription != null)
			txtSaleDescription.text = "";
		if (txtSaleQuantity != null)
			txtSaleQuantity.text = "";
		if (txtSaleUnitPrice != null)
			txtSaleUnitPrice.text = "";
		if (txtSaleTotal != null) {
			txtSaleTotal.text = "";
			setOverrideForField(txtSaleTotal, activeSale.opPrice);
		}
   }
   
   private function InitSessionBatch():void {
   		sessionBatch = new TapeSessionBatch();
   		//
   		// array of Transactions, could be Sale or Payments
   		//
		sessionBatch.transactionsList = new ArrayCollection();
		
		// the user was logged in during the session
		sessionBatch.user = Snowmass.getInstance().currentUser;
   }
   
 	//
	private function myKeyDownHandler(event:KeyboardEvent):void {
		var	stringChar:String;
		var curKeyCode:int;
		var goodKeyEquiv:Boolean;
		
		// ONLY WHEN command and shift keys are down
		//
		if( event.altKey == false && event.ctrlKey == true && event.shiftKey == true){
			curKeyCode = event.keyCode;
			stringChar = String.fromCharCode(event.charCode);
			
			//
			// look for the first charcater in the radio button titles as a match
			//
			if (stringChar == rbCash.label.substr(0,1)) {
				rbCash.dispatchEvent(new MouseEvent(MouseEvent.CLICK , false, false));
			} else if (stringChar == rbCreditCard.label.substr(0,1)) {
				rbCreditCard.dispatchEvent(new MouseEvent(MouseEvent.CLICK , false, false));
			} else if (stringChar == rbCheck.label.substr(0,1)) {
				rbCheck.dispatchEvent(new MouseEvent(MouseEvent.CLICK , false, false));
			} else if (stringChar == rbCharge.label.substr(0,1)) {
				rbCharge.dispatchEvent(new MouseEvent(MouseEvent.CLICK , false, false));
			} else {
				goodKeyEquiv = false;
				switch(stringChar) {
				case "1":
				case "2":
				case "3":
				case "4":
				case "5":
				case "6":
				case "7":
				case "8":
				case "9":
					tvItems.selectedIndex = (parseInt(stringChar) - 1);
					goodKeyEquiv = true;
					break;
				default:;
				}
				
				if(goodKeyEquiv == true) {
					this.stage.focus = null;
					
					tvItems.validateNow();
					tvItems.dispatchEvent(new ListEvent("change"));
					
					if (txtSaleQuantity != null && txtSaleQuantity.enabled)
						txtSaleQuantity.setFocus();
					
					event.stopImmediatePropagation();
				}
			}
		}
	}

  	//
	// this is used to change the font in the active field to show a override state
	//
	private function setOverrideForField(field:TextInput, overrideActive:Boolean):void
	{
		if (overrideActive)
		{
			field.setStyle("fontStyle","italic");
			field.setStyle("textDecoration","underline");
		} else {
			field.setStyle("fontStyle","normal");
			field.setStyle("textDecoration","none");
		}
	}

	public function init(event:FlexEvent = null):void {
		consumer.subscribe();
		notification_consumer.subscribe();
		
		this.throbber.visible = true;
		this.throbber.play();

		var mdiWin:MDIWindow = Snowmass.getInstance().containerManager.getWindowWithChild(this);
		mdiWin.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CashRegister');
		
		stage.addEventListener(KeyboardEvent.KEY_DOWN, myKeyDownHandler);
		
		//tape = new Tape();
		
		// these will be appeaded to the open tape
		tapeBatch = new TapeBatch();
		tapeBatch.sessionBatches = new ArrayCollection();
		
		//
		// this is the session that is appeaded to the open tape batch
		//
		InitSessionBatch();
		
		// current monies held in the cash drawer
		cashDrawer = new CashDrawer();
		
		dataServiceCashDrawer.getAll("CashDrawer");
		dataServiceSystemPreferences.getAll("PreferencesSystem");
		dataServiceCreditCardPreferences.getAll("PreferencesCreditCard");
		dataServiceTaxCodes.getAll("TaxCodes")	;
		dataServiceTaxTable.getCurrentTaxTables("TaxTable");
		dataServiceCashPreferences.getAll("PreferencesCashRegister");
		
	//	dataServiceTape.getall("Tape");
		dataServiceTapeBatch.getCurrentTapeBatch();
		
		InitSaleRecord();			// setup for the first sale transaction
		
		// perform the account load in the background, the button will come alive when list is loaded
		invoiceRepositoryService.getItemList();
		btnCustAcct.enabled = false;
		
		this.addEventListener(mx.events.StateChangeEvent.CURRENT_STATE_CHANGE, paymentStateHandler);
	}
	
	private function messageHandler(message:IMessage):void{
		var messageBody:Object = message.body;// as com.efi.messaging.MessageBody;
		
		var messageType:String = messageBody.messageType;
		if (messageType == "ADDUPDATE" || messageType == "DELETE") {
			var payloadType:String = messageBody.payloadType as String; // What kind of item was added/deleted
			var payload:Number = messageBody.payload as Number; // ID if item added or deleted
			if (payloadType == "TaxTable") {
				dataServiceTaxTable.getAll("TaxTable")
			}
			if (payloadType == "TaxCodes") {
				dataServiceTaxCodes.getAll("TaxCodes")
			}
		}
	}
      private function handleLoadCreditCardPreferencesResult(ev:ResultEvent):void {
		creditCardPreferencesArray = ev.result as ArrayCollection;
		
	}	            
	private function handleFault(ev:FaultEvent):void {  
		var message:String;
		              
		message = "Error: "                          
		+ ev.fault.faultCode + " - "                                  
		+ ev.fault.faultDetail + " - "                                  
		+ ev.fault.faultString;
		Alert.show(message, "Error", 0, null, null, null, 4);                                 
	}


// Data Load Handlers
//	private function handleLoadResult(ev:ResultEvent):void {
//		CashRegisterArray = ev.result as ArrayCollection;
//	}
	private function handleLoadAccountsResult(ev:ResultEvent):void {
		accounts = ev.result as ArrayCollection;
		
		btnCustAcct.enabled = true;
	}
// Data Save Handlers
	private function handleSaveResult(ev:ResultEvent):void {
    	//dataService.getAll("PreferencesSystem");
	}
	
	private function handleSaveUnPurchaseResult(ev:ResultEvent):void{

	}

	private function handleSaveTapeBatchResult(ev:ResultEvent):void{
		tapeBatch = ev.result as TapeBatch;
		
		//
		// good save of Tape batch and all session layers
		//
		this.throbber.visible = false;
		this.throbber.stop();
	}
	
//	private function handleBatchSaveResult(ev:ResultEvent):void{
//	}
	
	private function UpdateCashRegister():void{
		var temp:Number;
		var tempString:String;
		var tempQuantity:Number;
		
		if (txtSaleQuantity.text != "")
			tempQuantity = parseInt(txtSaleQuantity.text.replace(",",""));
		else
			tempQuantity = 0;
			
		if (txtSaleUnitPrice.text != "")
			temp = parseFloat(txtSaleUnitPrice.text.replace(",","")) * tempQuantity;
		else
			temp = 0;
		
		if ( tempQuantity > 0) {
			accept_button.enabled =  true;
			accept_button.tabIndex = 5;
			this.focusManager.defaultButton = accept_button;
		}	
		else {
			accept_button.enabled = false;
			this.focusManager.defaultButton = null;
		}
		
		// total price can be overridden
		if (activeSale != null && activeSale.opPrice == false)
			txtSaleTotal.text = Snowmass.getCurrencyFormatter(false,2).format(temp)
		
		activeSale.subTotal = temp;		// no tax at this point

		activeSale.taxTable = pickTaxTable.selectedItem as TaxTable;
		activeSale.taxCode = pickTaxCode.selectedItem as TaxCodes;
		
		if (chkNonTax.selected){
			activeSale.taxAmount = 0;
			UpdateBatchNumbers();
		}
		else
			taxCalculatorService.calculateTax(activeSale.taxTable, activeSale.subTotal);
			
		if (card_ref != null && card_ref.text.length == 0 && btPayment != null)
			btPayment.enabled = false;
		else
			btPayment.enabled = true;
	}
		
	private function openTree():void {
		var nodeList:XMLListCollection = 
			tvItems.dataProvider as XMLListCollection;
		tvItems.selectedIndex = -1;

		var node:XML = XML(tvItems.selectedItem);
	}

	private var treeStateString:String = "";
	private function treeSelect(event:Event):void {
		var treeItem:PreferencesCashRegister = tvItems.selectedItem as PreferencesCashRegister;
	
		accept_button.enabled = false;
		this.currentState = "";
		
		this.currentState = "departmentState";
		
		InitSaleRecord();
		
		treeStateString = this.currentState;
		txtSaleUnitPrice.text = Snowmass.getCurrencyFormatter(false,2).format(treeItem.rate);
		txtSaleDescription.text = treeItem.title;
		
		activeSale.cashRegisterDept = treeItem;
		activeSale.department = activeSale.cashRegisterDept.title;
		
		if (treeItem.taxTable != null)
			pickTaxTable.selectedIndex = findItem(treeItem.taxTable.name, TaxTableArray);
		if (treeItem.taxCodes != null)
			pickTaxCode.selectedIndex = findItem(treeItem.taxCodes.name, TaxCodesArray);
		
		if (txtSaleQuantity != null && txtSaleQuantity.enabled)
			txtSaleQuantity.setFocus();
		
		txtSaleQuantity.tabIndex = 1;
		txtSaleUnitPrice.tabIndex = 2;
		txtSaleTotal.tabIndex = 3;
		txtSaleDescription.tabIndex = 4;
		accept_button.tabIndex = 5;
		
		btnSave.tabIndex = -1;
		btPayment.tabIndex = -1;
	}
	
	private function findItem(name:String, array:ArrayCollection):int {
		for each(var element:Object in array) {
			if (name == element.name) {
				return array.getItemIndex(element);
			}
		}
		return -1;
	}
	private function doInvoice():void {
		this.currentState = "invoiceState";
	}
	
	private function doAddJob():void {
		var editJobWindow:EditJob= new EditJob();
		var parentId:int = Snowmass.getInstance().containerManager.getWindowWithChild(this, true).windowID;
		editJobWindow.addEventListener(JobEditCompleteEvent.SAVE, addNewJob);
		Snowmass.getInstance().containerManager.openNewMDIWindow(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'jobCmd.NewJob'),editJobWindow, -1,-1,-1,-1, parentId);
	}
	
	private function doAddCharge():void {
	
	}
	
	private function doCreditCardManualApproval():void {
		var creditCardManualApproveWindow:CreditCardDataEntry = CreditCardDataEntry(PopUpManager.createPopUp(this, CreditCardDataEntry, true));
		creditCardManualApproveWindow.setStyle("borderAlpha", 0.9);
		creditCardManualApproveWindow.addEventListener(CreditCardTransEvent.COMPLETE, handleCreditCardTransWrite);
		creditCardManualApproveWindow.setAmount(payment_cash_edit.text);
		creditCardManualApproveWindow.setTax(activePayment.taxAmount.toString());
	}

	private function addNewJob(event:Event):void
	{
		var target:EditJob=event.target as EditJob;
		
		if (target.job != null) {
			activeSale.quantity = target.job.qtyOrdered;
			activeSale.opPrice = true;
			activeSale.unitPrice = target.job.pricingRecord.unitPrice;
			activeSale.subTotal = target.job.pricingRecord.totalPrice;
			activeSale.department = target.job.description;
			if (activeSale.department.length == 0)
				activeSale.department = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'tapeCmd.QuickEst');

			txtSaleDescription.text = activeSale.department;
			txtSaleQuantity.text = activeSale.quantity.toString();
			txtSaleUnitPrice.text = Snowmass.getCurrencyFormatter(false,2).format(activeSale.unitPrice);
			txtSaleTotal.text = Snowmass.getCurrencyFormatter(false,2).format(activeSale.subTotal);

			doAccept();
		}
	}
	
	private function paymentMethodChanged(event:Event):void {
		var rbvalue:String = event.currentTarget.selectedValue;
	//	activePayment = new CashRegister();
						
		this.currentState = "";
		
		//
		// reverse any external values that could have already been completed, ie.. a Credit Card charge
		//
		doCancelPayment(activePayment);
		
		if (rbvalue == "Cash")
		{	
			activePayment.paymentMethod= "Cash"
			if (treeStateString == "invoiceState")
			{
				this.currentState = "invoiceCash";
			} 
			else 
			{
				this.currentState = "paymentCash";
			}
			btPayment.enabled = true;
			payment_cash_edit.setFocus();
			payment_cash_edit.tabIndex = 1;
			btPayment.tabIndex = 2;
			btnSave.tabIndex = 3;
		}
		if (rbvalue == "Credit Card")
		{
			activePayment.paymentMethod = "Credit Card";
			if (treeStateString == "invoiceState")
			{
				this.currentState = "invoiceCreditCard";
			} 
			else 
			{
				this.currentState = "paymentCreditCard";
			}
			btPayment.enabled = true;
			card_ref.setFocus();
			card_ref.tabIndex = 1;
			payment_cash_edit.tabIndex = 2;
			btPayment.tabIndex = 3;
			btnSave.tabIndex = 4;
		}
		if (rbvalue == "Check")
		{
			activePayment.paymentMethod= "Check"
			if (treeStateString == "invoiceState")
			{
				this.currentState = "invoiceCheck";
			} 
			else 
			{
				this.currentState = "paymentCheck";
			}
			btPayment.enabled = true;
			check_num.setFocus();
			check_num.tabIndex = 1;
			payment_cash_edit.tabIndex = 2;
			btPayment.tabIndex = 3;
			btnSave.tabIndex = 4;
		}
		if (rbvalue == "Charge")
		{
			if (customerAccount == null){
				Alert.show(resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'msg_Youmustselectanaccou'));
				btPayment.enabled = false;
			} else
				btPayment.enabled = true;
			
			activePayment.paymentMethod= "Charge"
			if (treeStateString == "invoiceState")
			{
				this.currentState = "invoiceCharge";
			} 
			else 
			{
				this.currentState = "paymentCharge";
			}
			payment_cash_edit.setFocus();
			payment_cash_edit.tabIndex = 1;
			btPayment.tabIndex = 2;
			btnSave.tabIndex = 3;
		}
		
		accept_button.tabIndex = -1;
		//
		// how much is left to pay
		//
		payment_cash_edit.text = Snowmass.getCurrencyFormatter(false,2).format((sessionBatch.accumTotal - sessionBatch.accumTendered));
		
	//	this.focusManager.setFocus(btPayment);
		this.focusManager.defaultButton = btPayment;
	}
	
	private function paymentStateHandler (e:Event):void {
		if (this.currentState == "departmentState")
		{
			var node:XML = XML(tvItems.selectedItem);
			txtSaleDescription.text = node.@label;
		}
	}

	private function doPayment():void{
		var payOK:Boolean = true;
		var message:String;
		
		if ((this.currentState = "invoiceCash") && (AustrailianRounding == true)) {
			
		} else {
			// ensure that variable content is the same as formatted screen content
			var temp:Number = parseFloat(payment_cash_edit.text.replace(",",""));
			var tempStr:String = Snowmass.getCurrencyFormatter(false,2).format(temp);
			activePayment.total = parseFloat(tempStr);	
			
			sessionBatch.accumTendered = sessionBatch.accumTendered + activePayment.total;
			sessionBatch.accumChange = sessionBatch.accumTendered - sessionBatch.accumTotal; 
			
			if (activePayment.paymentMethod=="Check"){
				activePayment.checkNumber = check_num.text;
				
				if (customerAccount != null) {
					if (customerAccount.type == "cash_only" || customerAccount.type == "full_deposit") {
						message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Onlycashisacceptedas");
						Alert.show(message, "Warning", 0, null, null, null, 4); 
						payOK = false;
					}
				}
			}
			if (activePayment.paymentMethod=="Credit Card"){
				activePayment.creditCard = card_type.selectedItem as PreferencesCreditCard;
				activePayment.refNumber = card_ref.text;
			}
			if (activePayment.paymentMethod=="Charge") {
				activePayment.customerAccount = customerAccount;	
				
				if (customerAccount != null) {
					if (customerAccount.status == "CustomerStatusFrozen") {
						message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_CustomeraccountisFRO");
						Alert.show(message, "Warning", 0, null, null, null, 4); 
						payOK = false;
					} else if (customerAccount.type != "charge_acct") {
						message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Onlycashisacceptedas");
						Alert.show(message, "Warning", 0, null, null, null, 4); 
						payOK = false;
					}
				}
				
				if (payOK) {
					if ((creditLimit > 0 && (creditLimit - activePayment.total)) < 0 || creditLimit < 0) {
						//TODO - some users can override credit limit
						
						message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Chargingthiswouldexc");
						message = StringUtil.substitute(message,numberFormatter.format(creditLimit)); 
						Alert.show(message, "Warning", 0, null, null, null, 4); 
						payOK = false;
					}
					
					if (payOK == true && creditLimit != 0) {
						creditLimit -= activePayment.total;
						if (creditLimit == 0)
							creditLimit = -1;		// so not to be zero
					}
				}
			}
			
			if (payOK == true) {
				sessionBatch.transactionsList.addItem(activePayment);
				InitPaymentRecord();
			}
		}
		this.currentState = "";
		openTree();
		rgPaymentMethod.selection = null;
		btPayment.enabled= false;
		UpdateBatchNumbers();
	}	
	
	private function doAccount():void{
		 var accountPickerWindow:AccountPicker = AccountPicker(PopUpManager.createPopUp(this, AccountPicker, true));
	    accountPickerWindow.setStyle("borderAlpha", 0.9);
	    accountPickerWindow.formIsEmpty = true;
	    accountPickerWindow.prospect_boolean = false;
	    accountPickerWindow.contact_boolean = false;
	    accountPickerWindow.setAccounts(accounts);
	    accountPickerWindow.addEventListener(AccountPickerSelectEvent.CANCELSELECTACCOUNT, handleAccountPickerCancel);
	    accountPickerWindow.addEventListener(AccountPickerSelectEvent.SELECTACCOUNT, handleAccountPickerSelect);
	    	   	    
	}
	private function handleAccountPickerSelect(evt:AccountPickerSelectEvent):void {
		
		dataService.getAccount(evt.account.id);
			
	}
	private function doTotalPrice(item:Object,column:DataGridColumn):String{
		var tempString:String;
		
		if (item is TapePaymentRecord) {
			var tempPayment:TapePaymentRecord;
			tempPayment = item as TapePaymentRecord;
			if (tempPayment != null){
				tempString = numberFormatter.format(tempPayment.total);
			} else
				tempString = "";
		} else if (item is TapeSaleRecord) {
			var tempSale:TapeSaleRecord = item as TapeSaleRecord;
			
			if (tempSale != null){
				tempString = numberFormatter.format(tempSale.total);
			} else
				tempString = "";
		}
		
		return tempString;
		
	}
	private function doSubtotalPrice(item:Object,column:DataGridColumn):String{
		var tempString:String;
		
		if (item is TapePaymentRecord) {
			var tempPayment:TapePaymentRecord;
			tempPayment = item as TapePaymentRecord;
			if (tempPayment != null){
				tempString = numberFormatter.format(tempPayment.subTotal);
			} else
				tempString = "";
		} else if (item is TapeSaleRecord) {
			var tempSale:TapeSaleRecord = item as TapeSaleRecord;
			
			if (tempSale != null){
				tempString = numberFormatter.format(tempSale.subTotal);
			} else
				tempString = "";
		}
		
		return tempString;
	}
	private function doDescript(item:Object, column:DataGridColumn):String{
		var tempString:String;
		
		if (item is TapePaymentRecord) {
			var tempPayment:TapePaymentRecord;
			tempPayment = item as TapePaymentRecord;
			if (tempPayment.paymentMethod != "" && tempPayment.total > 0){
				tempString = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Payment')+" " + tempPayment.paymentMethod;
			} else
				tempString = "";
		} else if (item is TapeSaleRecord) {
			var tempSale:TapeSaleRecord = item as TapeSaleRecord;
			
			if (activeSale.isPickup == false)
				tempString = tempSale.department + " " + tempSale.quantity.toString() + "x"+ tempSale.unitPrice.toString();
			else
				tempString = tempSale.department;
		}
		
		return tempString;
	}
	
	private function doAccept():void{
		
		if (this.currentState != "") {
			if (txtSaleDescription != null)
				activeSale.department = txtSaleDescription.text;
			if (txtSaleQuantity != null)
				activeSale.quantity = parseInt(txtSaleQuantity.text);
			if (txtSaleUnitPrice != null)
				activeSale.unitPrice = parseFloat(txtSaleUnitPrice.text.replace(",",""));
			if (txtSaleTotal != null)	
				activeSale.subTotal = parseFloat(txtSaleTotal.text.replace(",",""));
			
			sessionBatch.accumSubTotal = sessionBatch.accumSubTotal + activeSale.subTotal;
			sessionBatch.accumTotal = sessionBatch.accumTotal + activeSale.total;
			sessionBatch.accumTaxTotal = sessionBatch.accumTaxTotal + activeSale.taxAmount;
			sessionBatch.accumChange = sessionBatch.accumTendered - sessionBatch.accumTotal;
			sessionBatch.transactionsList.addItem(activeSale);			
			
			InitSaleRecord();		// setup for another sale
		}
		
		this.currentState = "";
		openTree();
		UpdateBatchNumbers();
	}
	
	
	private function handleCCTSaveResult(ev:ResultEvent):void{
		// nothing to do, the record has been initilized already
		
		this.throbber.visible = false;
		this.throbber.stop();
	}
	
	private function doCancelPayment(tempPayment:TapePaymentRecord) :void {
		
		//
		// for credit card payments, the sale must be reveresed
		//
		if (activePayment != null && activePayment.paymentMethod == "Credit Card") {
			if (tempPayment.cct != null && tempPayment.cct.transactionType == Constants.CREDIT_CARD_TRANSACTION_TYPE_kTransactionTypePurchase &&
				tempPayment.cct.transactionResults == Constants.CREDIT_CARD_TRANSACTION_RESULTS_kTransactionResultsApproved) {
				
				var temp:CreditCardTransactions = new CreditCardTransactions;
				temp.accountNumber = tempPayment.cct.accountNumber;
				temp.creditCard = tempPayment.cct.creditCard;
				temp.isCurrentTransaction = 1;
				temp.orderNumber = tempPayment.cct.orderNumber;
				temp.orderName = tempPayment.cct.orderName;
				temp.referenceNumber = tempPayment.cct.referenceNumber;
				temp.firstNumberPrefix = tempPayment.cct.firstNumberPrefix;
				temp.tax = tempPayment.cct.tax;
				temp.amount = tempPayment.cct.amount;
				temp.transactionType = Constants.CREDIT_CARD_TRANSACTION_TYPE_kTransactionTypeReversal;
				temp.transactionStatus = Constants.CREDIT_CARD_TRANSACTION_STATUS_kTransactionStatusWaiting;
				if (Snowmass.getInstance().currentUser != null) {
					temp.userName = Snowmass.getInstance().currentUser.name;
				}
				// save data
				// see "handleCCTSaveResult" for next processing step
				//
				dataServiceCCT.addUpdate(temp);
				
				this.throbber.visible = true;
				this.throbber.play();
				
				card_ref.text = "";
			}
		}
	}

	private function doVoid():void{
		var temp :Object;
		var index:int;
		
		temp = new Object();
		temp  = cashReg_grid.selectedItem as Object;
		
		if ( temp != null){
			index= sessionBatch.transactionsList.getItemIndex(temp);
			
			if (temp is TapePaymentRecord) {
				var tempPayment:TapePaymentRecord;
				tempPayment = temp as TapePaymentRecord;				
				sessionBatch.accumTendered = sessionBatch.accumTendered - tempPayment.total;
				sessionBatch.accumChange = sessionBatch.accumTendered - sessionBatch.accumTotal; 
				
				// reverse any external actions that the payment may have performed
				doCancelPayment(tempPayment);
			} else if (temp is TapeSaleRecord) {
				var tempSale:TapeSaleRecord = temp as TapeSaleRecord;
				sessionBatch.accumSubTotal = sessionBatch.accumSubTotal - tempSale.subTotal;
				sessionBatch.accumTotal = sessionBatch.accumTotal - tempSale.total;
				sessionBatch.accumTaxTotal = sessionBatch.accumTaxTotal - tempSale.taxAmount;
				sessionBatch.accumChange = sessionBatch.accumTendered - sessionBatch.accumTotal;
			}
			
			sessionBatch.transactionsList.removeItemAt(index);
			
			UpdateBatchNumbers();
		}
	}
	
	private function handleAccountPickerCancel(evt:AccountPickerSelectEvent):void {
		
		
	}
	private function handleGetResult(ev:ResultEvent):void {
		customerAccount = new Account();
		customerAccount = ev.result as Account;
		
		if (customerAccount.type == "charge_acct") {
			creditLimit = customerAccount.creditLimit;
			
			// any outstanding AR balance can effect available credit
			if (creditLimit != 0) {
				creditLimit -= customerAccount.balance;
			}
		} else {
			creditLimit = 0;
		}
		
		if (customerAccount.taxTable != null)
			pickTaxTable.selectedIndex = findItem(customerAccount.taxTable.name, TaxTableArray);
		if (customerAccount.taxCode != null)
			pickTaxCode.selectedIndex = findItem(customerAccount.taxCode.name, TaxCodesArray);
		
		// TODO - assign default invoice format from account
	}
	
	private function doApplyPayments(isPaidOut:Boolean):Boolean {
		var results:Boolean = true;
		var unApplied:Number = 0;
		var i:int = 0;
		var currentPaymentIndex:int = 0;
		var temp:Object;
		var totalPay:Number = 0;
		var totalCharge:Number = 0;
		var totalTransactionPay:Number = 0;
		var totalApplied:Number = 0;
		var refund:Number = 0;
		var payAmount:Number = 0;
		var diff:Number = 0;
		var tempSale:TapeSaleRecord;
		var tempPayment:TapePaymentRecord = new TapePaymentRecord();
		var paymentList:ArrayCollection = new ArrayCollection();
		var message:String;
		
		totalPay = sessionBatch.accumTendered;
		refund = sessionBatch.accumChange;
		
		if (refund > 0) {		// change amount still due to give back
			totalPay = totalPay - refund;
		}

		//
		// assign position index to each record, so order can be known later
		//
		for(i = 0; i< sessionBatch.transactionsList.length; i++)
		{
			temp  = sessionBatch.transactionsList.getItemAt(i) as Object;
			if (temp is TapePaymentRecord) {
				tempPayment = temp as TapePaymentRecord;
				tempPayment.index = i + 1;
			} else if (temp is TapeSaleRecord) {
				tempSale = temp as TapeSaleRecord;
				tempSale.index = i + 1;
			}
		}


		// make a local list of just the payments
		for(i = 0; i< sessionBatch.transactionsList.length; i++)
		{
			temp  = sessionBatch.transactionsList.getItemAt(i) as Object;
			if (temp is TapePaymentRecord) {
				paymentList.addItem(temp);
			}	
		}
			
		if (totalPay > 0 && paymentList.length > 0) {
			// get the first payment
			tempPayment = paymentList.getItemAt(currentPaymentIndex) as TapePaymentRecord;
			payAmount = tempPayment.total;
			
			//
			// balance out any refund amount that would go back to payee
			//
			if (refund > 0 && tempPayment.paymentMethod != "Charge") {
				if (payAmount >= refund) {
					payAmount -= refund;
					refund = 0;
				} else {
					refund -= payAmount;
					payAmount = 0;
				}
			}
			
			totalApplied += payAmount;
			
			for(i = 0; i < sessionBatch.transactionsList.length && tempPayment != null; i++)
			{
				temp  = sessionBatch.transactionsList.getItemAt(i) as Object;
				
				if (temp is TapePaymentRecord) {
					// ignore while appling to sales
				} else if (temp is TapeSaleRecord) {
					tempSale = temp as TapeSaleRecord;
											
					unApplied = tempSale.total - tempSale.amountPaid;
					
					// is sale a invoice pickup
					// record invoice data into the payment record
					if (tempSale.isPickup == true) {
						tempPayment.invoice = tempSale.invoice;
						tempPayment.postAR = true;
					}
					
					//
					// money still owed on this sale record
					//
					if (unApplied > 0) {
						
						// 
						// any left over charge to account value, whe no payments are left
						//
						if (tempSale.isPickup == true && tempPayment == null && totalCharge > 0.01) {
							totalTransactionPay += unApplied;
							totalCharge -= unApplied;
							unApplied = 0;
						} 
						// 
						// the current pay record can pay off the whole amount due
						//
						else if (unApplied <= payAmount) {
						
							// charge to account
							if (tempPayment.paymentMethod == "Charge") {
								if (tempPayment != null) {
									totalCharge += payAmount;
									payAmount = 0;
								} else {
									totalTransactionPay += unApplied;
									totalCharge -= unApplied;
									unApplied = 0;
								}
							} 
							// cash, check or credit card
							else {
								tempSale.amountPaid += unApplied;
								totalTransactionPay += unApplied;
								payAmount -= unApplied;
								unApplied = 0;
							}
						}
						// 
						// the sale requires more money to pay off than is available from current pay record
						//
						else {
							// charge to account
							if (tempPayment.paymentMethod == "Charge") {
								if (tempPayment != null) {
									totalCharge += payAmount;
									payAmount = 0;
								} else {
									totalTransactionPay += unApplied;
									totalCharge -= unApplied;
									unApplied = 0;
								}
							} 
							// cash, check or credit card
							else {

								tempSale.amountPaid += payAmount;
								totalTransactionPay += payAmount;
								unApplied -= payAmount;
								payAmount = 0;
							}
						}
						
						// assign the payment type to the sale record
						//
						if (tempSale.paymode == "") {
							tempSale.paymode = tempPayment.paymentMethod;
							if (tempPayment.paymentMethod != "Charge") {
								tempSale.checkNumber = tempPayment.checkNumber;
								tempSale.cct = tempPayment.cct;
								tempSale.refNumber = tempPayment.refNumber;		// cct
							}
						}
					}
				}
				
				if (payAmount <= .01) {
					currentPaymentIndex += 1;
					if (currentPaymentIndex < paymentList.length) {
						tempPayment = paymentList.getItemAt(currentPaymentIndex) as TapePaymentRecord;
					} else
						tempPayment = null;
						
					if (tempPayment != null) {
						payAmount = tempPayment.total;
					} else {
						payAmount = 0;
					}
					
					//
					// balance out any refund amount that would go back to payee
					//
					if (refund > 0 && tempPayment.paymentMethod != "Charge") {
						if (payAmount >= refund) {
							payAmount -= refund;
							refund = 0;
						} else {
							refund -= payAmount;
							payAmount = 0;
						}
					}
				
					totalApplied += payAmount;
				}
			}
			
			//
			// all sale records have been processed
			//
			//totalTransactionPay += roundAmount;
			
		} else {
			message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_WARNINGThistransacti");
			Alert.show(message, "Warning", 0, null, null, null, 4); 
			results = false;
		}
		
		// roll back any payments and sales changes from above
		if (results == false) {
			for(i = 0; i< sessionBatch.transactionsList.length; i++)
			{
				temp  = sessionBatch.transactionsList.getItemAt(i) as Object;
				if (temp is TapePaymentRecord) {
					tempPayment = temp as TapePaymentRecord;
					tempPayment.invoice = null;
				} else if (temp is TapeSaleRecord) {
					tempSale = temp as TapeSaleRecord;
					tempSale.amountPaid = 0;
					tempSale.checkNumber = "";
					tempSale.cct = null;
					tempSale.refNumber = "";
				}
			}
		} 
		// continue with posting
		else {
			if (totalTransactionPay != totalApplied) {
				//msg_WARNINGThistransacti=WARNING: This transaction did not balance!r	Total Payments: ${0}r	Total Transactions: ${1}rPlease review the transaction and contact your PrintSmith support center and report it in detail. r	OK to post transaction?
				//
				// un-balanced amount of sales .vs. payments
				//
				if (totalTransactionPay != totalApplied) {
					message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_WARNINGThistransacti");
					message = StringUtil.substitute(message,numberFormatter.format(totalTransactionPay),numberFormatter.format(totalApplied)); 
					Alert.show(message, "Warning", 0, null, null, null, 4); 
					if (Alert.NO)
						results = false;
					else if (isPaidOut == true) {
						// TODO - ask for description
					}
				}
			}
		}

		return(results);
	}
	
	private function calculateTotalChargesInBatch():Number {
		var tempPayment:TapePaymentRecord;
		var temp:Object;
		var results:Number = 0;
		var i:int;
		
		if (sessionBatch != null && sessionBatch.transactionsList != null) {
			for(i = 0; i< sessionBatch.transactionsList.length; i++)
			{
				temp  = sessionBatch.transactionsList.getItemAt(i) as Object;
				if (temp is TapePaymentRecord) {
					tempPayment = temp as TapePaymentRecord;
					if (tempPayment.paymentMethod == "Charge") {
						results += tempPayment.total;
					}
				}	
			}
		}
		return(results);
	}	

	private function calculateTotalCashInBatch():Number {
		var tempPayment:TapePaymentRecord;
		var temp:Object;
		var results:Number = 0;
		var i:int;
		
		if (sessionBatch != null && sessionBatch.transactionsList != null) {
			for(i = 0; i< sessionBatch.transactionsList.length; i++)
			{
				temp  = sessionBatch.transactionsList.getItemAt(i) as Object;
				if (temp is TapePaymentRecord) {
					tempPayment = temp as TapePaymentRecord;
					if (tempPayment.paymentMethod != "Charge") {
						results += tempPayment.total;
					}
				}	
			}
		}
		return(results);
	}	
	
	private function doPostBatch():void{
		var goodBatch:Boolean = true;
		var accountChanged:Boolean = false;
		var temp : Object;
		var tempSale:TapeSaleRecord;
		var tempPayment:TapePaymentRecord;
		var arRecord:AccountHistoryData;
		var isPaidOut:Boolean = false;
		var totalCharges:Number;
		var totalCash:Number;
		var message:String;
		var format:String;
		var printList:ArrayCollection = new ArrayCollection();
		var i:int = 0;
		
		//
		// no left open transactions
		//
		doAccept();
		
		//
		// the cash register is used as a PAID OUT as well, like a cash back method
		// The current user must be allowed this security feature.
		//
		if (sessionBatch.transactionsList.length == 1 && sessionBatch.accumTendered < 0) {
			tempPayment  = sessionBatch.transactionsList.getItemAt(0) as TapePaymentRecord;
			if (tempPayment != null && tempPayment.paymentMethod == "Cash") {
				if (sessionBatch.user != null && sessionBatch.user.noCashReturn == false)
					isPaidOut = true;
			}
		}
					
		totalCharges = calculateTotalChargesInBatch();
		totalCash = calculateTotalCashInBatch();
		
		// more charged than total can cover
		if (totalCharges > sessionBatch.accumTotal) {
			message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Sorrybutyouaretrying");
			Alert.show(message, "Warning", 0, null, null, null, 4); 
			goodBatch = false;
		}
		
		// does not balance - negative change
		if (goodBatch && !isPaidOut && sessionBatch.accumTendered < sessionBatch.accumTotal) {
			message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Thistransactiondoesn");
			Alert.show(message, "Warning", 0, null, null, null, 4); 
			goodBatch = false;
		}
		
		//
		// can the exccess refund be returned as CHECK
		if (goodBatch && totalCash < sessionBatch.accumChange) {	/* excess change */
			if (sessionBatch.user != null && sessionBatch.user.noCashReturn) {	// TODO (*currUser)->noCashChecks
				message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"rUtilText.Sorryyouarenotallowe");
				Alert.show(message, "Warning", 0, null, null, null, 4); 
				goodBatch = false;
			} else {
				//msg_WarningThereis0incas=Warning: There is {0} in cash in this transaction and the amount of change given is {1}.rrThe rest of the change ({2}) will be taken from the cash drawer.rr	Ok to continue?
				format = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_WarningThereis0incas");
				format = StringUtil.substitute(format,numberFormatter.format(totalCash),numberFormatter.format(sessionBatch.accumChange),numberFormatter.format((totalCash - sessionBatch.accumChange))); 
				Alert.show(format, "Warning", 0, null, null, null, 4); 
				if (Alert.NO) {
					goodBatch = false;
				}
			}
		}
		
		// user not allowed to charge this to an account
		if (PSSecurityUtils.getInstance().hasPermission(PSSecurityCommands.POS_POSTCHARGES) == false) {
			message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"rUtilText.Sorryyouarenotallowe");
			Alert.show(message, "Warning", 0, null, null, null, 4); 
			goodBatch = false;
		}

		// make sure the payments balance with the sales
		//
		if (goodBatch && doApplyPayments(isPaidOut) == true) {
			this.throbber.visible = true;
			this.throbber.play();

			//
			// Write transactions out to current tape batch and post any invoices to history.
			// Then perform any printing of receipts or invoice forms
			//
			
			cashDrawer.fund -= sessionBatch.accumChange;
			
			for(i = 0; i< sessionBatch.transactionsList.length; i++)
			{
				temp  = sessionBatch.transactionsList.getItemAt(i) as Object;
				
				if (temp is TapePaymentRecord) {
					tempPayment = temp as TapePaymentRecord;
					
					tempPayment.changeAmount = sessionBatch.accumChange;		// track how much was given back
					
					// post the invoice (payment record to the account history
					//
					if (tempPayment.postAR == true) {
						arRecord = new AccountHistoryData();
						tempSale.accountHistoryData = arRecord;			// record AR history record into tape
						
						arRecord.recordType = Constants.ACCOUNT_HISTORY_TYPE_PAYMENT;
						arRecord.account = sessionBatch.account;
						arRecord.postedDate = new Date();
						
						// TODO - calculate the payment due date
						//arRecord.paymentDueDate = 
						
						arRecord.invoice = tempPayment.invoice;
						arRecord.custPO = tempPayment.invoice.customerPO;
						arRecord.salesRep = tempPayment.invoice.salesRep;
						arRecord.name = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"posRegisterCmd.Payment");
						
						arRecord.finalPay = new TapePaymentRecord();
						arRecord.finalPay.created = new Date();
						arRecord.finalPay.paymentMethod = tempPayment.paymentMethod;
						arRecord.finalPay.cct = tempPayment.cct;
						arRecord.finalPay.refNumber = tempPayment.refNumber;
						arRecord.finalPay.checkNumber = tempPayment.checkNumber;
						arRecord.finalPay.total = -(tempPayment.total);			// show as negative in history
						arRecord.finalPay.taxTable = tempPayment.taxTable;
						arRecord.finalPay.taxCode = tempPayment.taxCode;
						arRecord.finalPay.taxExempt = tempPayment.taxExempt;
						arRecord.refundTotal = tempPayment.changeAmount;
						arRecord.balance = tempPayment.amountBalance;
						// TODO
						//arRecord.storeNumber = 
						
						//dataService.addUpdate(arRecord);
						
						if (sessionBatch.account != null) {
							sessionBatch.account.lastPaymentDate = new Date();
							accountChanged = true;
						}
					}
					
					//
					// put payment in the cash drawer 
					//
					switch(tempPayment.paymentMethod)
					{
						case "Cash":
							cashDrawer.cashTotal += tempPayment.total;
							break;
							
						case "Check":
						case "Draft":	// i.e., check
							cashDrawer.checkCount++;
							cashDrawer.checkTotal += tempPayment.total;
							break;
							
						case "Credit Card":
							cashDrawer.cardCount++;
							cashDrawer.cardTotal += tempPayment.total;
							break;
							
						case "Charge":
							cashDrawer.arBalance += tempPayment.total;
							
							if (sessionBatch.account != null) {
								sessionBatch.account.balance += tempPayment.total;
								accountChanged = true;
							}
							break;
					}

				} else if (temp is TapeSaleRecord) {
					tempSale = temp as TapeSaleRecord;
					
					// invoice pickup
					//
					if (tempSale.isPickup) {
						if (tempSale.invoice != null) {
							tempSale.invoice.pickupDate = new Date();
							tempSale.invoice.offPendingDate = tempSale.invoice.pickupDate;
							tempSale.invoice.onPendingList = false;
							tempSale.invoice.locked = true;
							dataService.addUpdate(tempSale.invoice);
							
							// TODO - costing the invoice is needed
							
							// TODO - Consume stock if needed
							
							// make entry on tape for all deposits
							
							//
							// make entry on tape for invoice pickup and amount due
							//
							arRecord = new AccountHistoryData();
							arRecord.recordType = Constants.ACCOUNT_HISTORY_TYPE_INVPICKUP;
							arRecord.account = sessionBatch.account;
							arRecord.created = new Date();
							arRecord.invoice = tempSale.invoice;
							
							// TODO - need name from account block WHEN cash account,in place of invoice name
							arRecord.name = tempSale.invoice.name;
							
							arRecord.total = tempSale.invoice.amountDue;
							arRecord.subTotalPosted = tempSale.invoice.grandTotal;
							arRecord.balance = tempSale.total - tempSale.amountPaid;
							if (tempSale.paymode != "") {	// some payment applied
								// still has outstanding balance
								if (arRecord.balance > 0) {
									// classic tracks partial pay in static way
									arRecord.partialPay = new TapePaymentRecord();
									arRecord.partialPay.paymentMethod = tempSale.paymode;
									arRecord.partialPay.cct = tempSale.cct;
									arRecord.partialPay.refNumber = tempSale.refNumber;
									arRecord.partialPay.checkNumber = tempSale.checkNumber;
									arRecord.partialPay.total = tempSale.amountPaid;
									arRecord.partialPay.taxTable = tempSale.taxTable;
									arRecord.partialPay.taxCode = tempSale.taxCode;
									arRecord.partialPay.taxExempt = tempSale.taxExempt;
									arRecord.partialPayCnt = 1;
									arRecord.partialPayTotal = tempSale.amountPaid;
								} 
								// all paid for
								else {
									arRecord.finalPaymentDate = new Date();
									arRecord.finalPay = new TapePaymentRecord();
									arRecord.finalPay.paymentMethod = tempSale.paymode;
									arRecord.finalPay.cct = tempSale.cct;
									arRecord.finalPay.refNumber = tempSale.refNumber;
									arRecord.finalPay.checkNumber = tempSale.checkNumber;
									arRecord.finalPay.total = tempSale.amountPaid;
									arRecord.finalPay.taxTable = tempSale.taxTable;
									arRecord.finalPay.taxCode = tempSale.taxCode;
									arRecord.finalPay.taxExempt = tempSale.taxExempt;
									
								}
							} 
							//
							// full deposit, no payment needed
							//
							else if (arRecord.balance == 0) {
								arRecord.finalPaymentDate = new Date();
								arRecord.finalPay = new TapePaymentRecord();
								arRecord.finalPay.paymentMethod = "Deposit";
								arRecord.finalPay.checkNumber = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"depositCmd.Deposit");
							}
							
							tempSale.accountHistoryData = arRecord;			// record AR history record into tape
							//dataService.addUpdate(arRecord);
							
							if (sessionBatch.account != null) {
								var amountForThisPosting:Number = (tempSale.subTotal - tempSale.taxAmount);
								
								if (sessionBatch.account.firstInvoiceDate == null) {
									sessionBatch.account.firstInvoiceDate = new Date();
								}
								sessionBatch.account.ordersMonth += 1;
								sessionBatch.account.ordersYear += 1;
								sessionBatch.account.ordersTotal += 1;
								sessionBatch.account.salesMonth += amountForThisPosting;
								sessionBatch.account.salesYear += amountForThisPosting;
								sessionBatch.account.termsDiscount += amountForThisPosting;
							//	sessionBatch.account.lastPostingDate = new Date();
								accountChanged = true;
							}
						}
					} 
					//
					// are there any merchandise charges that need to be logged
					//
					else {
						if (tempSale.paymode == "Charge") {
							// not compleletly paid for
							if (tempSale.amountPaid == 0 || tempSale.total > tempSale.amountPaid) {
								unPurchase = new UnpurchasedMerchandise();
								unPurchase.account = sessionBatch.account;
								unPurchase.saleRecord = tempSale;
								unPurchase.transactionDate = new Date();
								unPurchase.amountDue = (tempSale.total - tempSale.amountPaid);
								dataServiceUnPurchase.addupdate(unPurchase);
								
								sessionBatch.account.onAccount += unPurchase.amountDue;
								accountChanged = true;
							}
						}
					}
					
					// build print list
					if (chkPrintInvoice.selected == true) {
						printList.addItem(tempPayment.invoice);
					}
				}
			}
			
			//
			// appead this session to the current batch session list
			//
			tapeBatch.sessionBatches.addItem(sessionBatch);
			
			//
			// write out the Tape Batch and all of its sub records, session, sales, payments, account history 
			//
			//dataServiceTape.addUpdate(tape);
		
			dataServiceTapeBatch.addUpdate(tapeBatch);
			
			// some changed in the account record
			if (accountChanged == true) {
				dataService.addUpdate(sessionBatch.account);
			}
			
			//
			// save the cash drawer, when complete the register will be reset back to inital state
			// see "handleSaveCashDrawerResult"
			//
			dataServiceCashDrawer.addUpdate(cashDrawer);
			
			//
			// print the invoices that have been pick-up WHILE the print option was turn ON
			//
			if (printList != null && printList.length > 0) {
				var reportName:String = cboFormat.selectedItem as String;
				
				for(i = 0; i< printList.length; i++) {
					invoice = printList.getItemAt(i) as InvoiceBase;
					if (invoice != null) {
						var urlRequest:URLRequest = new URLRequest("http://localhost:8080/Snowmass/reportservlet?invoiceName="+reportName +"&reportParameter="+invoice.id);
               		 	navigateToURL(urlRequest, "_blank");
     				}
  				 }
			}
			
			printList.removeAll();
		}
	}
	
	private function doRevert():void{
		InitSessionBatch();
		
		doCancelPayment(activePayment);		// in case a credit card transaction needs to be reveresed
		InitSaleRecord();		// setup for another sale
		
		invoice = null;
		customerAccount = null;
		this.currentState = "";
		openTree();
		UpdateBatchNumbers();		
	}
	
	private function dotreelabel(item:Object):String{
		var tmpItem:PreferencesCashRegister ;
		tmpItem = item as PreferencesCashRegister;
		
		if (tmpItem != null && tmpItem.title != null && tmpItem.title != "") {
			return tmpItem.displayId.toString() + " " + tmpItem.title;
		} else {
			return "";
		}
	} 
	private function doTransactionGrid():void{
		button1.enabled = true;
	} 
	
	//
	// call back function when the user changes the value in the total price field
	// 
	private function doChangeTotalPrice():void
	{				
		// current value is EMPTY string, remove override
		if (txtSaleTotal.text == "")
			activeSale.opPrice = false;
		else {
			// price override format as currency
			var temp:Number = parseFloat(txtSaleTotal.text.replace(",",""))
			var tempStr:String = Snowmass.getCurrencyFormatter(false,2).format(temp);
			
			// data is different than calculated version
			if (tempStr != txtSaleTotal.text) {
				activeSale.opPrice = true;
			} else {
				activeSale.total = temp;
			}
			txtSaleTotal.text = tempStr;
		}
		
		// update the field font state to match
		setOverrideForField(txtSaleTotal, activeSale.opPrice);
		
		UpdateCashRegister();
	}
	
	private function doGetInvoice():void {	
		this.throbber.visible = true;
		this.throbber.play();
	
		dataService.getInvoiceByInvoiceNumber(txtInvoiceNumber.text,"I");
	}
	
	private function handleLoadCurrentTapeBatch(evt:ResultEvent):void {		
		tapeBatch = evt.result as TapeBatch;
		
		if (tapeBatch.sessionBatches == null) {
			tapeBatch.sessionBatches = new ArrayCollection();
		}
	}
	
	private function handlePickupInvoice(invoiceTmp:InvoiceBase):void {
		var message:String;   

		if (invoiceTmp != null) {
			var goodPickup:Boolean = true;
			
			invoice = invoiceTmp;
			
			if (invoice.pickupDate != null && invoice.pickupDate.getDate() != 0) {
				message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_ErrorduringpickupAni");
				Alert.show(message, "Warning", 0, null, null, null, 4); 
				goodPickup = false;
			}
			
			if (invoice.amountDue < 0) {
				message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Sorrybutthisinvoiceh");
				Alert.show(message, "Warning", 0, null, null, null, 4); 
				goodPickup = false;
			}
			
			if (invoice.account == null || invoice.account.accountId == "") {
				message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Cantpickupaninvoiceu");
				Alert.show(message, "Warning", 0, null, null, null, 4); 
				goodPickup = false;
			}
			
			// TODO: test for delayed payment from PSS
			
			//
			// attempting to pickup invoice from a different account
			//
			if (goodPickup && customerAccount != null) {
				if (invoice.account != null && customerAccount.id != invoice.account.id) {
					message = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"msg_Transactionalreadyin");
					Alert.show(message, "Warning", 0, null, null, null, 4); 
					goodPickup = false;
				}
			}
			
			if (goodPickup) {
				customerAccount = invoice.account;			// active account for charging
				activeSale.isPickup = true;
				activeSale.taxTable = invoice.taxTable
			//	activeSale.taxCode = invoice.
				activeSale.subTotal = invoice.subTotal;
				activeSale.total = invoice.amountDue;
				activeSale.taxAmount = invoice.tax;
				activeSale.department = invoice.name;
				
				if (activeSale.department.length == 0)
					activeSale.department = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'posPendCmd.PickUp');
				
				activeSale.noTax = invoice.notTaxable;
				
				if (invoice.taxTable != null) {
					pickTaxTable.selectedIndex = findItem(invoice.taxTable.name, TaxTableArray);
					pickTaxCode.selectedIndex = findItem(invoice.taxCode.name, TaxCodesArray)
				}
				
				txtSaleDescription.text = activeSale.department;
				txtSaleQuantity.text = activeSale.quantity.toString();
				txtSaleUnitPrice.text = Snowmass.getCurrencyFormatter(false,2).format(activeSale.unitPrice);
				txtSaleTotal.text = Snowmass.getCurrencyFormatter(false,2).format(activeSale.subTotal);


				// TODO: capture invoice ID, Invoice Number, Previous deposits
				
			}			
		}
	}
	

	private function handleLoadInvoice(evt:ResultEvent):void {
		var invoiceTmp:InvoiceBase = evt.result as InvoiceBase;
		    
		handlePickupInvoice(invoiceTmp);
		
		this.throbber.visible = false;
		this.throbber.stop();
	}
	
	private function doDescriptionActivate():void {
		txtSaleDescription.setFocus();
		txtSaleDescription.setSelection(0, txtSaleDescription.length);
	}
]]>
                             
</mx:Script>

	

	<mx:Label x="0" y="64" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.DEPARTMENT')}" width="130" textAlign="center"/>	
	<mx:Tree x="0" y="80" width="130"  
		id="tvItems" 
		dataProvider="{systemCashPreferencesArray}"
		labelFunction="dotreelabel" height="100%" change="treeSelect(event);"></mx:Tree>
	
	<comp:Throbber id="throbber" height="40" width="40" visible="true" horizontalCenter="0" verticalCenter="0"/>

	<mx:Button x="150" y="10" width="38" height="38" click="doPostBatch();" enabled="{enableSave}" id="btnSave">
		<mx:icon>@Embed(source='../../../../assets/file.png')</mx:icon>
	</mx:Button>
	<mx:Button x="214" y="10" width="38" height="38" click="doRevert();" enabled="{enableSave}" id="btnRevert">
		<mx:icon>@Embed(source='../../../../assets/cancel.png')</mx:icon>
	</mx:Button>
	<mx:Button x="280" y="10" width="38" height="38" click="doInvoice();" enabled="{enableSave}" id="btnInvoice">
		<mx:icon>@Embed(source='../../../../assets/InvoiceWONotes.png')</mx:icon>
	</mx:Button>
	<mx:Button x="345" y="10" width="38" height="38" click="doAddJob();" enabled="{enableSave}" id="btnAddJob">
		<mx:icon>@Embed(source='../../../../assets/new_job.png')</mx:icon>
	</mx:Button>
	<mx:Button x="413" y="10" width="38" height="38" click="doAddCharge();" enabled="{enableSave}" id="btnAddCharge">
		<mx:icon>@Embed(source='../../../../assets/new_job.png')</mx:icon>
	</mx:Button>

	<mx:Canvas x="130" y="80" width="100%" height="100%" id="cashregister_canvas" hideEffect="effect" showEffect="effect">
		<mx:Button x="10" y="10" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CustAcct')}" id="btnCustAcct" click="doAccount();"/>
		<mx:TextInput x="161" y="6" text="{customerAccount.title}" width="304" fontSize="9" fontWeight="bold" height="20"/>
		<mx:TextInput x="161" y="25" text="{customerAccount.type}" width="304" fontSize="9" fontWeight="normal" height="20"/>
		<mx:TextInput x="468" y="25" text="{customerAccount.status}" width="58" fontSize="9" fontWeight="normal" height="20"/>
		<mx:Canvas x="0" y="50" width="200" height="95" id="tax_canvas" borderStyle="inset">
			<mx:Label x="5" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.TaxTable')}" width="64" textAlign="right"/>
			<mx:Label x="5" y="35" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.TaxCode')}" width="64" textAlign="right"/>

		    <mx:ComboBox x="77" y="8" change="UpdateCashRegister()" id="pickTaxTable" width="100" dataProvider="{TaxTableArray}" labelField="name" selectedItem="{data.name}"/>
		    <mx:ComboBox x="77" y="33" change="UpdateCashRegister()" id="pickTaxCode" width="100" dataProvider="{TaxCodesArray}" labelField="name" selectedItem="{data.name}"/>
		    <mx:CheckBox x="77" y="63" label="Non-Tax" id="chkNonTax" />
		</mx:Canvas>
		<mx:Canvas x="198" y="50" width="210" height="95" id="tax_canvas0" hideEffect="effect" showEffect="effect" borderStyle="inset">
			<mx:Label x="0" y="12" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'labelCmd.Format')}" width="59" textAlign="right"/>
			<mx:ComboBox x="67" y="10" id="cboFormat"  dataProvider="{FormatArray}" labelField="name" width="128"/>
			<mx:CheckBox x="10" y="35" id="chkPrintInvoice" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.PrintInvoice')}"/>
				
		</mx:Canvas>
		<mx:Canvas x="0" y="143" width="408" height="278" id="tax_canvas1" hideEffect="effect" showEffect="effect" borderStyle="inset">
			<mx:Button x="10" y="200" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Accept')}" click="doAccept();" width="176" enabled="false" id="accept_button"/>
			<mx:CheckBox x="10" y="243" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.PrintReceipt')}" id="checkbox1"/>
			<mx:TextArea x="396" y="266" width="4.799999" height="4.8" focusIn="doDescriptionActivate()" id="txtSaleDescription" tabIndex="4" enabled="true"/>
		</mx:Canvas>
		<mx:Canvas x="407" y="50" width="261" height="215" id="tax_canvas2" hideEffect="effect" showEffect="effect" borderStyle="inset">
			<mx:Label x="50" y="10" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.PAYMENTMETHOD')}"/>
			<mx:Button x="10" y="180" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Payment')}" width="186" id="btPayment" click="doPayment();" enabled="false"/>
			<mx:RadioButtonGroup id="rgPaymentMethod" change="paymentMethodChanged(event)"/>
			<mx:RadioButton x="10" y="34" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CASH')}" id="rbCash" groupName="rgPaymentMethod" value="Cash"/>
			<mx:RadioButton x="10" y="60" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CRCARD')}" id="rbCreditCard" groupName="rgPaymentMethod" value="Credit Card"/>
			<mx:RadioButton x="131" y="34" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CHECK')}" id="rbCheck" groupName="rgPaymentMethod" value="Check"/>
			<mx:RadioButton x="131" y="60" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.CHARGE')}" id="rbCharge" groupName="rgPaymentMethod" value="Charge"/>

		</mx:Canvas>
		<mx:Canvas x="407" y="264" width="261" height="157" id="tax_canvas3" hideEffect="effect" showEffect="effect" borderStyle="inset">
			<mx:Label x="45" y="22" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.SubTotal')}" id="label9" width="92" textAlign="right"/>
			<mx:Label x="46" y="48" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Tax')}" id="label8" width="91" textAlign="right"/>
			<mx:Label x="45" y="74" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Total')}" id="label7" width="92" textAlign="right"/>
			<mx:Label x="45" y="100" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Tendered')}" id="label5" width="92" textAlign="right"/>
			<mx:Label x="44" y="126" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Change')}" id="label6" width="93" textAlign="right"/>
			<mx:Text id="subtotal_edit" x="145" y="22" width="86"  textAlign="right"/>
			<mx:Text id="tax_edit" x="145" y="48" width="86" textAlign="right"/>
			<mx:Text id="total_edit" x="145" y="74" width="86" textAlign="right"/>
			<mx:Text id="tender_edit" x="145" y="100" width="86" textAlign="right"/>
			<mx:Text id="change_edit" x="145" y="126" width="86" textAlign="right"/>

		</mx:Canvas>
		<mx:DataGrid x="0" y="420" width="666" id="cashReg_grid" dataProvider="{sessionBatch.transactionsList}" height="119" itemClick="doTransactionGrid();">
			<mx:columns>
				<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rChargeLabel.Description')}" labelFunction="doDescript"/>
				<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invTotalCmd.Subtotal')}" labelFunction="doSubtotalPrice"/>
				<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invTotalCmd.Total')}"  labelFunction="doTotalPrice" />
			</mx:columns>
		</mx:DataGrid>
		<mx:Button x="10" y="558" click="doVoid();" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'tapeCmd.VoidTransaction')}" width="154"  enabled="false" id="button1"/>
		
	</mx:Canvas>
	<mx:Label x="110" y="54" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Post')}" width="114" textAlign="center"/>
	<mx:Label x="175" y="54" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'listerCmd.Cancel')}" width="115" textAlign="center"/>
	<mx:Label x="242" y="54" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'barcodeCmd.Invoice')}" width="119" textAlign="center"/>
	<mx:Label x="300" y="54" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'jobCmd.NewJob')}"  width="130" textAlign="center"/>
	<mx:Label x="369" y="54" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'posRegisterCmd.Addcharges')}"  width="130" textAlign="center"/>
</mx:TitleWindow>
