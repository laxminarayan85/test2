<?xml version="1.0" encoding="utf-8"?>
<mx:Panel xmlns:mx="http://www.adobe.com/2006/mxml"
		  xmlns:view="com.efi.printsmith.view.*"
		  xmlns:ns1="com.efi.printsmith.components.*"
		  xmlns:ns2="com.efi.printsmith.common.components.*"
		  xmlns:common="com.efi.printsmith.common.components.*"
		  xmlns:vo="com.efi.printsmith.vo.*"
		  xmlns:fc="http://www.adobe.com/2006/fc"
		  xmlns:hc="com.hillelcoren.components.*"
		  xmlns:viewStackEffects="org.efflex.mx.viewStackEffects.*"
		  width="100%"
		  height="100%"
		  headerHeight="0"
		  title="Edit Invoice" 
		  implements="com.efi.printsmith.security.ISecureComponent" preinitialize="preInit();"
		  name="Invoice Editor"
		  fontSize="9" xmlns:components="com.efi.printsmith.common.components.*">
	
	<mx:RemoteObject id="estimatorService"
						destination="estimatorService">
		<mx:method name="createInvoiceFromEstimate"
					fault="handleFault(event)"
					result="handleCreateInvoiceResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataService"
					 destination="dataService" showBusyCursor="true">
		<mx:method name="getAll"
				   fault="handleFault(event)"
				   result="handleLoadResult(event)"/>
		<mx:method name="getSingle"
				   fault="handleFault(event)"
				   result="handleLoadSingleResult(event)"/>
		<mx:method name="deleteItem"
				   fault="handleFault(event)"
				   result="handleDeleteResult(event)"/>
		<mx:method name="getInvoice"
				   fault="handleFault(event)"
				   result="handleGetInvoiceResult(event)"/>
		<mx:method name="getById"
					fault="handleFault(event)"
					result="handleLoadJobForEdit(event)"/>
		<mx:method name="getJob"
					fault="handleFault(event)"
					result="handleLoadJobForEdit(event)"/>
		<mx:method name="getInvoice"
					fault="handleFault(event)"
					result="handleLoadInvoice(event)"/>
		<mx:method name="saveInvoice"
				   fault="handleFault(event)"
				   result="handleSaveResult(event)"/>
		<mx:method name="getDeliveryTicketJobsByInvoice"
				   fault="handleFault(event)"
				   result="handleLoadDeliveryTicketJobsResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="invoiceService"
					 destination="invoiceService" showBusyCursor="true">
		<mx:method name="saveInvoice"
				   fault="handleFault(event)"
				   result="handleSaveResult(event)"/>
		<mx:method name="convertToInvoice"
					fault="handleFault(event)"
					result="handleConvertInvoiceResult(event)"/>
		<mx:method name="copyToNewInvoice"
					fault="handleFault(event)"
					result="handleCopyToNewInvoiceResult(event)"/>
		<mx:method name="copyToNewEstimate"
					fault="handleFault(event)"
					result="handleCopyToNewEstimateResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="salesRepDataService"
					 destination="dataService">
		<mx:method name="getAll"
				   fault="handleFault(event)"
				   result="handleLoadSalesReps(event)"/>
	</mx:RemoteObject>

	<mx:RemoteObject id="shippingMethodDataService"
					 destination="dataService">
		<mx:method name="getAll"
				   fault="handleFault(event)"
				   result="handleLoadShippingMethods(event)"/>
	</mx:RemoteObject>
	
	
	<mx:RemoteObject id="accountDataService"
					 destination="dataService">
		<mx:method name="getContactsByAccountId"
				   fault="handleFault(event)"
				   result="handleLoadContacts(event)"/>
		<mx:method name="getAccountPicker"
				   fault="handleFault(event)"
				   result="handleLoadAccountsResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="invoiceRepositoryService" destination="invoiceRepositoryService">
		<mx:method name="getItemList"
					fault="handleFault(event)"
					result="handleLoadInvoiceTemplates(event)"/>		
	</mx:RemoteObject>
	
	<mx:RemoteObject id="contactDataService" destination="dataService" showBusyCursor="true">
		<mx:method name="addUpdate" fault="handleFault(event)" result="saveContactResult(event)" />
	</mx:RemoteObject>
	
	<mx:RemoteObject id="dataServiceEstimate" destination="dataService" showBusyCursor="true">
		<mx:method name="getInvoice"
					fault="handleFault(event)"
					result="handleEstimateLoadResult(event)"/>
		<mx:method name="saveInvoice"
					fault="handleFault(event)"
					result="handleEstimateSaveResult(event)"/>
	</mx:RemoteObject>
	
	<mx:Script source="../common/scripts/CommonUtils.as"/>
	<mx:Script source="../security/PSSecurityInclude.as" />

	<mx:Script>
		<![CDATA[
			import com.efi.printsmith.events.DeliveryTicketUpdateEvent;
			import com.efi.printsmith.data.DeliveryTicketJobs;
			import mx.formatters.DateFormatter;
			import mx.rpc.mxml.Concurrency;
			import com.efi.printsmith.data.ComLink;
			import com.efi.printsmith.components.ContactInfoPopup;
			import com.efi.printsmith.events.SaveContactEvent;
			import flexlib.controls.Fire;
			import mx.controls.RadioButtonGroup;
			import com.efi.printsmith.common.components.ToolbarButton;
			import com.efi.printsmith.data.ModelBase;
			import com.efi.printsmith.security.PSSecurityUtils;
			import com.efi.printsmith.security.PSSecurity;
			import com.efi.printsmith.security.PSSecurityCommands;
			import mx.events.FlexEvent;
			import com.efi.printsmith.events.ChargeDefinitionSelectEvent;
			import com.efi.printsmith.events.CopyToNewEstimateEvent;
			import com.efi.printsmith.events.PendingListUpdateEvent;
			import com.efi.printsmith.events.CopyToNewInvoiceEvent;
			import com.efi.printsmith.events.ConvertToInvoiceEvent;
			import flash.utils.setTimeout;
			import mx.utils.ObjectUtil;
			import flash.net.registerClassAlias;
			import com.efi.mdi.view.window.MDIWindow;
			import mx.utils.StringUtil;
			import mx.controls.RadioButton;
			import com.efi.printsmith.common.components.CommonLoadComponent;
			import com.efi.printsmith.data.JobBase;
			import com.efi.printsmith.events.TrackerStatusUpdateEvent;
			import com.efi.printsmith.pages.TrackerStatusView;
			import com.efi.printsmith.data.NotePad;
			import mx.events.ResourceEvent;
			import mx.controls.dataGridClasses.DataGridColumn;
			import com.efi.printsmith.data.Estimate;
			import com.efi.printsmith.data.InvoiceBase;
			import mx.events.CloseEvent;
			import com.efi.printsmith.events.JobEditCompleteEvent;
			import com.efi.printsmith.events.AccountPickerSelectEvent;

			import com.efi.printsmith.events.commandEvents.Invoice.*;
	
			import com.efi.printsmith.data.HoldState;
			import com.efi.printsmith.data.Invoice;
			import com.efi.printsmith.data.Marketing;
			import com.efi.printsmith.data.BusinessType;
			import com.efi.printsmith.data.SalesRep;
			import com.efi.printsmith.data.Contact;
			import com.efi.printsmith.data.Address;
			import com.efi.printsmith.data.CustomerLog;
			import com.efi.printsmith.data.Charge;
			import com.efi.printsmith.data.City;
			import com.efi.printsmith.data.Country;
			import com.efi.printsmith.data.State;
			import com.efi.printsmith.data.Zip;
			import com.efi.printsmith.data.ShippingMethod;
			import com.efi.printsmith.data.TaxTable;
			import com.efi.printsmith.data.TaxCodes;
			import com.efi.printsmith.data.SpecialInstructions;
			import com.efi.printsmith.data.Job;
			import com.efi.printsmith.data.Users;
			import com.efi.printsmith.data.PreferencesEstimating;
			
			import flash.geom.Matrix;
			import com.efi.printsmith.data.Account;
			import mx.controls.Alert;
			import mx.rpc.Responder;
			import mx.managers.PopUpManager;
			import mx.containers.TitleWindow;
			import mx.collections.ArrayCollection;
			import mx.rpc.events.ResultEvent;
			import mx.rpc.events.FaultEvent;
			import mx.messaging.messages.AsyncMessage;
			import mx.messaging.messages.IMessage;
			import mx.printing.FlexPrintJob;
			import mx.printing.PrintAdvancedDataGrid;
			import mx.printing.PrintDataGrid;
			import mx.core.Application;
			import mx.validators.Validator;
			import mx.events.ValidationResultEvent;
			import mx.effects.easing.Back;
			
			public static var EDITINVOICE:String = "{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Invoice')}";
			public static var EDITESTIMATE:String = "{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Estimate')}";
			
			private var accounts:ArrayCollection=new ArrayCollection();
		    
		    [Embed("../../../../assets/file.png")] 
		    private var saveIcon: Class; 

		    [Embed("../../../../assets/notePadNoNotes.png")] 
		    private var notepadIcon: Class; 

		    [Embed("../../../../assets/new_job.png")] 
		    private var newJobIcon: Class; 

		    [Embed("../../../../assets/delete.png")] 
		    private var cancelIcon: Class; 

		    [Embed("../../../../assets/tickets.png")] 
		    private var ticketIcon: Class; 

		    [Embed("../../../../assets/print.png")] 
		    private var printIcon: Class; 

		    [Embed("../../../../assets/preview.png")] 
		    private var previewIcon: Class; 
    
    	    [Embed("../../../../assets/invoiceCosting.png")] 
		    private var invoiceCostingIcon: Class; 
      
    	    [Embed("../../../../assets/change_account.png")] 
		    private var accountIcon: Class; 

			[Bindable]
			public var invoice:InvoiceBase = null;
			[Bindable]
			private var loginUser:Users;
			[Bindable]
			private var salesReps:ArrayCollection=new ArrayCollection();
			[Bindable]
			private var accountcontacts:ArrayCollection=new ArrayCollection();
			
		    [Bindable] private var loadComponent:CommonLoadComponent;

			[Bindable]
			private var shippingMethods:ArrayCollection=new ArrayCollection();

			[Bindable]
			private var invoiceTemplates:ArrayCollection=new ArrayCollection();
			
			private var editorType:String = EDITINVOICE;
			
			private var isEstimate:Boolean = false;
			
			[Bindable] private var multiQtyJobPresent:Boolean = false;
			
			private var selectedJobIndex:int=0;
			
			private var radioButtonGroupList:ArrayCollection = new ArrayCollection();
			
			private var resetJobsList:Boolean = true;
			
			public var convertedEstimatedId:int=0;
			
			private var preferencesEstimating:PreferencesEstimating;
			
			private var onPendingList:Boolean= false;
			private var newContact:Boolean = false;
			private var tempContactId:Number = -1;
			
			[Bindable] private var deliveryTicketJobsList:ArrayCollection = new ArrayCollection();
						
			public function getSecurityCommand():String {
				if ((invoice != null) && (invoice is Estimate))
					return PSSecurityCommands.INVOICE_CREATEESTIMATE;
				else 
					return PSSecurityCommands.INVOICE_CREATEINVOICE;
			}
		
		
			public function init(event:FlexEvent = null):void
			{
				// create toolbar buttons
				createToolbarButtons();
				
				this.bill_to_address_editor.setLabel(resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custCmd.InvoiceAddress'));
				loginUser = new Users();
				loginUser = Snowmass.getInstance().currentUser;
				inv_sales_rep.enabled = !(loginUser.lockSalesRep);
				//vbox.getDividerAt(0).visible=false;
				//vbox.getDividerAt(1).visible=false;
				
				if (invoice == null) {
					invoice=new Invoice();
					invoice.takenBy=Snowmass.getInstance().currentUser.name;
					invoice.onPendingList = true;
					doAccountPicker();
					if (editorType == EDITESTIMATE){
						inv_number.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invoiceRpt.NewEstimates');
						invoice_number_edit.label= resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.Estimate');
					} else {
						inv_number.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invoiceRpt.NewInvoices');
						invoice_number_edit.label = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.Invoice');
					}
					
					
				} else {
					onPendingList = invoice.onPendingList;
	
					if (invoice is Estimate)
						editorType= EDITESTIMATE
					
					if (editorType == EDITESTIMATE) {
						this.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Estimate');
				//		this.name = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Estimate');
						this.label = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Estimate');
						invoice_number_edit.label= resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.Estimate');
						
					} else {
						this.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Invoice');
				//		this.name = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Invoice');
						this.label = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Invoice');
						invoice_number_edit.label = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.Invoice');
					}
					
					if (invoice.id > 0) {
						dataService.getInvoice(invoice.id);
						dataService.getDeliveryTicketJobsByInvoice(invoice.id);
						if (editorType == EDITESTIMATE) {
							this.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.Estimate')+": "+invoice.invoiceNumber;
						} else {
							this.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.Invoice')+": "+invoice.invoiceNumber;
						}
					} else {
						if (editorType == EDITESTIMATE) {
							this.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.Estimate')+": "+resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.new');
						} else {
							this.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.Invoice')+": "+resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.new');
						}
						if(invoice.account==null){
							loadComponent = PopUpManager.createPopUp(this,CommonLoadComponent,true) as CommonLoadComponent;
							accountDataService.getAccountPicker();
						}
						//doAccountPicker();
					}
					if (invoice.account != null)
						this.setAccount(invoice.account);
					var mdiWin:MDIWindow = Snowmass.getInstance().containerManager.getWindowWithChild(this,true);
  					mdiWin.title = this.title;
  					
  					if (invoice.notes != null && invoice.notes.showOnOpen) {
  						doNotepad();
  					}
				}
				
				
				if (invoice.jobs == null) {
					invoice.jobs=new ArrayCollection();
				}
				
				if (invoice.charges == null) {
					invoice.charges=new ArrayCollection();
				}
				if(!invoice.onPendingList){
					Alert.show(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'msg_Thisdocumentislocked'));
				}
				
				if (invoice.contact != null && invoice.contact.tempFlag)
					tempContactId = invoice.contact.id;
					
				this.createInvoice.visible = false;		
				salesRepDataService.getAll("SalesRep");
				shippingMethodDataService.getAll("ShippingMethod");
				dataService.getSingle("PreferencesEstimating");
				invoiceRepositoryService.getItemList();
				var eventJobs:InvoiceJobsEvent = new InvoiceJobsEvent(toolbar.getButton("new_job_button0"),new mx.rpc.Responder(handleUIButtonEvent, handleUIButtonFault));
				eventJobs.dispatch();
				var eventCharges:InvoiceChargesEvent = new InvoiceChargesEvent(toolbar.getButton("new_job_button"),new mx.rpc.Responder(handleUIButtonEvent, handleUIButtonFault));
				eventCharges.dispatch();
				
				
				job_costing_stack.selectedChild = account_info_canvas;
				bottomrightstack.selectedChild = blankarea;
				
				contact_editor.addEventListener("SaveContactEvent", saveContactHandler, false, 1);
				contact_editor.addEventListener(CloseEvent.CLOSE, onContactEditorClose,false,1);
				
			}
			
			private function onContactEditorClose(evt:CloseEvent):void	{
				if (newContact)
					newContact = false;
			}
			private function saveContactHandler(evt:SaveContactEvent):void	{
				var c:Contact = null;
				
				if (evt.contact.id != NaN)	{
					var c:Contact = null;
					
					if (newContact)	{
						newContact = false;
						c = new Contact();
					}
					else	{
						var tempCon:Contact = findFirstItemByCondition(contact_list.dataProvider as ArrayCollection, "tempFlag", true) as Contact;
						if (tempCon != null)	{
							c = tempCon;
						}
						else	{
							c = new Contact();
							c.tempFlag = true;
						}
						
					}
					c.firstName = evt.contact.firstName;
					c.lastName = evt.contact.lastName;
					c.prefix = evt.contact.prefix;
					c.suffix = evt.contact.suffix;
					c.comLinks = new ArrayCollection();
					for (var i:int=0; i<evt.contact.comLinks.length;i++)	{
						var coml:ComLink = evt.contact.comLinks.getItemAt(i) as ComLink;
						var newcoml:ComLink = new ComLink();
						newcoml.type = coml.type;
						newcoml.value = coml.value;
						c.comLinks.addItem(newcoml);
					}
					c.jobTitle = evt.contact.jobTitle;
					c.salutation = evt.contact.salutation;
					c.parentAccount = invoice.account;
								
				}
				else	{
					c = evt.contact;
				}
				contactDataService.addUpdate(c);
			}
			
			private function findFirstItemByCondition(ac:ArrayCollection, propName:String, propValue:Object):Object	{
				for (var i:int=0; i<ac.length; i++)	{
					var obj:Object = ac.getItemAt(i);
					if (obj[propName] == propValue)	{
						return obj;
					}
				}
				return null;
			}
			
			private function saveContactResult(evt:ResultEvent):void	{
				//var  tempContact:Contact = evt.result as Contact;
				
				var obj:Object = findFirstItemByCondition(contact_list.dataProvider as ArrayCollection, "id", (evt.result as Contact).id);
				if (obj == null)	{
					(contact_list.dataProvider as ArrayCollection).addItem(evt.result);
					contact_list.selectedItem = evt.result;
				}
				else	
					contact_list.selectedItem = obj;				
				
				if ((contact_list.selectedItem as Contact).tempFlag)
					tempContactId = (contact_list.selectedItem as Contact).id;
			}
			
			private function createToolbarButtons():void	{
				var ac:ArrayCollection = new ArrayCollection();
				
				var tb:ToolbarButton = new ToolbarButton(
									"file_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Save'),
									saveIcon, doSave);
				tb.enabled = invoice.onPendingList;
				
				ac.addItem(tb);
				
				tb = new ToolbarButton(
									"cancel_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Cancel'),
									cancelIcon,doCancel);
				ac.addItem(tb);
				
				tb = new ToolbarButton(
									"note_pad_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rStandardMenuText.NotePad'),
									notepadIcon,doNotepad);
				ac.addItem(tb); 
				
				tb = new ToolbarButton(
									"new_job_button0", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'jobCmd.NewJob'),
									newJobIcon,doNewJob);
				ac.addItem(tb); 
				
				tb = new ToolbarButton(
									"new_job_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'changePriceCmd.NewCharges'),
									newJobIcon,doNewCharge);
				ac.addItem(tb); 
				
				tb = new ToolbarButton(
									"change_account_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rStandardMenuText.AccountInfo'),
									accountIcon,doChangeAcct);
				ac.addItem(tb); 
				
				tb = new ToolbarButton(
									"tickets_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Tickets'),
									ticketIcon,doTickets);
				ac.addItem(tb); 
				
				tb = new ToolbarButton(
									"print_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Print'),
									printIcon,doPrint);
				ac.addItem(tb); 
				
				tb = new ToolbarButton(
									"preview_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Preview'),
									previewIcon,null);
				ac.addItem(tb); 
				
				tb = new ToolbarButton(
									"costing_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Costing'),
									invoiceCostingIcon,showCosting);
				
				ac.addItem(tb); 
				
				tb = new ToolbarButton(
									"jobs_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rStandardMenuText.Jobs'),
									invoiceCostingIcon,showJobs);
				ac.addItem(tb); 
				
				toolbar.buttons  = ac;
			}		
			public function openTrackerStatus():void {
				if(invoice!=null && !isNaN(invoice.id) && invoice.id!=0){
					var trackerStatusView:TrackerStatusView = PopUpManager.createPopUp(this,TrackerStatusView,true) as TrackerStatusView;
					trackerStatusView.releasedToProduction = invoice.releasedToProduction;
					trackerStatusView.invoiceId = invoice.id;
					trackerStatusView.addEventListener(TrackerStatusUpdateEvent.CLOSE_EVENT,function(event:TrackerStatusUpdateEvent):void {
						if(invoice!=null){
							if(invoice.jobs!=null && invoice.jobs.length>0){
								for each(var jobBaseObj:JobBase in invoice.jobs){
									jobBaseObj.releasedToProduction = event.releasedToProduction;
								}
							}
							invoice.releasedToProduction = event.releasedToProduction;
						}
						
					});
				}
			}
			
			public function convertToInvoice():void {
				if(invoice!=null && invoice is Estimate){ 
					if(invoice.onPendingList){
						invoiceService.convertToInvoice(invoice);
					}
				}
			} 
			
			public function copyToNewInvoice():void {
				if(invoice!=null){
					invoiceService.copyToNewInvoice(invoice);
				}
			} 
			
			public function copyToNewEstimate():void {
				if(invoice!=null){
					invoiceService.copyToNewEstimate(invoice);
				}
			} 
			
			private function handleLoadAccountsResult(ev:ResultEvent):void {
				accounts = ev.result as ArrayCollection;
				doAccountPicker();
			}
			public function handleLoadInvoiceTemplates(evt:ResultEvent):void {
				if (evt.result != null) {
					invoiceTemplates = evt.result as ArrayCollection;
				}
			}
			public function handleUIButtonEvent(evt:ResultEvent):void {
				evt.result.button.enabled = evt.result.enabled;
			}		
			private function handleUIButtonFault(ev:FaultEvent):void {  
			}

			public function getEditorType():String
			{
				return this.editorType;
			}
			
			public function setEditorType(editorType:String):void
			{
				if (editorType == EDITINVOICE || editorType == EDITESTIMATE) {
					this.editorType = editorType;
					if (editorType == EDITINVOICE) {
						this.invoice = new Invoice();
						this.invoice.takenBy=Snowmass.getInstance().currentUser.name;
						invoice.onPendingList = true;
						
					} else if (editorType == EDITESTIMATE) {
						this.invoice = new Estimate();
						this.invoice.takenBy=Snowmass.getInstance().currentUser.name;
						invoice.onPendingList = true;
						
					}
				}
			}
			
			public function setInvoice(invoice:InvoiceBase):void
			{
				this.invoice=invoice;
				dataService.getInvoice(invoice.id);
			}

			public function getInvoice():InvoiceBase
			{
				return this.invoice;
			}

			private function handleLoadInvoice(event:ResultEvent):void {
				this.invoice = event.result as InvoiceBase;
				dataService
				if ( invoice.account != null)
					UpdateCustomerStatus();
			}
			
			private function handleLoadResult(event:Event):void
			{

			}
			
			private function handleLoadSingleResult(event:ResultEvent):void {
				preferencesEstimating = event.result as PreferencesEstimating;
				if (preferencesEstimating.canChangeAddress)
					bill_to_address_editor.enabled = true;
				else
					bill_to_address_editor.enabled = false;
			}

			private function handleSaveResult(ev:ResultEvent):void
			{
				var convertedEstimate:Boolean = false;
				this.invoice = ev.result as InvoiceBase;
				inv_number.text = invoice.invoiceNumber;
				//this.parent.removeChild(this);
				if(invoice is Invoice){
					if(convertedEstimatedId!=0){
						convertedEstimate = true;
						dataServiceEstimate.getInvoice(convertedEstimatedId);
					}
					if(!convertedEstimate){
						openConfirmationComponent(StringUtil.substitute(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'CommonConfirmation.SAVE'),resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.Invoice')));
					}
				} else if(invoice is Estimate){
					openConfirmationComponent(StringUtil.substitute(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'CommonConfirmation.SAVE'),resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.Estimate')));
				}
				if(!convertedEstimate){
					dispatchEvent(new PendingListUpdateEvent(PendingListUpdateEvent.PENDINGLIST_UPDATE_EVENT,true));
					Snowmass.getInstance().containerManager.getWindowWithChild(this,true).closeWindow();
				}
			}
			
			private function handleEstimateLoadResult(event:ResultEvent):void {
				var estimateObj:InvoiceBase = event.result as InvoiceBase;
				estimateObj.status = "Won";
				estimateObj.onPendingList = false;
				estimateObj.offPendingDate = new Date();
				estimateObj.convertedInvoiceNo = this.invoice.invoiceNumber;
				dataServiceEstimate.saveInvoice(estimateObj);
			}
			
			private function handleEstimateSaveResult(event:ResultEvent):void {
				openConfirmationComponent(StringUtil.substitute(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'CommonConfirmation.SAVE'),resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.Invoice')));
				dispatchEvent(new PendingListUpdateEvent(PendingListUpdateEvent.PENDINGLIST_UPDATE_EVENT,true));
				Snowmass.getInstance().containerManager.getWindowWithChild(this,true).closeWindow();
			}
			
			private function handleCreateInvoiceResult(ev:ResultEvent):void
			{
				this.invoice = ev.result as InvoiceBase;
				this.editorType = EDITINVOICE;
			}
			
			private function handleConvertInvoiceResult(event:ResultEvent):void {
				if(event.result is Invoice){
					var convertedInvoice:Invoice = event.result as Invoice;
					convertedInvoice.invoiceNumber = "";
					convertedEstimatedId = convertedInvoice.id;
					convertedInvoice.id=0;
					convertedInvoice.created = null;
					convertedInvoice.modified = null;
					convertedInvoice.releasedToProduction = false;
					/* var jobBaseList:ArrayCollection = new ArrayCollection();
					for each(var jobBaseObj:JobBase in convertedInvoice.jobs) {
						if(jobBaseObj.defaultJob){
							jobBaseObj.id = 0;
							jobBaseObj.created = null;
							jobBaseObj.modified = null;
							jobBaseObj.multiQtyJob = false;
							jobBaseObj.parentInvoice = convertedInvoice;
							jobBaseObj.releasedToProduction = false;
							if(jobBaseObj.charges!=null && jobBaseObj.charges.length>0){
								for each(var chargeObject:Charge in jobBaseObj.charges) {
									chargeObject.id=0;
									chargeObject.created = null;
									chargeObject.modified = null;
									chargeObject.parentJob = jobBaseObj;
								}
							}
							jobBaseList.addItem(jobBaseObj);
						}
					}
					convertedInvoice.jobs = jobBaseList;
					for each(var chargeObj:Charge in convertedInvoice.charges) {
						chargeObj.id=0;
						chargeObj.created = null;
						chargeObj.modified = null;
						chargeObj.parentInvoice = convertedInvoice;
					} */
					if (convertedInvoice.jobs != null && convertedInvoice.jobs.length > 0) {
						var i:int;
						convertedInvoice.subTotal = 0;
						for (i=0; i<convertedInvoice.jobs.length; i++) {
							var tmpJob:Job = convertedInvoice.jobs.getItemAt(i) as Job;	
							convertedInvoice.subTotal += tmpJob.pricingRecord.totalPrice;
						}
					}
					convertedInvoice.grandTotal = convertedInvoice.subTotal;
					convertedInvoice.amountDue = convertedInvoice.grandTotal;
					dispatchEvent(new ConvertToInvoiceEvent(ConvertToInvoiceEvent.CONVERT_TO_INVOICE_EVENT,convertedInvoice,convertedEstimatedId));
					Snowmass.getInstance().containerManager.getWindowWithChild(this,true).closeWindow();
				}
			}
			
			private function handleCopyToNewInvoiceResult(event:ResultEvent):void {
				if(event.result is Invoice){
					var newInvoice:Invoice = event.result as Invoice;
					newInvoice.invoiceNumber = "";
					newInvoice.releasedToProduction = false;
					/* for each(var chargeObj:Charge in newInvoice.charges) {
						chargeObj.id=0;
						chargeObj.created = null;
						chargeObj.modified = null;
						chargeObj.parentInvoice = newInvoice;
					} */
					if (newInvoice.jobs != null && newInvoice.jobs.length > 0) {
						var i:int;
						newInvoice.subTotal = 0;
						for (i=0; i<newInvoice.jobs.length; i++) {
							var tmpJob:Job = newInvoice.jobs.getItemAt(i) as Job;	
							newInvoice.subTotal += tmpJob.pricingRecord.totalPrice;
						}
					}
					newInvoice.grandTotal = newInvoice.subTotal;
					newInvoice.amountDue = newInvoice.grandTotal;
					dispatchEvent(new CopyToNewInvoiceEvent(CopyToNewInvoiceEvent.COPY_TO_NEWINVOICE_EVENT,newInvoice));
					//Snowmass.getInstance().containerManager.getWindowWithChild(this).closeWindow();
				}
			} 
			
			private function handleCopyToNewEstimateResult(event:ResultEvent):void {
				if(event.result is Estimate){
					var newEstimate:Estimate = event.result as Estimate;
					newEstimate.invoiceNumber = "";
					newEstimate.releasedToProduction = false;
					/* for each(var chargeObj:Charge in newEstimate.charges) {
						chargeObj.id=0;
						chargeObj.created = null;
						chargeObj.modified = null;
						chargeObj.parentInvoice = newEstimate;
					} */
					if (newEstimate.jobs != null && newEstimate.jobs.length > 0) {
						var i:int;
						newEstimate.subTotal = 0;
						for (i=0; i<newEstimate.jobs.length; i++) {
							var tmpJob:Job = newEstimate.jobs.getItemAt(i) as Job;	
							newEstimate.subTotal += tmpJob.pricingRecord.totalPrice;
						}
					}
					newEstimate.grandTotal = newEstimate.subTotal;
					newEstimate.amountDue = newEstimate.grandTotal;
					dispatchEvent(new CopyToNewEstimateEvent(CopyToNewEstimateEvent.COPY_TO_NEWESTIMATE_EVENT,newEstimate));
					//Snowmass.getInstance().containerManager.getWindowWithChild(this).closeWindow();
				}
			} 
			

			private function handleDeleteResult(event:Event):void
			{
				if(convertedEstimatedId!=0){
					dispatchEvent(new PendingListUpdateEvent(PendingListUpdateEvent.PENDINGLIST_UPDATE_EVENT,true));
					Snowmass.getInstance().containerManager.getWindowWithChild(this,true).closeWindow();
				}
			}

			private function handleFault(ev:FaultEvent):void {  
				if(loadComponent) {
					loadComponent.close();
				}                
				// TODO: This needs to be restored once the hibernate issues are figured out 3/23/2010
//				var message:String;
//				
//				message = "Error: "                          
//				+ ev.fault.faultCode + " - "                                  
//				+ ev.fault.faultDetail + " - "                                  
//				+ ev.fault.faultString;
//				Alert.show(message, "Error");                                 
			}

			private function validateForm(event:Event):void
			{
//        focussedFormControl = event.target as DisplayObject;    
//
//        formIsValid = true;            
			}

			private function validate(validator:Validator):Boolean
			{
//        var validatorSource:DisplayObject = validator.source as DisplayObject;
//     	var suppressEvents:Boolean = (validatorSource != focussedFormControl);
//        var event:ValidationResultEvent = validator.validate(null, suppressEvents); 
//        var currentControlIsValid:Boolean = (event.type == ValidationResultEvent.VALID);
//		formIsValid = formIsValid && currentControlIsValid;
//         
//		return currentControlIsValid;
				return true;
			}

			public function mapToInvoiceData():void
			{

				invoice.name=name_edit.text;
				invoice.invoiceNumber=inv_number.text;
				invoice.contact=contact_list.selectedItem as Contact;
				invoice.customerPO=inv_po_number.text;
				invoice.holdState=inv_hold_state.text as HoldState;
				invoice.resaleId = inv_resale_number.text;
				invoice.expenseCode = inv_expense_code.text;
				invoice.firmWantedByDate = inv_firm_wanted.selected;
				
				//invoice.salesCode =
				if (inv_sales_rep != null && inv_sales_rep.selectedItem != null)
					invoice.salesRep=inv_sales_rep.selectedItem as SalesRep;
				if (ship_via_combo != null && ship_via_combo.selectedItem != null)
					invoice.shippingMethod=ship_via_combo.selectedItem as ShippingMethod;
				invoice.specialInstructions=special_instructions_edit.text as SpecialInstructions
				invoice.billToAddress=bill_to_address_editor.getAddress();
				invoice.shipToAddress=this.delivery_intent_address_editor.getAddress();
				//invoice.contact = contact_editor.getContact();
				invoice.takenBy = taken_by.text;
			}

			public function doSave(ev:MouseEvent=null):void
			{
				mapToInvoiceData();
				if (!((contact_list.selectedItem as Contact).tempFlag) && tempContactId != -1)	{
					dataService.deleteItem("Contact", tempContactId);
				}	
				dataService.saveInvoice(invoice);
			}

			public function doGet():void
			{

			}

			public function doNew(ev:MouseEvent=null):void
			{

			}

			public function doCancel(ev:MouseEvent=null):void
			{
				//this.parent.removeChild(this);
				Snowmass.getInstance().containerManager.getWindowWithChild(this,true).closeWindow();
			}

			private function onNewContact():void	{
				newContact = true;
				contact_editor.setContact(new Contact()); 
				contact_editor.edit_contact_button.dispatchEvent(new MouseEvent(MouseEvent.CLICK));
			}			

			private function doNewJob(ev:MouseEvent=null):void
			{
				var editJobWindow:EditJob= new EditJob(); //EditJob(PopUpManager.createPopUp(this, EditJob, true));
				editJobWindow.invoice = this.invoice;
				//editJobWindow.setStyle("borderAlpha", 0.9);
				var windowID:int = Snowmass.getInstance().containerManager.getWindowWithChild(this,true).windowID;
				Snowmass.getInstance().containerManager.openNewMDIWindow(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'jobCmd.NewJob'),editJobWindow, -1,-1,-1,-1, windowID);
				editJobWindow.addEventListener(JobEditCompleteEvent.SAVE, addNewJob);
			}
			
			
			private function doNewCharge(ev:MouseEvent=null):void {
				var chargePicker:ChargePicker=ChargePicker(PopUpManager.createPopUp(this, ChargePicker, true));
				chargePicker.charges = this.invoice.charges;
				chargePicker.setStyle("borderAlpha", 0.9);
				chargePicker.addEventListener(ChargeDefinitionSelectEvent.CHARGEDEFINITIONCOMPLETE, handleChargeDefinitionComplete,false,0,true);
			}
			
			private function handleChargeDefinitionComplete(evt:ChargeDefinitionSelectEvent):void
			{
				this.invoice.charges=evt.chargeArray;
				//this.updatePrice();
			}

			private function addNewJob(event:Event):void
			{
				var target:EditJob=event.target as EditJob;

				if (target.job != null && !invoice.jobs.contains(target.job))
				{
					invoice.jobs.addItem(target.job);
				}
				
				if(target.multiQtyJobList!= null && target.multiQtyJobList.length>0){
					for each(var multiQtyJobObject:Job in target.multiQtyJobList){
						invoice.jobs.addItem(multiQtyJobObject);
					}
				}
				
				/* Hack code - needs to come out in favor of using the Pricing Engine asap */
				if (invoice.jobs != null && invoice.jobs.length > 0) {
					var i:int;
					invoice.subTotal = 0;
					for (i=0; i<invoice.jobs.length; i++) {
						var tmpJob:Job = invoice.jobs.getItemAt(i) as Job;	
						if(invoice is Estimate){
							if(tmpJob.defaultJob){
								invoice.subTotal += tmpJob.pricingRecord.totalPrice;
							}
						} else {
							invoice.subTotal += tmpJob.pricingRecord.totalPrice;
						}
					}
				}
				
				invoice.grandTotal = invoice.subTotal;
				invoice.amountDue = invoice.grandTotal;
				this.showJobs();
			}
		private function UpdateCustomerStatus():void{
			
			switch (invoice.account.status){
				
					case "CustomerStatusNew":
							account_status.text= resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custStatus.New');
						break;
					case "CustomerStatusCurrent":
							account_status.text= resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custStatus.Current');
						break;
					case "CustomerStatusInactive":
							account_status.text= resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custStatus.Inactive');
						break;
					case "CustomerStatusPastDue":
							account_status.text= resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custStatus.PastDue');
						break;
					case "CustomerStatusDelinquent":
							account_status.text= resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custStatus.Delinquent');
						break;
					case "CustomerStatusFrozen":
							account_status.text= resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custStatus.Frozen');
						break;

			}
			switch (invoice.account.type){
				
					case "full_deposit":
							account_type.text= resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custType.FullDeposit');
						break;
					case "cash_only":
							account_type.text= resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custType.CashOnly');
						break;
					case "cash_check_credit":
							account_type.text= resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custType.CashCheckCreditCard');
						break;
					case "charge_acct":
							account_type.text= resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custType.ChargeAccount');
						break;
					case "credit_card_on_file":
							account_type.text= resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custType.CreditCardonFile');
						break;

			}
		}
			private function saveJob(event:Event):void
			{
				var target:EditJob=event.target as EditJob;

//				if (target.job != null && !invoice.jobs.contains(target.job))
//				{
//					invoice.jobs.addItem(target.job);
//				}
				
				/* Hack code - needs to come out in favor of using the Pricing Engine asap */
				if(!target.job.multiQtyJob){
					var jobList:ArrayCollection = new ArrayCollection();
					for each(var jobBaseObj:JobBase in invoice.jobs){
						var checkFlag:Boolean = false;
						if(target.job.jobGroup!=0 && jobBaseObj.jobGroup==target.job.jobGroup && jobBaseObj.multiQtyJob){
							checkFlag = true;
						}
						if(!checkFlag){
							jobList.addItem(jobBaseObj);
						}
					}
					for each(var jobBaseObject:JobBase in target.invoiceMultiQtyJobList){
						jobList.addItem(jobBaseObject);
					}
					for each(var jobBaseObject:JobBase in target.multiQtyJobList){
						jobList.addItem(jobBaseObject);
					}
					invoice.jobs = jobList;
				}
				var updatedJobList:ArrayCollection = new ArrayCollection();
				for(var i:int=0;i<invoice.jobs.length;i++) {
					var tempJobBaseObj:JobBase = invoice.jobs.getItemAt(i) as JobBase;
					if(!isNaN(target.job.id) && target.job.id!=0){
						if(tempJobBaseObj.id == target.job.id){
							registerClassAlias("com.efi.printsmith.data.JobBase",JobBase);
							tempJobBaseObj = ObjectUtil.copy(target.job) as JobBase;
						}
					} else {
						if(tempJobBaseObj.jobIndex == target.job.jobIndex){
							registerClassAlias("com.efi.printsmith.data.JobBase",JobBase);
							tempJobBaseObj = ObjectUtil.copy(target.job) as JobBase;
						}
					}
					
					updatedJobList.addItem(tempJobBaseObj);
					tempJobBaseObj
				}
				invoice.jobs = updatedJobList;
				if (invoice.jobs != null && invoice.jobs.length > 0) {
					var i:int;
					invoice.subTotal = 0;
					for (i=0; i<invoice.jobs.length; i++) {
						var tmpJob:Job = invoice.jobs.getItemAt(i) as Job;	
						if(invoice is Estimate){
							if(tmpJob.defaultJob){
								invoice.subTotal += tmpJob.pricingRecord.totalPrice;
							}
						} else {
							invoice.subTotal += tmpJob.pricingRecord.totalPrice;
						}
					}
				}
				
				invoice.grandTotal = invoice.subTotal;
				invoice.amountDue = invoice.grandTotal;
				
				this.showJobs();
			}

			private function doChangeAcct(event:MouseEvent=null):void
			{
				job_costing_stack.selectedChild=account_info_canvas;
				bottomrightstack.selectedChild = blankarea;
				//viewstack3.selectedChild=this.account_total_canvas;
			}
			
			private function showCosting(event:MouseEvent=null):void
			{
				job_costing_stack.selectedChild=this.invoice_cost_canvas;
				bottomrightstack.selectedChild = cost_info_canvas;
			}

			private function showJobs(event:MouseEvent=null):void
			{
				job_costing_stack.selectedChild=this.invoice_job_canvas;
				bottomrightstack.selectedChild = job_info_canvas;
				
				if (editorType == EDITESTIMATE) {
					this.createInvoice.visible = true;
				}
//				invoice_job_grid.dataProvider = getJobList(invoice.jobs);
//				invoice_job_grid.validateNow();
			}
			
			public function doCreateInvoice():void
			{
				var selectedJob:Job = invoice_job_grid.selectedItem as Job;
				estimatorService.createInvoiceFromEstimate(this.invoice,Job);
			}

			public function setAccount(accountItem:Account):void
			{
				invoice.account=accountItem;
				invoice.shipToAddress=accountItem.shipToAddress;
				invoice.billToAddress=accountItem.shipToAddress;
				accountDataService.getContactsByAccountId("Contact", invoice.account.id);
//				this.accountcontacts.removeAll();
//				if (accountItem.contact != null)
//					this.accountcontacts.addItem(accountItem.contact);
//				if (accountItem.billToContact != null && accountItem.billToContact != accountItem.contact)
//					this.accountcontacts.addItem(accountItem.billToContact);
//				contact_list.selectedItem=invoice.account.contact as Contact;
				bill_to_address_editor.setAddress(invoice.billToAddress);
				this.delivery_intent_address_editor.setAddress(invoice.shipToAddress);
				UpdateCustomerStatus();
			}

			private function doNotepad(ev:MouseEvent=null):void
			{
				var titleWindow:NotePadEditor=NotePadEditor(PopUpManager.createPopUp(this, NotePadEditor, true));
				titleWindow.setStyle("borderAlpha", 0.9);
				if (invoice.notes == null){
					invoice.notes = new NotePad();
				}
				titleWindow.SetNote(invoice.notes.id, invoice)
			}

			private function doTickets(ev:MouseEvent=null):void
			{
				if (isNaN(invoice.id)) {
					Alert.show("You must save the Invoice before printing", "Error");
				} else {
					var reportName:String = "jobTicket.rpt";
					var urlRequest:URLRequest = new URLRequest("http://localhost:8080/Snowmass/reportservlet?invoiceTicket="+reportName +"&reportParameter="+invoice.id);
                	navigateToURL(urlRequest, "_blank");
				}
			}

			public function toggleCosting():void
			{
				if (job_costing_stack.selectedChild == invoice_job_canvas)
				{
					job_costing_stack.selectedChild=invoice_cost_canvas;
				}
				else
				{
					job_costing_stack.selectedChild=invoice_job_canvas;
				}
			}

			private function findItem(name:String, array:ArrayCollection):int
			{
				for each (var element:Object in array)
				{
					if (name == element.name)
					{
						return array.getItemIndex(element);
					}
				}
				return -1;
			}

			private function doSaleRep():void
			{
				var sales:SalesRep;
				var result:Boolean;

				if (inv_sales_rep.typedText != null && inv_sales_rep.typedText != "" && inv_sales_rep.selectedIndex == -1)
				{
					var item:int=findItem(inv_sales_rep.typedText, salesReps);
					if (item == -1)
					{
						sales=new SalesRep();
						sales.name=inv_sales_rep.text;
						salesRepDataService.addUpdate(sales);
						invoice.salesRep=sales
					}
					else
					{
						inv_sales_rep.selectedItem=item;
					}
				}
			}

			private function doShipVia():void
			{
				var shipv:ShippingMethod;
				var result:Boolean;

				if (ship_via_combo.text != null && ship_via_combo.text != "" && ship_via_combo.selectedIndex == -1)
				{
					var item:int=findItem(ship_via_combo.text, shippingMethods);
					if (item == -1)
					{
						shipv=new ShippingMethod();
						shipv.name=ship_via_combo.text;
						shippingMethodDataService.addUpdate(shipv);
						invoice.shippingMethod=shipv;
					}
					else
					{
						ship_via_combo.selectedIndex=item;
					}
				}
			}

			private function handleLoadSalesReps(ev:ResultEvent):void
			{
				salesReps=ev.result as ArrayCollection;
				if (invoice != null && invoice.salesRep != null)
					inv_sales_rep.selectedIndex=findItem(invoice.salesRep.name, salesReps);
			}

			private function handleLoadShippingMethods(ev:ResultEvent):void
			{
				shippingMethods=ev.result as ArrayCollection;
				if (invoice != null && invoice.shippingMethod != null)
					ship_via_combo.selectedIndex=findItem(invoice.shippingMethod.name, shippingMethods);
			}
			private function handleLoadContacts(ev:ResultEvent):void
			{
				var ac:ArrayCollection =ev.result as ArrayCollection;
				
				var contact:Contact = null;
				if (invoice.contact == null)	{
					contact = invoice.account.billToContact;
				}
				else	{
					if (invoice.contact.tempFlag)	{
						ac.addItem(invoice.contact);
					}
					contact = invoice.contact;						
				}
				
				accountcontacts =  ac;
				
				contact_list.selectedIndex = findItemIndex(accountcontacts, contact);
				contact_editor.setContact(contact);
				contact_ship_address.dataProvider = contact.shipToAddress;
				if (contact.shipToAddress == null || contact.shipToAddress.length == 0)
					rdoContactAddress.enabled = false;
				else
					rdoContactAddress.enabled = true;					 
			}
			private function findItemIndex(array:ArrayCollection, item:ModelBase):int	{
				for (var i:int=0;i<array.length;i++)	{
					var obj:ModelBase = array.getItemAt(i) as ModelBase;
					if (obj.id == item.id)	{
						return i;	
					}
				}
				return -1;
			}
			private function handleGetInvoiceResult(ev:ResultEvent):void{
				invoice = ev.result as InvoiceBase;
				this.invoice.takenBy=Snowmass.getInstance().currentUser.name;
						
				this.bill_to_address_editor.setAddress(invoice.billToAddress);
				this.delivery_intent_address_editor.setAddress(invoice.shipToAddress);
				if (invoice != null && invoice.account != null) 
					accountDataService.getContactsByAccountId("Contact", invoice.account.id);
				
				if (invoice.account == null){
					var eventChangeAccounts:InvoiceChangeAccountsEvent = new InvoiceChangeAccountsEvent(change_account_button,new mx.rpc.Responder(handleUIButtonEvent, handleUIButtonFault));
					eventChangeAccounts.dispatch();
					doChangeAcct();
					doAccountPicker();
				}
				
				
			}
			private function doAccountPicker():void
			{
					

				var accountPickerWindow:AccountPicker=AccountPicker(PopUpManager.createPopUp(this, AccountPicker, true));
				accountPickerWindow.setStyle("borderAlpha", 0.9);
				accountPickerWindow.setAccounts(accounts)
				accountPickerWindow.formIsEmpty=true;
				 accountPickerWindow.prospect_boolean = true;
				accountPickerWindow.addEventListener(AccountPickerSelectEvent.CANCELSELECTACCOUNT, handleAccountPickerCancel);
				accountPickerWindow.addEventListener(AccountPickerSelectEvent.SELECTACCOUNT, handleAccountPickerSelect);
				accountPickerWindow.addEventListener(AccountPickerSelectEvent.SELECTNEWACCOUNT, handleAccountPickerNew);
				
				if(loadComponent) {
					loadComponent.close();
				}
			}

			private function handleAccountPickerCancel(evt:AccountPickerSelectEvent):void
			{
				if (invoice.account == null)
					this.setAccount(new Account());
			}

			private function handleAccountPickerSelect(evt:AccountPickerSelectEvent):void
			{
				if (evt.account != null)
				{
					if (evt.account.status == "CustomerStatusFrozen"){
						Alert.show(resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'Customer_Acct.FROZEN'));
						this.setAccount(new Account());
					}
					else{
					
					this.setAccount(evt.account);
					}
				}
				else
				{
					this.setAccount(new Account());
					Alert.show("Account Picker returned a null account", "Error");
				}
			}

			private function handleAccountPickerNew(evt:AccountPickerSelectEvent):void
			{
				this.setAccount(new Account());
			}
			
			private function handleLoadJobForEdit(evt:ResultEvent):void {
				var selectedJob:Job = evt.result as Job;
				
				if (selectedJob != null) {
					selectedJob.jobIndex = selectedJobIndex;
					//invoice.jobs.setItemAt(selectedJob, invoice_job_grid.selectedIndex);
					//invoice_job_grid.selectedItem = selectedJob;
					openEditJobWindow(selectedJob);
				}	
			}
			
			private function doDoubleclickInvoiceItem():void {
				if(invoice_job_grid.selectedIndex>-1 && invoice_job_grid.selectedItem!=null){
					var selectedJob:Job = invoice_job_grid.selectedItem as Job;
					selectedJobIndex = selectedJob.jobIndex;
					//Commented to not to retrieve the job from DB 
					/* if (selectedJob.id != 0) { // this job had been persisted previously	
						dataService.getJob(selectedJob.id);
					} else {
						openEditJobWindow(selectedJob);
					} */
					openEditJobWindow(selectedJob);
				}
			}
			
			private function enableDeliveryIntentAddress():void {
				this.delivery_intent_address_editor.enabled = true;
			}
			
			private function disableDeliveryIntentAddress(): void {
				this.delivery_intent_address_editor.enabled = false;
				this.delivery_intent_address_editor.setAddress(this.bill_to_address_editor.getAddress());
			}

			private function openEditJobWindow(job:Job):void {
				var editJobWindow:EditJob= new EditJob(); //EditJob(PopUpManager.createPopUp(this, EditJob, true));
				//editJobWindow.setStyle("borderAlpha", 0.9);
				var windowID:int = Snowmass.getInstance().containerManager.getWindowWithChild(this,true).windowID;
				var invoiceNumber:String = "";
				var pricingMethodTitle:String = "";
				if(job.parentInvoice==null || job.parentInvoice.invoiceNumber==null || job.parentInvoice.invoiceNumber==""){
					invoiceNumber = "0";
				} else {
					invoiceNumber = job.parentInvoice.invoiceNumber;
				}
				if(job.pricingMethod==null){
					pricingMethodTitle = "";
				} else {
					pricingMethodTitle = job.pricingMethod.title;
				}
				var jobTitle:String = StringUtil.substitute(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"jobCmd.EditJob"),invoiceNumber,job.jobIndex,pricingMethodTitle);
				Snowmass.getInstance().containerManager.openNewMDIWindow(jobTitle,editJobWindow, -1,-1,-1,-1, windowID);
				var multiQtyJobList:ArrayCollection = new ArrayCollection();
				if(!job.multiQtyJob){
					for each(var jobBaseObj:JobBase in invoice.jobs) {
						if(job.jobGroup!=0 && jobBaseObj.jobGroup==job.jobGroup && jobBaseObj.multiQtyJob){
							multiQtyJobList.addItem(jobBaseObj);
						} 
					}
				}
				editJobWindow.setJob(job);
				editJobWindow.invoiceMultiQtyJobList = multiQtyJobList;
				editJobWindow.addEventListener(JobEditCompleteEvent.SAVE, saveJob);
				/* var editJobWindow:EditJob=EditJob(PopUpManager.createPopUp(this, EditJob, true));
				editJobWindow.setStyle("borderAlpha", 0.9);
				editJobWindow.setJob(job);
				editJobWindow.addEventListener(JobEditCompleteEvent.SAVE, saveJob); */
			}
			private function gridJobPrice(item:Object, column:DataGridColumn):String {
				var localJob:Job = item as Job;
				
				if (localJob != null && localJob.pricingRecord != null) {					
					return Snowmass.getCurrencyFormatter(false, 2).format(localJob.pricingRecord.totalPrice.toString());
				} else {
					return "";
				}
			}
			
			private function doPrint(ev:MouseEvent = null):void {
				if (isNaN(invoice.id)) {
					Alert.show("You must save the invoice before printing", "Error");
				} else {
					var reportName:String = format_combo.selectedItem as String;
					var urlRequest:URLRequest = new URLRequest("http://localhost:8080/Snowmass/reportservlet?invoiceName="+reportName +"&reportParameter="+invoice.id);
                	navigateToURL(urlRequest, "_blank");
				}
			}
			private function doContactChange():void{
				var temp:Contact= new Contact();
				temp = contact_list.selectedItem as Contact;
				
				contact_editor.setContact(temp);
				contact_ship_address.dataProvider = temp.shipToAddress;
				if (temp.shipToAddress == null || temp.shipToAddress.length == 0)	{
					rdoInvAddress.selected = true;
					rdoContactAddress.enabled = false;					 
				}
				else	{
					rdoContactAddress.enabled = true;
				}
				if( temp.useContactAddress) {
					bill_to_address_editor.setAddress(temp.address);
					//this.delivery_intent_address_editor.setAddress(temp.address);
				}
				else	{
					bill_to_address_editor.setAddress(invoice.billToAddress);
				}
			}
			
			private function getJobList(jobList:ArrayCollection):ArrayCollection {
				if(resetJobsList) {
					resetJobsList = false;
					multiQtyJobPresent = false;
					radioButtonGroupList = new ArrayCollection();
					if(invoice is Invoice) {
						var invoiceJobList:ArrayCollection = new ArrayCollection();
						var counter:int=0;
						for each(var jobBaseObj:JobBase in jobList){
							counter++;
							jobBaseObj.jobIndex = counter; 
							invoiceJobList.addItem(jobBaseObj);
						}
						resetJobsList = true;
						return jobList;
					} else if(invoice is Estimate) {
						if(jobList!=null && jobList.length>0){
							var tempMultiQtyJobPresent:Boolean = false;
							var estimatesJobList:ArrayCollection = new ArrayCollection();
							var rbCounter:int=0;
							var counter:int=0;
							for each(var jobBaseObj:JobBase in jobList){
								jobBaseObj.hasMultiQtyJobs = false;
								if(!jobBaseObj.multiQtyJob){
									var checkFlag:Boolean = false;
									for each(var estimatesJobObj:JobBase in estimatesJobList) {
										if(estimatesJobObj.id == jobBaseObj.id && estimatesJobObj.id!=0 && jobBaseObj.id!=0) {
											checkFlag = true;
											break;
										}
									}
									if(!checkFlag){
										jobBaseObj.rbIndex = rbCounter;
										counter++;
										jobBaseObj.jobIndex = counter;
										estimatesJobList.addItem(jobBaseObj);
										for each(var jobBaseObject:JobBase in jobList){
											if(jobBaseObj.jobGroup!=0 && jobBaseObj.jobGroup==jobBaseObject.jobGroup && jobBaseObject.multiQtyJob){
												jobBaseObj.hasMultiQtyJobs = true;
												tempMultiQtyJobPresent = true;
												jobBaseObject.rbIndex = jobBaseObj.rbIndex;
												counter++;
												jobBaseObject.jobIndex = counter;
												estimatesJobList.addItem(jobBaseObject);
											}
										}
										/* if(jobBaseObj.hasMultiQtyJobs){ */
											var radioButtonGroup:RadioButtonGroup = new RadioButtonGroup();
											radioButtonGroup.initialized(this.document,"defaultJob"+jobBaseObj.jobGroup);
											radioButtonGroupList.addItem(radioButtonGroup);
										/* } */
									}
								}
								rbCounter++;
							}
							multiQtyJobPresent = tempMultiQtyJobPresent;
							resetJobsList = true;
							return estimatesJobList;
						}
					}
					resetJobsList = true;
				}
				return null;
			}
			
			private function getContactShipToLabel(item:Object):String	{
				var temp:Address = item as Address;
				return temp.name + ":" + temp.street1 + "," + temp.street2;
			}
			private function contactLabel(item:Object):String {
				var tempItem:Contact = item as Contact;
				if ((tempItem.tempFlag != null) && (tempItem.tempFlag == true))	{
					return "*** Temporary Contact ***";
				}
				var returnString:String = tempItem.lastName + ", " + tempItem.firstName;
				return returnString;
			}
			
			public function setDefaultJob(object:Object,event:Event):void {
				if(event.currentTarget.selected) {
					for each(var jobBaseObj:JobBase in invoice.jobs){
						if(object.jobGroup!=0 && jobBaseObj.jobGroup==object.jobGroup){
							jobBaseObj.defaultJob = false;
						}
					}
					object.defaultJob = true;
				}
				if (invoice.jobs != null && invoice.jobs.length > 0) {
					var i:int;
					invoice.subTotal = 0;
					for (i=0; i<invoice.jobs.length; i++) {
						var tmpJob:Job = invoice.jobs.getItemAt(i) as Job;	
						if(invoice is Estimate){
							if(tmpJob.defaultJob){
								invoice.subTotal += tmpJob.pricingRecord.totalPrice;
							}
						} else {
							invoice.subTotal += tmpJob.pricingRecord.totalPrice;
						}
					}
				}
				invoice.grandTotal = invoice.subTotal;
				invoice.amountDue = invoice.grandTotal;
			}
			
			public function getRBGroupRef(object:Object):RadioButtonGroup {
				if(radioButtonGroupList!=null && radioButtonGroupList.length>object.rbIndex){
					return radioButtonGroupList.getItemAt(object.rbIndex) as RadioButtonGroup;
				}
				return null;
			}
			
			public function getJobIndex(object:Object):String {
				if(object.multiQtyJob){
					return "+++";	
				}
				return String(object.jobIndex);
			}
			
			public function getQtyOrdered(item:Object, column:DataGridColumn):String {
				if(item.showMultiQty){
					return item[column.dataField]+"+";
				}
				return item[column.dataField];
			}
			
			private function doDoubleclickTicketItem():void	{
				if(ticket_grid.selectedIndex>-1 && ticket_grid.selectedItem!=null){
					var selectedDeliveryTicketJob:DeliveryTicketJobs = ticket_grid.selectedItem as DeliveryTicketJobs;
					var child:DeliveryTicketEdit = new DeliveryTicketEdit();
					child.setDeliveryTicket(selectedDeliveryTicketJob.parentDeliveryTicket);
					child.addEventListener(DeliveryTicketUpdateEvent.DELIVERYTICKET_UPDATE_EVENT,updateDeliveryTicketJobsList,false,0,true);
					var win:MDIWindow = Snowmass.getInstance().containerManager.getWindowWithChild(child);
					if (win == null) {
						Snowmass.getInstance().containerManager.openNewMDIWindow(child.title, child);
					}
					else {
						win.closeWindow();
						Snowmass.getInstance().containerManager.openNewMDIWindow(child.title, child);	
					}
				}
			}
			
			private function getOrderedTime(dateObj:Date):String {
				if(dateObj!=null){
					var dateFormatter:DateFormatter = new DateFormatter();
					dateFormatter.formatString = "L:NN A";
				}
				return "";
			}
			
			private function setInvoiceDates(event:Event, propertyName:String, labelCompName:String=null):void {
				var dateObj:Date = event.currentTarget.selectedDate as Date;
				if(dateObj!=null){
					if(invoice[propertyName]!=null){
						invoice[propertyName].date = dateObj.date;
						invoice[propertyName].month = dateObj.month;
						invoice[propertyName].fullYear = dateObj.fullYear;
					} else {
						invoice[propertyName] = dateObj;
					}
				} else {
					invoice[propertyName] = null;
				}
				if(labelCompName!=null){
					var label:Label = this[labelCompName] as Label;
					label.text = getWeekName(invoice[propertyName]);
				} 
			}
			
			private function getWeekName(dateObj:Date):String {
				if(dateObj!=null){
					var dateFormatter:DateFormatter = new DateFormatter();
					dateFormatter.formatString = "EEE";
					return dateFormatter.format(dateObj);
				}
				return "";
			}
			
			private function handleLoadDeliveryTicketJobsResult(event:ResultEvent):void {
				deliveryTicketJobsList = event.result as ArrayCollection;
			}
			
			private function updateDeliveryTicketJobsList(event:DeliveryTicketUpdateEvent):void {
				if(event.ticketSaved) {
					if(invoice!=null && invoice.id>0){
						dataService.getDeliveryTicketJobsByInvoice(invoice.id);
					}
				}
			}
		]]>

	</mx:Script>
	<mx:VBox height="100%" width="100%" id="mainvbox" paddingBottom="5" paddingLeft="5" paddingRight="5" paddingTop="5">
		<!-- toolbar-->
		<ns2:Toolbar id="toolbar" height="5%" width="100%"/>
		<mx:ViewStack id="job_costing_stack" height="80%" width="100%" paddingBottom="5" paddingLeft="5" paddingRight="5" paddingTop="5">

		
			<mx:HBox id="account_info_canvas" >
				<mx:VBox width="50%" height="100%">
					<mx:HBox width="100%" height="5%" >
						<mx:Form height="100%" width="80%">
							<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.Title')}">
								<mx:TextInput text="{invoice.name}"
									  id="name_edit"
									  />
							</mx:FormItem>
							<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'chargeCmd.Account')}">
								<mx:Text 
									 text="{invoice.account.title}"
								 	id="account_text"
								 	/>		
							</mx:FormItem>
					
						</mx:Form>
						<mx:LinkButton width="20%" height="10%" id="change_account_button"
								   label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Changeacct')}"
								   click="{accountDataService.getAccountPicker()}"
								   />
						
					</mx:HBox>
						
					<mx:VBox height="70%" width="100%">
							<ns1:AddressEditor height="30%" width="100%"
										   id="bill_to_address_editor" 
										   address="{invoice.billToAddress}" editable="false"
										   addressLabel="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custCmd.InvoiceAddress')}"/>
										   <!--title="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.DeliveryIntent')}"-->
							<mx:VBox height="70%" width="100%" 
								  dropShadowEnabled="false"
								  
								  horizontalScrollPolicy="off"
								  verticalScrollPolicy="off">
								<mx:Label fontWeight="bold" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.DeliveryIntent')}" height="2%" width="100%" />
								<mx:RadioButtonGroup id="delivery_intent_radio_group"/>
								<mx:RadioButton
												label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.InvoiceAddress')}" id="rdoInvAddress"
												groupName="delivery_intent_radio_group" selected="true" click="disableDeliveryIntentAddress();"/>
								<mx:HBox width="100%" >
									<mx:RadioButton id="rdoContactAddress" enabled="false"
												label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.ContactShipAddress')}"
												groupName="delivery_intent_radio_group" />
									<mx:ComboBox id="contact_ship_address" labelFunction="getContactShipToLabel" enabled="{rdoContactAddress.selected}"/>
									
								</mx:HBox>

								<mx:RadioButton 
												label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.OtherAddress')}"
												groupName="delivery_intent_radio_group" click="enableDeliveryIntentAddress();"/>
								<ns1:AddressEditor
										   id="delivery_intent_address_editor"
										   address="{invoice.shipToAddress}"
										   enabled="false"/>
								<mx:HBox width="100%">
									<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'custDataCmd.Orderedon')}:" width="20%"
										textAlign="right" fontWeight="bold"/>
									<mx:DateField id="ordered_date" selectedDate="{invoice.orderedDate}" width="35%"
										change="{setInvoiceDates(event,'orderedDate','ordered_week')}"/>
									<mx:Label text="{getOrderedTime(invoice.orderedDate)}" width="35%"/>
									<mx:Label id="ordered_week" text="{getWeekName(invoice.orderedDate)}" width="10%"/>
								</mx:HBox>
								
								<mx:HBox width="100%">
									<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'custDataCmd.Wantedby')}:" width="20%"
										textAlign="right" fontWeight="bold"/>
									<components:CustomDateFieldComponent id="wanted_date" selectedDate="{invoice.wantedDate}" width="35%"
										change="{setInvoiceDates(event,'wantedDate','wanted_week')}"/>
									<components:CustomTimeEntryDateComponent
										dataHolder="{invoice}" variableName="wantedDate" customText="{invoice.wantedDate}" 
										is24Hour="false" width="35%" borderStyle="none"/>
									<mx:Label id="wanted_week" text="{getWeekName(invoice.wantedDate)}" width="10%"/>
								</mx:HBox>
								
								<mx:HBox width="100%">
									<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'custDataCmd.Deliveron')}:" width="20%"
										textAlign="right" fontWeight="bold"/>
									<components:CustomDateFieldComponent id="completed_date" selectedDate="{invoice.completedDate}" width="35%"
										change="{setInvoiceDates(event,'completedDate','completed_week')}"/>
									<components:CustomTimeEntryDateComponent
										dataHolder="{invoice}" variableName="completedDate" customText="{invoice.completedDate}" 
										is24Hour="false" width="35%" borderStyle="none"/>
									<mx:Label id="completed_week" text="{getWeekName(invoice.completedDate)}" width="10%"/>
								</mx:HBox>
								
								<mx:HBox width="100%">
									<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'custDataCmd.Proofby')}:" width="20%"
										textAlign="right" fontWeight="bold"/>
									<components:CustomDateFieldComponent id="proofby_date" selectedDate="{invoice.proofDate}" width="35%"
										change="{setInvoiceDates(event,'proofDate','proofby_week')}"/>
									<components:CustomTimeEntryDateComponent
										dataHolder="{invoice}" variableName="proofDate" customText="{invoice.proofDate}" 
										is24Hour="false" width="35%" borderStyle="none"/>
									<mx:Label id="proofby_week" text="{getWeekName(invoice.proofDate)}" width="10%"/>
								</mx:HBox>
								
								<mx:HBox width="100%">
									<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'custDataCmd.Reorder')}:" width="20%"
										textAlign="right" fontWeight="bold"/>
									<components:CustomDateFieldComponent id="reorder_date" selectedDate="{invoice.reorderDate}" width="35%"
										change="{setInvoiceDates(event,'reorderDate')}"/>
									<components:CustomCheckBoxComponent
										label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'custDataCmd.FileOriginals')}"
										dataHolder="{invoice}" variableName="fileOriginals" customText="{invoice.fileOriginals}"
										defaultValue="false" selectedValue="true" deSelectedValue="false" width="45%"/>
								</mx:HBox>
								
							</mx:VBox>			   
						
					</mx:VBox>
					
					<mx:VBox height="25%" width="100%">
						
					</mx:VBox> 
					
					
				</mx:VBox>	
					
				<mx:VBox width="50%" height="100%">
					<mx:Form height="1%" width="100%">	
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.Invoice')}" textAlign="right" id="invoice_number_edit">
							<mx:Text id="inv_number"
									  text="{invoice.invoiceNumber}"
								/>
						</mx:FormItem>					
					</mx:Form>
					
					<ns1:ContactInfoEditor height="70%" width="100%" id="contact_editor" contactLabel="Contact" />
									
					<mx:HBox height="10%" width="100%">
						<mx:Label height="100%" width="20%"
								  text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custCmd.ContactList')}" textAlign="right"/>
						<mx:ComboBox height="100%" width="40%"
									 dataProvider="{accountcontacts}"
									 id="contact_list" labelFunction="contactLabel" change="doContactChange()"/>
						<mx:Button id="btnContactNew" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.New')}" click="onNewContact();" />
					</mx:HBox>
					
					<mx:Form height="40%" width="100%">
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.AccountStatus')}" >
							<mx:Text id="account_status" />
						</mx:FormItem>
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rCustSort.AccountType')}" >
							<mx:Text id="account_type"/>
						</mx:FormItem>
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.Takenby')}" >
							<mx:TextInput id="taken_by"
									  text="{invoice.takenBy}"/>
						</mx:FormItem>
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.SalesRep')}" >
							<fc:AutoComplete id="inv_sales_rep"
										 dataProvider="{salesReps}"
										 labelField="name"
										 focusOut="doSaleRep();"
										 lookAhead="true"
										/>
						</mx:FormItem>
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rChargeLabel.ShipVia')}" >
							
							<common:EditableComboBox id="ship_via_combo"
											 dataProvider="{shippingMethods}"
											 labelField="name"
											 focusOut="doShipVia()"
											 
											 />
						</mx:FormItem>
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'scheduleJobEditCmd.Hold')}" >
							<mx:TextInput 
									  id="inv_hold_state"
									  text="{invoice.holdState.name}"
									  />
						</mx:FormItem>		
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.PO')}" >
							<mx:TextInput 
									  id="inv_po_number"
									  text="{invoice.customerPO}"
									  />
						</mx:FormItem>
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.Resale')}" >
							<mx:TextInput 
									  id="inv_resale_number"
									  text="{invoice.resaleId}"
									  />
						</mx:FormItem>		
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.ExpenseCode')}" >
							<mx:TextInput id="inv_expense_code"
									  text="{invoice.expenseCode}"
									  />
						</mx:FormItem>					  
						<mx:FormItem >					
							<mx:CheckBox id="inv_firm_wanted" selected="{invoice.firmWantedByDate}" label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.Firmwantedbydate')}" />
						</mx:FormItem>
						<mx:FormItem label= "{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.Proofreader')}" >
							<mx:TextInput id="inv_proofreader"
										  text=""
										  />
						</mx:FormItem>
					</mx:Form>
				</mx:VBox>	
					
					
					
								
			</mx:HBox>
			<mx:VBox id="invoice_cost_canvas">
				<mx:DataGrid width="100%"
							 height="100%"
							 id="invoice_cost_grid">
					<mx:columns>
						<mx:DataGridColumn headerText=""
										   width="30"
										   dataField="col1"/>
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Description')}"
										   dataField="col2"/>
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Estimated')}"
										   width="80"
										   dataField="col3"/>
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Actual')}"
										   width="80"
										   dataField="col3"/>
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Difference')}"
										   width="80"
										   dataField="col3"/>
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Price')}"
										   width="80"
										   dataField="col3"/>
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Margin')}"
										   width="80"
										   dataField="col3"/>
					</mx:columns>
				</mx:DataGrid>
			</mx:VBox>
			<mx:VBox id="invoice_job_canvas">
				<mx:DataGrid height="70%"
							 width="100%"
							 id="invoice_job_grid"
							 dataProvider="{getJobList(invoice.jobs)}"
							 sortableColumns="false"
							 doubleClick="doDoubleclickInvoiceItem()"
						  	 doubleClickEnabled="true">
					<mx:columns>
						<mx:DataGridColumn>
							<mx:itemRenderer>
								<mx:Component>
									<mx:Label text="{outerDocument.getJobIndex(data)}" textAlign="center" fontWeight="bold"/>
								</mx:Component>
							</mx:itemRenderer>
						</mx:DataGridColumn>
						<mx:DataGridColumn visible="{multiQtyJobPresent}">
							<mx:itemRenderer>
									<mx:Component>
									<mx:HBox width="100%" horizontalAlign="center">
										<mx:RadioButton group="{outerDocument.getRBGroupRef(data)}"
											enabled="{data.multiQtyJob || data.hasMultiQtyJobs}"
											selected="{data.defaultJob}" click="{outerDocument.setDefaultJob(data,event)}"/>
									</mx:HBox>
								</mx:Component>
							</mx:itemRenderer>
						</mx:DataGridColumn>	
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'copierDefCmd.Qty')}"
										   dataField="qtyOrdered" labelFunction="getQtyOrdered"/>
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Description')}"
										   dataField="description"/>
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Price')}"
										   labelFunction="gridJobPrice" textAlign="right"/>

					</mx:columns>
				</mx:DataGrid>
				<mx:DataGrid height="30%"
							 width="100%" 
							 id="ticket_grid"
							 dataProvider="{deliveryTicketJobsList}"
							 sortableColumns="false"
							 doubleClick="{doDoubleclickTicketItem()}"
						  	 doubleClickEnabled="true"
						  	 visible="{deliveryTicketJobsList!=null &amp;&amp; deliveryTicketJobsList.length>0}">
					<mx:columns>
						<mx:DataGridColumn dataField="jobNumber"/>
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Shipped')}"
							dataField="qtyShipped"/>	
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Description')}"
							dataField="description"/>
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Ticket')}">
							<mx:itemRenderer>
								<mx:Component>
									<mx:Label text="{data.parentDeliveryTicket.ticketNumber}"/>
								</mx:Component>
							</mx:itemRenderer>
						</mx:DataGridColumn>

					</mx:columns>
				</mx:DataGrid>
			</mx:VBox>

		</mx:ViewStack>
		<mx:HBox id="bottompartbox" height="10%" width="100%" borderThickness="2" borderStyle="solid" paddingBottom="5" paddingLeft="5" paddingRight="5" paddingTop="5">
			<mx:VBox width="30%" height="100%" id="spl_instructions_box">
				<mx:Label 
			  	text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'jobTicketCmd.SpecialInstructions')}"
			  	height="10%" width="100%"/>
				<mx:TextInput 
						  width="100%"
						  height="90%"
						  id="special_instructions_edit"
						  text="{invoice.specialInstructions.instructions}"/>
			</mx:VBox>
			<mx:VRule width="2%" height="100%"/>
			<mx:ViewStack id="bottomrightstack" height="100%" width="70%">
				
				<mx:HBox height="100%" width="70%" id="job_info_canvas">
					<mx:VBox width="30%" height="10%">
						<mx:HBox width="100%" height="50%">
							<mx:Label height="100%" width="20%" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'labelCmd.Format')}" textAlign="right"/>
							<mx:ComboBox width="80%" height="10%"
											 id="format_combo"
										 dataProvider="{invoiceTemplates}"/>
						</mx:HBox>
						<mx:Text width="50%" height="5%" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.OnPendingList')}" />
						<mx:Button width="50%" height="5%" label="Create Invoice" id="createInvoice" click="doCreateInvoice()" enabled="true"/>				 
					</mx:VBox>
					<mx:VRule width="2%" height="100%"/>
					<mx:Form width="30%" height="100%">
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.CustDiscount')}"  >
							<mx:Text textAlign="right"
									 id="cust_discount_text"
									 text="{invoice.discount}"
									 />
						</mx:FormItem>
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.NetSub')}"  >
							<mx:Text textAlign="right"
									 id="net_subtotal_text"
									 text="{Snowmass.getCurrencyFormatter(true, 2).format(invoice.subTotal)}"
									 />
						</mx:FormItem>
						
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.SalesTax')}" >
							<mx:Text textAlign="right"
									 id="sales_tax_text"
									 />
							
						</mx:FormItem>
						
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Shipping')}" >
							<mx:Text textAlign="right"
									 id="shipping_text"
									 text="{Snowmass.getCurrencyFormatter(true, 2).format(invoice.shipCharges)}"
									 />
						</mx:FormItem>
						
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Total')}" >
							<mx:Text textAlign="right"
									 id="total_text"
									 text="{Snowmass.getCurrencyFormatter(true, 2).format(invoice.grandTotal)}"
									 />
						</mx:FormItem>
						
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.AmtDue')}" >
							<mx:Text textAlign="right"
									 id="amt_due_text"
									 text="{Snowmass.getCurrencyFormatter(true, 2).format(invoice.amountDue)} "
									 />
						</mx:FormItem>
											
					</mx:Form>

				</mx:HBox>
				<mx:HBox id="cost_info_canvas">
					<mx:VBox width="10%" height="100%">
						<mx:HBox height="20%" width="100%">
							<mx:Button height="100%" width="50"
									   id="cost_entered_legend_button"
									   cornerRadius="0"
									   fillColors="[blue, blue]"
									   fillAlphas="[1.0, 1.0]"
									   borderColor="#000000"/>
							<mx:Label height="100%" width="50%"
							  text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Costentered')}"/>
							   	
						</mx:HBox>
						<mx:HBox height="20%" width="100%">
							
							<mx:Button height="100%" width="50" id="cost_entered_legend_button0"
									   cornerRadius="0"
									   fillColors="[green,green]"
									   	fillAlphas="[1.0, 1.0]"
									   borderColor="#000000"/>
							<mx:Label height="100%" width="50%"
							  text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Historicalcost')}"/>
						
						</mx:HBox>
						
						<mx:HBox height="20%" width="100%">
							<mx:Button height="100%" width="50" id="cost_entered_legend_button1"
									   cornerRadius="0"
									   fillColors="[#ff9600, #ff9600]"
									   fillAlphas="[1.0, 1.0]"
									   borderColor="#000000"/>
							<mx:Label height="100%" width="50%"
							  text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.DataCollections')}"/>
					
						</mx:HBox>
						
						<mx:HBox height="20%" width="100%">
						
							<mx:Button height="100%" width="50" id="cost_entered_legend_button2"
									   cornerRadius="0"
									   fillColors="[red, red]"
									   fillAlphas="[1.0, 1.0]"
									   borderColor="#000000"/>
								<mx:Label height="100%" width="50%"
								  text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Pricedbelowcost')}"/>
	
						</mx:HBox>
					</mx:VBox>
					<mx:VRule width="2%" height="100%"/>
					<mx:Form width="50%" height="100%" id="costing_total_canvas">
						
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Actual')}" >
							<mx:Text  width="50%" height="100%"
									textAlign="right"
									 id="cust_discount_text0"/>
						</mx:FormItem>
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Price')}" >
							<mx:Text width="50%" height="100%"
									 textAlign="right"
									 id="cust_discount_text1"/>
						</mx:FormItem>
						
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Margin')}" >
							<mx:Text width="50%" height="100%"
									 textAlign="right"
									 id="cust_discount_text2"/>
							
						</mx:FormItem>
						
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'salesCmd.EstProfit')}" >
								
							<mx:Text width="50%" height="100%"
										 textAlign="right"
										 id="cust_discount_text3"/>
							
						</mx:FormItem>
						
						
					</mx:Form>
				</mx:HBox>
				<mx:Canvas id="blankarea" height="100%" width="100%">
					<mx:Spacer width="100%" height="100%" />
				</mx:Canvas>						
		</mx:ViewStack>

	</mx:HBox>
</mx:VBox>
</mx:Panel>
