<?xml version="1.0" encoding="utf-8"?>
<mx:Panel xmlns:mx="http://www.adobe.com/2006/mxml"
		  xmlns:view="com.efi.printsmith.view.*"
		  xmlns:ns1="com.efi.printsmith.components.*"
		  xmlns:ns2="com.efi.printsmith.common.components.*"
		  xmlns:common="com.efi.printsmith.common.components.*"
		  xmlns:vo="com.efi.printsmith.vo.*" 
		  xmlns:fc="http://www.adobe.com/2006/fc"
		  xmlns:hc="com.hillelcoren.components.*"
		  xmlns:viewStackEffects="org.efflex.mx.viewStackEffects.*"
		  width="100%"
		  height="100%"
		  headerHeight="0"
		  title="Edit Invoice" 
		  implements="com.efi.mdi.IMDIWindowAware,com.efi.printsmith.security.ISecureComponent" preinitialize="preInit();"
		  fontSize="9" xmlns:components="com.efi.printsmith.common.components.*">
	
	
	
	<mx:RemoteObject id="prefStocksDataService" destination="dataService">
		<mx:method name="getSingle" fault="handleFault(event)" result="handleLoadPrefStocksResult(event)"/>
	</mx:RemoteObject>
	
	<mx:RemoteObject id="estimatorService"
						destination="estimatorService">
		<mx:method name="createInvoiceFromEstimate"
					fault="handleFault(event)"
					result="handleCreateInvoiceResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="createCustFromDocService"
						destination="dataService">
		<mx:method name="addUpdate"
					fault="handleFault(event)"
					result="handleCreateCustomerFromDoc(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="dataService"
					 destination="dataService" showBusyCursor="true">
		<mx:method name="getAll"
				   fault="handleFault(event)"
				   result="handleLoadResult(event)"/>
		<mx:method name="deleteItem"
				   fault="handleFault(event)"
				   result="handleDeleteResult(event)"/>
		<mx:method name="getInvoice"
				   fault="handleFault(event)"
				   result="handleGetInvoiceResult(event)"/>
		<mx:method name="getById"
					fault="handleFault(event)"
					result="handleLoadJobForEdit(event)"/>
		<mx:method name="getJob"
					fault="handleFault(event)"
					result="handleLoadJobForEdit(event)"/>
		<mx:method name="getInvoice"
					fault="handleFault(event)"
					result="handleLoadInvoice(event)"/>
		<mx:method name="saveInvoice"
				   fault="handleFault(event)"
				   result="handleSaveResult(event)"/>
		<mx:method name="getDeliveryTicketJobsByInvoice"
				   fault="handleFault(event)"
				   result="handleLoadDeliveryTicketJobsResult(event)"/>
		<mx:method name="addUpdate"
				   fault="handleFault(event)"
				   result="handleSaveWalkInAcct(event)"/>		   
	</mx:RemoteObject>
	<mx:RemoteObject id="invoiceService"
					 destination="invoiceService" showBusyCursor="true">
		<mx:method name="saveInvoice"
				   fault="handleFault(event)"
				   result="handleSaveResult(event)"/>
		<mx:method name="convertToInvoice"
					fault="handleFault(event)"
					result="handleConvertInvoiceResult(event)"/>
		<mx:method name="copyToNewInvoice"
					fault="handleFault(event)"
					result="handleCopyToNewInvoiceResult(event)"/>
		<mx:method name="copyToNewEstimate"
					fault="handleFault(event)"
					result="handleCopyToNewEstimateResult(event)"/>
	</mx:RemoteObject>
	
	
	<mx:RemoteObject id="accountDataService"
					 destination="dataService">
	
		<mx:method name="getAccountPicker"
				   fault="handleFault(event)"
				   result="handleLoadAccountsResult(event)"/>
	</mx:RemoteObject>
	<mx:RemoteObject id="invoiceRepositoryService" destination="invoiceRepositoryService">
		<mx:method name="getItemList"
					fault="handleFault(event)"
					result="handleLoadInvoiceTemplates(event)"/>		
	</mx:RemoteObject>
	
	<mx:RemoteObject id="newContactDataService" destination="dataService" showBusyCursor="true">
		<mx:method name="addUpdate" fault="handleFault(event)" result="saveNewContactResult(event)" />
	</mx:RemoteObject>
	<mx:RemoteObject id="tempContactDataService" destination="dataService" showBusyCursor="true">
		<mx:method name="addUpdate" fault="handleFault(event)" result="saveTempContactResult(event)" />
	</mx:RemoteObject>
	<mx:RemoteObject id="dataServiceEstimate" destination="dataService" showBusyCursor="true">
		<mx:method name="getInvoice"
					fault="handleFault(event)"
					result="handleEstimateLoadResult(event)"/>
		<mx:method name="saveInvoice"
					fault="handleFault(event)"
					result="handleEstimateSaveResult(event)"/>
	</mx:RemoteObject>
	
	<mx:Script source="../common/scripts/CommonUtils.as"/>
	<mx:Script source="../security/PSSecurityInclude.as" />

	<mx:Script>
		<![CDATA[
			import com.efi.printsmith.pricing.InvoicePricing;
			import mx.formatters.NumberFormatter;
			import com.efi.printsmith.data.StockDefinition;
			import com.efi.printsmith.data.PreferencesStocks;
			import com.efi.printsmith.pages.EstimatorCheckList;
			import com.efi.printsmith.events.UpdateChargeEvent;
			import mx.events.DragEvent;
			import com.efi.printsmith.events.InvoiceNotesAddedEvent;
			import mx.collections.Sort;
			import mx.collections.SortField;
			import mx.events.DataGridEvent;
			import mx.events.DataGridEventReason;
			import mx.managers.DragManager;
			import mx.core.DragSource;
			import com.efi.printsmith.data.DepositEntry;
			import com.efi.printsmith.events.DepositEntryAddedEvent;
			import com.efi.printsmith.data.PreferencesCashRegister;
			import com.efi.printsmith.data.PreferencesAccounting;
			import com.efi.printsmith.events.DeliveryTicketUpdateEvent;
			import com.efi.printsmith.data.DeliveryTicketJobs;
			import mx.formatters.DateFormatter;
			import mx.rpc.mxml.Concurrency;
			import com.efi.printsmith.data.ComLink;
			import com.efi.printsmith.components.ContactInfoPopup;
			import com.efi.printsmith.events.SaveContactEvent;
			import flexlib.controls.Fire;
			import mx.controls.RadioButtonGroup;
			import com.efi.printsmith.common.components.ToolbarButton;
			import com.efi.printsmith.data.ModelBase;
			import com.efi.printsmith.security.PSSecurityUtils;
			import com.efi.printsmith.security.PSSecurity;
			import com.efi.printsmith.security.PSSecurityCommands;
			import mx.events.FlexEvent;
			import com.efi.printsmith.events.ChargeDefinitionSelectEvent;
			import com.efi.printsmith.events.CopyToNewEstimateEvent;
			import com.efi.printsmith.events.PendingListUpdateEvent;
			import com.efi.printsmith.events.CopyToNewInvoiceEvent;
			import com.efi.printsmith.events.ConvertToInvoiceEvent;
			import flash.utils.setTimeout;
			import mx.utils.ObjectUtil;
			import flash.net.registerClassAlias;
			import com.efi.mdi.view.window.MDIWindow;
			import mx.utils.StringUtil;
			import mx.controls.RadioButton;
			import com.efi.printsmith.common.components.CommonLoadComponent;
			import com.efi.printsmith.data.JobBase;
			import com.efi.printsmith.events.TrackerStatusUpdateEvent;
			import com.efi.printsmith.pages.TrackerStatusView;
			import com.efi.printsmith.data.NotePad;
			import mx.events.ResourceEvent;
			import mx.controls.dataGridClasses.DataGridColumn;
			import com.efi.printsmith.data.Estimate;
			import com.efi.printsmith.data.InvoiceBase;
			import mx.events.CloseEvent;
			import com.efi.printsmith.events.JobEditCompleteEvent;
			import com.efi.printsmith.events.AccountPickerSelectEvent;

			import com.efi.printsmith.events.commandEvents.Invoice.*;
	
			import com.efi.printsmith.data.HoldState;
			import com.efi.printsmith.data.Invoice;
			import com.efi.printsmith.data.Marketing;
			import com.efi.printsmith.data.BusinessType;
			import com.efi.printsmith.data.SalesRep;
			import com.efi.printsmith.data.Contact;
			import com.efi.printsmith.data.Address;
			import com.efi.printsmith.data.CustomerLog;
			import com.efi.printsmith.data.Charge;
			import com.efi.printsmith.data.City;
			import com.efi.printsmith.data.Country;
			import com.efi.printsmith.data.State;
			import com.efi.printsmith.data.Zip;
			import com.efi.printsmith.data.ShippingMethod;
			import com.efi.printsmith.data.TaxTable;
			import com.efi.printsmith.data.TaxCodes;
			import com.efi.printsmith.data.SpecialInstructions;
			import com.efi.printsmith.data.Job;
			import com.efi.printsmith.data.Users;
			import com.efi.printsmith.data.PreferencesEstimating;
			
			import flash.geom.Matrix;
			import com.efi.printsmith.data.Account;
			import mx.controls.Alert;
			import mx.rpc.Responder;
			import mx.managers.PopUpManager;
			import mx.containers.TitleWindow;
			import mx.collections.ArrayCollection;
			import mx.rpc.events.ResultEvent;
			import mx.rpc.events.FaultEvent;
			import mx.messaging.messages.AsyncMessage;
			import mx.messaging.messages.IMessage;
			import mx.printing.FlexPrintJob;
			import mx.printing.PrintAdvancedDataGrid;
			import mx.printing.PrintDataGrid;
			import mx.core.Application;
			import mx.validators.Validator;
			import mx.events.ValidationResultEvent;
			import mx.effects.easing.Back;
			
			public static var EDITINVOICE:String = "{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Invoice')}";
			public static var EDITESTIMATE:String = "{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Estimate')}";
			
			private var accounts:ArrayCollection=new ArrayCollection();
		    
		    [Embed("../../../../assets/file.png")] 
		    private var saveIcon: Class; 

		    [Embed("../../../../assets/notePadNoNotes.png")] 
		    private var notepadIcon: Class; 

		    [Embed("../../../../assets/new_job.png")] 
		    private var newJobIcon: Class; 

		    [Embed("../../../../assets/delete.png")] 
		    private var cancelIcon: Class; 

		    [Embed("../../../../assets/tickets.png")] 
		    private var ticketIcon: Class; 

		    [Embed("../../../../assets/print.png")] 
		    private var printIcon: Class; 

		    [Embed("../../../../assets/preview.png")] 
		    private var previewIcon: Class; 
    
    	    [Embed("../../../../assets/invoiceCosting.png")] 
		    private var invoiceCostingIcon: Class; 
      
    	    [Embed("../../../../assets/change_account.png")] 
		    private var accountIcon: Class; 

			[Bindable]
			public var invoice:InvoiceBase = null;
			[Bindable]
			private var loginUser:Users;
			[Bindable]
			private var salesReps:ArrayCollection=new ArrayCollection();
			[Bindable]
			private var holdStates:ArrayCollection=new ArrayCollection();

			[Bindable]
			private var accountcontacts:ArrayCollection=new ArrayCollection();
			
		    [Bindable] private var loadComponent:CommonLoadComponent;

			[Bindable]
			private var shippingMethods:ArrayCollection=new ArrayCollection();

			[Bindable]
			private var invoiceTemplates:ArrayCollection=new ArrayCollection();
			
			private var editorType:String = EDITINVOICE;
			
			private var isEstimate:Boolean = false;
			
			[Bindable] private var multiQtyJobPresent:Boolean = false;
			
			private var selectedJobIndex:int=0;
			
			private var radioButtonGroupList:ArrayCollection = new ArrayCollection();
			
			private var resetJobsList:Boolean = true;
			
			public var convertedEstimatedId:int=0;
			
			private var preferencesEstimating:PreferencesEstimating;
			private var preferencesAccounting:PreferencesAccounting;
			private var deletedJobs:ArrayCollection = null;
			
			
//			private var newContact:Boolean = false;
//			private var tempContactId:Number = -1;
			public var contactNew:Contact = null;
			public var contactTemp:Contact = null;
			public var selectedContact:Contact = null;
						
			[Bindable] private var deliveryTicketJobsList:ArrayCollection = new ArrayCollection();
			
			private var randomNumber:Number;
			
			private var windowRef:MDIWindow;
			
			[Bindable] public var preferencesStocks:PreferencesStocks;
			
			private var onLoad:Boolean = true;
			
			[Bindable] private var originalInvoice:InvoiceBase;
									
			public function getSecurityCommand():String {
				
				if ((invoice != null) && (invoice is Estimate))
					return PSSecurityCommands.INVOICE_CREATEESTIMATE;
				else 
					return PSSecurityCommands.INVOICE_CREATEINVOICE;
			}
		
		
			public function init(event:FlexEvent = null):void
			{
				windowRef = Snowmass.getInstance().containerManager.getWindowWithChild(this, true);
				
				// create toolbar buttons
				createToolbarButtons();
				this.showJobs();
				
				randomNumber = Math.random();
				if (invoice == null) {
				
					invoice=new Invoice();
					invoice.takenBy=Snowmass.getInstance().currentUser.name;
					invoice.onPendingList = true;
	

					doAccountPicker();

					
					
					
				} else {
	
					if (invoice is Estimate)
						editorType = EDITESTIMATE;
					
					if (editorType == EDITESTIMATE) {
						this.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Estimate');
				//		this.name = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Estimate');
						this.label = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Estimate');
					} else {
						this.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Invoice');
				//		this.name = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Invoice');
						this.label = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Invoice');
					}
					
					if (invoice.id > 0) {
						dataService.getInvoice(invoice.id);
						dataService.getDeliveryTicketJobsByInvoice(invoice.id);
						if (editorType == EDITESTIMATE) {
							this.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.Estimate')+": "+invoice.invoiceNumber;
						} else {
							this.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.Invoice')+": "+invoice.invoiceNumber;
						}
					} else {
						if (editorType == EDITESTIMATE) {
							this.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.Estimate')+": "+resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.new');
						} else {
							this.title = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.Invoice')+": "+resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.new');
						}
						
						if (invoice.account == null)
							doAccountPicker();
					} 
									
					windowRef.title = this.title;
  					
  					if (invoice.notes != null)	{
  						lblHasNotes.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.HasNotes');
  						if ( invoice.notes.showOnOpen) {
  							doNotepad();
  						}
  					}
  					
  					if (invoice.deposits != null)	{
  						doDepositLabels();
  					}
  					
				}
				
				
				if (invoice.jobs == null) {
					invoice.jobs=new ArrayCollection();
				}
				
				if (invoice.charges == null) {
					invoice.charges=new ArrayCollection();
				}
				if(!invoice.onPendingList){
					Alert.show(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'msg_Thisdocumentislocked'));
				}
				
				if (isNaN(invoice.id))	{
					InvoicePricing.calculateTotals(invoice,InvoicePricing.ALL);	
				}
				
				prefStocksDataService.getSingle("PreferencesStocks");
				
				invoiceRepositoryService.getItemList();
				var eventJobs:InvoiceJobsEvent = new InvoiceJobsEvent(toolbar.getButton("new_job_button0"),new mx.rpc.Responder(handleUIButtonEvent, handleUIButtonFault));
				eventJobs.dispatch();
				var eventCharges:InvoiceChargesEvent = new InvoiceChargesEvent(toolbar.getButton("new_job_button"),new mx.rpc.Responder(handleUIButtonEvent, handleUIButtonFault));
				eventCharges.dispatch();
			}
			
			private function openAccountInfo():void	{
				
			}
		
			
			private function handleSaveWalkInAcct(event:ResultEvent):void	{
				var a:Account = event.result as Account;
				invoice.account = a;
				if (contactTemp != null)	{
					contactTemp.parentAccount = a;
					tempContactDataService.addUpdate(contactTemp);
				}
				else	{
					dataService.saveInvoice(invoice);	
				}
				
			}

			private function saveNewContactResult(evt:ResultEvent):void	{
				var currentContact:Contact = selectedContact;
				if (currentContact["newFlag"] == true)	{
					invoice.contact = evt.result as Contact;
					dataService.saveInvoice(invoice);
				}
			}
			private function saveTempContactResult(evt:ResultEvent):void	{
				invoice.contact = evt.result as Contact;
				dataService.saveInvoice(invoice);
			}
			private function createToolbarButtons():void	{
				var ac:ArrayCollection = new ArrayCollection();
				
				var tb:ToolbarButton = new ToolbarButton(
									"file_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Save'),
									saveIcon, doSave);
				tb.enabled = invoice.onPendingList;
				
				ac.addItem(tb);
				
				tb = new ToolbarButton(
									"cancel_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Cancel'),
									cancelIcon,doCancel);
				ac.addItem(tb);
				
				tb = new ToolbarButton(
									"note_pad_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rStandardMenuText.NotePad'),
									notepadIcon,doNotepad);
				ac.addItem(tb); 
				
				tb = new ToolbarButton(
									"new_job_button0", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'jobCmd.NewJob'),
									newJobIcon,doNewJob);
				ac.addItem(tb); 
				
				tb = new ToolbarButton(
									"new_job_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'changePriceCmd.NewCharges'),
									newJobIcon,doNewCharge);
				ac.addItem(tb); 
				
				tb = new ToolbarButton(
									"change_account_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rStandardMenuText.AccountInfo'),
									accountIcon,doAccountPicker);
				ac.addItem(tb); 
				
				tb = new ToolbarButton(
									"tickets_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Tickets'),
									ticketIcon,doTickets);
				ac.addItem(tb); 
				
				tb = new ToolbarButton(
									"print_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Print'),
									printIcon,doPrint);
				ac.addItem(tb); 
				
				tb = new ToolbarButton(
									"preview_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Preview'),
									previewIcon,null);
				ac.addItem(tb); 
				
				tb = new ToolbarButton(
									"costing_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rButtonLabel.Costing'),
									invoiceCostingIcon,showCosting);
				
				ac.addItem(tb); 
				
				tb = new ToolbarButton(
									"jobs_button", 
									resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'rStandardMenuText.Jobs'),
									invoiceCostingIcon,showJobs);
				ac.addItem(tb); 
				
				toolbar.buttons  = ac;
			}		
			public function openTrackerStatus():void {
				if(invoice!=null && !isNaN(invoice.id) && invoice.id!=0){
					var trackerStatusView:TrackerStatusView = PopUpManager.createPopUp(this,TrackerStatusView,true) as TrackerStatusView;
					trackerStatusView.releasedToProduction = invoice.releasedToProduction;
					trackerStatusView.invoiceId = invoice.id;
					trackerStatusView.addEventListener(TrackerStatusUpdateEvent.CLOSE_EVENT,function(event:TrackerStatusUpdateEvent):void {
						if(invoice!=null){
							if(invoice.jobs!=null && invoice.jobs.length>0){
								for each(var jobBaseObj:JobBase in invoice.jobs){
									jobBaseObj.releasedToProduction = event.releasedToProduction;
								}
							}
							invoice.releasedToProduction = event.releasedToProduction;
						}
						
					});
				}
			}
			
			public function cancelDocument():void {
				var warningString:String = "";
				var invoiceString:String = "";
				if(invoice is Invoice) {
					invoiceString = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'rStandardMenuText.Invoice');
				} else if(invoice is Estimate) {
					invoiceString = resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.Estimate');
				}
				if(!invoice.voided) {
					warningString = StringUtil.substitute(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'msg_Oktovoid0'),invoiceString);
					Alert.show(warningString, resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'webDataCmd.Warning'), Alert.YES|Alert.NO, Application.application as Application, confirmVoidDocumentHandler, null, Alert.NO);
				} else if(invoice.voided) {
					warningString = StringUtil.substitute(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'msg_Oktodelete0'),invoiceString);
					Alert.show(warningString, resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'webDataCmd.Warning'), Alert.YES|Alert.NO, Application.application as Application, confirmDeleteDocHandler, null, Alert.NO);
				}
			}
			
			private function confirmVoidDocumentHandler(event:CloseEvent):void {
				if(event.detail == Alert.YES) {
					mapToInvoiceData();
					invoice.voided = true;
					invoice.onPendingList = false;
					invoice.offPendingDate = new Date();
					dataService.saveInvoice(invoice);
				}
			}
			
			private function confirmDeleteDocHandler(event:CloseEvent):void {
				if(event.detail == Alert.YES) {
					if(invoice is Invoice) {
						dataService.deleteItem("Invoice",invoice.id);
					} else if(invoice is Estimate) {
						dataService.deleteItem("Estimate",invoice.id);
					}
				}
			}
			
			public function convertToInvoice():void {
				if(invoice!=null && invoice is Estimate){ 
					if(invoice.onPendingList){
						invoiceService.convertToInvoice(invoice);
					}
				}
			} 
			
			public function copyToNewInvoice():void {
				if(invoice!=null){
					invoiceService.copyToNewInvoice(invoice);
				}
			} 
			
			public function copyToNewEstimate():void {
				if(invoice!=null){
					invoiceService.copyToNewEstimate(invoice);
				}
			} 
			
			private function handleLoadAccountsResult(ev:ResultEvent):void {
				accounts = ev.result as ArrayCollection;
				doAccountPicker();
			}
			public function handleLoadInvoiceTemplates(evt:ResultEvent):void {
				if (evt.result != null) {
					invoiceTemplates = evt.result as ArrayCollection;
				}
			}
			public function handleUIButtonEvent(evt:ResultEvent):void {
				evt.result.button.enabled = evt.result.enabled;
			}		
			private function handleUIButtonFault(ev:FaultEvent):void {  
			}

			public function getEditorType():String
			{
				return this.editorType;
			}
			
			public function setEditorType(editorType:String):void
			{
				if (editorType == EDITINVOICE || editorType == EDITESTIMATE) {
					this.editorType = editorType;
					if (editorType == EDITINVOICE) {
						this.invoice = new Invoice();
						this.invoice.takenBy=Snowmass.getInstance().currentUser.name;
						invoice.onPendingList = true;
						
					} else if (editorType == EDITESTIMATE) {
						this.invoice = new Estimate();
						this.invoice.takenBy=Snowmass.getInstance().currentUser.name;
						invoice.onPendingList = true;
						
					}
				}
			}
			
			public function setInvoice(invoice:InvoiceBase):void
			{
				this.invoice=invoice;
				dataService.getInvoice(invoice.id);
			}

			public function getInvoice():InvoiceBase
			{
				return this.invoice;
			}

			private function handleLoadInvoice(event:ResultEvent):void {
				this.invoice = event.result as InvoiceBase;
				
					
				if(invoice.jobs!=null) {
					for each(var jobBaseObj:JobBase in invoice.jobs) {
						jobBaseObj.originalQty = jobBaseObj.qtyOrdered;
						if(jobBaseObj.costingRecord!=null) {
							jobBaseObj.costingRecord.originalTotalCost = jobBaseObj.costingRecord.actualTotalCost;
						}
						if(jobBaseObj.pricingRecord!=null) {
							jobBaseObj.pricingRecord.originalPrice = jobBaseObj.pricingRecord.totalPrice;
						}
						
						if(jobBaseObj.charges!=null) {
							for each(var chargeObj:Charge in jobBaseObj.charges) {
								chargeObj.originalPrice = chargeObj.price;
								chargeObj.originalQty = chargeObj.quantity;
							}
						}
					}
				}
				
				if(invoice.charges!=null) {
					for each(var chargeObj:Charge in invoice.charges) {
						chargeObj.originalPrice = chargeObj.price;
						chargeObj.originalQty = chargeObj.quantity;
					}
				}
				updateTotals();
				setOriginalInvoice();
			}
			
			private function handleLoadResult(event:Event):void
			{

			}
			
		
			private function handleSaveResult(ev:ResultEvent):void
			{
				var convertedEstimate:Boolean = false;
				this.invoice = ev.result as InvoiceBase;
				//this.parent.removeChild(this);
				if(invoice is Invoice){
					if(convertedEstimatedId!=0){
						convertedEstimate = true;
						dataServiceEstimate.getInvoice(convertedEstimatedId);
					}
					if(!convertedEstimate){
						openConfirmationComponent(StringUtil.substitute(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'CommonConfirmation.SAVE'),resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.Invoice')));
					}
				} else if(invoice is Estimate){
					openConfirmationComponent(StringUtil.substitute(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'CommonConfirmation.SAVE'),resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.Estimate')));
				}
				if(!convertedEstimate){
					setOriginalInvoice();
					dispatchEvent(new PendingListUpdateEvent(PendingListUpdateEvent.PENDINGLIST_UPDATE_EVENT,true));
					Snowmass.getInstance().containerManager.getWindowWithChild(this,true).closeWindow();
				}
			}
			
			private function handleEstimateLoadResult(event:ResultEvent):void {
				var estimateObj:InvoiceBase = event.result as InvoiceBase;
				estimateObj.status = "Won";
				estimateObj.onPendingList = false;
				estimateObj.offPendingDate = new Date();
				estimateObj.convertedInvoiceNo = this.invoice.invoiceNumber;
				dataServiceEstimate.saveInvoice(estimateObj);
			}
			
			private function handleEstimateSaveResult(event:ResultEvent):void {
				setOriginalInvoice();
				openConfirmationComponent(StringUtil.substitute(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'CommonConfirmation.SAVE'),resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.Invoice')));
				dispatchEvent(new PendingListUpdateEvent(PendingListUpdateEvent.PENDINGLIST_UPDATE_EVENT,true));
				Snowmass.getInstance().containerManager.getWindowWithChild(this,true).closeWindow();
			}
			
			private function handleCreateInvoiceResult(ev:ResultEvent):void
			{
				this.invoice = ev.result as InvoiceBase;
				this.editorType = EDITINVOICE;
			}
			
			private function handleConvertInvoiceResult(event:ResultEvent):void {
				if(event.result is Invoice){
					var convertedInvoice:Invoice = event.result as Invoice;
					convertedInvoice.invoiceNumber = "";
					convertedEstimatedId = convertedInvoice.id;
					convertedInvoice.id=0;
					convertedInvoice.created = null;
					convertedInvoice.modified = null;
					convertedInvoice.releasedToProduction = false;
					/* var jobBaseList:ArrayCollection = new ArrayCollection();
					for each(var jobBaseObj:JobBase in convertedInvoice.jobs) {
						if(jobBaseObj.defaultJob){
							jobBaseObj.id = 0;
							jobBaseObj.created = null;
							jobBaseObj.modified = null;
							jobBaseObj.multiQtyJob = false;
							jobBaseObj.parentInvoice = convertedInvoice;
							jobBaseObj.releasedToProduction = false;
							if(jobBaseObj.charges!=null && jobBaseObj.charges.length>0){
								for each(var chargeObject:Charge in jobBaseObj.charges) {
									chargeObject.id=0;
									chargeObject.created = null;
									chargeObject.modified = null;
									chargeObject.parentJob = jobBaseObj;
								}
							}
							jobBaseList.addItem(jobBaseObj);
						}
					}
					convertedInvoice.jobs = jobBaseList;
					for each(var chargeObj:Charge in convertedInvoice.charges) {
						chargeObj.id=0;
						chargeObj.created = null;
						chargeObj.modified = null;
						chargeObj.parentInvoice = convertedInvoice;
					} */
					if (convertedInvoice.jobs != null && convertedInvoice.jobs.length > 0) {
						var i:int;
						convertedInvoice.subTotal = 0;
						for (i=0; i<convertedInvoice.jobs.length; i++) {
							var tmpJob:Job = convertedInvoice.jobs.getItemAt(i) as Job;	
							convertedInvoice.subTotal += tmpJob.pricingRecord.totalPrice;
							if(tmpJob.charges!=null) {
								for each(var chargeObj:Charge in tmpJob.charges) {
									convertedInvoice.subTotal += chargeObj.price;
								}
							}
						}
					}
					if(convertedInvoice.charges!=null) {
						for each(var chargeObj:Charge in convertedInvoice.charges) {
							convertedInvoice.subTotal += chargeObj.price;
						}
					}
					convertedInvoice.grandTotal = convertedInvoice.subTotal;
					convertedInvoice.amountDue = convertedInvoice.grandTotal;
					setOriginalInvoice();
					dispatchEvent(new ConvertToInvoiceEvent(ConvertToInvoiceEvent.CONVERT_TO_INVOICE_EVENT,convertedInvoice,convertedEstimatedId));
					Snowmass.getInstance().containerManager.getWindowWithChild(this,true).closeWindow();
				}
			}
			
			private function handleCopyToNewInvoiceResult(event:ResultEvent):void {
				if(event.result is Invoice){
					var newInvoice:Invoice = event.result as Invoice;
					newInvoice.invoiceNumber = "";
					newInvoice.releasedToProduction = false;
					/* for each(var chargeObj:Charge in newInvoice.charges) {
						chargeObj.id=0;
						chargeObj.created = null;
						chargeObj.modified = null;
						chargeObj.parentInvoice = newInvoice;
					} */
					if (newInvoice.jobs != null && newInvoice.jobs.length > 0) {
						var i:int;
						newInvoice.subTotal = 0;
						for (i=0; i<newInvoice.jobs.length; i++) {
							var tmpJob:Job = newInvoice.jobs.getItemAt(i) as Job;	
							newInvoice.subTotal += tmpJob.pricingRecord.totalPrice;
							if(tmpJob.charges!=null) {
								for each(var chargeObj:Charge in tmpJob.charges) {
									newInvoice.subTotal += chargeObj.price;
								}
							}
						}
					}
					if(newInvoice.charges!=null) {
						for each(var chargeObj:Charge in newInvoice.charges) {
							newInvoice.subTotal += chargeObj.price;
						}
					}
					newInvoice.grandTotal = newInvoice.subTotal;
					newInvoice.amountDue = newInvoice.grandTotal;
					dispatchEvent(new CopyToNewInvoiceEvent(CopyToNewInvoiceEvent.COPY_TO_NEWINVOICE_EVENT,newInvoice));
					//Snowmass.getInstance().containerManager.getWindowWithChild(this).closeWindow();
				}
			} 
			
			private function handleCopyToNewEstimateResult(event:ResultEvent):void {
				if(event.result is Estimate){
					var newEstimate:Estimate = event.result as Estimate;
					newEstimate.invoiceNumber = "";
					newEstimate.releasedToProduction = false;
					/* for each(var chargeObj:Charge in newEstimate.charges) {
						chargeObj.id=0;
						chargeObj.created = null;
						chargeObj.modified = null;
						chargeObj.parentInvoice = newEstimate;
					} */
					if (newEstimate.jobs != null && newEstimate.jobs.length > 0) {
						var i:int;
						newEstimate.subTotal = 0;
						for (i=0; i<newEstimate.jobs.length; i++) {
							var tmpJob:Job = newEstimate.jobs.getItemAt(i) as Job;	
							newEstimate.subTotal += tmpJob.pricingRecord.totalPrice;
							if(tmpJob.charges!=null) {
								for each(var chargeObj:Charge in tmpJob.charges) {
									newEstimate.subTotal += chargeObj.price;
								}
							}
						}
					}
					if(newEstimate.charges!=null) {
						for each(var chargeObj:Charge in newEstimate.charges) {
							newEstimate.subTotal += chargeObj.price;
						}
					}
					newEstimate.grandTotal = newEstimate.subTotal;
					newEstimate.amountDue = newEstimate.grandTotal;
					dispatchEvent(new CopyToNewEstimateEvent(CopyToNewEstimateEvent.COPY_TO_NEWESTIMATE_EVENT,newEstimate));
					//Snowmass.getInstance().containerManager.getWindowWithChild(this).closeWindow();
				}
			} 
			

			private function handleDeleteResult(event:Event):void
			{
				setOriginalInvoice();
				dispatchEvent(new PendingListUpdateEvent(PendingListUpdateEvent.PENDINGLIST_UPDATE_EVENT,true));
				Snowmass.getInstance().containerManager.getWindowWithChild(this,true).closeWindow();
			}

			private function handleFault(ev:FaultEvent):void {  
				if(loadComponent) {
					loadComponent.close();
				}                
				// TODO: This needs to be restored once the hibernate issues are figured out 3/23/2010
//				var message:String;
//				
//				message = "Error: "                          
//				+ ev.fault.faultCode + " - "                                  
//				+ ev.fault.faultDetail + " - "                                  
//				+ ev.fault.faultString;
//				Alert.show(message, "Error");                                 
			}

			private function validateForm(event:Event):void
			{
//        focussedFormControl = event.target as DisplayObject;    
//
//        formIsValid = true;            
			}

			private function validate(validator:Validator):Boolean
			{
//        var validatorSource:DisplayObject = validator.source as DisplayObject;
//     	var suppressEvents:Boolean = (validatorSource != focussedFormControl);
//        var event:ValidationResultEvent = validator.validate(null, suppressEvents); 
//        var currentControlIsValid:Boolean = (event.type == ValidationResultEvent.VALID);
//		formIsValid = formIsValid && currentControlIsValid;
//         
//		return currentControlIsValid;
				return true;
			}

			public function mapToInvoiceData():void
			{
				
				var si:SpecialInstructions = null;
				if (invoice.specialInstructions != null)	{
					si = invoice.specialInstructions;					
				}
				else	{
					si = new SpecialInstructions();
				}
				si.instructions = special_instructions_edit.text;
				invoice.specialInstructions=si;
				
			}

			public function doSave(ev:MouseEvent=null):void
			{
				mapToInvoiceData();
				var doInvoiceLater:Boolean = false;
				
				if (invoice.account != null)	{				
					if (invoice.account.walkIn)	{
						dataService.addUpdate(invoice.account);
						doInvoiceLater = true;
					}
					if (contactTemp != null && selectedContact.tempFlag)	{
						if (!invoice.account.walkIn)	{
							tempContactDataService.addUpdate(contactTemp);
							doInvoiceLater = true;
						}
					}
					
					if (contactNew != null)	{
						newContactDataService.addUpdate(contactNew);
						doInvoiceLater = true;
					}
				}
								
				if (!doInvoiceLater)
					dataService.saveInvoice(invoice);
					
				if(deletedJobs!=null) {
					for (var i:int = 0; i < this.deletedJobs.length; i++) {
						dataService.deleteItem("Job", (deletedJobs.getItemAt(i) as Number));
					}
				}
				
			}

			public function doGet():void
			{

			}

			public function doNew(ev:MouseEvent=null):void
			{

			}

			public function doCancel(ev:MouseEvent=null):void
			{
				//this.parent.removeChild(this);
				setOriginalInvoice();
				Snowmass.getInstance().containerManager.getWindowWithChild(this,true).closeWindow();
			}

	
			private function doNewJob(ev:MouseEvent=null):void
			{
				var editJobWindow:EditJob= new EditJob(); //EditJob(PopUpManager.createPopUp(this, EditJob, true));
				editJobWindow.invoice = this.invoice;
				//editJobWindow.setStyle("borderAlpha", 0.9);
				var windowID:int = Snowmass.getInstance().containerManager.getWindowWithChild(this,true).windowID;
				Snowmass.getInstance().containerManager.openNewMDIWindow(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'jobCmd.NewJob'),editJobWindow, -1,-1,-1,-1, windowID);
				editJobWindow.addEventListener(JobEditCompleteEvent.SAVE, addNewJob);
				editJobWindow.addEventListener(JobEditCompleteEvent.DELETE, deleteJob);
			} 
			
			
			private function doNewCharge(ev:MouseEvent=null):void {
				var chargePicker:ChargePicker=ChargePicker(PopUpManager.createPopUp(this, ChargePicker, true));
				chargePicker.charges = this.invoice.charges;
				chargePicker.setStyle("borderAlpha", 0.9);
				chargePicker.addEventListener(ChargeDefinitionSelectEvent.CHARGEDEFINITIONCOMPLETE, handleChargeDefinitionComplete,false,0,true);
			}
			
			private function handleChargeDefinitionComplete(evt:ChargeDefinitionSelectEvent):void {
				this.invoice.charges=evt.chargeArray;
				for each(var chargeObj:Charge in invoice.charges) {
					chargeObj.originalPrice = chargeObj.price;
					chargeObj.originalQty = chargeObj.quantity;
				}
				//this.updatePrice();
			}

			private function deleteJob(event:Event):void {
				var target:EditJob=event.target as EditJob;
				var deletedJob:Job = target.job as Job;
				
				var jobsList:ArrayCollection = invoice.jobs;
				
				if (jobsList != null) {
					for (var i:int=0; i < jobsList.length; i++) {
						if (jobsList.getItemAt(i).id == deletedJob.id) {
							jobsList.removeItemAt(i);
						}
					}
				}

				invoice.jobs = jobsList;
				
				updateTotals();
				this.showJobs();
				
				if (this.deletedJobs == null) {
					this.deletedJobs = new ArrayCollection();
				}
				
				this.deletedJobs.addItem(deletedJob.id);
			}
			
			private function addNewJob(event:JobEditCompleteEvent):void {
				var target:EditJob=event.target as EditJob;
				
				var jobsList:ArrayCollection = new ArrayCollection();
				
				jobsList = invoice.jobs;

				if (target.job != null && !invoice.jobs.contains(target.job))
				{
					jobsList.addItem(target.job);
				}
				
				if(target.invoiceMultiQtyJobList!= null && target.invoiceMultiQtyJobList.length>0){
					for each(var multiQtyJobObject:Job in target.invoiceMultiQtyJobList){
						jobsList.addItem(multiQtyJobObject);
					}
				}
				
				invoice.jobs = jobsList;
				
				if(event.updateLocationDate) {
					invoice.locationChangeDate = new Date();
				}
				
				/* Hack code - needs to come out in favor of using the Pricing Engine asap */
				updateTotals();
				this.showJobs();
			}
	
			private function saveJob(event:JobEditCompleteEvent):void
			{
				var target:EditJob=event.target as EditJob;

//				if (target.job != null && !invoice.jobs.contains(target.job))
//				{
//					invoice.jobs.addItem(target.job);
//				}
				
				/* Hack code - needs to come out in favor of using the Pricing Engine asap */
				if(!target.job.multiQtyJob){
					var jobList:ArrayCollection = new ArrayCollection();
					for each(var jobBaseObj:JobBase in invoice.jobs){
						var checkFlag:Boolean = false;
						if(target.job.jobGroup!=0 && jobBaseObj.jobGroup==target.job.jobGroup && jobBaseObj.multiQtyJob){
							checkFlag = true;
						}
						if(!checkFlag){
							jobList.addItem(jobBaseObj);
						}
					}
					for each(var jobBaseObject:JobBase in target.invoiceMultiQtyJobList){
						jobList.addItem(jobBaseObject);
					}
					for each(jobBaseObject in target.multiQtyJobList){
						jobList.addItem(jobBaseObject);
					}
					invoice.jobs = jobList;
				}
				var updatedJobList:ArrayCollection = new ArrayCollection();
				for(var i:int=0;i<invoice.jobs.length;i++) {
					var tempJobBaseObj:JobBase = invoice.jobs.getItemAt(i) as JobBase;
					if(!isNaN(target.job.id) && target.job.id!=0){
						if(tempJobBaseObj.id == target.job.id){
							registerClassAlias("com.efi.printsmith.data.JobBase",JobBase);
							tempJobBaseObj = ObjectUtil.copy(target.job) as JobBase;
						}
					} else {
						if(tempJobBaseObj.jobIndex == target.job.jobIndex){
							registerClassAlias("com.efi.printsmith.data.JobBase",JobBase);
							tempJobBaseObj = ObjectUtil.copy(target.job) as JobBase;
						}
					}
					
					updatedJobList.addItem(tempJobBaseObj);
				}
				invoice.jobs = updatedJobList;
				
				if(event.updateLocationDate) {
					invoice.locationChangeDate = new Date();
				}
				
				updateTotals();
				
				this.showJobs();
			}

			private function showCosting(event:MouseEvent=null):void
			{
				job_costing_stack.selectedChild=this.invoice_cost_canvas;
				bottomrightstack.selectedChild = cost_info_canvas;
			}

			private function showJobs(event:MouseEvent=null):void
			{
				job_costing_stack.selectedChild=this.invoice_job_canvas;
				bottomrightstack.selectedChild = job_info_canvas;
				
//				if (editorType == EDITESTIMATE) {
//					this.createInvoice.visible = true;
//				}
//				invoice_job_grid.dataProvider = getJobList(invoice.jobs);
//				invoice_job_grid.validateNow();
			}
			
			public function doCreateInvoice():void
			{
				var selectedJob:Job = invoice_job_grid.selectedItem as Job;
				estimatorService.createInvoiceFromEstimate(this.invoice,Job);
			}
			
			// called from init - for existing invoice
			// called from 	handleaccountpickerselect - when account is selected or changed
				
				
//				this.accountcontacts.removeAll();
//				if (accountItem.contact != null)
//					this.accountcontacts.addItem(accountItem.contact);
//				if (accountItem.billToContact != null && accountItem.billToContact != accountItem.contact)
//					this.accountcontacts.addItem(accountItem.billToContact);
//				contact_list.selectedItem=invoice.account.contact as Contact;
			
			

			private function doNotepad(ev:MouseEvent=null):void
			{
				var titleWindow:NotePadEditor=NotePadEditor(PopUpManager.createPopUp(this, NotePadEditor, true));
				titleWindow.setStyle("borderAlpha", 0.9);
				if (invoice.notes == null){
					invoice.notes = new NotePad();
				}
				titleWindow.SetNote(invoice.notes.id, invoice)
				titleWindow.addEventListener(InvoiceNotesAddedEvent.INVOICENOTESADDED,onNotesAdded);
			}
			
			private function isNotePadEmpty(notes:NotePad):Boolean	{
				if (notes.notesWho == "" && notes.phoneNumber == "" && notes.notesWhat ==""
					&& notes.howMany == "" && notes.whatSize =="" 
					&& notes.paper == "" && notes.notes == "" 
					&& notes.notesWhen == "")
					return true;
				else
					return false;
			}
			private function onNotesAdded(evt:InvoiceNotesAddedEvent):void	{
				if (isNotePadEmpty(evt.notes))	
					lblHasNotes.text = "";
				else
					lblHasNotes.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, "newInvCmd.HasNotes");
			}
			
			private function doTickets(ev:MouseEvent=null):void
			{
				if (isNaN(invoice.id)) {
					Alert.show("You must save the Invoice before printing", "Error");
				} else {
					var reportName:String = "jobTicket.rpt";
					var urlRequest:URLRequest = new URLRequest("http://localhost:8080/Snowmass/reportservlet?invoiceTicket="+reportName +"&reportParameter="+invoice.id);
                	navigateToURL(urlRequest, "_blank");
				}
			}

			public function toggleCosting():void
			{
				if (job_costing_stack.selectedChild == invoice_job_canvas)
				{
					job_costing_stack.selectedChild=invoice_cost_canvas;
				}
				else
				{
					job_costing_stack.selectedChild=invoice_job_canvas;
				}
			}

			private function findItem(name:String, array:ArrayCollection):int
			{
				for each (var element:Object in array)
				{
					if (name == element.name)
					{
						return array.getItemIndex(element);
					}
				}
				return -1;
			}

			private function findItemIndex(array:ArrayCollection, item:ModelBase):int	{
				for (var i:int=0;i<array.length;i++)	{
					var obj:ModelBase = array.getItemAt(i) as ModelBase;
					if (obj.id == item.id)	{
						return i;	
					}
				}
				return -1;
			}
			private function handleGetInvoiceResult(ev:ResultEvent):void{
				invoice = ev.result as InvoiceBase;
				this.invoice.takenBy=Snowmass.getInstance().currentUser.name;
						
				
			}
			private function doAccountPicker(evt:MouseEvent = null):void
			{
				var thisWin:MDIWindow = Snowmass.getInstance().containerManager.getWindowWithChild(this, true);
				var ac:ArrayCollection = Snowmass.getInstance().containerManager.getChildrenOfWindow(thisWin.windowID);
				
				if (ac != null)	{
					for (var i:int=0; i<ac.length; i++)	{
						var win:MDIWindow = ac.getItemAt(i) as MDIWindow;
						if (win.content.className.indexOf("EditInvoiceAccountInfo") > -1)	{
							win.bringWindowToFront();
							return;
						}  
					}
				}
								
				var accInfoRef:EditInvoiceAccountInfo = new EditInvoiceAccountInfo();
				accInfoRef.parentInvoice = invoice;
				accInfoRef.invWindow = this;
				
				//accInfo.addEventListener(DepositEntryAddedEvent.DEPOSITENTRYADDED, onDepEntryAdded,false, 0, true);
				var winId:int = Snowmass.getInstance().containerManager.getWindowWithChild(this, true).windowID;
				Snowmass.getInstance().containerManager.openNewMDIWindow(resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'custDataCmd.AccountInfo'), accInfoRef,-1,-1,-1,-1,winId);
				
			}


			
			
			private function handleLoadJobForEdit(evt:ResultEvent):void {
				var selectedJob:Job = evt.result as Job;
				
				if (selectedJob != null) {
					selectedJob.jobIndex = selectedJobIndex;
					//invoice.jobs.setItemAt(selectedJob, invoice_job_grid.selectedIndex);
					//invoice_job_grid.selectedItem = selectedJob;
					openEditJobWindow(selectedJob);
				}	
			}
			
			private function doDoubleclickInvoiceItem():void {
				if(invoice_job_grid.selectedIndex>-1 && invoice_job_grid.selectedItem!=null && invoice_job_grid.selectedItem is Job){
					var selectedJob:Job = invoice_job_grid.selectedItem as Job;
					selectedJobIndex = selectedJob.jobIndex;
					//Commented to not to retrieve the job from DB 
					/* if (selectedJob.id != 0) { // this job had been persisted previously	
						dataService.getJob(selectedJob.id);
					} else {
						openEditJobWindow(selectedJob);
					} */
					openEditJobWindow(selectedJob);
				} else if(invoice_job_grid.selectedIndex>-1 && invoice_job_grid.selectedItem!=null && invoice_job_grid.selectedItem is Charge){
					var selectedCharge:Charge = invoice_job_grid.selectedItem as Charge;
					var editChargeWindow:EditCharge = PopUpManager.createPopUp(this,EditCharge,true) as EditCharge;
					editChargeWindow.setCharge(selectedCharge);
					if(selectedCharge.parentJob!=null) {
						editChargeWindow.jobIndex = selectedCharge.jobIndex;
					}
					editChargeWindow.addEventListener(UpdateChargeEvent.UPDATECHARGE_EVENT,updateChargeEventHandler,false,0,true);
				} 
			}
			
			private function updateChargeEventHandler(event:UpdateChargeEvent):void {
				if(event.isSave) {
					if(event.jobIndex!=-1){
						for each(var jobObj:JobBase in invoice.jobs) {
							if(jobObj.jobIndex == event.jobIndex) {
								if(jobObj.charges!=null) {
									jobObj.charges.removeItemAt(event.charge.chargeIndex-1);
									jobObj.charges.addItemAt(event.charge,event.charge.chargeIndex-1);
								}
								break;
							}
						}
					} else {
						invoice.charges.removeItemAt(event.charge.chargeIndex-1);
						invoice.charges.addItemAt(event.charge,event.charge.chargeIndex-1);
					}
				} else {
					if(event.jobIndex!=-1){
						for each(var jobObj:JobBase in invoice.jobs) {
							if(jobObj.jobIndex == event.jobIndex) {
								jobObj.charges.removeItemAt(event.charge.chargeIndex-1);
								break;
							}
						}
					} else {
						invoice.charges.removeItemAt(event.charge.chargeIndex-1);
					}
				}
				invoice_job_grid.dataProvider = getJobChargesList(invoice.jobs,invoice.charges);
				updateTotals();
			}
			
			private function updateTotals():void {
				InvoicePricing.calculateTotals(invoice, InvoicePricing.ALL);
//				if (invoice.jobs != null && invoice.jobs.length > 0) {
//					var i:int;
//					invoice.subTotal = 0;
//					var hasMultiQty:Boolean = false;
//					for (i=0; i<invoice.jobs.length; i++) {
//						var jobObj:Job = invoice.jobs.getItemAt(i) as Job;
//						if(jobObj.multiQtyJob) {
//							hasMultiQty = true;
//							break;
//						}
//					}
//					for (i=0; i<invoice.jobs.length; i++) {
//						var tmpJob:Job = invoice.jobs.getItemAt(i) as Job;
//						if(hasMultiQty){
//							if(tmpJob.defaultJob) {
//								invoice.subTotal += tmpJob.pricingRecord.totalPrice;
//								if(tmpJob.charges!=null) {
//									for each(var chargeObj:Charge in tmpJob.charges) {
//										invoice.subTotal += chargeObj.price;
//									}
//								}
//							}
//						} else {	
//							invoice.subTotal += tmpJob.pricingRecord.totalPrice;
//							if(tmpJob.charges!=null) {
//								for each(var chargeObj:Charge in tmpJob.charges) {
//									invoice.subTotal += chargeObj.price;
//								}
//							}
//						}
//					}
//				}
//				if(invoice.charges!=null) {
//					for each(var chargeObj:Charge in invoice.charges) {
//						invoice.subTotal += chargeObj.price;
//					}
//				}
//				invoice.grandTotal = invoice.subTotal;
//				invoice.amountDue = invoice.grandTotal;
			}
		

			private function openEditJobWindow(job:Job):void {
				var editJobWindow:EditJob= new EditJob(); //EditJob(PopUpManager.createPopUp(this, EditJob, true));
				//editJobWindow.setStyle("borderAlpha", 0.9);
				var windowID:int = Snowmass.getInstance().containerManager.getWindowWithChild(this,true).windowID;
				var invoiceNumber:String = "";
				var pricingMethodTitle:String = "";
				if(job.parentInvoice==null || job.parentInvoice.invoiceNumber==null || job.parentInvoice.invoiceNumber==""){
					invoiceNumber = "0";
				} else {
					invoiceNumber = job.parentInvoice.invoiceNumber;
				}
				if(job.pricingMethod==null){
					pricingMethodTitle = "";
				} else {
					pricingMethodTitle = job.pricingMethod.title;
				}
				var jobTitle:String = StringUtil.substitute(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,"jobCmd.EditJob"),invoiceNumber,job.jobIndex,pricingMethodTitle);
				editJobWindow.name = jobTitle;
				var win:MDIWindow = Snowmass.getInstance().containerManager.getWindowWithChild(editJobWindow,false);
				if(win == null) {
					Snowmass.getInstance().containerManager.openNewMDIWindow(jobTitle,editJobWindow, -1,-1,-1,-1, windowID);
					var multiQtyJobList:ArrayCollection = new ArrayCollection();
					if(!job.multiQtyJob){
						for each(var jobBaseObj:JobBase in invoice.jobs) {
							if(job.jobGroup!=0 && jobBaseObj.jobGroup==job.jobGroup && jobBaseObj.multiQtyJob){
								multiQtyJobList.addItem(jobBaseObj);
							} 
						}
					}
					registerClassAlias("com.efi.printsmith.data.Job",Job);
					editJobWindow.setJob(ObjectUtil.copy(job) as Job);
					editJobWindow.invoiceMultiQtyJobList = multiQtyJobList;
					editJobWindow.addEventListener(JobEditCompleteEvent.SAVE, saveJob);
					editJobWindow.addEventListener(JobEditCompleteEvent.DELETE, deleteJob);
				} else {
					win.bringWindowToFront();
				}
				/* var editJobWindow:EditJob=EditJob(PopUpManager.createPopUp(this, EditJob, true));
				editJobWindow.setStyle("borderAlpha", 0.9);
				editJobWindow.setJob(job);
				editJobWindow.addEventListener(JobEditCompleteEvent.SAVE, saveJob); */
			}
			
			private function getEstimatedCost(item:Object, column:DataGridColumn):String {
				var localJob:Job = item as Job;
				var estimatedTotalCost:Number = 0;
				if(localJob != null && localJob.pricingRecord!=null){
					estimatedTotalCost = estimatedTotalCost + ((isNaN(localJob.pricingRecord.laborCost))?0:localJob.pricingRecord.laborCost);
				}
				if(localJob != null && localJob.pricingRecord!=null){
					estimatedTotalCost = estimatedTotalCost + ((isNaN(localJob.pricingRecord.stockCost))?0:localJob.pricingRecord.stockCost);
				}
				return Snowmass.getCurrencyFormatter(false, 2).format(estimatedTotalCost);
			}
			
			private function getActualCost(item:Object, column:DataGridColumn):String {
				var localJob:Job = item as Job;
				var actualTotalCost:Number = 0;
				if(localJob != null && localJob.costingRecord!=null){
					actualTotalCost = ((isNaN(localJob.costingRecord.actualTotalCost))?0:localJob.costingRecord.actualTotalCost);
				}
				return Snowmass.getCurrencyFormatter(false, 2).format(actualTotalCost);
			}
			
			private function getDifferenceValue(item:Object, column:DataGridColumn):String {
				var localJob:Job = item as Job;
				var estimatedTotalCost:Number = 0;
				var actualTotalCost:Number = 0;
				var diffValue:Number = 0;
				var prcntValue:Number = 0;
				if(localJob != null && localJob.pricingRecord!=null){
					estimatedTotalCost = estimatedTotalCost + ((isNaN(localJob.pricingRecord.laborCost))?0:localJob.pricingRecord.laborCost);
				}
				if(localJob != null && localJob.pricingRecord!=null){
					estimatedTotalCost = estimatedTotalCost + ((isNaN(localJob.pricingRecord.stockCost))?0:localJob.pricingRecord.stockCost);
				}
				if(localJob != null && localJob.costingRecord!=null){
					actualTotalCost = ((isNaN(localJob.costingRecord.actualTotalCost))?0:localJob.costingRecord.actualTotalCost);
				}
				diffValue = actualTotalCost - estimatedTotalCost;
				if(actualTotalCost!=0){
					prcntValue = (diffValue/actualTotalCost)*100;
				}
				return Snowmass.getCurrencyFormatter(false, 2).format(diffValue)+" "+ Snowmass.getCurrencyFormatter(false, 0).format(prcntValue)+"%";
			}
			
			public function gridJobPrice(item:Object, column:DataGridColumn):String {
				if(item is Job) {
					var localJob:Job = item as Job;
					if (localJob != null && localJob.pricingRecord != null) {					
						return Snowmass.getCurrencyFormatter(false, 2).format(localJob.pricingRecord.totalPrice.toString());
					} else {
						return "";
					}
				} else if(item is Charge){
					return item.price;
				}
				return "";
			}
			
			public function getNonTaxLabel(item:Object):String {
				if(item is Job) {
					var localJob:Job = item as Job;
					if(!localJob.taxable) {
						return resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.nontax');
					}
				} else if(item is Charge) {
					var localCharge:Charge = item as Charge;
					if(!localCharge.taxable) {
						return resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.nontax');
					}
				}
				return "";
			}
			
			public function getInvoiceIndicator(item:Object):String {
				var indicatorString:String = "";
				if(item is Job) {
					var localJob:Job = item as Job;
					if(localJob.jobNotes!=null && StringUtil.trim(localJob.jobNotes)!="") {
						indicatorString = indicatorString + " ";
					}
					if(!localJob.finished) {
						indicatorString = indicatorString + resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.1');
					}
					if(localJob.brokered) {
						indicatorString = indicatorString + resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.B');
					}
				} else if(item is Charge) {
					var localCharge:Charge = item as Charge;
					if(!localCharge.finished) {
						indicatorString = indicatorString + resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.1');
					}
					if(localCharge.brokered) {
						indicatorString = indicatorString + resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.B');
					}
					if(localCharge.chargeDefinition!=null && localCharge.chargeDefinition.salesCategory!=null) {
						if(localCharge.chargeDefinition.salesCategory.name == "Shipping") {
							indicatorString = indicatorString + "";
						}
					}
				}
				return indicatorString;
			}
			
			public function getJobChargeDescription(item:Object, prefStcoksObj:PreferencesStocks, column:DataGridColumn):String {
				var description:String = "";
				if(item is Job) {
					var localJob:JobBase = item as JobBase;
					description = localJob.description;
					if(localJob.finishSize!=null) {
						description = description + ", " + localJob.finishSize.name;
					}
					if(localJob.stock!=null && localJob.stock.color!=null) {
						description = description + " " + localJob.stock.color.name;
					}
					description = description + " " + getStockName(localJob.stock,prefStcoksObj);
				} else if(item is Charge) {
					if(item.parentInvoice!=null){
						description = item.description;
					} else {
						description = "\t\t\t"+item.description;
					}
				}
				return description;
			}
			
			private function getStockName(stockDefObj:StockDefinition,preferencesStocksObj:PreferencesStocks):String {
				var displayedText:String = "";
				if(preferencesStocksObj!=null){
					if(stockDefObj!=null){
						if(preferencesStocksObj.weight!=null && preferencesStocksObj.weight!=""){
							if(stockDefObj.uom!=null && stockDefObj.uom==resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'stockPickerCmd.Caliper')) {
								displayedText = preferencesStocksObj.weight;
								if(displayedText.indexOf("^0")!=-1) {
									displayedText = displayedText.replace("^0",stockDefObj.weight);
								}
								if(displayedText.indexOf("^1")!=-1) {
									displayedText = displayedText.replace("^1",stockDefObj.name);
								}
								if(displayedText.indexOf("^2")!=-1) {
									if(stockDefObj.finish!=null) {
										displayedText = displayedText.replace("^2",stockDefObj.finish.name);
									} else {
										displayedText = displayedText.replace("^2","");
									}
								}
								if(displayedText.indexOf("^3")!=-1) {
									displayedText = displayedText.replace("^3",getCertifiedText(stockDefObj,preferencesStocksObj));
								}
								if(displayedText==preferencesStocksObj.weight){
									return stockDefObj.name;
								}
								return displayedText;
							}
							return stockDefObj.name;
						} else if(preferencesStocksObj.points!=null && preferencesStocksObj.points!=""){
							if(stockDefObj.uom!=null && (stockDefObj.uom==resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'stockPickerCmd.Points')
								|| stockDefObj.uom==resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'stockPickerCmd.Mils')
								|| stockDefObj.uom==resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'stockPickerCmd.Thous'))) {
									
								displayedText = preferencesStocksObj.points;
								if(displayedText.indexOf("^0")!=-1) {
									displayedText = displayedText.replace("^0",stockDefObj.weight);
								}
								if(displayedText.indexOf("^1")!=-1) {
									displayedText = displayedText.replace("^1",stockDefObj.name);
								}
								if(displayedText.indexOf("^2")!=-1) {
									if(stockDefObj.finish!=null) {
										displayedText = displayedText.replace("^2",stockDefObj.finish.name);
									} else {
										displayedText = displayedText.replace("^2","");
									}
								}
								if(displayedText.indexOf("^3")!=-1) {
									displayedText = displayedText.replace("^3",getCertifiedText(stockDefObj,preferencesStocksObj));
								}
								if(displayedText==preferencesStocksObj.points){
									return stockDefObj.name;
								}
								return displayedText;
							}
							return stockDefObj.name;
						} else if(preferencesStocksObj.microns!=null && preferencesStocksObj.microns!=""){
							if(stockDefObj.uom!=null && stockDefObj.uom==resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'stockPickerCmd.Microns')) {
								displayedText = preferencesStocksObj.microns;
								if(displayedText.indexOf("^0")!=-1) {
									displayedText = displayedText.replace("^0",stockDefObj.weight);
								}
								if(displayedText.indexOf("^1")!=-1) {
									displayedText = displayedText.replace("^1",stockDefObj.name);
								}
								if(displayedText.indexOf("^2")!=-1) {
									if(stockDefObj.finish!=null) {
										displayedText = displayedText.replace("^2",stockDefObj.finish.name);
									} else {
										displayedText = displayedText.replace("^2","");
									}
								}
								if(displayedText.indexOf("^3")!=-1) {
									displayedText = displayedText.replace("^3",getCertifiedText(stockDefObj,preferencesStocksObj));
								}
								if(displayedText==preferencesStocksObj.microns){
									return stockDefObj.name;
								}
								return displayedText;
							}
							return stockDefObj.name;
						} else if(preferencesStocksObj.plies!=null && preferencesStocksObj.plies!=""){
							if(stockDefObj.uom!=null && stockDefObj.uom==resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'stockPickerCmd.Plies')) {
								displayedText = preferencesStocksObj.plies;
								if(displayedText.indexOf("^0")!=-1) {
									displayedText = displayedText.replace("^0",stockDefObj.weight);
								}
								if(displayedText.indexOf("^1")!=-1) {
									displayedText = displayedText.replace("^1",stockDefObj.name);
								}
								if(displayedText.indexOf("^2")!=-1) {
									if(stockDefObj.finish!=null) {
										displayedText = displayedText.replace("^2",stockDefObj.finish.name);
									} else {
										displayedText = displayedText.replace("^2","");
									}
								}
								if(displayedText.indexOf("^3")!=-1) {
									displayedText = displayedText.replace("^3",getCertifiedText(stockDefObj,preferencesStocksObj));
								}
								if(displayedText==preferencesStocksObj.plies){
									return stockDefObj.name;
								}
								return displayedText;
							}
							return stockDefObj.name;
						} else if(preferencesStocksObj.millimeters!=null && preferencesStocksObj.millimeters!=""){
							if(stockDefObj.uom!=null && stockDefObj.uom==resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'stockPickerCmd.Millimeters')) {
								displayedText = preferencesStocksObj.millimeters;
								if(displayedText.indexOf("^0")!=-1) {
									displayedText = displayedText.replace("^0",stockDefObj.weight);
								}
								if(displayedText.indexOf("^1")!=-1) {
									displayedText = displayedText.replace("^1",stockDefObj.name);
								}
								if(displayedText.indexOf("^2")!=-1) {
									if(stockDefObj.finish!=null) {
										displayedText = displayedText.replace("^2",stockDefObj.finish.name);
									} else {
										displayedText = displayedText.replace("^2","");
									}
								}
								if(displayedText.indexOf("^3")!=-1) {
									displayedText = displayedText.replace("^3",getCertifiedText(stockDefObj,preferencesStocksObj));
								}
								if(displayedText==preferencesStocksObj.millimeters){
									return stockDefObj.name;
								}
								return displayedText;
							}
							return stockDefObj.name;
						}
					}
				} else {
					return stockDefObj.name;
				}
				return "";
			}
			
			private function getCertifiedText(stockDefObj:StockDefinition, preferencesStocksObj:PreferencesStocks):String {
				var certifiedString:String = "";
				if(preferencesStocksObj!=null && stockDefObj!=null){
					if(preferencesStocksObj.includeCerifiedOption || preferencesStocksObj.includeManagementType || preferencesStocksObj.includeRecyclePercent) {
						if(preferencesStocksObj.open!=null && preferencesStocksObj.open!=""){
							certifiedString = preferencesStocksObj.open;
						} else {
							certifiedString = "(";
						}
						if(stockDefObj.fscCertified || stockDefObj.sfiCertified || stockDefObj.greenSealCertified){
							if(preferencesStocksObj.includeCerifiedOption){
								if(stockDefObj.fscCertified) {
									certifiedString = certifiedString+resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'stockDefCmd.FSC');
								}
								if(stockDefObj.sfiCertified) {
									if(stockDefObj.fscCertified){
										certifiedString = certifiedString+", "+resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'stockDefCmd.SFI');
									} else {
										certifiedString = certifiedString+resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'stockDefCmd.SFI');
									}
								}
								if(stockDefObj.greenSealCertified) {
									if(stockDefObj.fscCertified || stockDefObj.sfiCertified){ 
										certifiedString = certifiedString+", "+resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'stockDefCmd.GreenSeal');
									} else { 
										certifiedString = certifiedString+resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'stockDefCmd.GreenSeal');
									}
								}
								certifiedString = certifiedString+" "+resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'stockDefCmd.Certified');
							}
						}
						if(preferencesStocksObj.includeManagementType){
							if(stockDefObj.forestManagement!=null && stockDefObj.forestManagement!="") {
								certifiedString = certifiedString+" "+stockDefObj.forestManagement;
							}
						}
						if(preferencesStocksObj.includeRecyclePercent){
							if(!(isNaN(stockDefObj.pcwRecycledPercent)) && stockDefObj.pcwRecycledPercent!=0) {
								certifiedString = certifiedString+" "+StringUtil.substitute(resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'stockDefCmd.Recycled0'),(stockDefObj.pcwRecycledPercent*100)+"%");
							} 
						}
						if(preferencesStocksObj.close!=null && preferencesStocksObj.close!=""){
							certifiedString = certifiedString+preferencesStocksObj.close;
						} else {
							certifiedString = certifiedString+")";
						}
					}
				}
				return certifiedString;
			}
			
			private function getMarginValue(item:Object, column:DataGridColumn):String {
				var localJob:Job = item as Job;
				var actualTotalCost:Number = 0;
				var price:Number = 0;
				var marginValue:Number = 0;
				var prcntValue:Number = 0;
				if(localJob != null && localJob.costingRecord!=null){
					actualTotalCost = ((isNaN(localJob.costingRecord.actualTotalCost))?0:localJob.costingRecord.actualTotalCost);
				}
				if (localJob != null && localJob.pricingRecord != null) {					
					price = localJob.pricingRecord.totalPrice;
				}
				marginValue = price - actualTotalCost;
				if(price!=0){
					prcntValue = (marginValue/price)*100;
				}
				return Snowmass.getCurrencyFormatter(false, 2).format(marginValue)+" "+ Snowmass.getCurrencyFormatter(false, 0).format(prcntValue)+"%";
			}
			
			private function doPrint(ev:MouseEvent = null):void {
				if (isNaN(invoice.id)) {
					Alert.show("You must save the invoice before printing", "Error");
				} else {
					var reportName:String = format_combo.selectedItem as String;
					var urlRequest:URLRequest = new URLRequest("http://localhost:8080/Snowmass/reportservlet?invoiceName="+reportName +"&reportParameter="+invoice.id);
                	navigateToURL(urlRequest, "_blank");
				}
			}
			

			public function createCustFromDoc():void	{
				//only for deleted customers or walk in customers
				if (invoice.account.walkIn && invoice.billToAddress != null && invoice.billToAddress.name != "")	{					
					invoice.account.walkIn = false;
					createCustFromDocService.addUpdate(invoice.account);	
				}
				if (invoice.account.isDeleted)	{
					invoice.account.isDeleted = true;
					createCustFromDocService.addUpdate(invoice.account);
				}	
			}
			
			private function handleCreateCustomerFromDoc(event:ResultEvent):void	{
				//this.setAccount(event.result as Account, false);
			}
			public function openDepositEntry():void		{
				if (invoice is Invoice)	{
					
					var ac:ArrayCollection = Snowmass.getInstance().containerManager.getChildrenOfWindow(windowRef.windowID);
					
					if (ac != null)	{
						for (var i:int=0; i<ac.length; i++)	{
							var win:MDIWindow = ac.getItemAt(i) as MDIWindow;
							if (win.content.className.indexOf("DepositEntryEditor") > -1)	{
								win.bringWindowToFront();
								return;
							}  
						}
					}
									
					var de:DepositEntryEditor = new DepositEntryEditor();
					de.addEventListener(DepositEntryAddedEvent.DEPOSITENTRYADDED, onDepEntryAdded,false, 0, true);
					var winId:int = windowRef.windowID;
					Snowmass.getInstance().containerManager.openNewMDIWindow(resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'depositCmd.DepositEntry'), de,-1,-1,550,500,winId);
					de.depArray = expandDepositsArray(invoice.deposits);
				}				
			}

			public function openDocTotals():void		{
				
				var ac:ArrayCollection = Snowmass.getInstance().containerManager.getChildrenOfWindow(windowRef.windowID);
				
				if (ac != null)	{
					for (var i:int=0; i<ac.length; i++)	{
						var win:MDIWindow = ac.getItemAt(i) as MDIWindow;
						if (win.content.className.indexOf("DocumentTotalsEditor") > -1)	{
							win.bringWindowToFront();
							return;
						}  
					}
				}
								
				var de:DocumentTotalsEditor= new DocumentTotalsEditor();
				//de.addEventListener(DepositEntryAddedEvent.DEPOSITENTRYADDED, onDepEntryAdded,false, 0, true);
				var winId:int = windowRef.windowID;
				Snowmass.getInstance().containerManager.openNewMDIWindow(resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invTotalCmd.DocumentTotals'), de,-1,-1,550,500,winId);
				de.invoice = invoice; 
				
				
								
			}

			
			private function expandDepositsArray(ac:ArrayCollection):ArrayCollection	{
				if (ac == null)
					return null;
					
				var eac:ArrayCollection = new ArrayCollection();
				
				for (var i:int=0; i < 3; i++)	{
					var de:DepositEntry = null;
					for (var j:int=0; j < ac.length; j++)	{
						var de2:DepositEntry = ac.getItemAt(j) as DepositEntry;
						if (de2.depositNumber == (i+1))	{
							de = de2;
							break;
						}
					}
					if (de == null)	{
						de = new DepositEntry();												
					}	
					
					eac.addItem(de);	
				}
				return eac;
			}
			private function trimDepositsArray(ac:ArrayCollection):ArrayCollection	{
				if (ac == null)
					return null;
					
				var tac:ArrayCollection = new ArrayCollection();
				
				for (var i:int=0; i < ac.length; i++)	{
					var de:DepositEntry = ac.getItemAt(i) as DepositEntry;
					if (de.amount != 0)	{
						de.parentInvoice = invoice;
						tac.addItem(de);
					}	
				}
				return tac;
			}
			private function doDepositLabels():void	{
				var ac:ArrayCollection = expandDepositsArray(invoice.deposits);
				setDepositLabels(ac);
				
			}
			private function onDepEntryAdded(event:DepositEntryAddedEvent):void	{
				var ac:ArrayCollection = event.depositsArray;
				
				if (ac != null && ac.length ==3)	{
					setDepositLabels(ac);
					invoice.deposits = trimDepositsArray(ac);
					
					InvoicePricing.calculateTotals(invoice, InvoicePricing.DEPOSITS);
					
				}
			}
			
			private function setDepositLabels(ac:ArrayCollection):void	{
				var dep1:DepositEntry = ac.getItemAt(0) as DepositEntry;
				txtDep1.text = "";
				if (dep1.amount != 0)	{
					txtDep1.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'depositCmd.Deposit') + " 1: " + Snowmass.getCurrencyFormatter(false, 2).format(dep1.amount) + " (" + dep1.type.name + ") ";
					if (dep1.referenceNumber != "") 
						txtDep1.text += " (" + dep1.referenceNumber + ")";
				}
				var dep2:DepositEntry = ac.getItemAt(1) as DepositEntry;
				txtDep2.text = "";
				if (dep2.amount != 0)	{
					txtDep2.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'depositCmd.Deposit') + " 2: " + Snowmass.getCurrencyFormatter(false, 2).format(dep2.amount) + " (" + dep2.type.name + ") ";
					if (dep2.referenceNumber != "") 
						txtDep2.text += " (" + dep2.referenceNumber + ")";
				}
				var dep3:DepositEntry = ac.getItemAt(2) as DepositEntry;
				txtDep3.text = "";
				if (dep3.amount != 0)	{
					txtDep3.text = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'depositCmd.Deposit') + " 3: " + Snowmass.getCurrencyFormatter(false, 2).format(dep3.amount) + " (" + dep3.type.name + ") ";
					if (dep3.referenceNumber != "") 
						txtDep3.text += " (" + dep3.referenceNumber + ")";
				}
			}
			private function getJobChargesList(jobList:ArrayCollection,chargesList:ArrayCollection):ArrayCollection {
				if(resetJobsList) {
					resetJobsList = false;
					multiQtyJobPresent = false;
					radioButtonGroupList = new ArrayCollection();
					if(invoice is Invoice) {
						var invoiceJobChargeList:ArrayCollection = new ArrayCollection();
						var counter:int=0;
						for each(var jobBaseObj:JobBase in jobList){
							counter++;
							jobBaseObj.jobIndex = counter; 
							invoiceJobChargeList.addItem(jobBaseObj);
							if(jobBaseObj.charges!=null && jobBaseObj.charges.length>0) {
								var chargeCounter:int=0;
								for each(var chargeObj:Charge in jobBaseObj.charges){
									chargeCounter++;
									chargeObj.jobIndex = jobBaseObj.jobIndex;
									chargeObj.chargeIndex = chargeCounter; 
									invoiceJobChargeList.addItem(chargeObj);
								}
							}
						}
						var chargeCounter:int=0;
						for each(var chargeObject:Charge in invoice.charges){
							chargeObject.parentInvoice = invoice;
							chargeCounter++;
							chargeObject.chargeIndex = chargeCounter; 
							invoiceJobChargeList.addItem(chargeObject);
						}
						resetJobsList = true;
						if(onLoad) {
							onLoad = false;
							setOriginalInvoice();
						}
						return invoiceJobChargeList;
					} else if(invoice is Estimate) {
						if(jobList!=null && jobList.length>0){
							var tempMultiQtyJobPresent:Boolean = false;
							var estimatesJobChargeList:ArrayCollection = new ArrayCollection();
							var rbCounter:int=0;
							var counter:int=0;
							for each(var jobBaseObj:JobBase in jobList){
								jobBaseObj.hasMultiQtyJobs = false;
								if(!jobBaseObj.multiQtyJob){
									var checkFlag:Boolean = false;
									for each(var estimatesJobChargeObj:Object in estimatesJobChargeList) {
										if((estimatesJobChargeObj is Job) && estimatesJobChargeObj.id == jobBaseObj.id && estimatesJobChargeObj.id!=0 && jobBaseObj.id!=0) {
											checkFlag = true;
											break;
										}
									}
									if(!checkFlag){
										jobBaseObj.rbIndex = rbCounter;
										counter++;
										jobBaseObj.jobIndex = counter;
										estimatesJobChargeList.addItem(jobBaseObj);
										if(jobBaseObj.charges!=null && jobBaseObj.charges.length>0) {
											var chargeCounter:int=0;
											for each(var chargeObj:Charge in jobBaseObj.charges){
												chargeCounter++;
												chargeObj.jobIndex = jobBaseObj.jobIndex;
												chargeObj.chargeIndex = chargeCounter; 
												estimatesJobChargeList.addItem(chargeObj);
											}
										}
										for each(var jobBaseObject:JobBase in jobList){
											if(jobBaseObj.jobGroup!=0 && jobBaseObj.jobGroup==jobBaseObject.jobGroup && jobBaseObject.multiQtyJob){
												jobBaseObj.hasMultiQtyJobs = true;
												tempMultiQtyJobPresent = true;
												jobBaseObject.rbIndex = jobBaseObj.rbIndex;
												counter++;
												jobBaseObject.jobIndex = counter;
												estimatesJobChargeList.addItem(jobBaseObject);
												if(jobBaseObject.charges!=null && jobBaseObject.charges.length>0) {
													var chargeCounter:int=0;
													for each(var chargeObj:Charge in jobBaseObject.charges){
														chargeCounter++;
														chargeObj.jobIndex = jobBaseObject.jobIndex;
														chargeObj.chargeIndex = chargeCounter; 
														estimatesJobChargeList.addItem(chargeObj);
													}
												}
											}
										}
										/* if(jobBaseObj.hasMultiQtyJobs){ */
											var radioButtonGroup:RadioButtonGroup = new RadioButtonGroup();
											radioButtonGroup.initialized(this.document,"defaultJob"+jobBaseObj.jobGroup);
											radioButtonGroupList.addItem(radioButtonGroup);
										/* } */
									}
								}
								rbCounter++;
							}
							multiQtyJobPresent = tempMultiQtyJobPresent;
							resetJobsList = true;
						}
						if(chargesList!=null && chargesList.length>0) {
							var chargeCounter:int=0;
							for each(var chargeObj:Charge in chargesList){
								chargeCounter++;
								chargeObj.chargeIndex = chargeCounter; 
								chargeObj.parentInvoice = invoice;
								estimatesJobChargeList.addItem(chargeObj);
							}
						}
						if(onLoad) {
							onLoad = false;
							setOriginalInvoice();
						}
						return estimatesJobChargeList;
					}
					resetJobsList = true;
				}
				return null;
			}
			
			private function getCostingJobsList(jobList:ArrayCollection):ArrayCollection {
				if(invoice is Invoice) {
					var invoiceJobList:ArrayCollection = new ArrayCollection();
					var counter:int=0;
					for each(var jobBaseObj:JobBase in jobList){
						counter++;
						jobBaseObj.jobIndex = counter; 
						invoiceJobList.addItem(jobBaseObj);
					}
					return jobList;
				} else if(invoice is Estimate) {
					if(jobList!=null && jobList.length>0){
						var estimatesJobList:ArrayCollection = new ArrayCollection();
						var counter:int=0;
						for each(var jobBaseObj:JobBase in jobList){
							jobBaseObj.hasMultiQtyJobs = false;
							if(!jobBaseObj.multiQtyJob){
								var checkFlag:Boolean = false;
								for each(var estimatesJobObj:JobBase in estimatesJobList) {
									if(estimatesJobObj.id == jobBaseObj.id && estimatesJobObj.id!=0 && jobBaseObj.id!=0) {
										checkFlag = true;
										break;
									}
								}
								if(!checkFlag){
									counter++;
									jobBaseObj.jobIndex = counter;
									estimatesJobList.addItem(jobBaseObj);
									for each(var jobBaseObject:JobBase in jobList){
										if(jobBaseObj.jobGroup!=0 && jobBaseObj.jobGroup==jobBaseObject.jobGroup && jobBaseObject.multiQtyJob){
											jobBaseObj.hasMultiQtyJobs = true;
											counter++;
											jobBaseObject.jobIndex = counter;
											estimatesJobList.addItem(jobBaseObject);
										}
									}
								}
							}
						}
						return estimatesJobList;
					}
				}
				return null;
			}
			
			private function getContactShipToLabel(item:Object):String	{
				var temp:Address = item as Address;
				return temp.name + ":" + temp.street1 + "," + temp.street2;
			}
			private function contactLabel(item:Object):String {
				var tempItem:Contact = item as Contact;
				if ((tempItem.tempFlag != null) && (tempItem.tempFlag == true))	{
					return resourceManager.getString(Snowmass.RESOURCE_BUNDLE, "custDataCmd.TemporaryContact");
				}
				if ((tempItem["newFlag"] != null) && (tempItem["newFlag"] == true))	{
					return resourceManager.getString(Snowmass.RESOURCE_BUNDLE, "custDataCmd.NEWCONTACT");
				}
				
				var returnString:String = tempItem.lastName + ", " + tempItem.firstName;
				return returnString;
			}
			
			public function setDefaultJob(object:Object,event:Event):void {
				if(event.currentTarget.selected) {
					for each(var jobBaseObj:JobBase in invoice.jobs){
						if(object.jobGroup!=0 && jobBaseObj.jobGroup==object.jobGroup){
							jobBaseObj.defaultJob = false;
						}
					}
					object.defaultJob = true;
				}
				invoice.jobs.refresh();
				invoice_job_grid.dataProvider.refresh();
				invoice_job_grid.validateProperties();
				updateTotals();
				/* if (invoice.jobs != null && invoice.jobs.length > 0) {
					var i:int;
					invoice.subTotal = 0;
					for (i=0; i<invoice.jobs.length; i++) {
						var tmpJob:Job = invoice.jobs.getItemAt(i) as Job;	
						if(invoice is Estimate){
							if(tmpJob.defaultJob){
								invoice.subTotal += tmpJob.pricingRecord.totalPrice;
								if(tmpJob.charges!=null) {
									for each(var chargeObj:Charge in tmpJob.charges) {
										invoice.subTotal += chargeObj.price;
									}
								}
							}
						} else {
							invoice.subTotal += tmpJob.pricingRecord.totalPrice;
							if(tmpJob.charges!=null) {
								for each(var chargeObj:Charge in tmpJob.charges) {
									invoice.subTotal += chargeObj.price;
								}
							}
						}
					}
				}
				if(invoice.charges!=null) {
					for each(var chargeObj:Charge in invoice.charges) {
						invoice.subTotal += chargeObj.price;
					}
				}
				invoice.grandTotal = invoice.subTotal;
				invoice.amountDue = invoice.grandTotal; */
			}
			
			public function getRBGroupRef(object:Object):RadioButtonGroup {
				if(radioButtonGroupList!=null && radioButtonGroupList.length>object.rbIndex){
					return radioButtonGroupList.getItemAt(object.rbIndex) as RadioButtonGroup;
				}
				return null;
			}
			
			public function getJobIndex(object:Object):String {
				if(object is Job) {
					if(object.multiQtyJob){
						return "+++";	
					}
					return String(object.jobIndex);
				} else if(object is Charge) {
					if(object.parentInvoice!=null) {
						return "*";
					}
				}
				return "";
			}
			
			public function getQtyOrdered(item:Object, column:DataGridColumn):String {
				if(item is Job) {
					var localJob:Job = item as Job;
					if(localJob.showMultiQty){
						return localJob.qtyOrdered.toFixed(2)+"+";
					}
					return localJob.qtyOrdered.toFixed(2);
				} else if(item is Charge){
					var localCharge:Charge = item as Charge;
					if(localCharge.displayQty) {
						return localCharge.quantity.toFixed(2);
					}
				}
				return "";
			}
			
			public function getCompQuantity(item:Object):Number {
				if(item is Job) {
					return item.qtyOrdered;
				} else {
					if(item.displayQty) {
						return item.quantity;
					}
				}
				return 0;
			}
			
			public function getQuantityEnability(item:Object):Boolean {
				if(item is Job) {
					return true;
				} else if(item is Charge){
					if(item.displayQty) {
						return true;
					}
				}
				return false;
			}
			
			private function doDoubleclickTicketItem():void	{
				if(ticket_grid.selectedIndex>-1 && ticket_grid.selectedItem!=null){
					var selectedDeliveryTicketJob:DeliveryTicketJobs = ticket_grid.selectedItem as DeliveryTicketJobs;
					var child:DeliveryTicketEdit = new DeliveryTicketEdit();
					child.name = "DeliveryTicket"+selectedDeliveryTicketJob.parentDeliveryTicket.id;
					var win:MDIWindow = Snowmass.getInstance().containerManager.getWindowWithChild(child);
					if (win == null) {
						child.setDeliveryTicket(selectedDeliveryTicketJob.parentDeliveryTicket);
						child.addEventListener(DeliveryTicketUpdateEvent.DELIVERYTICKET_UPDATE_EVENT,updateDeliveryTicketJobsList,false,0,true);
						Snowmass.getInstance().containerManager.openNewMDIWindow(child.title, child);
					}
					else {
						win.bringWindowToFront();	
					}
				}
			}
			
			private function getOrderedTime(dateObj:Date):String {
				if(dateObj!=null){
					var dateFormatter:DateFormatter = new DateFormatter();
					dateFormatter.formatString = "L:NN A";
				}
				return "";
			}
			
			private function setInvoiceDates(event:Event, propertyName:String, labelCompName:String=null):void {
				var dateObj:Date = event.currentTarget.selectedDate as Date;
				if(dateObj!=null){
					if(invoice[propertyName]!=null){
						invoice[propertyName].date = dateObj.date;
						invoice[propertyName].month = dateObj.month;
						invoice[propertyName].fullYear = dateObj.fullYear;
					} else {
						invoice[propertyName] = dateObj;
					}
				} else {
					invoice[propertyName] = null;
				}
				if(labelCompName!=null){
					var label:Label = this[labelCompName] as Label;
					label.text = getWeekName(invoice[propertyName]);
				} 
			}
			
			private function getWeekName(dateObj:Date):String {
				if(dateObj!=null){
					var dateFormatter:DateFormatter = new DateFormatter();
					dateFormatter.formatString = "EEE";
					return dateFormatter.format(dateObj);
				}
				return "";
			}
			
			private function handleLoadDeliveryTicketJobsResult(event:ResultEvent):void {
				deliveryTicketJobsList = event.result as ArrayCollection;
			}
			
			private function updateDeliveryTicketJobsList(event:DeliveryTicketUpdateEvent):void {
				if(event.ticketSaved) {
					if(invoice!=null && invoice.id>0){
						dataService.getDeliveryTicketJobsByInvoice(invoice.id);
					}
				}
			}
			
			/* private function mouseMoveHandler(event:MouseEvent):void {
            
	            // Get the drag initiator component from the event object.
	            var dragInitiator:DataGrid=DataGrid(event.currentTarget);
	            
	            if(dragInitiator.selectedIndex>-1 && dragInitiator.selectedItem!=null) {
		            // Create a DragSource object.
		            var ds:DragSource = new DragSource();
		
		            // Add the data to the object.
		            ds.addData(dragInitiator.selectedItem, 'draggedItem');
		            
		            ds.addData(randomNumber, 'uniqueKey');
		
		            // Call the DragManager doDrag() method to start the drag. 
		            DragManager.doDrag(dragInitiator, ds, event);
	            }
	        } */
	        
	        private function dragStartHandler(event:DragEvent):void {
	        	event.dragSource.addData(randomNumber,"randomNumber");
	        }
	        
	        private function dragEnterHandler(event:DragEvent):void {
	        	if (event.dragSource.hasFormat('items')) {
	            	var dragObj:Array = event.dragSource.dataForFormat("items") as Array; 
					var draggedItem:Object = dragObj[0];
					if(draggedItem is Job || draggedItem is Charge) {
						if(!event.dragSource.hasFormat("randomNumber")) {
							event.dragSource.addData(randomNumber,"randomNumber");
						}
	        			DragManager.acceptDragDrop(event.currentTarget as DataGrid);
	    			}
	        	}
	        }
	        
	        private function dragDropHandler(event:DragEvent):void {
	        	event.preventDefault();
	        	if (event.dragSource.hasFormat('items') && event.dragSource.hasFormat('randomNumber')) {
	            	var dragObj:Array = event.dragSource.dataForFormat("items") as Array;
	            	var dragRandomNumber:Number = Number(event.dragSource.dataForFormat("randomNumber"));
	            	var acrossInvocies:Boolean = false;
	            	if(randomNumber!=dragRandomNumber) {
	            		acrossInvocies = true;
	            	}
					var draggedItem:Object = dragObj[0];
					var dataGrid:DataGrid = event.currentTarget as DataGrid;
					dataGrid.hideDropFeedback(event);
					var dropIndex:int = dataGrid.calculateDropIndex(event);
					if(draggedItem is Charge) {
						dropCharge(draggedItem,dropIndex,acrossInvocies);
					} else if(draggedItem is Job) {
						dropJob(draggedItem,dropIndex,acrossInvocies);
					}
	        	}
	        }
	        
	        private function dropCharge(draggedItem:Object,dropIndex:int,acrossInvocies:Boolean):void {
	        	registerClassAlias("com.efi.printsmith.data.Charge",Charge);
				var selectedCharge:Charge = ObjectUtil.copy(draggedItem) as Charge;
				if(!acrossInvocies) {
					if(selectedCharge.parentInvoice!=null) {
						if(invoice.charges!=null) {
							invoice.charges.removeItemAt(selectedCharge.chargeIndex-1);
						}
					} else if(selectedCharge.parentJob!=null) {
						for each(var jobBaseObj:Job in invoice.jobs) {
							if(jobBaseObj.jobIndex==selectedCharge.jobIndex) {
								if(jobBaseObj.charges!=null) {
									jobBaseObj.charges.removeItemAt(selectedCharge.chargeIndex-1);
								}
							}
						}
					}
				}
				if(dropIndex<invoice_job_grid.dataProvider.length){
					var localObject:Object = invoice_job_grid.dataProvider.getItemAt(dropIndex);
					if(localObject is Job) {
						var localJob:Job = localObject as Job;
						selectedCharge.id = 0;
						selectedCharge.created = null;
						selectedCharge.created = null;
						selectedCharge.parentInvoice = null;
						selectedCharge.parentJob = localJob;
						if(localJob.charges==null) {
							localJob.charges = new ArrayCollection();
						}
						localJob.charges.addItem(selectedCharge);
						localJob.charges.refresh();
						
					} else if(localObject is Charge) {
						var localCharge:Charge = localObject as Charge;
						if(localCharge.parentJob!=null) {
							selectedCharge.id = 0;
							selectedCharge.created = null;
							selectedCharge.created = null;
							selectedCharge.parentInvoice = null;
							selectedCharge.parentJob = localCharge.parentJob;
							if(localCharge.parentJob.charges==null) {
								localCharge.parentJob.charges = new ArrayCollection();
							}
							localCharge.parentJob.charges.addItem(selectedCharge);
							localCharge.parentJob.charges.refresh();
						} else if(localCharge.parentInvoice!=null) {
							selectedCharge.id = 0;
							selectedCharge.created = null;
							selectedCharge.created = null;
							selectedCharge.parentInvoice = localCharge.parentInvoice;
							selectedCharge.parentJob = null;
							if(localCharge.parentInvoice.charges==null) {
								localCharge.parentInvoice.charges = new ArrayCollection();
							}
							localCharge.parentInvoice.charges.addItem(selectedCharge);
							localCharge.parentInvoice.charges.refresh();
						}
					}
				} else {
					selectedCharge.id = 0;
					selectedCharge.created = null;
					selectedCharge.created = null;
					selectedCharge.parentInvoice = invoice;
					selectedCharge.parentJob = null;
					if(invoice.charges==null) {
						invoice.charges = new ArrayCollection();
					}
					invoice.charges.addItem(selectedCharge);
					invoice.charges.refresh();
				}
				invoice.jobs = getSortedList(invoice.jobs);
				invoice_job_grid.dataProvider = getJobChargesList(invoice.jobs,invoice.charges);
				updateTotals();
	        }
	        
	        private function dropJob(draggedItem:Object,dropIndex:int,acrossInvocies:Boolean):void {
	        	registerClassAlias("com.efi.printsmith.data.Job",Job);
				var selectedJob:Job = ObjectUtil.copy(draggedItem) as Job;
				if(!acrossInvocies) {
					if(dropIndex<invoice_job_grid.dataProvider.length){
						var localObject:Object = invoice_job_grid.dataProvider.getItemAt(dropIndex);
						if(localObject is Job) {
							var localJob:Job = localObject as Job;
							if(selectedJob.jobIndex!=localJob.jobIndex){
								var initValue:int=0;
								var maxValue:int=0;
								var droppableIndex:Number = localJob.jobIndex;
								if(selectedJob.jobIndex>localJob.jobIndex) {
									initValue = localJob.jobIndex-1;
									maxValue = selectedJob.jobIndex-1;
								} else {
									initValue = selectedJob.jobIndex-1;
									maxValue = localJob.jobIndex-1;
								}
								invoice.jobs.removeItemAt(selectedJob.jobIndex-1);
								if(localJob.multiQtyJob){
									selectedJob.multiQtyJob = true;
									selectedJob.jobGroup = localJob.jobGroup;
									invoice.jobs.addItem(selectedJob);
								} else {
									for(var i:int=initValue;i<maxValue;i++) {
										var swapJob:Job = invoice.jobs.getItemAt(i) as Job;
										swapJob.jobIndex = i+2;
									}
									selectedJob.multiQtyJob = false;
									if(selectedJob.multiQtyJob){
										selectedJob.jobGroup = 0;
									}
									selectedJob.jobIndex = droppableIndex;
									invoice.jobs.addItem(selectedJob);
								}
							}	
						}
					} else {
						invoice.jobs.removeItemAt(selectedJob.jobIndex-1);
						if(selectedJob.multiQtyJob){
							selectedJob.jobGroup = 0;
						}
						selectedJob.multiQtyJob = false;
						selectedJob.jobIndex = invoice.jobs.length+1;
						invoice.jobs.addItem(selectedJob);
					}
				} else {
					if(selectedJob.charges!=null) {
						for each(var chargeObj:Charge in selectedJob.charges) {
							chargeObj.id = null;
							chargeObj.created = null;
							chargeObj.modified = null;
						} 
					}
					if(dropIndex<invoice_job_grid.dataProvider.length){
						var localObject:Object = invoice_job_grid.dataProvider.getItemAt(dropIndex);
						if(localObject is Job) {
							var localJob:Job = localObject as Job;
							var initValue:int=0;
							var maxValue:int=0;
							var droppableIndex:Number = localJob.jobIndex;
							initValue = localJob.jobIndex-1;
							maxValue = invoice.jobs.length;
							if(localJob.multiQtyJob){
								selectedJob.id = 0;
								selectedJob.created = null;
								selectedJob.created = null;
								selectedJob.multiQtyJob = true;
								selectedJob.jobGroup = localJob.jobGroup;
								selectedJob.parentInvoice = this.invoice;
								invoice.jobs.addItem(selectedJob);
							} else {
								for(var i:int=initValue;i<maxValue;i++) {
									var swapJob:Job = invoice.jobs.getItemAt(i) as Job;
									swapJob.jobIndex = i+2;
								}
								selectedJob.id = 0;
								selectedJob.created = null;
								selectedJob.created = null;
								selectedJob.multiQtyJob = false;
								if(selectedJob.multiQtyJob){
									selectedJob.jobGroup = 0;
								}
								selectedJob.parentInvoice = this.invoice;
								selectedJob.jobIndex = droppableIndex;
								invoice.jobs.addItem(selectedJob);
							}
						}
					} else {
						selectedJob.id = 0;
						selectedJob.created = null;
						selectedJob.created = null;
						if(selectedJob.multiQtyJob){
							selectedJob.jobGroup = 0;
						}
						selectedJob.multiQtyJob = false;
						selectedJob.jobIndex = invoice.jobs.length+1;
						selectedJob.parentInvoice = this.invoice;
						invoice.jobs.addItem(selectedJob);
					}
				}
				invoice.jobs = getSortedList(invoice.jobs);
				invoice_job_grid.dataProvider = getJobChargesList(invoice.jobs,invoice.charges);
				updateTotals();
			}
	        
	        private function getSortedList(list:ArrayCollection):ArrayCollection {
				var dataSortField:SortField = new SortField();
                dataSortField.name = "jobIndex";
                dataSortField.numeric = true;
 				var numericDataSort:Sort = new Sort();
                numericDataSort.fields = [dataSortField];
                list.sort = numericDataSort;
                list.refresh();
				return list;
			}
	        
	        public function getCostingColor(item:Object,priceCheck:Boolean=false):uint {
	        	if(item.costingRecord!=null) {
	        		if(priceCheck) {
	        			var totalPrice:Number = 0;
	        			if(item.pricingRecord!=null){
	        				totalPrice = item.pricingRecord.totalPrice;
	        			}
	        			if(totalPrice<item.costingRecord.actualTotalCost){
	        				return 0XFF0000;
	        			}
	        		}
	        		if(item.costingRecord.costEntered) {
	        			return 0x0000FF;
	        		} else if(item.costingRecord.dataCollected) {
	        			return 0xFF8040;
	        		}
	        	}
	        	return 0x000000;
	        }
	        
	        public function updateCostingRecord(item:Object):void {
	        	if(item is Job) {
		        	if(item.costingRecord!=null) {
			        	if(item.costingRecord.actualTotalCost!=item.costingRecord.originalTotalCost) {
			        		item.costingRecord.dataCollected = false;
			        		item.costingRecord.costEntered = true;
			        		item.costingRecord.originalTotalCost = item.costingRecord.actualTotalCost;
			        	}
		        	}
	        		callLater(updateCostingDataGrid);
	        	}
	        }
	        
	        public function updatePricing(item:Object):void {
	        	if(item is Job) {
	        		var localJob:Job = item as Job;
	        		if(localJob.pricingRecord!=null) {
	        			if(localJob.pricingRecord.originalPrice!=localJob.pricingRecord.totalPrice) {
	        				localJob.pricingRecord.originalPrice = localJob.pricingRecord.totalPrice;
	        				localJob.pricingRecord.totalPriceOverride = true;
	        			}
	        		}	        		
	        	} else if(item is Charge) {
	        		var localCharge:Charge = item as Charge;
	        		if(localCharge.originalPrice!=localCharge.price){
	        			localCharge.originalPrice==localCharge.price;
	        			localCharge.overridePrice = true;
	        		}
	        	}
	        	callLater(updateCostingDataGrid);
	        }
	        
	        public function updateInvoicePricing(item:Object):void {
	        	if(item is Job) {
	        		var localJob:Job = item as Job;
	        		if(localJob.pricingRecord!=null) {
	        			if(localJob.pricingRecord.originalPrice!=localJob.pricingRecord.totalPrice) {
	        				localJob.pricingRecord.originalPrice = localJob.pricingRecord.totalPrice;
	        				localJob.pricingRecord.totalPriceOverride = true;
	        			}
	        		}	        		
	        	} else if(item is Charge) {
	        		var localCharge:Charge = item as Charge;
	        		if(localCharge.originalPrice!=localCharge.price){
	        			localCharge.originalPrice==localCharge.price;
	        			localCharge.overridePrice = true;
	        		}
	        	}
	        	callLater(updateInvoiceDataGrid);
	        }
	        
	        public function updateQuantity(item:Object):void {
	        	if(item is Job) {
	        		var localJob:Job = item as Job;
        			if(localJob.originalQty!=localJob.qtyOrdered) {
        				localJob.originalQty = localJob.qtyOrdered;
        			}       		
	        	} else if(item is Charge) {
	        		var localCharge:Charge = item as Charge;
	        		if(localCharge.originalQty!=localCharge.quantity){
	        			localCharge.originalQty==localCharge.quantity;
	        			localCharge.overrideQuantity = true;
	        		}
	        	}
	        	callLater(updateInvoiceDataGrid);
	        }
	        
	        private function updateInvoiceDataGrid():void {
	        	invoice_job_grid.dataProvider = getJobChargesList(invoice.jobs,invoice.charges);
	        	updateTotals();
	        }
	        
	        private function updateCostingDataGrid():void {
	        	invoice_cost_grid.dataProvider = getCostingJobsList(invoice.jobs);
	        	cust_discount_text0.text = getActualTotals(invoice.jobs);
	        	cust_discount_text1.text = getPriceTotals(invoice.jobs);
	        	cust_discount_text2.text = getMarginTotals(invoice.jobs);
	        	cust_discount_text3.text = getEstProfitTotals(invoice.jobs);
	        }
	        
	        private function getActualTotals(jobList:ArrayCollection):String {
	        	var totalCost:Number = 0;
	        	for each(var jobBase:JobBase in jobList) {
	        		if(jobBase.costingRecord!=null) {
	        			totalCost = totalCost + (isNaN(jobBase.costingRecord.actualTotalCost)?0:(jobBase.costingRecord.actualTotalCost));
	        		}
	        	}
	        	return Snowmass.getCurrencyFormatter(false, 2).format(totalCost);
	        }
	        
	        private function getPriceTotals(jobList:ArrayCollection):String {
	        	var totalPrice:Number = 0;
	        	for each(var jobBase:JobBase in jobList) {
	        		if(jobBase.pricingRecord!=null) {
	        			totalPrice = totalPrice + (isNaN(jobBase.pricingRecord.totalPrice)?0:(jobBase.pricingRecord.totalPrice));
	        		}
	        	}
	        	return Snowmass.getCurrencyFormatter(false, 2).format(totalPrice);
	        }
	        
	        private function getMarginTotals(jobList:ArrayCollection):String {
	        	var totalCost:Number = 0;
	        	var totalPrice:Number = 0;
	        	var totalMargin:Number = 0;
	        	for each(var jobBase:JobBase in jobList) {
	        		if(jobBase.costingRecord!=null) {
	        			totalCost = totalCost + (isNaN(jobBase.costingRecord.actualTotalCost)?0:(jobBase.costingRecord.actualTotalCost));
	        		}
	        		if(jobBase.pricingRecord!=null) {
	        			totalPrice = totalPrice + (isNaN(jobBase.pricingRecord.totalPrice)?0:(jobBase.pricingRecord.totalPrice));
	        		}
	        	}
	        	totalMargin = totalPrice-totalCost;
	        	return Snowmass.getCurrencyFormatter(false, 2).format(totalMargin);
	        }
	        
	        private function getEstProfitTotals(jobList:ArrayCollection):String {
	        	var totalCost:Number = 0;
	        	var totalPrice:Number = 0;
	        	var totalMargin:Number = 0;
	        	var estProfit:Number = 0;
	        	for each(var jobBase:JobBase in jobList) {
	        		if(jobBase.costingRecord!=null) {
	        			totalCost = totalCost + (isNaN(jobBase.costingRecord.actualTotalCost)?0:(jobBase.costingRecord.actualTotalCost));
	        		}
	        		if(jobBase.pricingRecord!=null) {
	        			totalPrice = totalPrice + (isNaN(jobBase.pricingRecord.totalPrice)?0:(jobBase.pricingRecord.totalPrice));
	        		}
	        	}
	        	totalMargin = totalPrice-totalCost;
	        	if(totalPrice!=0) {
	        		estProfit = (totalMargin/totalPrice)*100;
	        	}
	        	return Snowmass.getCurrencyFormatter(false, 0).format(estProfit)+"%";
	        }
	        
	        public function getTicketDescription(item:Object,column:DataGridColumn):String {
				if(item.completed){
					return item.description+" "+resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'workflowCmd.done');
				}
				return item.description;
			}
			
			public function openDeliveryTicket():void {
				if(invoice!=null && invoice is Invoice && !isNaN(invoice.id) && invoice.id!=0) {
					var child:DeliveryTicketEdit = new DeliveryTicketEdit();
					child.name = "DeliveryTicket";
					var win:MDIWindow = Snowmass.getInstance().containerManager.getWindowWithChild(child);
					if (win == null) {
						child.setInvoice(invoice as InvoiceBase);
						child.addEventListener(DeliveryTicketUpdateEvent.DELIVERYTICKET_UPDATE_EVENT,updateDeliveryTicketJobsList,false,0,true);
						Snowmass.getInstance().containerManager.openNewMDIWindow(child.title, child);
					}
					else {
						win.bringWindowToFront();	
					}/* 
					var child:DeliveryTicketEdit = new DeliveryTicketEdit();
					child.setInvoice(invoice as InvoiceBase);
					child.addEventListener(DeliveryTicketUpdateEvent.DELIVERYTICKET_UPDATE_EVENT,updateDeliveryTicketJobsList,false,0,true);
					var win:MDIWindow = Snowmass.getInstance().containerManager.getWindowWithChild(child);
					if (win == null) {
						Snowmass.getInstance().containerManager.openNewMDIWindow(child.title, child);
					}
					else {
						win.closeWindow();
						Snowmass.getInstance().containerManager.openNewMDIWindow(child.title, child);	
					} */
				}
			}
			
			private function keyDownEventHandler(event:KeyboardEvent):void {
				if(event.keyCode==Keyboard.ENTER) {
					doDoubleclickInvoiceItem();
				}
			}
			
			private function handleLoadPrefStocksResult(event:ResultEvent):void {
				preferencesStocks = event.result as PreferencesStocks;
			}
			
			public function openEstimatorCheckList():void {
				if(invoice!=null && invoice.jobs!=null) {
					for each(var jobObj:JobBase in invoice.jobs) {
						var estimatorCheckList:EstimatorCheckList = PopUpManager.createPopUp(this,EstimatorCheckList,false) as EstimatorCheckList;
						estimatorCheckList.preferencesStocks = preferencesStocks;
						estimatorCheckList.setJob(jobObj);
					}
				}
			}
			
			public function setOriginalInvoice():void {
				registerClassAlias("com.efi.printsmith.data.InvoiceBase",InvoiceBase);
				originalInvoice = ObjectUtil.copy(invoice) as InvoiceBase;
				if(originalInvoice!=null) {
					if(originalInvoice.specialInstructions==null) {
						originalInvoice.specialInstructions = new SpecialInstructions();
					}
				}
			}
			
			public function getOriginalObject():ArrayCollection {
				var originalList:ArrayCollection = new ArrayCollection();
				originalList.addItem(originalInvoice);
				return originalList;
			}
				
			public function getUpdatedObject():ArrayCollection {
				var updatedList:ArrayCollection = new ArrayCollection();
				updatedList.addItem(invoice);
				return updatedList;
			}
			
			public function getConfirmationText():String {
				return "\n"+this.title;
			} 
				
			public function onClose():void {
				if(invoice!=null){
					mapToInvoiceData();
				}
			}
			
			public function onSave():void {
				doSave();
			}
			
			public function onDontSave():void {
				
			}
			
			public function onCancel():void {
				
			}
		]]>

	</mx:Script>
	<mx:DateFormatter id="dateFormatter" formatString="MM/DD/YYYY L:NN A EEE"/>
	
	<mx:VBox height="100%" width="100%" id="mainvbox" paddingBottom="5" paddingLeft="5" paddingRight="5" paddingTop="5">
		<!-- toolbar-->
		<ns2:Toolbar id="toolbar" height="5%" width="100%"/>
		<mx:ViewStack id="job_costing_stack" height="80%" width="100%" paddingBottom="5" paddingLeft="5" paddingRight="5" paddingTop="5">

		
			<mx:VBox id="invoice_cost_canvas">
				<mx:DataGrid width="100%"
							 height="100%"
							 id="invoice_cost_grid"
							 dataProvider="{getCostingJobsList(invoice.jobs)}" editable="true">
					<mx:columns>
						<mx:DataGridColumn headerText=""
										   width="50"
										   dataField="jobIndex" editable="false">
							<mx:itemRenderer>
								<mx:Component>
									<mx:Label text="{data.jobIndex}" textAlign="center" fontWeight="bold"/>
								</mx:Component>
							</mx:itemRenderer>
						</mx:DataGridColumn>				  
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Description')}"
										   width="200"
										   dataField="description" editable="false"/>
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Estimated')}"
										   width="150"
										   labelFunction="getEstimatedCost" editable="false" textAlign="right"/>
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Actual')}"
										   width="150"
										   labelFunction="getActualCost">
							<mx:itemRenderer>
								<mx:Component>
									<mx:Label color="{outerDocument.getCostingColor(data)}" textAlign="right"/>
								</mx:Component>
							</mx:itemRenderer>
							<mx:itemEditor>
								<mx:Component>
									<components:CustomNumericTextInputComponent
										dataHolder="{data.costingRecord}" variableName="actualTotalCost" customText="{data.costingRecord.actualTotalCost}"
										precision="2" rounding="nearest" focusOut="{outerDocument.updateCostingRecord(data)}"/>
								</mx:Component>
							</mx:itemEditor>
						</mx:DataGridColumn>
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Difference')}"
										   width="150"
										   labelFunction="getDifferenceValue" editable="false">
							<mx:itemRenderer>
								<mx:Component>
									<mx:Label color="{outerDocument.getCostingColor(data)}" textAlign="right"/>
								</mx:Component>
							</mx:itemRenderer>
						</mx:DataGridColumn>
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Price')}"
										   width="150"
										   labelFunction="gridJobPrice">
							<mx:itemRenderer>
								<mx:Component>
									<mx:Label color="{outerDocument.getCostingColor(data)}" textAlign="right"/>
								</mx:Component>
							</mx:itemRenderer>
							<mx:itemEditor>
								<mx:Component>
									<components:CustomNumericTextInputComponent
										dataHolder="{data.pricingRecord}" variableName="totalPrice" customText="{data.pricingRecord.totalPrice}"
										precision="2" rounding="nearest" focusOut="{outerDocument.updatePricing(data)}"/>
								</mx:Component>
							</mx:itemEditor>
						</mx:DataGridColumn>
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Margin')}"
										   width="150"
										   labelFunction="getMarginValue" editable="false">
							<mx:itemRenderer>
								<mx:Component>
									<mx:Label color="{outerDocument.getCostingColor(data,true)}" textAlign="right"/>
								</mx:Component>
							</mx:itemRenderer>
						</mx:DataGridColumn>
					</mx:columns>
				</mx:DataGrid>
			</mx:VBox>
			<mx:VBox id="invoice_job_canvas">
				<mx:Canvas width="100%" height="100%">
					<mx:DataGrid height="100%"
								 width="100%"
								 id="invoice_job_grid"
								 dataProvider="{getJobChargesList(invoice.jobs,invoice.charges)}"
								 sortableColumns="false"
								 doubleClick="{doDoubleclickInvoiceItem()}"
							  	 doubleClickEnabled="true"
							  	 dragEnabled="true"
							  	 dropEnabled="true"
							  	 dragEnter="{dragEnterHandler(event)}"
							  	 dragDrop="{dragDropHandler(event)}"
							  	 editable="true"
							  	 keyDown="{keyDownEventHandler(event)}">
						<mx:columns>
							<mx:DataGridColumn editable="false">
								<mx:itemRenderer>
									<mx:Component>
										<mx:Label text="{outerDocument.getJobIndex(data)}" textAlign="center" fontWeight="bold"/>
									</mx:Component>
								</mx:itemRenderer>
							</mx:DataGridColumn>
							<mx:DataGridColumn visible="{multiQtyJobPresent}" editable="false">
								<mx:itemRenderer>
										<mx:Component>
										<mx:HBox width="100%" horizontalAlign="center">
											<mx:RadioButton group="{outerDocument.getRBGroupRef(data)}"
												enabled="{data.multiQtyJob || data.hasMultiQtyJobs}"
												selected="{data.defaultJob}" click="{outerDocument.setDefaultJob(data,event)}"/>
										</mx:HBox>
									</mx:Component>
								</mx:itemRenderer>
							</mx:DataGridColumn>	
							<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'copierDefCmd.Qty')}"
											   labelFunction="getQtyOrdered" editable="true">
								<mx:itemEditor>
									<mx:Component>
										<components:CustomNumericTextInputComponent
											dataHolder="{data}" variableName="{(data is Job)?'qtyOrdered':'quantity'}" customText="{outerDocument.getCompQuantity(data)}"
											precision="2" rounding="nearest" textAlignStyle="left" focusOut="{outerDocument.updateQuantity(data)}" enabled="{outerDocument.getQuantityEnability(data)}">
											<mx:Script>
												<![CDATA[
													import com.efi.printsmith.data.Job;
												]]>
											</mx:Script>
										</components:CustomNumericTextInputComponent>
									</mx:Component>
								</mx:itemEditor>
							</mx:DataGridColumn>
							<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Description')}"
						   		dataField="description" editable="false">
								<mx:itemRenderer>
									<mx:Component>
										<mx:HBox width="100%" horizontalScrollPolicy="off">
											<mx:Label text="{outerDocument.getJobChargeDescription(data,outerDocument.preferencesStocks,null)}"/>	
											<mx:Label text="{outerDocument.getNonTaxLabel(data)}" textAlign="right"/>
										</mx:HBox>
									</mx:Component>
								</mx:itemRenderer>
							</mx:DataGridColumn>
							<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Price')}"
											   textAlign="right" editable="true">
								<mx:itemRenderer>
									<mx:Component>
										<mx:HBox width="100%" horizontalScrollPolicy="off">
											<mx:Label text="{outerDocument.getInvoiceIndicator(data)}"/>
											<mx:Label text="{outerDocument.gridJobPrice(data,null)}" textAlign="right"/>	
										</mx:HBox>
										
									</mx:Component>
								</mx:itemRenderer>
								<mx:itemEditor>
									<mx:Component>
										<components:CustomNumericTextInputComponent
											dataHolder="{(data is Job)?data.pricingRecord:data}" variableName="{(data is Job)?'totalPrice':'price'}" customText="{(data is Job)?data.pricingRecord.totalPrice:data.price}"
											precision="2" rounding="nearest" focusOut="{outerDocument.updateInvoicePricing(data)}">
											<mx:Script>
												<![CDATA[
													import com.efi.printsmith.data.Job;
												]]>
											</mx:Script>
										</components:CustomNumericTextInputComponent>
									</mx:Component>
								</mx:itemEditor>
							</mx:DataGridColumn>
						</mx:columns>
					</mx:DataGrid>
					<mx:HBox visible="{invoice.voided}" horizontalCenter="0" verticalCenter="0">
						<mx:Label text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE,'newInvCmd.VOID')}"
							fontWeight="bold" fontSize="16"/>
						<mx:Label text="{dateFormatter.format(invoice.offPendingDate)}" fontSize="14"/>	
					</mx:HBox>
					
				</mx:Canvas>
				<mx:DataGrid height="100%"
							 width="100%" 
							 id="ticket_grid"
							 dataProvider="{deliveryTicketJobsList}"
							 sortableColumns="false"
							 doubleClick="{doDoubleclickTicketItem()}"
						  	 doubleClickEnabled="true"
						  	 visible="{deliveryTicketJobsList!=null &amp;&amp; deliveryTicketJobsList.length>0}"
						  	 includeInLayout="{deliveryTicketJobsList!=null &amp;&amp; deliveryTicketJobsList.length>0}">
					<mx:columns>
						<mx:DataGridColumn headerText="" dataField="jobNumber"/>
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Shipped')}"
							dataField="qtyShipped"/>	
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Description')}"
							labelFunction="getTicketDescription" dataField="description"/>
						<mx:DataGridColumn headerText="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Ticket')}">
							<mx:itemRenderer>
								<mx:Component>
									<mx:Label text="{data.parentDeliveryTicket.ticketNumber}"/>
								</mx:Component>
							</mx:itemRenderer>
						</mx:DataGridColumn>

					</mx:columns>
				</mx:DataGrid>
			</mx:VBox>

		</mx:ViewStack>
		<mx:HBox id="bottompartbox" height="10%" width="100%" borderThickness="2" borderStyle="solid" paddingBottom="5" paddingLeft="5" paddingRight="5" paddingTop="5">
			<mx:VBox width="30%" height="100%" id="spl_instructions_box">
				<mx:Label 
			  	text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'jobTicketCmd.SpecialInstructions')}"
			  	height="10%" width="100%"/>
				<mx:TextInput 
						  width="100%"
						  height="90%"
						  id="special_instructions_edit"
						  text="{invoice.specialInstructions.instructions}"/>
			</mx:VBox>
			<mx:VRule width="2%" height="100%"/>
			<mx:ViewStack id="bottomrightstack" height="100%" width="70%">
				
				<mx:HBox height="100%" width="70%" id="job_info_canvas">
					<mx:VBox width="30%" height="10%">
						<mx:HBox width="100%" height="50%">
							<mx:Label height="100%" width="20%" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'labelCmd.Format')}" textAlign="right"/>
							<mx:ComboBox width="80%" height="10%"
											 id="format_combo"
										 dataProvider="{invoiceTemplates}"/>
						</mx:HBox>
						<mx:Text width="50%" height="5%" visible="{(!isNaN(invoice.id))}" text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.OnPendingList')}" />
						<mx:Label width="50%" height="5%" id="lblHasNotes" />
						<mx:VBox id="btnDepEntry"  width="250" height="150" backgroundColor="0xc0c0c0" click="openDepositEntry();" >
							<mx:Text id="txtDep1" text="" textAlign="left" width="100%" height="10%"  />
							<mx:Text id="txtDep2" text="" textAlign="left" width="100%" height="10%"  />
							<mx:Text id="txtDep3" text="" textAlign="left" width="100%" height="10%"  />								
						</mx:VBox> 
						 
							
						 				 
					</mx:VBox>
					<mx:VRule width="2%" height="100%"/>
					<mx:Form width="30%" height="100%"  click="openDocTotals();">
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.CustDiscount')}"  >
							<mx:Text textAlign="right"
									 id="cust_discount_text"
									 text="{invoice.dollarDiscount}"
									 />
						</mx:FormItem>
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.NetSub')}"  >
							<mx:Text textAlign="right"
									 id="net_subtotal_text"
									 text="{Snowmass.getCurrencyFormatter(true, 2).format(invoice.subTotal)}"
									 />
						</mx:FormItem>
						
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.SalesTax')}" >
							<mx:Text textAlign="right"
									 id="sales_tax_text" text="{Snowmass.getCurrencyFormatter(true, 2).format(invoice.tax)}"
									 />
							
						</mx:FormItem>
						
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Shipping')}" >
							<mx:Text textAlign="right"
									 id="shipping_text"
									 text="{Snowmass.getCurrencyFormatter(true, 2).format(invoice.shipPrice)}"
									 />
						</mx:FormItem>
						
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.Total')}" >
							<mx:Text textAlign="right"
									 id="total_text"
									 text="{Snowmass.getCurrencyFormatter(true, 2).format(invoice.grandTotal)}"
									 />
						</mx:FormItem>
						
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'newInvCmd.AmtDue')}" >
							<mx:Text textAlign="right"
									 id="amt_due_text"
									 text="{Snowmass.getCurrencyFormatter(true, 2).format(invoice.amountDue)} "
									 />
						</mx:FormItem>
											
					</mx:Form>

				</mx:HBox>
				<mx:HBox id="cost_info_canvas">
					<mx:VBox width="10%" height="100%">
						<mx:HBox height="20%" width="100%">
							<mx:Button height="100%" width="50"
									   id="cost_entered_legend_button"
									   cornerRadius="0"
									   fillColors="[blue, blue]"
									   fillAlphas="[1.0, 1.0]"
									   borderColor="#000000"/>
							<mx:Label height="100%" width="50%"
							  text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Costentered')}"/>
							   	
						</mx:HBox>
						<mx:HBox height="20%" width="100%">
							
							<mx:Button height="100%" width="50" id="cost_entered_legend_button0"
									   cornerRadius="0"
									   fillColors="[green,green]"
									   	fillAlphas="[1.0, 1.0]"
									   borderColor="#000000"/>
							<mx:Label height="100%" width="50%"
							  text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Historicalcost')}"/>
						
						</mx:HBox>
						
						<mx:HBox height="20%" width="100%">
							<mx:Button height="100%" width="50" id="cost_entered_legend_button1"
									   cornerRadius="0"
									   fillColors="[#ff9600, #ff9600]"
									   fillAlphas="[1.0, 1.0]"
									   borderColor="#000000"/>
							<mx:Label height="100%" width="50%"
							  text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.DataCollections')}"/>
					
						</mx:HBox>
						
						<mx:HBox height="20%" width="100%">
						
							<mx:Button height="100%" width="50" id="cost_entered_legend_button2"
									   cornerRadius="0"
									   fillColors="[red, red]"
									   fillAlphas="[1.0, 1.0]"
									   borderColor="#000000"/>
								<mx:Label height="100%" width="50%"
								  text="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Pricedbelowcost')}"/>
	
						</mx:HBox>
					</mx:VBox>
					<mx:VRule width="2%" height="100%"/>
					<mx:Form width="50%" height="100%" id="costing_total_canvas" click="openDocTotals();">
						
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Actual')}" >
							<mx:Text   height="100%"
									textAlign="right"
									 id="cust_discount_text0" text="{getActualTotals(invoice.jobs)}"/>
						</mx:FormItem>
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Price')}" >
							<mx:Text  height="100%"
									 textAlign="right"
									 id="cust_discount_text1"  text="{getPriceTotals(invoice.jobs)}"/>
						</mx:FormItem>
						
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'invCostingCmd.Margin')}" >
							<mx:Text  height="100%"
									 textAlign="right"
									 id="cust_discount_text2" text="{getMarginTotals(invoice.jobs)}"/>
							
						</mx:FormItem>
						
						<mx:FormItem label="{resourceManager.getString(Snowmass.RESOURCE_BUNDLE, 'salesCmd.EstProfit')}" >
								
							<mx:Text  height="100%"
										 textAlign="right"
										 id="cust_discount_text3" text="{getEstProfitTotals(invoice.jobs)}"/>
							
						</mx:FormItem>
						
						
					</mx:Form>
				</mx:HBox>
				<mx:Canvas id="blankarea" height="100%" width="100%">
					<mx:Spacer width="100%" height="100%" />
				</mx:Canvas>						
		</mx:ViewStack>

	</mx:HBox>
</mx:VBox>
</mx:Panel>
