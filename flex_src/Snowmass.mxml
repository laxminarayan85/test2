<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute"  
		width="100%" height="100%" pageTitle="Snowmass"
 		xmlns:local="*" creationComplete="init()"  xmlns:ns1="com.efi.printsmith.view.*" 
 		applicationComplete="initAppFunctions()"
 		xmlns:ns2="flexlib.controls.*"
 		xmlns:flexlib="flexlib.containers.*"
 		xmlns:business="com.efi.printsmith.business.*"
 		xmlns:control="com.efi.printsmith.control.*" backgroundColor="#003893" xmlns:components="com.efi.printsmith.components.*">
 		<mx:Metadata>
 			[ResourceBundle("psResources")]
 		</mx:Metadata>
 		
	    <mx:Move 
	        id="moveLogo" target="{logo}" 
	        easingFunction="mx.effects.easing.Quadratic.easeIn" effectEnd="endMoveLogo()" duration="2000" xTo="480"
	    />
	    <mx:Fade
	    	id="efiLogoFade" target="{efi_logo}"
	    	alphaFrom="0" alphaTo="1" duration="2000"
	    />
	    <mx:Fade
	    	id="poweredByFade" target="{powered_by}"
	    	alphaFrom="0" alphaTo="1" duration="2000"
	    />
	<!--<mx:Style source="styles/darkroom.css"/>-->
	
    <!--mx:TraceTarget/-->
 	<mx:TraceTarget fieldSeparator="->" level="6" includeCategory="true" includeLevel="true" includeTime="true" />
    <mx:HBox x="0" y="32" width="100%" height="100%">
    <mx:Canvas width="2" height="100%">
    </mx:Canvas>

    <mx:VBox x="0" y="0" width="100%" height="100%" verticalGap="0" id="mainContainer" visible="true">
		<mx:Canvas height="2" width="100%">
		</mx:Canvas>	
		<flexlib:SuperTabNavigator id="mainNavigator" width="100%" height="100%" stopScrollingEvent="{MouseEvent.MOUSE_UP}" startScrollingEvent="{MouseEvent.MOUSE_DOWN}" closePolicy="{SuperTab.CLOSE_ROLLOVER}"   >
			<mx:Canvas height="100%" width="100%" id="mainWindow" label="{resourceManager.getString(RESOURCE_BUNDLE, 'kQuickAccessPanelCmd.QuickAccessPanel')}" name="PrintSmith QuickAccess" backgroundColor="#FFFFFF">
		  		<mx:Image x="-185" y="579" width="186" height="61" id="logo" source="assets/printsmith_logo.png"/>
				
				<components:MultiLineLabelButton x="10" y="10" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.CreateEstimate')}" width="158" height="90" id="create_estimate" labelPlacement="bottom" icon="@Embed(source='assets/createInvoice.png')" click="doCreateEstimate();" fontSize="9"/>
				<components:MultiLineLabelButton x="674" y="104" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.TrackerConsole')}" width="158" height="90" id="tracker_console" labelPlacement="bottom" icon="@Embed(source='assets/trackerConsole.png')" click="doTracker();" fontSize="9"/>
				<components:MultiLineLabelButton x="176" y="10" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.Accounts')}" width="158" height="90" id="accounts" labelPlacement="bottom" icon="@Embed(source='assets/accounts.png')" click="doAccounts()" fontSize="9"/>
				<components:MultiLineLabelButton x="176" y="198" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.UserDefinitions')}" width="158" height="90" id="users" labelPlacement="bottom" icon="@Embed(source='assets/accounts.png')" click="doUsers();" fontSize="9"/>
				<components:MultiLineLabelButton x="176" y="104" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.Contacts')}" width="158" height="90" id="contacts" labelPlacement="bottom" icon="@Embed(source='assets/contacts.png')" click="doContacts();" fontSize="9"/>
				<components:MultiLineLabelButton x="674" y="292" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.PostPayments')}" width="158" height="90" id="post_payment" labelPlacement="bottom" icon="@Embed(source='assets/postPayment.png')" click="doPayments();" fontSize="9"/>
				<components:MultiLineLabelButton x="675" y="480" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.Closeout')}" width="158" height="90" id="closeout" labelPlacement="bottom" icon="@Embed(source='assets/closeout.png')" fontSize="9"/>
				<components:MultiLineLabelButton x="674" y="386" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.MonthlyCloseout')}" width="158" height="90" id="monthly_closeout" labelPlacement="bottom" icon="@Embed(source='assets/monthlyCloseout.png')" fontSize="9"/>
				<components:MultiLineLabelButton x="508" y="386" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.DeliveryTicketManage')}" width="158" height="90" id="deliver_ticket" labelPlacement="bottom" icon="@Embed(source='assets/tickets.png')" click="doDeliveryTicket();" fontSize="9"/>
				<components:MultiLineLabelButton x="508" y="480" label="Utilities" width="158" height="90" id="utilities" labelPlacement="bottom" icon="@Embed(source='assets/reportManager.png')" click="doUtilities();"/>
				<components:MultiLineLabelButton x="674" y="10" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.ScheduleBoardManager')}" width="158" height="90" id="schedule_jobs" labelPlacement="bottom" icon="@Embed(source='assets/schedulejobs.png')" click="doSchedule();" fontSize="9"/>
				<!--<components:MultiLineLabelButton x="176" y="480" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.ClockInOut')}" width="158" height="90" id="punch_clock" labelPlacement="bottom" icon="@Embed(source='assets/punchclock.png')" click="doClockInOut();"/>-->
				<components:MultiLineLabelButton x="10" y="104" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.CreateInvoice')}" width="158" height="90" id="create_invoice" labelPlacement="bottom" icon="@Embed(source='assets/createInvoice.png')" click="doCreateInvoice();" fontSize="9"/>
				<components:MultiLineLabelButton width="158" height="90" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.PendingDocumentWindo')}" id="pending_documents" icon="@Embed(source='assets/pendingList.png')"  click="doPendingList();" fontSize="9" textAlign="center" x="10" y="386" labelPlacement="bottom" fontWeight="bold"/>
				<components:MultiLineLabelButton x="10" y="480" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.Pricing')}" width="158" height="90" id="pricing" labelPlacement="bottom" click="doPricing();"/>
				<components:MultiLineLabelButton x="10" y="198" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.AccountHistory')}" width="158" height="90" id="account_history" labelPlacement="bottom" icon="@Embed(source='assets/accountHistory.png')" click="doAccountHistory();" fontSize="9"/>
				<components:MultiLineLabelButton x="10" y="292" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.EstimateHistory')}" width="158" height="90" id="estimate_history" labelPlacement="bottom" icon="@Embed(source='assets/estimateHistory.png')" click="doEstimateHistory();" fontSize="9"/>
				<components:MultiLineLabelButton x="674" y="198" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.OpenCashRegister')}" width="158" height="90" id="cash_register" labelPlacement="bottom" icon="@Embed(source='assets/cash_register.png')" click="doCashRegister();" fontSize="9"/>
				<components:MultiLineLabelButton x="508" y="10" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.WorkinProgress')}" width="158" height="90" id="work_in_progress" labelPlacement="bottom" icon="@Embed(source='assets/workInProgress.png')" click="doWorkInProgress();" fontSize="9"/>
				<components:MultiLineLabelButton x="342" y="10" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.StockDefinitions')}" width="158" height="90" id="stock_definitions" labelPlacement="bottom" icon="@Embed(source='assets/stockDefinitions.png')" click="doStockDefinitions()" fontSize="9"/>
				<components:MultiLineLabelButton x="342" y="104" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.PressDefinitions')}" width="158" height="90" id="press_definitions" labelPlacement="bottom" icon="@Embed(source='assets/pressDefinitions.png')" click="doPressDefinitions()" fontSize="9"/>
				<components:MultiLineLabelButton x="342" y="198"  label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.CopierDigitalDefinit')}" width="158" height="90" id="copier_definitions" labelPlacement="bottom" icon="@Embed(source='assets/copierDefinitions.png')" click="doCopyDefinitions()" fontSize="9"/>
				<components:MultiLineLabelButton x="342" y="292" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.ChargeDefinitions')}" width="158" height="90" id="charge_definitions" labelPlacement="bottom" icon="@Embed(source='assets/chargeDefinitions.png')" click="doChargeDefinitions()" fontSize="9"/>
				<components:MultiLineLabelButton x="342" y="386" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.Preferences')}" width="158" height="90" id="preferences" labelPlacement="bottom" icon="@Embed(source='assets/preference.png')" click="doSystemPreferences()" fontSize="9"/>
				<components:MultiLineLabelButton x="342" y="480" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.DocumentPreferences')}" width="158" height="90" id="document_preferences" labelPlacement="bottom" icon="@Embed(source='assets/createInvoice.png')" fontSize="9"/>
				<components:MultiLineLabelButton x="508" y="104" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.MailingLabels')}" width="158" height="90" id="mailing_labels" labelPlacement="bottom" icon="@Embed(source='assets/mailingLabels.png')" fontSize="9"/>
				<components:MultiLineLabelButton x="508" y="198" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.ReportManager')}" width="158" height="90" id="report_manager" labelPlacement="bottom" icon="@Embed(source='assets/reportManager.png')" fontSize="9"/>
				<components:MultiLineLabelButton x="508" y="292" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.CreditCardManager')}" width="158" height="90" id="report_writer" labelPlacement="bottom" icon="@Embed(source='assets/reportWriter.png')" click="doCreditCardManager()" fontSize="9"/>
				<mx:Image x="91" y="574" id="efi_logo" source="assets/logo-efi-print-to-win.gif" visible="true" alpha="0.0" width="89" height="28"/>
				<mx:Text x="10" y="587" text="Powered by:&#xd;" id="powered_by" alpha="0.0"/>
				<components:MultiLineLabelButton x="176" y="386" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.Employees')}" width="158" height="90" icon="@Embed(source='assets/employeeManager.png')" labelPlacement="bottom" click="doEmployee();" fontSize="9"/>
				<components:MultiLineLabelButton x="176" y="292" label="{resourceManager.getString(RESOURCE_BUNDLE, 'rStandardMenuText.SecuritySetup')}" width="158" height="90" id="admin_button" labelPlacement="bottom" click="doSecurity();" fontSize="9"/>
				
			</mx:Canvas>
		</flexlib:SuperTabNavigator>

	</mx:VBox>
    <mx:Canvas width="2" height="100%">
    </mx:Canvas>
</mx:HBox>
<mx:RemoteObject id="loginService" destination="loginService"
	result="handleLoginResult(event)"  fault="handleFault(event)"
	showBusyCursor="true" />

<mx:Script>
	<![CDATA[
		import mx.collections.ArrayCollection;
		import mx.managers.IFocusManagerComponent;
		import mx.managers.FocusManager;
		import mx.core.ComponentDescriptor;
		import mx.formatters.DateFormatter;
		import mx.formatters.CurrencyFormatter;
		import com.efi.printsmith.events.commandEvents.EditForms.*;
		import com.efi.printsmith.events.ShowCreditCardMgrEvent;
		
		import com.efi.printsmith.view.*;

		import com.efi.printsmith.data.Users;
		import mx.effects.easing.Quadratic;
		import com.efi.printsmith.pages.Debug;
		import com.efi.printsmith.data.InvoiceBase;
		
		import com.efi.printsmith.security.PSSecurity;
		
		import mx.formatters.NumberFormatter;
		import mx.controls.DateField;
		import flash.utils.setTimeout;
		import flash.net.navigateToURL;
		import mx.resources.ResourceBundle;
		import mx.rpc.remoting.mxml.RemoteObject;
		import mx.rpc.events.FaultEvent;
		import mx.events.ResourceEvent;
		import mx.controls.Alert;
		import mx.rpc.events.ResultEvent;
		import mx.effects.Zoom;
		import mx.containers.Panel;
		import mx.managers.PopUpManager;
		import mx.rpc.IResponder;
        import mx.managers.BrowserManager;
        import mx.managers.IBrowserManager;
        import mx.events.BrowserChangeEvent;
        import mx.utils.StringUtil;
         
		import com.efi.printsmith.pages.Login;
		import mx.managers.ToolTipManager;
		import flash.events.EventDispatcher;
		import flash.events.TimerEvent;
		import flash.external.ExternalInterface;
		import flash.utils.Timer;
		import com.efi.printsmith.view.EditCustomer;
		import com.efi.printsmith.view.ListUsers;
		import flexlib.controls.SuperTabBar;
		import flexlib.events.TabReorderEvent;
		import flexlib.controls.tabBarClasses.SuperTab;
		import com.efi.printsmith.components.MultiLineLabelButton;
		import mx.logging.ILogger;
		import mx.logging.Log;
		
		public var timer : Timer;
		public var nf:NumberFormatter;
		
		private var keyListener:Object;

		private var remoteObject:RemoteObject;
		
		public static const RESOURCE_BUNDLE:String = "psResources";
		
		public var userName:String;
		public var userPass:String;
		
		private var gCardDataBuffer:String;
		private var gQuestionMarkCount:int = 0;
		private var gCardDataCharCount:int = 0;
		private var gCaptureCardData:Boolean = false;
		private var gComponent:IFocusManagerComponent = null;
		private var gTimer:Timer = null;
		
		public var security:com.efi.printsmith.security.PSSecurity;
		
        private var bm:IBrowserManager;
        
        [Bindable] public var autoClockOutDetectortList:ArrayCollection = new ArrayCollection();
        		
		[Bindable]
		public var currentUser:Users;

        private static var thisInstance:Snowmass = null;  
		
		[Bindable]
		private var locales:Array = ["de_DE", "en_AU", "en_GB", "en_US", "es_CL", "es_CO", "es_ES", "es_MX", "fr_CA", "fr_FR", "ja_JP", "lv_LV", "nl_NL", "pt_PT", "ru_RU"];
		public static function getInstance() : Snowmass {
			return thisInstance;
		}		
		
    	private function showLoginPage() : void
		{
		}
		
		private function onPreferences():void	{
			var event:Event = new Event("addPreferencesTab");
			dispatchEvent(event);
		}
		
		private function showLogin():void	{
			var loginPopup : Login = Login(PopUpManager.createPopUp(this, Login, true));
		//	this.mainContainer.visible=false;
			PopUpManager.centerPopUp(loginPopup);
		}
		
		private function showHelp():void {
		
		}
		
		private function onLogout():void {
			
		}

		public function handleUIEvent(evt:ResultEvent):void {
			var child:Panel = evt.result as Panel;
			addUniqueTab(child);
		}		

		
		private function doAccounts():void {
			var event:EditCustomerEvent = new EditCustomerEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}

		private function doUsers():void {
			var event:EditUserEvent = new EditUserEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		private function doContacts():void {
			var event:EditContactEvent = new EditContactEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		private function doPayments():void {
			var event:EditPaymentEvent = new EditPaymentEvent(new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		private function doPressDefinitions():void {
			var event:EditPressDefinitionEvent = new EditPressDefinitionEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		private function doCopyDefinitions():void {
			var event:EditCopierDefinitionEvent = new EditCopierDefinitionEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		private function doWorkInProgress():void{
			var event:EditWorkInProgressEvent = new EditWorkInProgressEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
			
		}
		
		private function doChargeDefinitions():void {
			var event:EditChargeDefinitionEvent = new EditChargeDefinitionEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		
		private function doCreditCardManager():void {
			var event:ShowCreditCardMgrEvent = new ShowCreditCardMgrEvent(new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}

		private function doAccountHistory():void {
			var event:EditAccountHistoryEvent = new EditAccountHistoryEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		private function doEstimateHistory():void {
			var event:EditEstimateHistoryEvent = new EditEstimateHistoryEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		
		private function doStockDefinitions():void {
			var event:EditStockDefinitionEvent = new EditStockDefinitionEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		
		private function doSystemPreferences():void {
			var event:EditSystemPreferencesEvent = new EditSystemPreferencesEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		private function doCashRegister():void {
			var event:EditCashRegisterEvent = new EditCashRegisterEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}

		private function doPendingList():void {
			var event:EditPendingListEvent = new EditPendingListEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		private function doEmployee():void {
			var event:EditEmployeeEvent = new EditEmployeeEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		private function doSchedule():void {
			var event:EditScheduleEvent = new EditScheduleEvent(new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		private function doSecurity():void {
			var event:EditSecurityEvent = new EditSecurityEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		private function doTracker():void {
			var event:EditTrackerEvent = new EditTrackerEvent(new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		private function doPricing():void {
			var event:EditPricingEvent = new EditPricingEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}


		private function doUtilities():void {
			var child:Utilities = new Utilities();
			addUniqueTab(child);
		}

		private function doClockInOut():void {
//			var event:EditClockInOutEvent = new EditClockInOutEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
//			event.dispatch();
		}
		private function doCreateEstimate():void {
			var event:EditCreateEstimateEvent = new EditCreateEstimateEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		private function doCreateInvoice():void {
			var event:EditCreateInvoiceEvent = new EditCreateInvoiceEvent(null, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		public function doEditEstimate(estimate:InvoiceBase):void {
			var event:EditEditEstimateEvent = new EditEditEstimateEvent(estimate, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		public function doEditInvoice(invoice:InvoiceBase):void {
			var event:EditEditInvoiceEvent = new EditEditInvoiceEvent(invoice, new mx.rpc.Responder(handleUIEvent, handleFault));
			event.dispatch();
		}
		
		public function doLogout():void {
			for (var i:int = 1; i < mainNavigator.numChildren; i++) {
				mainNavigator.removeChildAt(i);
			}
			this.currentUser = null;
			this.showLogin();
			this.updateTitle();
       	}
       	
		private function addUniqueTab(tab:Panel):void {
			var tabFound:Boolean = false;
			
			for (var i:int = 0; i < mainNavigator.numChildren; i++)
			{
				if (mainNavigator.getChildAt(i).name == tab.name)
				{
					mainNavigator.selectedIndex = i;
					tabFound = true;
					break;
				}
			}
			if (!tabFound) {
				var tmpPanel:Panel = mainNavigator.addChild(tab) as Panel;
				mainNavigator.selectedIndex = mainNavigator.numChildren-1;
			}
		}
		
		private function initAppFunctions() : void {
			stage.addEventListener(KeyboardEvent.KEY_UP, myKeyUpHandler);
		}
		
		private function init() : void {
			thisInstance = this;
			mainNavigator.setClosePolicyForTab(0, SuperTab.CLOSE_NEVER);
			var eventDispatcher:IEventDispatcher = resourceManager.loadResourceModule("Resources_en_US.swf");
            eventDispatcher.addEventListener(ResourceEvent.COMPLETE, completeHandler);
            eventDispatcher.addEventListener(ResourceEvent.ERROR, resourceFaultHandler);
            resourceManager.localeChain = [ "en_US" ];
			this.languageComboBox.selectedItem = "en_US";
			userName = Application.application.parameters.userName;
			userPass = Application.application.parameters.userPass;
			
			if (userName == null && userPass == null) { 
				showLogin();
			} else {
				loginService.validateLogin(userName, userPass);
			}
			moveLogo.play();
			
			this.addEventListener(KeyboardEvent.KEY_DOWN, keyHandler);

            bm = BrowserManager.getInstance();
            bm.init("", "Welcome to Snowmass");

		}
	
		private function keyHandler(event:KeyboardEvent):void {

		var bAltPressed:Boolean = event.altKey;
		var bCtrlPressed:Boolean = event.ctrlKey;
		var curKeyCode:int = event.keyCode;

		if( bAltPressed && bCtrlPressed){
			if(curKeyCode==83){

				//CTRL + S pressed; saveCall()

			}
			if(curKeyCode==78 ){

				//CTRL + N pressed; NewEntryCall()

			}

			if(curKeyCode == 68){

				//CTRL + D pressed; DeleteEntryCall()

			}

			if(curKeyCode == 67){

				//CTRL + C pressed; CopyCall()

			}

			if(curKeyCode == 70){

				//CTRL + F pressed; SearchCall()

			}
			if(curKeyCode == 73){

				//alt + I 
			doCreateInvoice();
			}
			}
		}
		
		//
		// timer to allow for failed credit card brick reading, this will switch back to normal
		//	operations when no REAL card data can be found.
		//
 		private function timerCallBack(evt:TimerEvent):void {
            var tmr:Timer = evt.currentTarget as Timer;
            if (tmr.currentCount >= 3) {
            	// give up on more data coming in from card reader
				gCaptureCardData = false;
				// restore the focus
				focusManager.setFocus(gComponent);
				tmr.stop();
            }
        }
        
		private function startWaitTimer():void {
			if (gTimer == null) {
	             gTimer = new Timer(1000,3);
	             gTimer.addEventListener(TimerEvent.TIMER, timerCallBack);
	             gTimer.start();
	 		 } else {
	 		 	gTimer.reset();
	 		 	gTimer.start();
	 		 }
        }
		
		//
		// The main level key UP event processing, handles ALL key strokes from the user,
		//	which is also where the card brick data comes from.
		// *** BE VERY CAREFUL MAKING CHANGES HERE, EFFECTS GLOBAL STATES AND TIMERS ***
		//
		// Sample raw card data:  Track one and Track two
		// %B3000 100000 50000^RODGERS/D                 ^1109061188864?
		// ;3000150000052007=110906119999?
		//
		private function myKeyUpHandler(event:KeyboardEvent):void {
		
			var curKeyCode:int;
			var localString:String;
			
			// ONLY WHEN NO ALT OR CONTROL KEYS ARE DOWN
			//
			if( event.altKey == false && event.ctrlKey == false){
				curKeyCode = event.keyCode;
				
				// all bricks are programmed to preceed data with a "F6" key stroke.
				if(curKeyCode==Keyboard.F6 && gCaptureCardData == false) {
					gCardDataBuffer = "";
					gQuestionMarkCount = 0;
					gCardDataCharCount = 0;
					gCaptureCardData = true;
					// save off the current focus and set the current focus to null, keep text fields from seeing the card data
					gComponent = focusManager.getFocus();
					this.stage.focus = null;
					
					// kick off a timer to know when all data should have come in.
					//  give up after a few seconds.
					startWaitTimer();
				} 
				//
				// if the card data is being captured, grab one character at a time into the buffer
				//
				else if (gCaptureCardData) {
					
					localString = String.fromCharCode(event.charCode);
					gCardDataBuffer = gCardDataBuffer.concat(localString);
					
					++gCardDataCharCount;
					
					if (event.charCode == 63) {		// "?"
						gQuestionMarkCount += 1;
					}
					
					if (gCardDataBuffer.length > 40 && gQuestionMarkCount > 1 && event.charCode == 13) {
						// tell the timer we are complete, it can shut down now
						if (gTimer != null) {
							gTimer.stop();
						}
						// no more data will be captured into the card buffer
						gCaptureCardData = false;
						// restore the focus
						focusManager.setFocus(gComponent);
						
						parseCreditCardRawTrackData(gCardDataBuffer);
					}
				}
			}
		}
		
		private function parseCreditCardRawTrackData(inputTxt:String):void {
			var startSentinal:String;
			var cardNumber:String;
			var cardHolderName:String;
			var formatCode:String;
			var expirationYY:String;
			var expirationMM:String;
			var cr:String = String.fromCharCode(13);
			var trackOne:String;
			var trackTwo:String;
			var k:int;
			var len:int;
			var i:int;
			var cardType:Number;
			var myRegExp:RegExp;
			
			startSentinal = inputTxt.charAt(0);
			formatCode = inputTxt.charAt(1);
			
			// good starting code and track data markers
			if (startSentinal == "%" && formatCode == "B") {
				len = inputTxt.length;
				k = 0;
				while (inputTxt.charAt(k) != "^" && k < len)
				{
					++k;
				}
				--k;  // don't include the "^" symbol
				cardNumber = inputTxt.substring(2,k);
				
				myRegExp = new RegExp(" ","g");		// find a SPACE character, all of them
				cardNumber.replace(myRegExp,"");	// replace the SPACE with <empty>
				
				k += 2;  // skip the "^" symbol
						
				len = inputTxt.length;
				i = k;	// the starting point, first letter in name section
				while (inputTxt.charAt(k) != "^" && k < len)
				{
					++k;
				}
				--k;  // don't include the "^" symbol
				cardHolderName = inputTxt.substring(i,k);
				cardHolderName = StringUtil.trim(cardHolderName);
				
				// read the YYMM expiration date
				k += 2;
				i=k;
				expirationYY = inputTxt.substring(i,i+1);
				i += 2;
				expirationMM = inputTxt.substring(i,i+1);
				
				// find the track one and track two seperator
				k = i+1;
				while (inputTxt.charAt(k) != cr && k < len)
				{
					++k;
				}
				
				// capture the raw track data and compute the credit card type number from first digit
				cardType = (cardNumber.charCodeAt(0) - 48);
				trackOne = inputTxt.substring(0,k);
				trackTwo = inputTxt.substring(k+1,len);
				
				// remove white space at the end, ie.. CR, LF, SPACE
				trackOne = StringUtil.trim(trackOne);
				trackTwo = StringUtil.trim(trackTwo);
			}
		}
		
		
		private function endMoveLogo() : void {
			efiLogoFade.play();
			poweredByFade.play();			
		}
		
		public function updateTitle() : void {
			if (currentUser != null) {
			   	bm.setTitle("Welcome to Snowmass " + currentUser.name);
			} else {
				bm.setTitle("Welcome to Snowmass");
			}
		}
		
		private function handleLoginResult(event:ResultEvent):void	{
			var res:Users = event.result as Users;
			if (res != null) {
				currentUser = res;
				security = new PSSecurity(currentUser);
 			} else {
				Alert.show("Invalid login", null, Alert.OK, null, null, null, Alert.OK);
				showLogin();
			}
		}
		
		private function handleFault(ev:FaultEvent):void {
			var errorDetail:String="";
			if (ev.fault!=null && ev.fault.faultCode=="InvalidSecurityAccess"){
				errorDetail = resourceManager.getString(Snowmass.RESOURCE_BUNDLE, ev.fault.faultDetail);
			}else{
				errorDetail = ev.fault.faultDetail;
			}
			Alert.show(errorDetail,ev.fault.faultCode, Alert.OK, null, null, null, Alert.OK);
		}
		
		private function enableLogout():Boolean {
			return (currentUser==null)?false:true;
		}
		
//		CONFIG::debugging
		private function showDebugButton():Boolean {
			return true;
		}
		
//		CONFIG::release
//		private function showDebugButton():Boolean {
//			return false;
//		}
		
//		CONFIG::debugging
		private function doDebug():void {
			var debugPopup : Debug = Debug(PopUpManager.createPopUp(this, Debug, true));
		//	this.mainContainer.visible=false;
			PopUpManager.centerPopUp(debugPopup);
		}
		
//		CONFIG::release
//		private function doDebug():void {
//		}

		private function doDeliveryTicket():void{
			var child:DeliveryTicketMgr = new DeliveryTicketMgr();
			addUniqueTab(child);
		}		
		
		/**
		 *  The labelFunction for the Language combobox.
		 *  It takes a locale such as "en_US"
		 *  and produces the localized string "English".
		 */
		private function languageComboBoxLabelFunction(item:Object):String {
			var locale:String = String(item);
			switch (locale) {
				case "de_DE":
					return "Deutsch";
					break;
				case "en_AU":
					return "English (Australia)";
					break;
				case "en_GB":
					return "English (UK)";
					break;
				case "en_US":
					return "English (US)";
					break;
				case "es_CL":
					return "Español (Chile)";
					break;
				case "es_CO":
					return "Español (Colombia)";
					break;
				case "es_ES":
					return "Español (España)";
					break;
				case "es_MX":
					return "Español (México)";
					break;
				case "fr_CA":
					return "Français (Le Canada)";
					break;
				case "fr_FR":
					return "Français (La France)";
					break;
				case "ja_JP":
					return "日本語"
					break;
				case "lv_LV":
					return "Latvian"
					break;
				case "nl_NL":
					return "Nederlands"
					break;
				case "pt_PT":
					return "Português"
					break;
				case "ru_RU":
					return "Русско"
					break;
			}
			return resourceManager.getString(RESOURCE_BUNDLE, locale);
		}
				
		/**
		 *  Comparison function for sorting the 'locales' Array,
		 *  which is the dataProvider for the Language combobox.
		 *  The sort order is locale-dependent,
		 *  because the localized language names for the locales
		 *  are presented in alphabetical order.
		 */
		private function localeCompareFunction(item1:Object, item2:Object):int {
			var language1:String = languageComboBoxLabelFunction(item1);
			var language2:String = languageComboBoxLabelFunction(item2);
			
			if (language1 < language2)
				return -1;
			if (language1 > language2)
				return 1;
			return 0;
		}
		
		/**
		 *  Repopulates the Language combobox with localized language names
		 *  for the supported locales, alphabetized by language name.
		 */
		private function updateLanguageComboBox():void {
			var oldSelectedItem:Object = languageComboBox.selectedItem;
			
			// Repopulate the combobox with locales,
			// re-sorting by localized language name.
			locales.sort(localeCompareFunction);
			languageComboBox.dataProvider = locales;
			
			languageComboBox.selectedItem = oldSelectedItem;
		}

		private function languageComboBox_changeHandler(event:Event):void {
            var newLocale:String = String(languageComboBox.selectedItem);

            if (resourceManager.getLocales().indexOf(newLocale) != -1)
            {
                completeHandler(null);
            }
            else
            {
                var resourceModuleURL:String = "Resources_" + newLocale + ".swf";
                var eventDispatcher:IEventDispatcher =
                    resourceManager.loadResourceModule(resourceModuleURL);
                eventDispatcher.addEventListener(
                    ResourceEvent.COMPLETE, completeHandler);
                eventDispatcher.addEventListener(
                	ResourceEvent.ERROR, resourceFaultHandler);
            }
            updateLanguageComboBox();
		}
		
        private function completeHandler(event:ResourceEvent):void {
            resourceManager.localeChain = [ languageComboBox.selectedItem ];
        }
        
        private function resourceFaultHandler(event:ResourceEvent):void {
			Alert.show("Error loading resources: " + event.errorText, null, Alert.OK, null, null, null, Alert.OK);
        }
        
        public static function getCurrencyFormatter(showSymbol:Boolean, precision:Number):CurrencyFormatter {
        	var formatter:CurrencyFormatter = new CurrencyFormatter();
        	if (showSymbol){
        		formatter.currencySymbol = "$";
        	}else{
        		formatter.currencySymbol = "";
        	}
        	formatter.precision = precision;
        	
        	return formatter;
        }
        
        public static function getDateFormatter():DateFormatter {
        	var formatter:DateFormatter = new DateFormatter;
        	formatter.formatString = "MMMM DD, YYYY   L:NN:SS A";
        	return formatter;
        }
        
        public function getApplicationRootURL():String {
        	return this.url.substr(0, this.url.lastIndexOf("/"));
        }
        
        public function getLocalizedEnum(enumerationName:String, enumerationValue:String):String {
        	return resourceManager.getString(Snowmass.RESOURCE_BUNDLE, enumerationName + '_' + enumerationValue);
        }
]]>		
</mx:Script>
	<business:Services id="services" />
	<control:MainController id="controller" />
	<mx:LinkButton label="Logout" id="logout_button" enabled="{(currentUser==null)?false:true}" click="{doLogout()}" right="10" top="5"/>
	<mx:LinkButton label="Debug" id="debug_button" show="{showDebugButton()}" click="{doDebug()}" right="77" top="5"/>
	<mx:ComboBox x="475" y="4" id="languageComboBox" dataProvider="{locales}"				 
					labelFunction="languageComboBoxLabelFunction"
					change="languageComboBox_changeHandler(event)"/>
</mx:Application>
